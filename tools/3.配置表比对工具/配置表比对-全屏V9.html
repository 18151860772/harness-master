<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®è¡¨æ¯”å¯¹å·¥å…· V9ï¼ˆå…¨å±ç‰ˆï¼‰</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // åŠ¨æ€åŠ è½½xlsx-js-styleåº“
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js';
            script.onload = function() {
                console.log('xlsx-js-style loaded');
                // æ˜¾ç¤ºåº“åŠ è½½æˆåŠŸçš„æç¤º
                const statusIndicator = document.getElementById('libraryStatus');
                if (statusIndicator) {
                    statusIndicator.className = 'status-success';
                    statusIndicator.textContent = 'âœ“ æ ·å¼åº“å·²å°±ç»ª';
                }
            };
            script.onerror = function() {
                console.warn('xlsx-js-style failed to load, colors may not export properly');
                const statusIndicator = document.getElementById('libraryStatus');
                if (statusIndicator) {
                    statusIndicator.className = 'status-warning';
                    statusIndicator.textContent = 'âš  æ ·å¼åº“åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸºæœ¬å¯¼å‡º';
                }
            };
            document.head.appendChild(script);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-badge {
            text-align: center;
            margin-bottom: 25px;
        }

        .version-badge span {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .library-status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .status-success {
            color: #2e7d32;
            font-weight: 600;
        }

        .status-warning {
            color: #f57c00;
            font-weight: 600;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            transition: all 0.5s ease;
            opacity: 0;
        }

        .upload-box:hover::before {
            opacity: 1;
            top: -30%;
            left: -30%;
        }

        .upload-box:hover {
            border-color: #764ba2;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .upload-box.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e8eaf6 0%, #e1bee7 100%);
            transform: scale(1.02);
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        .upload-box p {
            color: #666;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .upload-box .icon {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            color: #2e7d32;
            font-size: 12px;
            word-break: break-all;
            border-left: 4px solid #667eea;
            font-weight: 600;
        }

        .compare-btn {
            display: block;
            width: 200px;
            margin: 0 auto 25px;
            padding: 14px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .compare-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .compare-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 18px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .result-header h2 {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 700;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
        }

        .export-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .legend-color.yellow {
            background: #F9A825;
        }

        .legend-color.red {
            background: #E57373;
        }

        .legend-color.green {
            background: #66BB6A;
        }

        .legend-item span {
            color: #2c3e50;
            font-size: 13px;
            font-weight: 600;
        }

        .table-wrapper {
            overflow: auto;
            max-height: 75vh;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: #4CAF50;
            color: white;
            padding: 12px 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            border: 1px solid #388E3C;
            font-weight: 700;
        }

        th.fixed-column {
            background: #2E7D32;
            position: sticky;
            left: 0;
            z-index: 20;
        }

        /* è¡¨å¤´è¡Œ1ï¼ˆè½¦å‹åºå·ï¼‰- è“è‰² */
        thead tr:nth-child(1) th {
            background: #1565C0;
            border-color: #0D47A1;
            position: sticky;
            top: 0;
            z-index: 15;
        }

        /* è¡¨å¤´è¡Œ1çš„å›ºå®šåˆ— */
        thead tr:nth-child(1) th.fixed-column {
            background: #0D47A1;
            z-index: 25;
        }

        /* è¡¨å¤´è¡Œ2ï¼ˆè½¦å‹åç§°ï¼‰- è“è‰² */
        thead tr:nth-child(2) th {
            background: #1565C0;
            border-color: #0D47A1;
            position: sticky;
            top: 38px;
            z-index: 15;
        }

        /* è¡¨å¤´è¡Œ2çš„å›ºå®šåˆ— */
        thead tr:nth-child(2) th.fixed-column {
            background: #0D47A1;
            z-index: 25;
        }

        /* è¡¨å¤´è¡Œ2ï¼šåˆ é™¤/æ–°å¢è½¦å‹åˆ— - å¿…é¡»æ”¾åœ¨æœ€åä»¥è¦†ç›–å…¶ä»–æ ·å¼ */
        thead tr:nth-child(2) th.header-red.fixed-column,
        thead tr:nth-child(2) th.fixed-column.header-red {
            background: #E53935 !important;
            border-color: #C62828 !important;
        }

        thead tr:nth-child(2) th.header-red {
            background: #E53935 !important;
            border-color: #C62828 !important;
        }

        thead tr:nth-child(2) th.header-green.fixed-column,
        thead tr:nth-child(2) th.fixed-column.header-green {
            background: #43A047 !important;
            border-color: #2E7D32 !important;
        }

        thead tr:nth-child(2) th.header-green {
            background: #43A047 !important;
            border-color: #2E7D32 !important;
        }

        td {
            padding: 10px;
            border: 1px solid #ddd;
            min-width: 90px;
            text-align: center;
            color: #333;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }

        td.fixed-column {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #4CAF50;
            max-width: 70px;
            min-width: 55px;
        }

        /* ç¬¬ä¸€åˆ—ç‰¹å¾å€¼ä»£ç åˆ— */
        td.fixed-column:first-child {
            max-width: 70px;
            min-width: 55px;
            font-size: 11px;
        }

        /* å›ºå®šåˆ—çš„è¡Œçº§é¢œè‰² */
        .row-added td.fixed-column:not(.fixed-column-green) {
            background: #66BB6A !important;
        }

        .row-deleted td.fixed-column:not(.fixed-column-red) {
            background: #E57373 !important;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        tr:hover {
            background: #f0f0f0;
        }

        .cell-yellow {
            background: #F9A825 !important;
            font-weight: bold;
            color: #000 !important;
        }

        .cell-red {
            background: #E57373 !important;
        }

        .cell-green {
            background: #66BB6A !important;
        }

        .fixed-column-yellow {
            background: #F9A825 !important;
            font-weight: bold;
            color: #000 !important;
        }

        .row-added {
            background: #66BB6A !important;
        }

        .row-deleted {
            background: #E57373 !important;
        }

        .fixed-column-green {
            background: #66BB6A !important;
            font-weight: bold;
        }

        .fixed-column-red {
            background: #E57373 !important;
            font-weight: bold;
        }

        .header-red {
            background: #E53935 !important;
        }

        .header-green {
            background: #43A047 !important;
        }

        /* V8: æ‰“ç‚¹æ±‡æ€»è¡Œæ ·å¼ */
        .dot-summary-row {
            background: #E3F2FD !important;
            font-weight: bold;
            border-top: 3px solid #1976D2 !important;
        }

        .dot-summary-row td {
            padding: 15px 10px;
            text-align: center;
            vertical-align: top;
        }

        .dot-summary-row td.fixed-column {
            background: #BBDEFB !important;
            font-size: 14px;
            text-align: left;
        }

        .dot-summary-content {
            text-align: left;
            font-size: 12px;
            line-height: 1.8;
        }

        .dot-summary-content .dot-add {
            color: #2E7D32;
            font-weight: bold;
        }

        .dot-summary-content .dot-remove {
            color: #C62828;
            font-weight: bold;
        }

        .dot-summary-content .dot-item {
            display: inline-block;
            margin: 2px 4px;
            padding: 2px 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .summary {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }

        .summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 13px;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #c62828;
            font-size: 13px;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            display: none;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #2e7d32;
            font-size: 13px;
        }

        .success-message.active {
            display: block;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .filter-label {
            color: #2c3e50;
            font-size: 15px;
            font-weight: 700;
        }

        .filter-options {
            display: flex;
            gap: 25px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .filter-option input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .filter-option span {
            color: #2c3e50;
            font-size: 13px;
            font-weight: 600;
        }

        .filter-option:hover span {
            color: #667eea;
        }

        .family-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .family-filter-input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .family-filter-select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .family-filter-select:hover {
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .family-filter-select:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .family-filter-input {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            background: white;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .family-filter-input:hover {
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .family-filter-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .family-filter-input::placeholder {
            color: #999;
            font-weight: 400;
        }

        .clear-filter-btn {
            padding: 8px 12px;
            border: 2px solid #f57c00;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #f57c00;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filter-btn:hover {
            background: #f57c00;
            color: white;
            box-shadow: 0 2px 8px rgba(245, 124, 0, 0.3);
        }

        .filter-divider {
            width: 2px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 10px;
        }

        /* å¯¼å‡ºé€‰é¡¹é¢æ¿ */
        .export-options {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 350px;
        }

        .export-options.active {
            display: block;
        }

        .export-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .export-overlay.active {
            display: block;
        }

        .export-options h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
        }

        .export-option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f5f7fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-option-item:hover {
            background: #e8eaf6;
        }

        .export-option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .export-option-item label {
            cursor: pointer;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .export-buttons-panel {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .export-confirm-btn {
            flex: 1;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .export-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .export-cancel-btn {
            flex: 1;
            padding: 12px 24px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .export-cancel-btn:hover {
            background: #d0d0d0;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }

            .result-header {
                flex-direction: column;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é…ç½®è¡¨æ¯”å¯¹å·¥å…· V9</h1>
        <div class="version-badge">
            <span>å…¨å±å¢å¼ºç‰ˆ - Familyè‡ªåŠ¨åŒ¹é… + Familyç­›é€‰ + æ‰“ç‚¹å˜åŒ–ç»Ÿè®¡ï¼ˆæ˜¾ç¤ºæè¿°ï¼‰</span>
        </div>

        <div class="library-status">
            <span id="libraryStatus">æ­£åœ¨åŠ è½½æ ·å¼åº“...</span>
        </div>

        <div class="upload-section">
            <div class="upload-box" id="uploadBox1" onclick="document.getElementById('fileInput1').click()">
                <span class="icon">ğŸ“„</span>
                <h3>æ—§ç‰ˆæœ¬æ–‡ä»¶</h3>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</p>
                <input type="file" id="fileInput1" class="file-input" accept=".xlsx,.xls">
                <div class="file-info" id="fileInfo1" style="display: none;"></div>
            </div>

            <div class="upload-box" id="uploadBox2" onclick="document.getElementById('fileInput2').click()">
                <span class="icon">ğŸ“„</span>
                <h3>æ–°ç‰ˆæœ¬æ–‡ä»¶</h3>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</p>
                <input type="file" id="fileInput2" class="file-input" accept=".xlsx,.xls">
                <div class="file-info" id="fileInfo2" style="display: none;"></div>
            </div>

            <div class="upload-box" id="uploadBox3" onclick="document.getElementById('fileInput3').click()">
                <span class="icon">ğŸ“Š</span>
                <h3>Familyæ˜ å°„è¡¨</h3>
                <p>ä¸Šä¼ ç‰¹å¾å€¼-Familyå¯¹åº”è¡¨ï¼ˆå¯é€‰ï¼‰</p>
                <input type="file" id="fileInput3" class="file-input" accept=".xlsx,.xls">
                <div class="file-info" id="fileInfo3" style="display: none;"></div>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <button class="compare-btn" id="compareBtn" disabled onclick="compareFiles()">
            å¼€å§‹æ¯”å¯¹
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #666; font-weight: 600;">æ­£åœ¨å¤„ç†æ–‡ä»¶...</p>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2>æ¯”å¯¹ç»“æœ</h2>
                <div class="export-buttons">
                    <button class="export-btn" onclick="showExportOptions()">å¯¼å‡ºExcel</button>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color yellow"></div>
                    <span>å·®å¼‚å•å…ƒæ ¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>æ–°å¢çš„è½¦å‹åˆ—</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>åˆ é™¤çš„è½¦å‹åˆ—ï¼ˆæ˜¾ç¤ºæ—§ç‰ˆæ•°æ®ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>æ–°å¢è¡Œï¼ˆæ•´è¡Œç»¿è‰²ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>åˆ é™¤è¡Œï¼ˆæ•´è¡Œçº¢è‰²ï¼‰</span>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-label">æ˜¾ç¤ºç­›é€‰ï¼š</div>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="filter" value="all" checked onchange="applyFilter()">
                        <span>å…¨éƒ¨è¡Œ</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="filter" value="diff" onchange="applyFilter()">
                        <span>ä»…å·®å¼‚è¡Œ</span>
                    </label>
                </div>

                <div class="filter-divider"></div>

                <div class="family-filter">
                    <div class="filter-label">Familyç­›é€‰ï¼š</div>
                    <select id="familyFilterSelect" class="family-filter-select" onchange="onFamilyFilterSelectChange()">
                        <option value="all">å…¨éƒ¨Family</option>
                        <option value="has">æœ‰Family</option>
                        <option value="no">æ— Family</option>
                        <option value="custom">æ‰‹åŠ¨è¾“å…¥...</option>
                    </select>

                    <div class="family-filter-input-wrapper" id="familyInputWrapper" style="display: none;">
                        <input
                            type="text"
                            id="familyFilterInput"
                            class="family-filter-input"
                            list="familyList"
                            placeholder="è¾“å…¥Familyå€¼ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰"
                            oninput="onFamilyInputChange()"
                            onkeydown="onFamilyInputKeyDown(event)"
                        >
                        <datalist id="familyList"></datalist>
                        <button class="clear-filter-btn" onclick="clearFamilyInput()" title="æ¸…é™¤ç­›é€‰">âœ•</button>
                    </div>
                </div>
            </div>

            <div class="summary">
                <h3>ç»Ÿè®¡æ‘˜è¦</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalFeatures">0</div>
                        <div class="stat-label">ç‰¹å¾å€¼æ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalModels">0</div>
                        <div class="stat-label">è½¦å‹æ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="diffCells">0</div>
                        <div class="stat-label">å·®å¼‚å•å…ƒæ ¼</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="addedModels">0</div>
                        <div class="stat-label">æ–°å¢è½¦å‹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="deletedModels">0</div>
                        <div class="stat-label">åˆ é™¤è½¦å‹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="familyCount">0</div>
                        <div class="stat-label">Familyæ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="familyCoverage">0%</div>
                        <div class="stat-label">Familyè¦†ç›–ç‡</div>
                    </div>
                </div>
            </div>

            <div class="table-wrapper" id="tableWrapper">
                <table id="resultTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºé€‰é¡¹å¼¹çª— -->
    <div class="export-overlay" id="exportOverlay" onclick="closeExportOptions()"></div>
    <div class="export-options" id="exportOptions">
        <h3>å¯¼å‡ºé€‰é¡¹</h3>
        <div class="export-option-item">
            <input type="checkbox" id="exportWithColors" checked>
            <label for="exportWithColors">ä¿ç•™é¢œè‰²æ ‡è®°ï¼ˆæ¨èï¼‰</label>
        </div>
        <div class="export-option-item">
            <input type="checkbox" id="exportFrozenColumns" checked>
            <label for="exportFrozenColumns">å†»ç»“å‰3åˆ—</label>
        </div>
        <div class="export-option-item">
            <input type="checkbox" id="exportAutoFilter">
            <label for="exportAutoFilter">å¯ç”¨è‡ªåŠ¨ç­›é€‰</label>
        </div>
        <div class="export-buttons-panel">
            <button class="export-confirm-btn" onclick="confirmExport()">ç¡®è®¤å¯¼å‡º</button>
            <button class="export-cancel-btn" onclick="closeExportOptions()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        let file1Workbook = null;
        let file2Workbook = null;
        let file3Workbook = null;
        let familyMap = new Map(); // ç‰¹å¾å€¼ -> Family æ˜ å°„
        let file1Name = '';
        let file2Name = '';
        let comparisonResult = null;
        let currentFilter = 'all';
        let currentFamilyFilter = 'all'; // V6: Familyç­›é€‰
        let customFamilyFilter = ''; // V7: æ‰‹åŠ¨è¾“å…¥çš„Familyå€¼

        const CONFIG_SHEET_NAME = 'äº§å“å·¥ç¨‹é…ç½®è¡¨';
        const HEADER_ROW = 3;
        const DATA_START_ROW = 5;
        const INPUT_FIXED_COLUMNS = 3; // åŸå§‹é…ç½®è¡¨çš„å›ºå®šåˆ—æ•°ï¼ˆç‰¹å¾å€¼ç¼–å·ã€ç‰¹å¾å€¼æè¿°ã€å¤‡æ³¨ï¼‰
        const OUTPUT_FIXED_COLUMNS = 4; // è¾“å‡ºç»“æœçš„å›ºå®šåˆ—æ•°ï¼ˆç‰¹å¾å€¼ç¼–å·ã€Familyã€ç‰¹å¾å€¼æè¿°ã€å¤‡æ³¨ï¼‰

        // V7: å€¼æ¯”è¾ƒå‡½æ•°ï¼Œå¤„ç†ç©ºæ ¼å’Œç±»å‹è½¬æ¢
        function compareValues(val1, val2) {
            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
            let str1 = String(val1 || '').trim();
            let str2 = String(val2 || '').trim();

            // V7ä¿®å¤: å°† "-" ä¹Ÿè§†ä¸ºç©ºå€¼
            if (str1 === '-') str1 = '';
            if (str2 === '-') str2 = '';

            // æ¯”è¾ƒå¤„ç†åçš„å€¼
            return str1 !== str2;
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload(inputId, boxId, infoId, workbookVar) {
            const input = document.getElementById(inputId);
            const box = document.getElementById(boxId);
            const info = document.getElementById(infoId);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file, infoId, workbookVar);
                }
            });

            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });

            box.addEventListener('dragleave', () => {
                box.classList.remove('dragover');
            });

            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    handleFile(file, infoId, workbookVar);
                } else {
                    showError('è¯·ä¸Šä¼ æœ‰æ•ˆçš„Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰');
                }
            });
        }

        function handleFile(file, infoId, workbookVar) {
            const info = document.getElementById(infoId);
            info.style.display = 'block';
            info.textContent = `å·²é€‰æ‹©: ${file.name}`;

            // ä¿å­˜æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
            const fileName = file.name.replace(/\.(xlsx|xls)$/i, '');
            if (workbookVar === 'file1Workbook') {
                file1Name = fileName;
            } else if (workbookVar === 'file2Workbook') {
                file2Name = fileName;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (workbookVar === 'file1Workbook') {
                        file1Workbook = workbook;
                    } else if (workbookVar === 'file2Workbook') {
                        file2Workbook = workbook;
                    } else if (workbookVar === 'file3Workbook') {
                        file3Workbook = workbook;
                        // è¯»å–Familyæ˜ å°„å…³ç³»
                        readFamilyMapping(workbook);
                        showSuccess('Familyæ˜ å°„è¡¨åŠ è½½æˆåŠŸï¼å…± ' + familyMap.size + ' æ¡æ˜ å°„å…³ç³»');
                    }

                    checkBothFilesLoaded();
                    hideError();
                } catch (error) {
                    showError('è¯»å–æ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // è¯»å–Familyæ˜ å°„è¡¨
        function readFamilyMapping(workbook) {
            try {
                familyMap.clear();

                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯ç‰¹å¾å€¼ä»£ç ï¼Œç¬¬äºŒåˆ—æ˜¯Family
                // ä»ç¬¬2è¡Œå¼€å§‹è¯»å–ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row[0]) {
                        const featureCode = String(row[0]).trim();
                        const family = row[1] ? String(row[1]).trim() : '';
                        if (featureCode) {
                            familyMap.set(featureCode, family);
                        }
                    }
                }

                console.log('Familyæ˜ å°„åŠ è½½å®Œæˆï¼Œå…±', familyMap.size, 'æ¡è®°å½•');
            } catch (error) {
                console.warn('è¯»å–Familyæ˜ å°„è¡¨å¤±è´¥:', error);
                showError('è¯»å–Familyæ˜ å°„è¡¨å¤±è´¥: ' + error.message);
            }
        }

        function checkBothFilesLoaded() {
            const compareBtn = document.getElementById('compareBtn');
            if (file1Workbook && file2Workbook) {
                compareBtn.disabled = false;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            document.getElementById('successMessage').classList.remove('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // è¯»å–é…ç½®è¡¨æ•°æ®
        function readConfigSheet(workbook) {
            const sheetName = workbook.SheetNames.includes(CONFIG_SHEET_NAME)
                ? CONFIG_SHEET_NAME
                : workbook.SheetNames[0];

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

            const headers = jsonData[HEADER_ROW] || [];

            // V7è°ƒè¯•: è¾“å‡ºè¡¨å¤´ä¿¡æ¯
            console.log(`\n========== è¯»å–é…ç½®è¡¨ ==========`);
            console.log(`å·¥ä½œè¡¨åç§°: ${sheetName}`);
            console.log(`ç¬¬${HEADER_ROW + 1}è¡Œè¡¨å¤´:`, headers);
            console.log(`å‰${INPUT_FIXED_COLUMNS}åˆ—å›ºå®šåˆ—:`, headers.slice(0, INPUT_FIXED_COLUMNS));
            console.log(`ä»ç¬¬${INPUT_FIXED_COLUMNS + 1}åˆ—å¼€å§‹çš„è½¦å‹:`, headers.slice(INPUT_FIXED_COLUMNS));

            const dataRows = jsonData.slice(DATA_START_ROW).filter(row => {
                return row[0] && String(row[0]).trim() !== '';
            });

            console.log(`ç¬¬${DATA_START_ROW + 1}è¡Œå¼€å§‹è¯»å–æ•°æ®ï¼Œå…±${dataRows.length}è¡Œ`);
            console.log(`================================\n`);

            const dataMap = new Map();
            dataRows.forEach(row => {
                const featureCode = String(row[0] || '').trim();
                if (featureCode) {
                    const rowData = {
                        featureCode: featureCode,
                        description: row[1] || '',
                        remark: row[2] || '',
                        models: {}
                    };

                    for (let i = INPUT_FIXED_COLUMNS; i < headers.length; i++) {
                        const modelName = headers[i] || `è½¦å‹${i - INPUT_FIXED_COLUMNS + 1}`;
                        rowData.models[modelName] = row[i] || '';
                    }

                    dataMap.set(featureCode, rowData);
                }
            });

            return {
                sheetName,
                headers,
                dataMap,
                totalFeatures: dataMap.size,
                totalModels: headers.length - INPUT_FIXED_COLUMNS
            };
        }

        // æ¯”å¯¹æ–‡ä»¶
        function compareFiles() {
            showLoading();

            setTimeout(() => {
                try {
                    if (!file1Workbook || !file2Workbook) {
                        throw new Error('è¯·å…ˆä¸Šä¼ ä¸¤ä¸ªExcelæ–‡ä»¶');
                    }

                    const file1Data = readConfigSheet(file1Workbook);
                    const file2Data = readConfigSheet(file2Workbook);

                    // V7è°ƒè¯•: è¾“å‡ºè¡¨å¤´ä¿¡æ¯
                    console.log('===== æ–‡ä»¶1è¡¨å¤´ä¿¡æ¯ =====');
                    console.log('å®Œæ•´è¡¨å¤´:', file1Data.headers);
                    console.log('è½¦å‹è¡¨å¤´:', file1Data.headers.slice(INPUT_FIXED_COLUMNS));

                    console.log('===== æ–‡ä»¶2è¡¨å¤´ä¿¡æ¯ =====');
                    console.log('å®Œæ•´è¡¨å¤´:', file2Data.headers);
                    console.log('è½¦å‹è¡¨å¤´:', file2Data.headers.slice(INPUT_FIXED_COLUMNS));

                    const models1 = new Set(file1Data.headers.slice(INPUT_FIXED_COLUMNS).filter(h => h));
                    const models2 = new Set(file2Data.headers.slice(INPUT_FIXED_COLUMNS).filter(h => h));

                    console.log('===== è½¦å‹é›†åˆ =====');
                    console.log('æ–‡ä»¶1è½¦å‹æ•°:', models1.size, 'è½¦å‹:', Array.from(models1));
                    console.log('æ–‡ä»¶2è½¦å‹æ•°:', models2.size, 'è½¦å‹:', Array.from(models2));

                    const addedModels = [...models2].filter(m => !models1.has(m));
                    const deletedModels = [...models1].filter(m => !models2.has(m));
                    const commonModels = [...models1].filter(m => models2.has(m));

                    const oldModels = file1Data.headers.slice(INPUT_FIXED_COLUMNS).filter(h => h);
                    const newModels = file2Data.headers.slice(INPUT_FIXED_COLUMNS).filter(h => h);

                    const allModelsSorted = [];
                    const usedDeletedModels = new Set();

                    newModels.forEach((newModel, newIndex) => {
                        if (newIndex < oldModels.length) {
                            const oldModelAtPosition = oldModels[newIndex];
                            if (oldModelAtPosition && deletedModels.includes(oldModelAtPosition) && !usedDeletedModels.has(oldModelAtPosition)) {
                                allModelsSorted.push(oldModelAtPosition);
                                usedDeletedModels.add(oldModelAtPosition);
                            }
                        }
                        allModelsSorted.push(newModel);
                    });

                    for (let i = newModels.length; i < oldModels.length; i++) {
                        const oldModel = oldModels[i];
                        if (deletedModels.includes(oldModel) && !usedDeletedModels.has(oldModel)) {
                            allModelsSorted.push(oldModel);
                            usedDeletedModels.add(oldModel);
                        }
                    }

                    const allFeatures = new Set([
                        ...file1Data.dataMap.keys(),
                        ...file2Data.dataMap.keys()
                    ]);

                    comparisonResult = {
                        headers: [
                            file2Data.headers[0], // ç‰¹å¾å€¼ç¼–å·
                            'Family', // V5: Familyåˆ—æ”¾åœ¨ç¬¬2åˆ—
                            file2Data.headers[1], // ç‰¹å¾å€¼æè¿°
                            file2Data.headers[2], // å¤‡æ³¨
                            ...allModelsSorted // è½¦å‹åˆ—
                        ],
                        fixedColumns: OUTPUT_FIXED_COLUMNS,
                        addedModels,
                        deletedModels,
                        commonModels,
                        diffCells: [],
                        rows: [],
                        // V8: æ‰“ç‚¹å˜åŒ–ç»Ÿè®¡
                        dotChanges: {},
                        stats: {
                            totalFeatures: allFeatures.size,
                            totalModels: Math.max(file1Data.totalModels, file2Data.totalModels),
                            diffCells: 0,
                            addedModels: addedModels.length,
                            deletedModels: deletedModels.length,
                            diffRows: 0,
                            addedRows: 0,
                            deletedRows: 0
                        }
                    };

                    // V8: åˆå§‹åŒ–æ¯ä¸ªè½¦å‹çš„æ‰“ç‚¹å˜åŒ–ç»Ÿè®¡
                    allModelsSorted.forEach(model => {
                        comparisonResult.dotChanges[model] = {
                            added: [],    // å¢åŠ çš„æ‰“ç‚¹ï¼ˆç‰¹å¾å€¼åˆ—è¡¨ï¼‰
                            removed: []   // å–æ¶ˆçš„æ‰“ç‚¹ï¼ˆç‰¹å¾å€¼åˆ—è¡¨ï¼‰
                        };
                    });

                    allFeatures.forEach(featureCode => {
                        const row1 = file1Data.dataMap.get(featureCode);
                        const row2 = file2Data.dataMap.get(featureCode);

                        let rowStatus = 'unchanged';
                        if (!row1 && row2) {
                            rowStatus = 'added';
                            comparisonResult.stats.addedRows++;
                        } else if (row1 && !row2) {
                            rowStatus = 'deleted';
                            comparisonResult.stats.deletedRows++;
                        }

                        const resultRow = {
                            featureCode: featureCode,
                            description: row2 ? row2.description : (row1 ? row1.description : ''),
                            remark: row2 ? row2.remark : (row1 ? row1.remark : ''),
                            family: familyMap.get(featureCode) || '', // V5: æ·»åŠ Familyå­—æ®µ
                            cells: {},
                            diffs: [],
                            hasDiff: false,
                            hasRealDataDiff: false,
                            rowStatus: rowStatus
                        };

                        // V7ä¿®å¤: ä½¿ç”¨å»é‡çš„è½¦å‹åˆ—è¡¨ï¼Œé¿å…é‡å¤æ¯”å¯¹
                        const allModels = [...new Set([...models1, ...models2])];

                        allModels.forEach(model => {
                            const val1 = row1 ? (row1.models[model] || '') : '';
                            const val2 = row2 ? (row2.models[model] || '') : '';

                            // V7ä¿®å¤: ä½¿ç”¨æ”¹è¿›çš„æ¯”è¾ƒå‡½æ•°
                            const isDiff = compareValues(val1, val2);

                            // V9: æ£€æŸ¥æ‰“ç‚¹å˜åŒ–ï¼ˆä»â—åˆ°éâ—ï¼Œæˆ–ä»éâ—åˆ°â—ï¼‰
                            // åªç»Ÿè®¡æœ‰Familyçš„ç‰¹å¾å€¼
                            const featureFamily = familyMap.get(featureCode);
                            const hasFamily = featureFamily && featureFamily.trim() !== '';

                            if (hasFamily) {
                                const cleanVal1 = String(val1 || '').trim();
                                const cleanVal2 = String(val2 || '').trim();
                                const isDot1 = cleanVal1 === 'â—';
                                const isDot2 = cleanVal2 === 'â—';

                                // V9: ä½¿ç”¨"ç‰¹å¾å€¼ä»£ç : æè¿°"æ ¼å¼
                                const featureDesc = resultRow.description || '';
                                const featureLabel = featureDesc
                                    ? `${featureCode}: ${featureDesc}`
                                    : featureCode;

                                // ä»éâ—å˜ä¸ºâ—ï¼šå¢åŠ æ‰“ç‚¹
                                if (!isDot1 && isDot2) {
                                    if (comparisonResult.dotChanges[model]) {
                                        comparisonResult.dotChanges[model].added.push(featureLabel);
                                    }
                                }
                                // ä»â—å˜ä¸ºéâ—ï¼šå–æ¶ˆæ‰“ç‚¹
                                else if (isDot1 && !isDot2) {
                                    if (comparisonResult.dotChanges[model]) {
                                        comparisonResult.dotChanges[model].removed.push(featureLabel);
                                    }
                                }
                            }

                            // V7è°ƒè¯•: æ‰“å°æ¯”å¯¹è¯¦æƒ…ï¼ˆä»…åœ¨çœŸæ­£æœ‰å·®å¼‚æ—¶ï¼‰
                            if (isDiff && (val1 || val2)) {
                                const str1 = String(val1 || '').trim();
                                const str2 = String(val2 || '').trim();
                                console.log(`å·®å¼‚å‘ç° - ç‰¹å¾å€¼: ${featureCode}, è½¦å‹: ${model}`);
                                console.log(`  æ—§å€¼: "${str1}" (é•¿åº¦: ${str1.length})`);
                                console.log(`  æ–°å€¼: "${str2}" (é•¿åº¦: ${str2.length})`);
                            }

                            resultRow.cells[model] = {
                                old: val1,
                                new: val2,
                                isDiff: isDiff
                            };

                            if (isDiff) {
                                resultRow.diffs.push(model);
                                comparisonResult.stats.diffCells++;
                                resultRow.hasDiff = true;

                                const isAddedOrDeletedModel = comparisonResult.addedModels.includes(model) || comparisonResult.deletedModels.includes(model);
                                if (!isAddedOrDeletedModel) {
                                    resultRow.hasRealDataDiff = true;
                                }

                                if (rowStatus === 'unchanged') {
                                    rowStatus = 'modified';
                                    resultRow.rowStatus = rowStatus;
                                }
                            }
                        });

                        if (resultRow.hasDiff) {
                            comparisonResult.stats.diffRows++;
                        }

                        comparisonResult.rows.push(resultRow);
                    });

                    // V6: å¡«å……Familyä¸‹æ‹‰åˆ—è¡¨
                    populateFamilyFilter();

                    displayResult();
                    hideLoading();
                    showSuccess('æ¯”å¯¹å®Œæˆï¼å…±å‘ç° ' + comparisonResult.stats.diffCells + ' ä¸ªå·®å¼‚å•å…ƒæ ¼');
                } catch (error) {
                    hideLoading();
                    showError('æ¯”å¯¹å¤±è´¥: ' + error.message);
                }
            }, 100);
        }

        // V6: å¡«å……Familyç­›é€‰ä¸‹æ‹‰åˆ—è¡¨
        function populateFamilyFilter() {
            const select = document.getElementById('familyFilterSelect');
            const datalist = document.getElementById('familyList');

            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„Familyå€¼
            const families = new Set();
            comparisonResult.rows.forEach(row => {
                if (row.family && row.family.trim() !== '') {
                    families.add(row.family.trim());
                }
            });

            // V7: æ¸…ç©ºå¹¶å¡«å……selectä¸‹æ‹‰åˆ—è¡¨ï¼ˆä¿ç•™å‰4ä¸ªé»˜è®¤é€‰é¡¹ï¼‰
            select.innerHTML = `
                <option value="all">å…¨éƒ¨Family</option>
                <option value="has">æœ‰Family</option>
                <option value="no">æ— Family</option>
                <option value="custom">æ‰‹åŠ¨è¾“å…¥...</option>
            `;

            // æŒ‰å­—æ¯é¡ºåºæ’åºå¹¶æ·»åŠ Familyé€‰é¡¹åˆ°selectï¼ˆé™åˆ¶æ•°é‡é¿å…åˆ—è¡¨è¿‡é•¿ï¼‰
            const sortedFamilies = Array.from(families).sort();
            sortedFamilies.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                select.appendChild(option);
            });

            // V7: å¡«å……datalistç”¨äºæ‰‹åŠ¨è¾“å…¥æ—¶çš„è‡ªåŠ¨è¡¥å…¨
            datalist.innerHTML = '';
            sortedFamilies.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                datalist.appendChild(option);
            });

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            const totalWithFamily = comparisonResult.rows.filter(row => row.family && row.family.trim() !== '').length;
            const totalWithoutFamily = comparisonResult.rows.length - totalWithFamily;

            console.log(`Familyç»Ÿè®¡: å…±${families.size}ä¸ªä¸åŒçš„Familyå€¼ï¼Œ${totalWithFamily}è¡Œæœ‰Familyï¼Œ${totalWithoutFamily}è¡Œæ— Family`);
        }

        // V7: Familyç­›é€‰ä¸‹æ‹‰æ¡†å˜åŒ–å¤„ç†
        function onFamilyFilterSelectChange() {
            const select = document.getElementById('familyFilterSelect');
            const inputWrapper = document.getElementById('familyInputWrapper');
            const value = select.value;

            if (value === 'custom') {
                // æ˜¾ç¤ºè¾“å…¥æ¡†
                inputWrapper.style.display = 'flex';
                document.getElementById('familyFilterInput').focus();
            } else {
                // éšè—è¾“å…¥æ¡†
                inputWrapper.style.display = 'none';
                document.getElementById('familyFilterInput').value = '';
                customFamilyFilter = '';
            }

            applyFilter();
        }

        // V7: Familyè¾“å…¥æ¡†å˜åŒ–å¤„ç†
        function onFamilyInputChange() {
            const input = document.getElementById('familyFilterInput');
            customFamilyFilter = input.value.trim();

            // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è§¦å‘ç­›é€‰
            if (window.familyFilterTimeout) {
                clearTimeout(window.familyFilterTimeout);
            }
            window.familyFilterTimeout = setTimeout(() => {
                applyFilter();
            }, 300);
        }

        // V7: Familyè¾“å…¥æ¡†æŒ‰é”®å¤„ç†
        function onFamilyInputKeyDown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (window.familyFilterTimeout) {
                    clearTimeout(window.familyFilterTimeout);
                }
                applyFilter();
            } else if (event.key === 'Escape') {
                clearFamilyInput();
            }
        }

        // V7: æ¸…é™¤Familyè¾“å…¥
        function clearFamilyInput() {
            document.getElementById('familyFilterInput').value = '';
            customFamilyFilter = '';
            applyFilter();
        }

        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const filterOptions = document.getElementsByName('filter');
            for (const option of filterOptions) {
                if (option.checked) {
                    currentFilter = option.value;
                    break;
                }
            }

            // V6: è·å–Familyç­›é€‰å€¼
            currentFamilyFilter = document.getElementById('familyFilterSelect').value;

            displayResult();
        }

        // è·å–ç­›é€‰åçš„è¡Œæ•°æ®
        function getFilteredRows() {
            let rows = comparisonResult.rows;

            // åº”ç”¨å·®å¼‚ç­›é€‰
            if (currentFilter === 'diff') {
                rows = rows.filter(row => row.hasDiff);
            }

            // V6: åº”ç”¨Familyç­›é€‰
            if (currentFamilyFilter === 'has') {
                rows = rows.filter(row => row.family && row.family.trim() !== '');
            } else if (currentFamilyFilter === 'no') {
                rows = rows.filter(row => !row.family || row.family.trim() === '');
            } else if (currentFamilyFilter !== 'all' && currentFamilyFilter !== '') {
                // V7: æ”¯æŒæ‰‹åŠ¨è¾“å…¥å’Œæ¨¡ç³ŠåŒ¹é…
                if (currentFamilyFilter === 'custom' && customFamilyFilter) {
                    // æ¨¡ç³ŠåŒ¹é…ï¼šåŒ…å«è¾“å…¥çš„æ–‡æœ¬å³å¯
                    const searchTerm = customFamilyFilter.toLowerCase();
                    rows = rows.filter(row => {
                        if (!row.family) return false;
                        return row.family.toLowerCase().includes(searchTerm);
                    });
                } else {
                    // ç²¾ç¡®åŒ¹é…ç‰¹å®šçš„Familyå€¼
                    rows = rows.filter(row => row.family === currentFamilyFilter);
                }
            }

            return rows;
        }

        function displayResult() {
            const resultSection = document.getElementById('resultSection');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            const fixedHeaders = comparisonResult.headers.slice(0, OUTPUT_FIXED_COLUMNS);
            const modelHeaders = comparisonResult.headers.slice(OUTPUT_FIXED_COLUMNS);

            // ç¬¬1è¡Œè¡¨å¤´
            const tr1 = document.createElement('tr');
            fixedHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';
                th.className = 'fixed-column';
                tr1.appendChild(th);
            });
            modelHeaders.forEach((_, index) => {
                const th = document.createElement('th');
                th.textContent = index + 1;
                tr1.appendChild(th);
            });
            tableHeader.appendChild(tr1);

            // ç¬¬2è¡Œè¡¨å¤´
            const tr2 = document.createElement('tr');
            fixedHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';
                th.className = 'fixed-column';
                tr2.appendChild(th);
            });
            modelHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';

                if (comparisonResult.deletedModels.includes(header)) {
                    th.className = 'header-red';
                } else if (comparisonResult.addedModels.includes(header)) {
                    th.className = 'header-green';
                }

                tr2.appendChild(th);
            });
            tableHeader.appendChild(tr2);

            const filteredRows = getFilteredRows();

            filteredRows.forEach(row => {
                const tr = document.createElement('tr');

                if (row.rowStatus === 'added') {
                    tr.className = 'row-added';
                } else if (row.rowStatus === 'deleted') {
                    tr.className = 'row-deleted';
                }

                const fixedCells = [
                    row.featureCode,
                    row.family || '', // Familyæ”¾åœ¨ç¬¬2åˆ—
                    row.description,
                    row.remark
                ];

                fixedCells.forEach((cellValue, index) => {
                    const td = document.createElement('td');
                    td.textContent = cellValue || '';
                    if (index === 0) {
                        if (row.rowStatus === 'added') {
                            td.className = 'fixed-column fixed-column-green';
                        } else if (row.rowStatus === 'deleted') {
                            td.className = 'fixed-column fixed-column-red';
                        } else if (row.hasRealDataDiff) {
                            td.className = 'fixed-column fixed-column-yellow';
                        } else {
                            td.className = 'fixed-column';
                        }
                    } else {
                        td.className = 'fixed-column';
                    }
                    tr.appendChild(td);
                });

                modelHeaders.forEach(model => {
                    const td = document.createElement('td');
                    const cell = row.cells[model];

                    if (cell) {
                        // V3ï¼šåˆ é™¤çš„è½¦å‹åˆ—æ˜¾ç¤ºæ—§å€¼ï¼Œå…¶ä»–æ˜¾ç¤ºæ–°å€¼
                        const isDeletedModel = comparisonResult.deletedModels.includes(model);
                        td.textContent = isDeletedModel ? cell.old : cell.new;

                        if (comparisonResult.addedModels.includes(model)) {
                            td.className = 'cell-green';
                        } else if (isDeletedModel) {
                            td.className = 'cell-red';
                        } else if (row.rowStatus === 'added') {
                            td.className = 'row-added';
                        } else if (row.rowStatus === 'deleted') {
                            td.className = 'row-deleted';
                        } else if (cell.isDiff) {
                            td.className = 'cell-yellow';
                        }
                    } else {
                        td.textContent = '';
                        if (comparisonResult.addedModels.includes(model)) {
                            td.className = 'cell-green';
                        } else if (comparisonResult.deletedModels.includes(model)) {
                            td.className = 'cell-red';
                        } else if (row.rowStatus === 'added') {
                            td.className = 'row-added';
                        } else if (row.rowStatus === 'deleted') {
                            td.className = 'row-deleted';
                        }
                    }

                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });

            document.getElementById('totalFeatures').textContent = filteredRows.length;
            document.getElementById('totalModels').textContent = comparisonResult.stats.totalModels;
            document.getElementById('diffCells').textContent = comparisonResult.stats.diffCells;
            document.getElementById('addedModels').textContent = comparisonResult.stats.addedModels;
            document.getElementById('deletedModels').textContent = comparisonResult.stats.deletedModels;

            // V6: æ›´æ–°Familyç»Ÿè®¡
            const allFamilies = new Set();
            const totalWithFamily = comparisonResult.rows.filter(row => {
                if (row.family && row.family.trim() !== '') {
                    allFamilies.add(row.family.trim());
                    return true;
                }
                return false;
            }).length;

            document.getElementById('familyCount').textContent = allFamilies.size;
            const coverage = comparisonResult.rows.length > 0
                ? ((totalWithFamily / comparisonResult.rows.length) * 100).toFixed(1)
                : '0.0';
            document.getElementById('familyCoverage').textContent = coverage + '%';

            // V8: æ·»åŠ æ‰“ç‚¹å˜åŒ–æ±‡æ€»è¡Œï¼ˆä¸¤è¡Œï¼šå¢åŠ è¡Œå’Œå‡å°‘è¡Œï¼‰
            if (comparisonResult.dotChanges && Object.keys(comparisonResult.dotChanges).length > 0) {
                // ç¬¬ä¸€è¡Œï¼šå¢åŠ çš„æ‰“ç‚¹
                const addSummaryRow = document.createElement('tr');
                addSummaryRow.className = 'dot-summary-row';

                // å›ºå®šåˆ—ï¼šæ˜¾ç¤º"å¢åŠ æ‰“ç‚¹"
                fixedHeaders.forEach((header, index) => {
                    const td = document.createElement('td');
                    td.className = 'fixed-column';

                    if (index === 0) {
                        td.textContent = 'å¢åŠ æ‰“ç‚¹â—';
                        td.style.fontWeight = 'bold';
                        td.style.fontSize = '14px';
                        td.style.color = '#2E7D32';
                    } else {
                        td.textContent = '';
                    }

                    addSummaryRow.appendChild(td);
                });

                // è½¦å‹åˆ—ï¼šæ˜¾ç¤ºæ¯ä¸ªè½¦å‹å¢åŠ çš„æ‰“ç‚¹
                modelHeaders.forEach(model => {
                    const td = document.createElement('td');
                    const changes = comparisonResult.dotChanges[model] || { added: [], removed: [] };

                    if (changes.added.length > 0) {
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'dot-summary-content';

                        const addDiv = document.createElement('div');
                        addDiv.innerHTML = `<span class="dot-add">+${changes.added.length}</span>: ` +
                            changes.added.map(code =>
                                `<span class="dot-item">${code}</span>`
                            ).join('');
                        contentDiv.appendChild(addDiv);

                        td.appendChild(contentDiv);
                    } else {
                        td.textContent = '-';
                        td.style.color = '#999';
                        td.style.fontSize = '14px';
                    }

                    addSummaryRow.appendChild(td);
                });

                tableBody.appendChild(addSummaryRow);

                // ç¬¬äºŒè¡Œï¼šå‡å°‘çš„æ‰“ç‚¹
                const removeSummaryRow = document.createElement('tr');
                removeSummaryRow.className = 'dot-summary-row';

                // å›ºå®šåˆ—ï¼šæ˜¾ç¤º"å–æ¶ˆæ‰“ç‚¹"
                fixedHeaders.forEach((header, index) => {
                    const td = document.createElement('td');
                    td.className = 'fixed-column';

                    if (index === 0) {
                        td.textContent = 'å–æ¶ˆæ‰“ç‚¹â—';
                        td.style.fontWeight = 'bold';
                        td.style.fontSize = '14px';
                        td.style.color = '#C62828';
                    } else {
                        td.textContent = '';
                    }

                    removeSummaryRow.appendChild(td);
                });

                // è½¦å‹åˆ—ï¼šæ˜¾ç¤ºæ¯ä¸ªè½¦å‹å–æ¶ˆçš„æ‰“ç‚¹
                modelHeaders.forEach(model => {
                    const td = document.createElement('td');
                    const changes = comparisonResult.dotChanges[model] || { added: [], removed: [] };

                    if (changes.removed.length > 0) {
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'dot-summary-content';

                        const removeDiv = document.createElement('div');
                        removeDiv.innerHTML = `<span class="dot-remove">-${changes.removed.length}</span>: ` +
                            changes.removed.map(code =>
                                `<span class="dot-item">${code}</span>`
                            ).join('');
                        contentDiv.appendChild(removeDiv);

                        td.appendChild(contentDiv);
                    } else {
                        td.textContent = '-';
                        td.style.color = '#999';
                        td.style.fontSize = '14px';
                    }

                    removeSummaryRow.appendChild(td);
                });

                tableBody.appendChild(removeSummaryRow);
            }

            resultSection.classList.add('active');
        }

        // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
        function showExportOptions() {
            if (!comparisonResult) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }
            document.getElementById('exportOverlay').classList.add('active');
            document.getElementById('exportOptions').classList.add('active');
        }

        // å…³é—­å¯¼å‡ºé€‰é¡¹
        function closeExportOptions() {
            document.getElementById('exportOverlay').classList.remove('active');
            document.getElementById('exportOptions').classList.remove('active');
        }

        // ç¡®è®¤å¯¼å‡º
        function confirmExport() {
            const withColors = document.getElementById('exportWithColors').checked;
            const frozenColumns = document.getElementById('exportFrozenColumns').checked;
            const autoFilter = document.getElementById('exportAutoFilter').checked;

            exportResult(withColors, frozenColumns, autoFilter);
            closeExportOptions();
        }

        // å¯¼å‡ºExcelï¼ˆV2å¢å¼ºç‰ˆ - å®Œæ•´ä¿ç•™é¢œè‰²ï¼‰
        function exportResult(withColors = true, frozenColumns = true, autoFilter = false) {
            if (!comparisonResult) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }

            try {
                const workbook = XLSX.utils.book_new();
                const exportData = [];

                const filteredRows = getFilteredRows();

                // ç¬¬1è¡Œï¼šè½¦å‹åºå·
                const row1 = ['ç‰¹å¾å€¼ç¼–å·', '', 'ç‰¹å¾å€¼æè¿°', 'å¤‡æ³¨']; // V5: Familyåˆ—ç¬¬2è¡Œä¸ºç©º
                const modelHeaders = comparisonResult.headers.slice(OUTPUT_FIXED_COLUMNS);
                modelHeaders.forEach((_, index) => {
                    row1.push(index + 1);
                });
                exportData.push(row1);

                // ç¬¬2è¡Œï¼šè½¦å‹åç§°
                exportData.push(comparisonResult.headers);

                // æ•°æ®è¡Œ
                filteredRows.forEach(row => {
                    const dataRow = [
                        row.featureCode,
                        row.family || '', // Familyæ”¾åœ¨ç¬¬2åˆ—
                        row.description,
                        row.remark
                    ];

                    modelHeaders.forEach(model => {
                        const cell = row.cells[model];
                        // V3ï¼šåˆ é™¤çš„è½¦å‹åˆ—å¯¼å‡ºæ—§å€¼ï¼Œå…¶ä»–å¯¼å‡ºæ–°å€¼
                        const isDeletedModel = comparisonResult.deletedModels.includes(model);
                        dataRow.push(cell ? (isDeletedModel ? cell.old : cell.new) : '');
                    });

                    exportData.push(dataRow);
                });

                // V8: æ·»åŠ æ‰“ç‚¹å˜åŒ–æ±‡æ€»è¡Œ
                if (comparisonResult.dotChanges && Object.keys(comparisonResult.dotChanges).length > 0) {
                    // ç¬¬ä¸€è¡Œï¼šå¢åŠ çš„æ‰“ç‚¹
                    const addSummaryRow = [
                        'å¢åŠ æ‰“ç‚¹â—',
                        '',
                        '',
                        ''
                    ];

                    modelHeaders.forEach(model => {
                        const changes = comparisonResult.dotChanges[model] || { added: [], removed: [] };
                        if (changes.added.length > 0) {
                            addSummaryRow.push(`+${changes.added.length}: ${changes.added.join(', ')}`);
                        } else {
                            addSummaryRow.push('-');
                        }
                    });

                    exportData.push(addSummaryRow);

                    // ç¬¬äºŒè¡Œï¼šå–æ¶ˆçš„æ‰“ç‚¹
                    const removeSummaryRow = [
                        'å–æ¶ˆæ‰“ç‚¹â—',
                        '',
                        '',
                        ''
                    ];

                    modelHeaders.forEach(model => {
                        const changes = comparisonResult.dotChanges[model] || { added: [], removed: [] };
                        if (changes.removed.length > 0) {
                            removeSummaryRow.push(`-${changes.removed.length}: ${changes.removed.join(', ')}`);
                        } else {
                            removeSummaryRow.push('-');
                        }
                    });

                    exportData.push(removeSummaryRow);
                }

                // åˆ›å»ºå·¥ä½œè¡¨
                const worksheet = XLSX.utils.aoa_to_sheet(exportData);

                // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ ·å¼å¯¼å‡º
                const supportsStyles = typeof XLSX !== 'undefined' && XLSX.write && withColors;

                if (supportsStyles) {
                    // è®¾ç½®å•å…ƒæ ¼æ ·å¼
                    const range = XLSX.utils.decode_range(worksheet['!ref']);

                    // å®šä¹‰é¢œè‰²
                    const YELLOW = "FFF9A825";
                    const RED = "FFE57373";
                    const GREEN = "FF66BB6A";
                    const RED_HEADER = "FFE53935";
                    const GREEN_HEADER = "FF43A047";
                    const BLUE_HEADER = "FF1565C0";
                    const BLUE_HEADER_DARK = "FF0D47A1";
                    const WHITE = "FFFFFFFF";
                    const BLACK = "FF000000";

                    // å¤„ç†å‰2è¡Œè¡¨å¤´
                    for (let R = 0; R < 2; R++) {
                        // å›ºå®šåˆ—è¡¨å¤´é¢œè‰²
                        for (let C = 0; C < OUTPUT_FIXED_COLUMNS; C++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            const cell = worksheet[cellAddress];
                            if (cell) {
                                cell.s = {
                                    fill: { patternType: "solid", fgColor: { rgb: BLUE_HEADER_DARK } },
                                    font: { color: { rgb: WHITE }, bold: true },
                                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                                    border: {
                                        top: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        bottom: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        left: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        right: { style: "thin", color: { rgb: "FFCCCCCC" } }
                                    }
                                };
                            }
                        }

                        // è½¦å‹åˆ—è¡¨å¤´é¢œè‰²
                        for (let C = OUTPUT_FIXED_COLUMNS; C <= range.e.c; C++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            const cell = worksheet[cellAddress];
                            if (cell) {
                                let fillColor = BLUE_HEADER;
                                if (R === 1) {
                                    const headerName = comparisonResult.headers[C];
                                    if (comparisonResult.deletedModels.includes(headerName)) {
                                        fillColor = RED_HEADER;
                                    } else if (comparisonResult.addedModels.includes(headerName)) {
                                        fillColor = GREEN_HEADER;
                                    }
                                }

                                cell.s = {
                                    fill: { patternType: "solid", fgColor: { rgb: fillColor } },
                                    font: { color: { rgb: WHITE }, bold: true },
                                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                                    border: {
                                        top: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        bottom: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        left: { style: "thin", color: { rgb: "FFCCCCCC" } },
                                        right: { style: "thin", color: { rgb: "FFCCCCCC" } }
                                    }
                                };
                            }
                        }
                    }

                    // å¤„ç†æ•°æ®è¡Œ
                    for (let R = 2; R <= range.e.r; R++) {
                        const rowData = filteredRows[R - 2];
                        if (!rowData) continue;

                        let rowColor = null;
                        if (rowData.rowStatus === 'added') {
                            rowColor = GREEN;
                        } else if (rowData.rowStatus === 'deleted') {
                            rowColor = RED;
                        }

                        for (let C = 0; C <= range.e.c; C++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            const worksheetCell = worksheet[cellAddress];

                            if (!worksheetCell) continue;

                            const cellStyle = {
                                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                                border: {
                                    top: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                    bottom: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                    left: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                    right: { style: "thin", color: { rgb: "FFE0E0E0" } }
                                }
                            };

                            // ä¼˜å…ˆçº§1ï¼šæ–°å¢/åˆ é™¤çš„è½¦å‹åˆ—
                            if (C >= OUTPUT_FIXED_COLUMNS) {
                                const headerName = comparisonResult.headers[C];
                                if (comparisonResult.addedModels.includes(headerName)) {
                                    cellStyle.fill = { patternType: "solid", fgColor: { rgb: GREEN } };
                                    cellStyle.font = { color: { rgb: BLACK } };
                                    worksheetCell.s = cellStyle;
                                    continue;
                                } else if (comparisonResult.deletedModels.includes(headerName)) {
                                    cellStyle.fill = { patternType: "solid", fgColor: { rgb: RED } };
                                    cellStyle.font = { color: { rgb: BLACK } };
                                    worksheetCell.s = cellStyle;
                                    continue;
                                }
                            }

                            // ä¼˜å…ˆçº§2ï¼šæ–°å¢è¡Œæˆ–åˆ é™¤è¡Œçš„æ•´è¡Œé¢œè‰²
                            if (rowColor) {
                                cellStyle.fill = { patternType: "solid", fgColor: { rgb: rowColor } };
                                cellStyle.font = { color: { rgb: BLACK } };
                                worksheetCell.s = cellStyle;
                                continue;
                            }

                            // ä¼˜å…ˆçº§3ï¼šç¬¬ä¸€åˆ—ç‰¹å¾å€¼ä»£ç  - æ ‡è®°é»„è‰²
                            if (C === 0 && rowData.hasRealDataDiff) {
                                cellStyle.fill = { patternType: "solid", fgColor: { rgb: YELLOW } };
                                cellStyle.font = { bold: true, color: { rgb: BLACK } };
                                worksheetCell.s = cellStyle;
                                continue;
                            }

                            // ä¼˜å…ˆçº§4ï¼šè½¦å‹åˆ—çš„å·®å¼‚å•å…ƒæ ¼
                            if (C >= OUTPUT_FIXED_COLUMNS) {
                                const headerName = comparisonResult.headers[C];
                                if (rowData.cells[headerName]) {
                                    const cell = rowData.cells[headerName];
                                    if (cell.isDiff) {
                                        cellStyle.fill = { patternType: "solid", fgColor: { rgb: YELLOW } };
                                        cellStyle.font = { bold: true, color: { rgb: BLACK } };
                                        worksheetCell.s = cellStyle;
                                        continue;
                                    }
                                }
                            }

                            // é»˜è®¤æ ·å¼
                            cellStyle.font = { color: { rgb: BLACK } };
                            worksheetCell.s = cellStyle;
                        }
                    }

                    // V8: å¤„ç†æ±‡æ€»è¡Œæ ·å¼
                    if (comparisonResult.dotChanges && Object.keys(comparisonResult.dotChanges).length > 0) {
                        // æ±‡æ€»è¡Œç´¢å¼•
                        const addSummaryRowIndex = filteredRows.length + 2;
                        const removeSummaryRowIndex = filteredRows.length + 3;

                        // å¤„ç†å¢åŠ æ‰“ç‚¹æ±‡æ€»è¡Œ
                        if (addSummaryRowIndex <= range.e.r) {
                            for (let C = 0; C <= range.e.c; C++) {
                                const cellAddress = XLSX.utils.encode_cell({ r: addSummaryRowIndex, c: C });
                                const worksheetCell = worksheet[cellAddress];
                                if (worksheetCell) {
                                    worksheetCell.s = {
                                        fill: { patternType: "solid", fgColor: { rgb: "FFC8E6C9" } }, // æµ…ç»¿è‰²
                                        font: { bold: true, color: { rgb: "FF1B5E20" } },
                                        alignment: { horizontal: "left", vertical: "center", wrapText: true },
                                        border: {
                                            top: { style: "medium", color: { rgb: "FF1B5E20" } },
                                            bottom: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                            left: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                            right: { style: "thin", color: { rgb: "FFE0E0E0" } }
                                        }
                                    };
                                }
                            }
                        }

                        // å¤„ç†å–æ¶ˆæ‰“ç‚¹æ±‡æ€»è¡Œ
                        if (removeSummaryRowIndex <= range.e.r) {
                            for (let C = 0; C <= range.e.c; C++) {
                                const cellAddress = XLSX.utils.encode_cell({ r: removeSummaryRowIndex, c: C });
                                const worksheetCell = worksheet[cellAddress];
                                if (worksheetCell) {
                                    worksheetCell.s = {
                                        fill: { patternType: "solid", fgColor: { rgb: "FFFFCDD2" } }, // æµ…çº¢è‰²
                                        font: { bold: true, color: { rgb: "FFB71C1C" } },
                                        alignment: { horizontal: "left", vertical: "center", wrapText: true },
                                        border: {
                                            top: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                            bottom: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                            left: { style: "thin", color: { rgb: "FFE0E0E0" } },
                                            right: { style: "thin", color: { rgb: "FFE0E0E0" } }
                                        }
                                    };
                                }
                            }
                        }
                    }
                }

                // è®¾ç½®åˆ—å®½
                const colWidths = comparisonResult.headers.map((h, i) => {
                    if (i === 0) return { wch: 8 }; // ç‰¹å¾å€¼ä»£ç 
                    if (i === 1) return { wch: 18 }; // Familyåˆ—
                    if (i === 2) return { wch: 40 }; // ç‰¹å¾å€¼æè¿°
                    if (i === 3) return { wch: 15 }; // å¤‡æ³¨
                    return { wch: 20 }; // è½¦å‹åˆ—
                });
                worksheet['!cols'] = colWidths;

                // è®¾ç½®å†»ç»“
                if (frozenColumns) {
                    worksheet['!freeze'] = { xSplit: OUTPUT_FIXED_COLUMNS, ySplit: 2, topLeftCell: 'E3' }; // V5: å†»ç»“å‰4åˆ—
                }

                // è®¾ç½®è‡ªåŠ¨ç­›é€‰
                if (autoFilter) {
                    worksheet['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(worksheet['!ref'])) };
                }

                XLSX.utils.book_append_sheet(workbook, worksheet, 'é…ç½®è¡¨');

                // å¯¼å‡ºæ–‡ä»¶
                const suffix = currentFilter === 'diff' ? '_ä»…å·®å¼‚è¡Œ' : '';
                const styleSuffix = withColors ? '_å¸¦é¢œè‰²' : '';

                // ç”Ÿæˆæ–‡ä»¶åï¼šæ—§ç‰ˆæœ¬_vs_æ–°ç‰ˆæœ¬
                let exportFileName = '';
                if (file1Name && file2Name) {
                    exportFileName = `${file1Name}_vs_${file2Name}${suffix}${styleSuffix}.xlsx`;
                } else {
                    // å¦‚æœæ²¡æœ‰æ–‡ä»¶åï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
                    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    exportFileName = `é…ç½®è¡¨å·®å¼‚V9_${date}${suffix}${styleSuffix}.xlsx`;
                }

                XLSX.writeFile(workbook, exportFileName);

                const colorMsg = withColors ? 'ï¼ˆä¿ç•™é¢œè‰²æ ‡è®°ï¼‰' : 'ï¼ˆåŸºæœ¬æ ¼å¼ï¼‰';
                showSuccess('å¯¼å‡ºæˆåŠŸï¼å…±å¯¼å‡º ' + filteredRows.length + ' è¡Œæ•°æ® ' + colorMsg);
            } catch (error) {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
                console.error(error);
            }
        }

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        setupFileUpload('fileInput1', 'uploadBox1', 'fileInfo1', 'file1Workbook');
        setupFileUpload('fileInput2', 'uploadBox2', 'fileInfo2', 'file2Workbook');
        setupFileUpload('fileInput3', 'uploadBox3', 'fileInfo3', 'file3Workbook');
    </script>
</body>
</html>
