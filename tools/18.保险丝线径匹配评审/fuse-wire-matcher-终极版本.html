<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿é™©ä¸ä¸çº¿å¾„åŒ¹é…æ¸…å•ç”Ÿæˆå·¥å…· v4.2 (ç›´æ¥è¿æ¥ç‰ˆ - å»é™¤ç„Šç‚¹å’ŒInline)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e0f;
            --bg-card: #141a1d;
            --bg-hover: #1c2428;
            --text-primary: #e8eaec;
            --text-secondary: #8b949e;
            --accent-lime: #7fff00;
            --accent-orange: #ff6b35;
            --accent-cyan: #00d9ff;
            --border: #2d353b;
            --fuse-5a: #4ade80;
            --fuse-10a: #60a5fa;
            --fuse-15a: #a78bfa;
            --fuse-20a: #f472b6;
            --fuse-25a: #fb923c;
            --fuse-30a: #facc15;
            --fuse-40a: #f87171;
            --fuse-50a: #e879f9;
            --fuse-60a: #2dd4bf;
            --fuse-70a: #94a3b8;
            --fuse-80a: #a3a3a3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated circuit board background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(127, 255, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(127, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-lime), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(127, 255, 0, 0.05) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .upload-section:hover {
            border-color: var(--accent-lime);
            transform: translateY(-2px);
        }

        .upload-section:hover::before {
            opacity: 1;
        }

        .upload-section.dragover {
            border-color: var(--accent-lime);
            background: rgba(127, 255, 0, 0.05);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--accent-lime), var(--accent-cyan));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--bg-dark);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
            border-left: 4px solid var(--accent-lime);
        }

        .file-info.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-lime);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(127, 255, 0, 0.1);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-lime);
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--accent-lime), #5cb600);
            color: var(--bg-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(127, 255, 0, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        #copyHtmlBtn {
            background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
        }

        #copyHtmlBtn:hover {
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.3);
        }

        /* Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: var(--bg-hover);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: rgba(127, 255, 0, 0.05);
        }

        th.sortable::after {
            content: 'â†•';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
            font-size: 0.75rem;
        }

        th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: var(--accent-lime);
        }

        th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: var(--accent-lime);
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        td {
            padding: 0.875rem 1rem;
            color: var(--text-primary);
        }

        /* Table column width control */
        table {
            table-layout: fixed;
        }

        /* ä¿é™©ä¸ä»£å·åˆ— */
        th:nth-child(1), td:nth-child(1) {
            width: 100px;
        }

        /* å›è·¯å·åˆ— */
        th:nth-child(2), td:nth-child(2) {
            width: 150px;
        }

        /* Optionåˆ— */
        th:nth-child(3), td:nth-child(3) {
            width: 150px;
        }

        /* åŠŸèƒ½çº¿å¾„åˆ— */
        th:nth-child(6), td:nth-child(6) {
            width: 120px;
        }

        /* ä¿é™©ä¸åŠŸèƒ½åˆ— */
        th:nth-child(7), td:nth-child(7) {
            width: 450px;
        }

        .wire-diameter {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .fuse-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.875rem;
            min-width: 60px;
            text-align: center;
        }

        .fuse-5 { background: rgba(74, 222, 128, 0.15); color: var(--fuse-5a); border: 1px solid var(--fuse-5a); }
        .fuse-7 { background: rgba(74, 222, 128, 0.15); color: var(--fuse-5a); border: 1px solid var(--fuse-5a); }
        .fuse-10 { background: rgba(96, 165, 250, 0.15); color: var(--fuse-10a); border: 1px solid var(--fuse-10a); }
        .fuse-15 { background: rgba(167, 139, 250, 0.15); color: var(--fuse-15a); border: 1px solid var(--fuse-15a); }
        .fuse-20 { background: rgba(244, 114, 182, 0.15); color: var(--fuse-20a); border: 1px solid var(--fuse-20a); }
        .fuse-25 { background: rgba(251, 146, 60, 0.15); color: var(--fuse-25a); border: 1px solid var(--fuse-25a); }
        .fuse-30 { background: rgba(250, 204, 21, 0.15); color: var(--fuse-30a); border: 1px solid var(--fuse-30a); }
        .fuse-35 { background: rgba(248, 113, 113, 0.15); color: var(--fuse-40a); border: 1px solid var(--fuse-40a); }
        .fuse-40 { background: rgba(248, 113, 113, 0.15); color: var(--fuse-40a); border: 1px solid var(--fuse-40a); }
        .fuse-50 { background: rgba(232, 121, 249, 0.15); color: var(--fuse-50a); border: 1px solid var(--fuse-50a); }
        .fuse-60 { background: rgba(45, 212, 191, 0.15); color: var(--fuse-60a); border: 1px solid var(--fuse-60a); }
        .fuse-70 { background: rgba(148, 163, 184, 0.15); color: var(--fuse-70a); border: 1px solid var(--fuse-70a); }
        .fuse-80 { background: rgba(163, 163, 163, 0.15); color: var(--fuse-80a); border: 1px solid var(--fuse-80a); }

        .fuse-type {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .harness-group {
            background: rgba(127, 255, 0, 0.03);
            font-weight: 600;
        }

        .index {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        /* Fuse Distribution Chart */
        .distribution-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .distribution-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .distribution-bars {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .distribution-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .bar-label {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            min-width: 50px;
            color: var(--text-primary);
        }

        .bar-track {
            flex: 1;
            height: 24px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.5s ease-out;
            border-radius: 4px;
        }

        .bar-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-section {
                padding: 2rem 1rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            table {
                font-size: 0.75rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-lime);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
        }

        /* Upload Container */
        .upload-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Process Section */
        .process-section {
            margin-bottom: 2rem;
        }

        #processBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #processBtn:disabled:hover {
            box-shadow: none;
        }

        /* Filter Section */
        .filter-section {
            display: none;
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .filter-section.active {
            display: block;
        }

        .filter-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .filter-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            border-color: var(--accent-lime);
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-lime), #5cb600);
            border-color: var(--accent-lime);
            color: var(--bg-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(127, 255, 0, 0.3);
        }

        .filter-btn .count {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .filter-btn.active .count {
            background: rgba(0, 0, 0, 0.2);
        }

        .from-to-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent-cyan);
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        /* Warning Badge */
        .warning-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255, 107, 53, 0.1);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-container.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-percentage {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-lime);
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-lime), var(--accent-cyan));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-status {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Template Download Section */
        .template-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .template-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .template-btn:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        /* Analysis Dashboard */
        .analysis-dashboard {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .analysis-dashboard.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .analysis-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analysis-card {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .analysis-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .analysis-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-lime);
            margin-bottom: 0.5rem;
        }

        .analysis-subtext {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Alert Messages */
        .alert-box {
            display: none;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }

        .alert-box.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .alert-warning {
            background: rgba(255, 107, 53, 0.1);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .alert-success {
            background: rgba(127, 255, 0, 0.1);
            border-color: var(--accent-lime);
            color: var(--accent-lime);
        }

        /* Config Panel */
        .config-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-panel.active {
            display: block;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .config-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .config-toggle-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-toggle-btn:hover {
            border-color: var(--accent-lime);
        }

        .config-section {
            margin-bottom: 1.5rem;
        }

        .config-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .config-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .config-input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.625rem 0.875rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-lime);
        }

        .config-unit {
            color: var(--text-secondary);
            padding: 0.625rem 0.875rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .config-btn {
            background: linear-gradient(135deg, var(--accent-lime), #5cb600);
            color: var(--bg-dark);
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(127, 255, 0, 0.3);
        }

        /* ç¬¬5-9åˆ—ç»Ÿä¸€æ ·å¼ï¼šç¡®ä¿å¯¹é½ */
        #resultsTable td:nth-child(5),
        #resultsTable td:nth-child(6),
        #resultsTable td:nth-child(7),
        #resultsTable td:nth-child(8),
        #resultsTable td:nth-child(9) {
            white-space: pre-line;
            font-size: 0.75rem;  /* å‡å°å­—ä½“å¤§å° */
            line-height: 1.3;     /* ç»Ÿä¸€è¡Œé«˜ */
            vertical-align: top;  /* é¡¶éƒ¨å¯¹é½ */
        }

        /* TOå¯¹åº”å›è·¯å·åˆ—ï¼ˆç¬¬6åˆ—ï¼‰ï¼šé€—å·åˆ†éš”ä¸æ¢è¡Œï¼Œå®½åº¦ç¿»å€ */
        #resultsTable td:nth-child(6) {
            word-break: keep-all;
            overflow-wrap: normal;
            font-family: 'JetBrains Mono', monospace;
            min-width: 300px;     /* å¢åŠ å®½åº¦ */
            max-width: 500px;
        }

        /* å›è·¯å·Optionåˆ—ï¼ˆç¬¬7åˆ—ï¼‰ï¼šé€—å·åˆ†éš”ä¸æ¢è¡Œï¼Œå®½åº¦ç¿»å€ */
        #resultsTable td:nth-child(7) {
            word-break: keep-all;
            overflow-wrap: normal;
            font-family: 'JetBrains Mono', monospace;
            min-width: 250px;     /* å¢åŠ å®½åº¦ */
            max-width: 400px;
        }

        /* å›è·¯çº¿å¾„åˆ—ï¼ˆç¬¬8åˆ—ï¼‰ï¼šé€—å·åˆ†éš”ä¸æ¢è¡Œ */
        #resultsTable td:nth-child(8) {
            word-break: keep-all;
            overflow-wrap: normal;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ä¿é™©ä¸åŠŸèƒ½åˆ—ï¼ˆç¬¬9åˆ—ï¼‰ï¼šå…è®¸è‡ªåŠ¨æ¢è¡Œ */
        #resultsTable td:nth-child(9) {
            word-break: break-word;  /* å…è®¸é•¿å•è¯æ¢è¡Œ */
            overflow-wrap: break-word;
            min-width: 250px;
            max-width: 400px;
        }

        /* æœ€åäº”åˆ—ï¼ˆç¬¬11-15åˆ—ï¼‰ï¼šè°ƒçª„å®½åº¦ */
        #resultsTable td:nth-child(11),
        #resultsTable td:nth-child(12),
        #resultsTable td:nth-child(13),
        #resultsTable td:nth-child(14),
        #resultsTable td:nth-child(15) {
            min-width: 60px;       /* è°ƒçª„ */
            max-width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¿é™©ä¸ä¸çº¿å¾„åŒ¹é…å·¥å…· v4.2</h1>
            <p class="subtitle">è‡ªåŠ¨åˆ†æçº¿æŸæ¸…å•ï¼Œè¿‡æ»¤ä¸­é—´èŠ‚ç‚¹ | ä»…æ˜¾ç¤ºæœ€ç»ˆè¿æ¥çš„æ’ä»¶ï¼ˆå»é™¤Inlineå’Œç„Šç‚¹ä¸­é—´èŠ‚ç‚¹ï¼‰</p>
        </header>

        <!-- Template Download Section -->
        <div class="template-section">
            <div class="template-title">
                <span>ğŸ“¥</span>
                <span>å¯¼å…¥æ¨¡æ¿ä¸‹è½½</span>
            </div>
            <div class="template-buttons">
                <button class="template-btn" onclick="downloadWirelistTemplate()">
                    <span>ğŸ“‹</span>
                    <span>Wirelist æ¨¡æ¿</span>
                </button>
                <button class="template-btn" onclick="downloadConnlistTemplate()">
                    <span>ğŸ”Œ</span>
                    <span>Connlist æ¨¡æ¿</span>
                </button>
                <button class="template-btn" onclick="downloadInlineTemplate()">
                    <span>ğŸ”—</span>
                    <span>Inline æ¨¡æ¿</span>
                </button>
            </div>
        </div>

        <div class="upload-container">
            <div class="upload-section" id="wirelistUploadZone">
                <div class="upload-icon">ğŸ“‹</div>
                <div class="upload-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  Wirelist æ–‡ä»¶</div>
                <div class="upload-hint">å¿…é¡»åŒ…å«ï¼šWire IDã€Size / Gaugeã€From Codeã€From Pinã€To Codeã€To Pinåˆ—</div>
                <input type="file" id="wirelistInput" accept=".xlsx,.xls">
                <div class="file-info" id="wirelistFileInfo">
                    <div class="file-name" id="wirelistFileName"></div>
                    <div class="file-size" id="wirelistFileSize"></div>
                </div>
            </div>

            <div class="upload-section" id="connlistUploadZone">
                <div class="upload-icon">ğŸ”Œ</div>
                <div class="upload-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  Connlist æ–‡ä»¶ï¼ˆå¿…é€‰ï¼‰</div>
                <div class="upload-hint">ç”¨äºè¯†åˆ«ä¿é™©ä¸åŠŸèƒ½ï¼ˆå¿…é¡»ä¸Šä¼ ï¼‰</div>
                <input type="file" id="connlistInput" accept=".xlsx,.xls">
                <div class="file-info" id="connlistFileInfo">
                    <div class="file-name" id="connlistFileName"></div>
                    <div class="file-size" id="connlistFileSize"></div>
                </div>
            </div>

            <div class="upload-section" id="inlineUploadZone">
                <div class="upload-icon">ğŸ”—</div>
                <div class="upload-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  Inline æ–‡ä»¶ï¼ˆå¿…é€‰ï¼‰</div>
                <div class="upload-hint">ç”¨äºè¯†åˆ«åŒä¸€å›è·¯è¿æ¥å…³ç³»ï¼ˆå¿…é¡»ä¸Šä¼ ï¼‰</div>
                <input type="file" id="inlineInput" accept=".xlsx,.xls">
                <div class="file-info" id="inlineFileInfo">
                    <div class="file-name" id="inlineFileName"></div>
                    <div class="file-size" id="inlineFileSize"></div>
                </div>
            </div>
        </div>

        <div class="process-section">
            <button class="export-btn" id="processBtn" style="width: 100%; justify-content: center; font-size: 1rem; padding: 1rem;">
                <span>ğŸš€</span>
                <span>å¼€å§‹åˆ†æ</span>
            </button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-header">
                <div class="progress-label" id="progressLabel">æ­£åœ¨å¤„ç†...</div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-status" id="progressStatus">å‡†å¤‡ä¸­...</div>
        </div>

        <!-- Alert Messages -->
        <div class="alert-box alert-warning" id="warningAlert">
            <strong>âš ï¸ è­¦å‘Šï¼š</strong><span id="warningMessage"></span>
        </div>
        <div class="alert-box alert-info" id="infoAlert">
            <strong>â„¹ï¸ ä¿¡æ¯ï¼š</strong><span id="infoMessage"></span>
        </div>
        <div class="alert-box alert-success" id="successAlert">
            <strong>âœ… æˆåŠŸï¼š</strong><span id="successMessage"></span>
        </div>

        <!-- Config Panel -->
        <div class="config-panel" id="configPanel">
            <div class="config-header">
                <div class="config-title">âš™ï¸ ä¿é™©ä¸è§„åˆ™é…ç½®</div>
                <button class="config-toggle-btn" id="toggleConfigBtn">æ”¶èµ·</button>
            </div>

            <div class="config-section">
                <div class="config-section-title">çº¿å¾„åˆ°ä¿é™©ä¸è§„æ ¼æ˜ å°„</div>
                <div id="fuseConfigContainer"></div>
                <button class="config-btn" onclick="addFuseMapping()" style="margin-top: 0.5rem;">
                    <span>+</span> æ·»åŠ æ˜ å°„è§„åˆ™
                </button>
            </div>

            <div class="config-section">
                <div class="config-section-title">è‡ªå®šä¹‰ç”µå™¨ç›’ä»£ç </div>
                <div class="config-input-group">
                    <input type="text" class="config-input" id="customBoxCode" placeholder="ä¾‹å¦‚ï¼šJEC">
                    <button class="config-btn" onclick="addCustomBoxCode()">æ·»åŠ </button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    å½“å‰æœ‰æ•ˆä»£ç ï¼š<span id="validCodesDisplay"></span>
                </div>
            </div>

            <div class="config-section">
                <div class="config-section-title">æ•°æ®éªŒè¯è§„åˆ™</div>
                <div class="config-input-group">
                    <label style="color: var(--text-primary); padding: 0.625rem;">
                        <input type="checkbox" id="validateWireDiameter" checked>
                        å¯ç”¨çº¿å¾„éªŒè¯
                    </label>
                </div>
                <div class="config-input-group">
                    <label style="color: var(--text-primary); padding: 0.625rem;">
                        <input type="checkbox" id="validateFuseRating" checked>
                        å¯ç”¨ä¿é™©ä¸è§„æ ¼éªŒè¯
                    </label>
                </div>
                <button class="config-btn" onclick="saveConfig()" style="margin-top: 0.5rem;">
                    ğŸ’¾ ä¿å­˜é…ç½®
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨åˆ†ææ•°æ®...</div>
        </div>

        <div class="filter-section" id="filterSection">
            <div class="filter-title">æŒ‰ç”µå™¨ç›’ç­›é€‰</div>
            <div class="filter-buttons" id="filterButtons"></div>
        </div>

        <div class="stats-section" id="statsSection"></div>

        <!-- Analysis Dashboard -->
        <div class="analysis-dashboard" id="analysisDashboard">
            <div class="analysis-header">ğŸ“Š æ•°æ®åˆ†æä»ªè¡¨æ¿</div>

            <div class="analysis-grid">
                <div class="analysis-card">
                    <div class="analysis-card-title">å¹³å‡çº¿å¾„</div>
                    <div class="analysis-value" id="avgWireDiameter">-</div>
                    <div class="analysis-subtext">mmÂ²</div>
                </div>
                <div class="analysis-card">
                    <div class="analysis-card-title">æœ€å°çº¿å¾„</div>
                    <div class="analysis-value" id="minWireDiameter">-</div>
                    <div class="analysis-subtext">mmÂ²</div>
                </div>
                <div class="analysis-card">
                    <div class="analysis-card-title">æœ€å¤§çº¿å¾„</div>
                    <div class="analysis-value" id="maxWireDiameter">-</div>
                    <div class="analysis-subtext">mmÂ²</div>
                </div>
                <div class="analysis-card">
                    <div class="analysis-card-title">ç„Šç‚¹è¿æ¥æ•°</div>
                    <div class="analysis-value" id="solderJointCount">-</div>
                    <div class="analysis-subtext">æ¡çº¿è·¯</div>
                </div>
                <div class="analysis-card">
                    <div class="analysis-card-title">ç›´æ¥è¿æ¥æ•°</div>
                    <div class="analysis-value" id="directConnectionCount">-</div>
                    <div class="analysis-subtext">æ¡çº¿è·¯</div>
                </div>
                <div class="analysis-card">
                    <div class="analysis-card-title">å¼‚å¸¸æ•°æ®</div>
                    <div class="analysis-value" id="abnormalDataCount">-</div>
                    <div class="analysis-subtext">æ¡éœ€è¦äººå·¥ç¡®è®¤</div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-title">åŒ¹é…ç»“æœ</div>
                <div class="export-buttons">
                    <button class="export-btn" id="exportBtn">
                        <span>ğŸ“¥</span>
                        <span>å¯¼å‡ºå½©è‰²Excel</span>
                    </button>
                    <button class="export-btn" id="copyHtmlBtn">
                        <span>ğŸ“‹</span>
                        <span>å¤åˆ¶HTML</span>
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>ä¿é™©ä¸ä»£å·</th>
                            <th>å›è·¯å·</th>
                            <th>Option</th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th>TOå¯¹åº”å›è·¯å·</th>
                            <th>å›è·¯å·Option</th>
                            <th>å›è·¯çº¿å¾„</th>
                            <th>ä¿é™©ä¸åŠŸèƒ½</th>
                            <th class="sortable" data-column="wireDiameter">çº¿å¾„ (mmÂ²)</th>
                            <th class="sortable" data-column="circuitType">ç”µè·¯ç±»å‹</th>
                            <th class="sortable" data-column="harnessType">çº¿æŸç±»å‹</th>
                            <th class="sortable" data-column="fuseRating">æ¨èä¿é™©ä¸</th>
                            <th>ä¿é™©ä¸ç±»å‹</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>

            <div class="distribution-section">
                <div class="distribution-title">ä¿é™©ä¸è§„æ ¼åˆ†å¸ƒ</div>
                <div class="distribution-bars" id="distributionBars"></div>
            </div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦å·²åŠ è½½
        if (typeof XLSX === 'undefined') {
            console.error('é”™è¯¯ï¼šSheetJS (XLSX) åº“æœªåŠ è½½ï¼');
            alert('SheetJSåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        }
        if (typeof ExcelJS === 'undefined') {
            console.error('é”™è¯¯ï¼šExcelJSåº“æœªåŠ è½½ï¼');
            alert('ExcelJSåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        }

        // Wire diameter to fuse rating mapping (automotive industry standard)
        const fuseMapping = {
            0.5: { rating: '5A/7.5A', type: 'Mini Fuse', primary: 5 },
            0.75: { rating: '10A', type: 'Mini Fuse', primary: 10 },
            0.85: { rating: '10A/15A', type: 'Mini Fuse', primary: 10 },
            1.0: { rating: '15A', type: 'Mini Fuse', primary: 15 },
            1.25: { rating: '15A/20A', type: 'Mini Fuse', primary: 15 },
            1.5: { rating: '20A/25A', type: 'Mini Fuse', primary: 20 },
            2.0: { rating: '25A', type: 'Mini/Maxi', primary: 25 },
            2.5: { rating: '30A', type: 'Maxi Fuse', primary: 30 },
            4.0: { rating: '35A/40A', type: 'Maxi Fuse', primary: 40 },
            6.0: { rating: '50A', type: 'Maxi/JCASE', primary: 50 },
            8.0: { rating: '60A', type: 'JCASE/Mega', primary: 60 },
            10.0: { rating: '70A/80A', type: 'JCASE/Mega', primary: 70 }
        };

        // Filter definitions
        const boxFilters = {
            'å‰ä»“ç”µå™¨ç›’': { codes: ['UEC', 'FFB'], color: '#4ade80' },
            'ä»ªè¡¨ç”µå™¨ç›’': { codes: ['IEC', 'IPFB'], color: '#60a5fa' },
            'è¡Œæç®±ç”µå™¨ç›’': { codes: ['TFB', 'REC'], color: '#f472b6' },
            'é¢„ä¿é™©ä¸ç›’': { codes: ['PFB'], color: '#fbbf24' }
        };

        const validCodes = ['UEC', 'IEC', 'PFB', 'FFB', 'IPFB', 'TFB', 'REC'];

        // Configuration
        let customFuseMapping = {...fuseMapping}; // å¯è‡ªå®šä¹‰çš„ä¿é™©ä¸æ˜ å°„
        let customBoxCodes = [...validCodes]; // å¯è‡ªå®šä¹‰çš„ç”µå™¨ç›’ä»£ç 
        let configSettings = {
            validateWireDiameter: true,
            validateFuseRating: true
        };

        let allData = [];
        let filteredData = [];
        let activeFilter = null;
        let currentSort = { column: null, direction: 'asc' };

        // Connlist data
        let connectorFunctions = {}; // æ’ä»¶ä»£ç  -> åŠŸèƒ½æ˜ å°„ï¼ˆBåˆ— -> Cåˆ—ï¼‰

        // Wirelist data
        let wirelistAllData = []; // å®Œæ•´çš„wirelistæ•°æ®ï¼ˆç”¨äºæŸ¥æ‰¾ç„Šç‚¹è¿æ¥ï¼‰
        let wirelistFile = null; // å­˜å‚¨wirelistæ–‡ä»¶
        let connlistFile = null; // å­˜å‚¨connlistæ–‡ä»¶
        let inlineFile = null; // å­˜å‚¨inlineæ–‡ä»¶

        // Inline data
        let inlineMapping = {}; // inlineè¿æ¥æ˜ å°„: LEFT -> RIGHT, RIGHT -> LEFT
        let inlineCodes = new Set(); // æ‰€æœ‰inlineä»£ç é›†åˆ
        let circuitGroups = []; // åŒä¸€å›è·¯çš„åˆ†ç»„æ•°æ®

        // DOM Elements (åœ¨DOMContentLoadedå†…åˆå§‹åŒ–)
        let wirelistUploadZone, connlistUploadZone, inlineUploadZone;
        let wirelistInput, connlistInput, inlineInput;
        let wirelistFileInfo, connlistFileInfo, inlineFileInfo;
        let wirelistFileName, wirelistFileSize;
        let connlistFileName, connlistFileSize;
        let inlineFileName, inlineFileSize;
        let loading, filterSection, filterButtons;
        let statsSection, resultsSection, resultsBody, exportBtn, copyHtmlBtn, distributionBars, processBtn;

        function handleDragOver(e, zone) {
            e.preventDefault();
            zone.classList.add('dragover');
        }

        function handleWirelistDrop(e) {
            e.preventDefault();
            wirelistUploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleWirelistFile(files[0]);
            }
        }

        function handleConnlistDrop(e) {
            e.preventDefault();
            connlistUploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleConnlistFile(files[0]);
            }
        }

        function handleInlineDrop(e) {
            e.preventDefault();
            inlineUploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleInlineFile(files[0]);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–DOMå…ƒç´ 
            wirelistUploadZone = document.getElementById('wirelistUploadZone');
            connlistUploadZone = document.getElementById('connlistUploadZone');
            inlineUploadZone = document.getElementById('inlineUploadZone');
            wirelistInput = document.getElementById('wirelistInput');
            connlistInput = document.getElementById('connlistInput');
            inlineInput = document.getElementById('inlineInput');
            wirelistFileInfo = document.getElementById('wirelistFileInfo');
            connlistFileInfo = document.getElementById('connlistFileInfo');
            inlineFileInfo = document.getElementById('inlineFileInfo');
            wirelistFileName = document.getElementById('wirelistFileName');
            wirelistFileSize = document.getElementById('wirelistFileSize');
            connlistFileName = document.getElementById('connlistFileName');
            connlistFileSize = document.getElementById('connlistFileSize');
            inlineFileName = document.getElementById('inlineFileName');
            inlineFileSize = document.getElementById('inlineFileSize');
            loading = document.getElementById('loading');
            filterSection = document.getElementById('filterSection');
            filterButtons = document.getElementById('filterButtons');
            statsSection = document.getElementById('statsSection');
            resultsSection = document.getElementById('resultsSection');
            resultsBody = document.getElementById('resultsBody');
            exportBtn = document.getElementById('exportBtn');
            copyHtmlBtn = document.getElementById('copyHtmlBtn');
            distributionBars = document.getElementById('distributionBars');
            processBtn = document.getElementById('processBtn');

            // Event Listeners
            wirelistUploadZone.addEventListener('click', () => wirelistInput.click());
            wirelistInput.addEventListener('change', (e) => handleWirelistFile(e.target.files[0]));
            wirelistUploadZone.addEventListener('dragover', (e) => handleDragOver(e, wirelistUploadZone));
            wirelistUploadZone.addEventListener('dragleave', () => wirelistUploadZone.classList.remove('dragover'));
            wirelistUploadZone.addEventListener('drop', (e) => handleWirelistDrop(e));

            connlistUploadZone.addEventListener('click', () => connlistInput.click());
            connlistInput.addEventListener('change', (e) => handleConnlistFile(e.target.files[0]));
            connlistUploadZone.addEventListener('dragover', (e) => handleDragOver(e, connlistUploadZone));
            connlistUploadZone.addEventListener('dragleave', () => connlistUploadZone.classList.remove('dragover'));
            connlistUploadZone.addEventListener('drop', (e) => handleConnlistDrop(e));

            inlineUploadZone.addEventListener('click', () => inlineInput.click());
            inlineInput.addEventListener('change', (e) => handleInlineFile(e.target.files[0]));
            inlineUploadZone.addEventListener('dragover', (e) => handleDragOver(e, inlineUploadZone));
            inlineUploadZone.addEventListener('dragleave', () => inlineUploadZone.classList.remove('dragover'));
            inlineUploadZone.addEventListener('drop', (e) => handleInlineDrop(e));

            processBtn.addEventListener('click', processDataFiles);
            exportBtn.addEventListener('click', exportToExcel);
            copyHtmlBtn.addEventListener('click', copyHtmlToClipboard);

            // Setup sortable headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort(th.dataset.column));
            });

            // Load configuration
            loadConfig();
            updateValidCodesDisplay();
            renderFuseConfig();

            // Config panel toggle
            document.getElementById('toggleConfigBtn').addEventListener('click', toggleConfigPanel);
        });

        // Load config from localStorage
        function loadConfig() {
            const savedConfig = localStorage.getItem('fuseMatcherConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    customFuseMapping = config.fuseMapping || customFuseMapping;
                    customBoxCodes = config.boxCodes || customBoxCodes;
                    configSettings = config.settings || configSettings;
                } catch (e) {
                    console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:', e);
                }
            }
        }

        // Save config to localStorage
        function saveConfig() {
            const config = {
                fuseMapping: customFuseMapping,
                boxCodes: customBoxCodes,
                settings: configSettings
            };
            localStorage.setItem('fuseMatcherConfig', JSON.stringify(config));
            showAlert('success', 'é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        }

        // Alert messages
        function showAlert(type, message) {
            const alertBox = document.getElementById(`${type}Alert`);
            const messageSpan = document.getElementById(`${type}Message`);
            messageSpan.textContent = message;
            alertBox.classList.add('active');

            setTimeout(() => {
                alertBox.classList.remove('active');
            }, 5000);
        }

        // Progress bar
        function updateProgress(label, percentage, status) {
            const progressContainer = document.getElementById('progressContainer');
            const progressLabel = document.getElementById('progressLabel');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');

            progressContainer.classList.add('active');
            progressLabel.textContent = label;
            progressPercentage.textContent = `${percentage}%`;
            progressFill.style.width = `${percentage}%`;
            progressStatus.textContent = status;
        }

        function hideProgress() {
            setTimeout(() => {
                document.getElementById('progressContainer').classList.remove('active');
            }, 500);
        }

        // Template download functions
        function downloadWirelistTemplate() {
            const template = [
                {
                    'Wire ID': 'W001',
                    'Size / Gauge': 0.5,
                    'From Code': 'UEC',
                    'From Pin': '1A',
                    'To Code': 'E101',
                    'To Pin': '1',
                    'Circuit': 'ç”µæº',
                    'Harness': 'å‰ä»“çº¿æŸ'
                },
                {
                    'Wire ID': 'W002',
                    'Size / Gauge': 1.0,
                    'From Code': 'IEC',
                    'From Pin': '2B',
                    'To Code': 'E201',
                    'To Pin': '3',
                    'Circuit': 'ä¿¡å·',
                    'Harness': 'ä»ªè¡¨çº¿æŸ'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Wirelistæ¨¡æ¿');
            XLSX.writeFile(wb, 'Wirelistå¯¼å…¥æ¨¡æ¿.xlsx');
            showAlert('success', 'Wirelistæ¨¡æ¿å·²ä¸‹è½½');
        }

        function downloadConnlistTemplate() {
            const template = [
                {
                    'æ›´æ”¹è®°å½•': '',
                    'æ’ä»¶ä»£ç ': 'UEC',
                    'ä¸­æ–‡æè¿°': 'å‰ä»“ç”µå™¨ç›’'
                },
                {
                    'æ›´æ”¹è®°å½•': '',
                    'æ’ä»¶ä»£ç ': 'IEC',
                    'ä¸­æ–‡æè¿°': 'ä»ªè¡¨ç”µå™¨ç›’'
                },
                {
                    'æ›´æ”¹è®°å½•': '',
                    'æ’ä»¶ä»£ç ': 'PFB',
                    'ä¸­æ–‡æè¿°': 'é¢„ä¿é™©ä¸ç›’'
                },
                {
                    'æ›´æ”¹è®°å½•': '',
                    'æ’ä»¶ä»£ç ': 'E101',
                    'ä¸­æ–‡æè¿°': 'å‘åŠ¨æœºæ§åˆ¶æ¨¡å—'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Connlistæ¨¡æ¿');
            XLSX.writeFile(wb, 'Connlistå¯¼å…¥æ¨¡æ¿.xlsx');
            showAlert('success', 'Connlistæ¨¡æ¿å·²ä¸‹è½½');
        }

        function downloadInlineTemplate() {
            const template = [
                {
                    'INLINE-LEFT': 'BDBT',
                    'INLINE-RIGHT': 'BTBD'
                },
                {
                    'INLINE-LEFT': 'BDDHT',
                    'INLINE-RIGHT': 'DHTBD'
                },
                {
                    'INLINE-LEFT': 'BDEG5',
                    'INLINE-RIGHT': 'EGBD5'
                },
                {
                    'INLINE-LEFT': 'BDIPM',
                    'INLINE-RIGHT': 'IPBDM'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inlineæ¨¡æ¿');
            XLSX.writeFile(wb, 'Inlineå¯¼å…¥æ¨¡æ¿.xlsx');
            showAlert('success', 'Inlineæ¨¡æ¿å·²ä¸‹è½½');
        }

        // Config panel functions
        function toggleConfigPanel() {
            const panel = document.getElementById('configPanel');
            const btn = document.getElementById('toggleConfigBtn');
            panel.classList.toggle('active');
            btn.textContent = panel.classList.contains('active') ? 'æ”¶èµ·' : 'å±•å¼€';
        }

        function addFuseMapping() {
            const wireDiameter = prompt('è¯·è¾“å…¥çº¿å¾„ (mmÂ²):');
            if (!wireDiameter) return;

            const fuseRating = prompt('è¯·è¾“å…¥ä¿é™©ä¸è§„æ ¼ (ä¾‹å¦‚: 5A):');
            if (!fuseRating) return;

            const fuseType = prompt('è¯·è¾“å…¥ä¿é™©ä¸ç±»å‹ (ä¾‹å¦‚: Mini Fuse):');
            if (!fuseType) return;

            customFuseMapping[parseFloat(wireDiameter)] = {
                rating: fuseRating,
                type: fuseType,
                primary: parseInt(fuseRating)
            };

            renderFuseConfig();
            showAlert('success', `å·²æ·»åŠ : ${wireDiameter}mmÂ² â†’ ${fuseRating}`);
        }

        function renderFuseConfig() {
            const container = document.getElementById('fuseConfigContainer');
            container.innerHTML = '';

            Object.entries(customFuseMapping)
                .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))
                .forEach(([diameter, info]) => {
                    const div = document.createElement('div');
                    div.className = 'config-input-group';
                    div.innerHTML = `
                        <input type="number" class="config-input" value="${diameter}" step="0.1" readonly>
                        <span class="config-unit">â†’</span>
                        <input type="text" class="config-input" value="${info.rating}" readonly>
                        <span class="config-unit">(${info.type})</span>
                        <button class="config-btn" onclick="removeFuseMapping('${diameter}')" style="padding: 0.625rem;">Ã—</button>
                    `;
                    container.appendChild(div);
                });
        }

        function removeFuseMapping(diameter) {
            delete customFuseMapping[diameter];
            renderFuseConfig();
            showAlert('info', `å·²åˆ é™¤çº¿å¾„ ${diameter}mmÂ² çš„æ˜ å°„è§„åˆ™`);
        }

        function addCustomBoxCode() {
            const input = document.getElementById('customBoxCode');
            const code = input.value.trim().toUpperCase();

            if (!code) {
                showAlert('warning', 'è¯·è¾“å…¥ç”µå™¨ç›’ä»£ç ');
                return;
            }

            if (customBoxCodes.includes(code)) {
                showAlert('warning', `ä»£ç  ${code} å·²å­˜åœ¨`);
                return;
            }

            customBoxCodes.push(code);
            updateValidCodesDisplay();
            input.value = '';
            showAlert('success', `å·²æ·»åŠ ç”µå™¨ç›’ä»£ç : ${code}`);
        }

        function updateValidCodesDisplay() {
            document.getElementById('validCodesDisplay').textContent = customBoxCodes.join(', ');
        }

        function handleWirelistFile(file) {
            if (!file) return;

            // Display file info
            wirelistFileName.textContent = file.name;
            wirelistFileSize.textContent = formatFileSize(file.size);
            wirelistFileInfo.classList.add('active');

            // Store file
            wirelistFile = file;

        }

        async function handleConnlistFile(file) {
            if (!file) return;

            // Display file info
            connlistFileName.textContent = file.name;
            connlistFileSize.textContent = formatFileSize(file.size);
            connlistFileInfo.classList.add('active');

            // Store file
            connlistFile = file;

            // Process connlist immediately
            try {
                await processConnlistFile(file);
            } catch (error) {
                console.error('Connlist å¤„ç†å¤±è´¥:', error);
                connlistFileName.textContent = `${file.name} (å¤„ç†å¤±è´¥)`;
            }
        }

        async function handleInlineFile(file) {
            if (!file) return;

            // Display file info
            inlineFileName.textContent = file.name;
            inlineFileSize.textContent = formatFileSize(file.size);
            inlineFileInfo.classList.add('active');

            // Store file
            inlineFile = file;

            // Process inline immediately
            try {
                await processInlineFile(file);
                showAlert('success', `Inlineæ–‡ä»¶å·²åŠ è½½ï¼Œè¯†åˆ«åˆ° ${inlineCodes.size} ä¸ªinlineè¿æ¥`);
            } catch (error) {
                console.error('Inline å¤„ç†å¤±è´¥:', error);
                inlineFileName.textContent = `${file.name} (å¤„ç†å¤±è´¥)`;
            }
        }

        async function processDataFiles() {

            if (!wirelistFile) {
                showAlert('warning', 'è¯·å…ˆä¸Šä¼  Wirelist æ–‡ä»¶');
                return;
            }

            if (!connlistFile) {
                showAlert('warning', 'è¯·å…ˆä¸Šä¼  Connlist æ–‡ä»¶ï¼ˆå¿…é€‰ï¼‰\n\nConnlistæ–‡ä»¶ç”¨äºè¯†åˆ«ä¿é™©ä¸åŠŸèƒ½ï¼Œå¿…é¡»ä¸Šä¼ æ‰èƒ½ç”Ÿæˆå®Œæ•´çš„ä¿é™©ä¸åŒ¹é…æ¸…å•ã€‚');
                return;
            }

            if (!inlineFile) {
                showAlert('warning', 'è¯·å…ˆä¸Šä¼  Inline æ–‡ä»¶ï¼ˆå¿…é€‰ï¼‰\n\nInlineæ–‡ä»¶ç”¨äºè¯†åˆ«åŒä¸€å›è·¯è¿æ¥å…³ç³»ï¼Œå¿…é¡»ä¸Šä¼ æ‰èƒ½è¯†åˆ«åŒä¸€å›è·¯ã€‚');
                return;
            }

            // æ£€æŸ¥connlistæ˜¯å¦æ­£ç¡®åŠ è½½
            if (Object.keys(connectorFunctions).length === 0) {
                showAlert('warning', 'Connlistæ–‡ä»¶å¤„ç†å¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®\n\nè¯·ç¡®ä¿Connlistæ–‡ä»¶åŒ…å«Båˆ—ï¼ˆæ’ä»¶ä»£ç ï¼‰å’ŒCåˆ—ï¼ˆä¸­æ–‡æè¿°ï¼‰ã€‚');
                return;
            }

            // æ£€æŸ¥inlineæ˜¯å¦æ­£ç¡®åŠ è½½
            if (inlineCodes.size === 0) {
                showAlert('warning', 'Inlineæ–‡ä»¶å¤„ç†å¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®\n\nè¯·ç¡®ä¿Inlineæ–‡ä»¶åŒ…å«INLINE-LEFTå’ŒINLINE-RIGHTåˆ—ã€‚');
                return;
            }


            // Reset data
            allData = [];
            filteredData = [];

            // Show loading and progress
            loading.classList.add('active');
            resultsSection.classList.remove('active');
            statsSection.innerHTML = '';
            document.getElementById('analysisDashboard').classList.remove('active');
            filterSection.classList.remove('active');
            processBtn.disabled = true;

            updateProgress('æ­£åœ¨è¯»å–æ–‡ä»¶...', 10, 'å‡†å¤‡è§£æ Wirelist æ–‡ä»¶');

            try {
                // å¼€å§‹æ€§èƒ½è®¡æ—¶
                const startTime = performance.now();

                // Process wirelist with progress updates
                updateProgress('æ­£åœ¨è§£æ Wirelist...', 30, 'è¯»å–æ•°æ®ä¸­');
                await processWirelistFile(wirelistFile);

                updateProgress('æ­£åœ¨éªŒè¯æ•°æ®...', 60, 'æ£€æŸ¥æ•°æ®å®Œæ•´æ€§');
                await validateData();

                updateProgress('æ­£åœ¨è¯†åˆ«åŒä¸€å›è·¯...', 70, 'åˆ†æinlineè¿æ¥å’Œç„Šç‚¹å…³ç³»');
                // è¯†åˆ«åŒä¸€å›è·¯
                circuitGroups = identifyCircuitGroups(allData);
                console.log(`âœ… è¯†åˆ«åˆ° ${circuitGroups.length} ä¸ªå›è·¯ç»„`);

                updateProgress('æ­£åœ¨ç”Ÿæˆåˆ†æç»“æœ...', 80, 'è®¡ç®—ç»Ÿè®¡æ•°æ®');

                // è®¡ç®—å¤„ç†æ—¶é—´
                const endTime = performance.now();
                const processingTime = ((endTime - startTime) / 1000).toFixed(2);
                console.log(`âš¡ å¤„ç†å®Œæˆï¼Œè€—æ—¶: ${processingTime}ç§’`);

                // Initialize filter buttons
                initializeFilters();

                // Display results
                displayResults();
                displayStats();
                displayAnalysisDashboard();

                updateProgress('å¤„ç†å®Œæˆï¼', 100, `æˆåŠŸå¤„ç† ${allData.length} æ¡æ•°æ®`);
                hideProgress();
                showAlert('success', `åˆ†æå®Œæˆï¼å…±å¤„ç† ${allData.length} æ¡çº¿è·¯æ•°æ®ï¼Œè€—æ—¶ ${processingTime} ç§’`);

                // Re-enable button and hide loading
                loading.classList.remove('active');
                processBtn.disabled = false;

            } catch (error) {
                console.error('Error processing files:', error);
                showAlert('warning', 'æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š' + error.message);
                hideProgress();
                loading.classList.remove('active');
                processBtn.disabled = false;
            }
        }

        function processWirelistFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);

                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        if (jsonData.length === 0) {
                            alert('Wirelistæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                            reject(new Error('Empty file'));
                            return;
                        }

                        // Find column names
                        const columns = findColumns(jsonData[0]);

                        // Debug: Show found columns
                        console.log('è¯†åˆ«åˆ°çš„åˆ—:', columns);
                        console.log('Excelä¸­çš„æ‰€æœ‰åˆ—å:', Object.keys(jsonData[0]));
                        console.log('çº¿æŸç±»å‹åˆ—è¯†åˆ«ä¸º:', columns.harnessType ? `"${columns.harnessType}"` : 'æœªæ‰¾åˆ°ï¼ˆå°†ä½¿ç”¨é»˜è®¤å€¼ï¼‰');

                        if (!columns.wireDiameter) {
                            alert('æœªæ‰¾åˆ°"çº¿å¾„"åˆ—ï¼Œè¯·ç¡®ä¿Excelä¸­åŒ…å«çº¿å¾„ä¿¡æ¯');
                            reject(new Error('Missing wire diameter column'));
                            return;
                        }

                        if (!columns.from || !columns.to) {
                            alert(`æœªæ‰¾åˆ°From Codeæˆ–to Codeåˆ—ã€‚\n\nè¯†åˆ«åˆ°çš„åˆ—: ${Object.keys(jsonData[0]).join(', ')}\n\nè¯·ç¡®ä¿Excelä¸­åŒ…å«From Codeå’Œto Codeåˆ—`);
                            reject(new Error('Missing From/To columns'));
                            return;
                        }

                        // Store all wirelist data for later reference
                        wirelistAllData = jsonData.map((row, index) => {
                            const wireId = (columns.wireId && row[columns.wireId]) ? String(row[columns.wireId]) : `Wire${index + 1}`;
                            return {
                                wireId: wireId,
                                from: columns.from ? String(row[columns.from] || '') : '',
                                fromPin: columns.fromPin ? String(row[columns.fromPin] || '') : '',
                                to: columns.to ? String(row[columns.to] || '') : '',
                                toPin: columns.toPin ? String(row[columns.toPin] || '') : '',
                                wireDiameter: columns.wireDiameter ? (parseFloat(row[columns.wireDiameter]) || 0) : 0,
                                option: columns.option ? String(row[columns.option] || '') : ''
                            };
                        });

                        // Process data
                        // æ„å»ºè¿é€šå›¾ï¼ˆåªæ„å»ºä¸€æ¬¡ï¼Œå¤§å¹…æå‡æ€§èƒ½ï¼‰
                        updateProgress('æ­£åœ¨æ„å»ºè¿é€šå›¾...', 40, 'åˆ†æç”µè·¯è¿æ¥å…³ç³»');
                        const circuitGraph = buildConnectivityGraph(wirelistAllData);
                        console.log('âœ… è¿é€šå›¾æ„å»ºå®Œæˆï¼ŒèŠ‚ç‚¹æ•°:', circuitGraph.size);

                        // æ„å»ºwirelistç´¢å¼•ï¼ˆåŠ é€ŸæŸ¥æ‰¾ï¼‰
                        updateProgress('æ­£åœ¨æ„å»ºç´¢å¼•...', 50, 'ä¼˜åŒ–æ•°æ®æŸ¥æ‰¾');
                        const wirelistIndex = buildWirelistIndex(wirelistAllData);
                        console.log('âœ… Wirelistç´¢å¼•æ„å»ºå®Œæˆï¼Œç´¢å¼•æ•°:', wirelistIndex.size);

                        allData = processData(jsonData, columns, wirelistAllData, circuitGraph, wirelistIndex);


                        if (allData.length === 0) {
                            alert(`æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„çº¿è·¯ã€‚\n\nåŸå§‹æ•°æ®æœ‰ ${jsonData.length} æ¡ï¼Œä½†æ²¡æœ‰FROMæˆ–TOåŒ…å«ä»¥ä¸‹ä»£ç çš„çº¿è·¯ï¼š\nUECã€IECã€PFBã€FFBã€IPFBã€TFBã€REC\n\nè¯·æ£€æŸ¥Excelä¸­çš„FROMå’ŒTOåˆ—ã€‚`);
                            reject(new Error('No matching data'));
                            return;
                        }

                        filteredData = [...allData];
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function processConnlistFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];


                        // æ–¹æ³•1ï¼šç›´æ¥ä»sheetè¯»å–ç‰¹å®šåˆ—ï¼ˆæŒ‰åˆ—å­—æ¯ï¼‰
                        // Båˆ— = æ’ä»¶ä»£ç ï¼ŒCåˆ— = ä¸­æ–‡æè¿°
                        const columnB = [];
                        const columnC = [];
                        const range = XLSX.utils.decode_range(firstSheet['!ref']);


                        // éå†æ‰€æœ‰è¡Œï¼ˆä»ç¬¬2è¡Œå¼€å§‹ï¼Œè·³è¿‡è¡¨å¤´ï¼‰
                        for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
                            // Båˆ—ï¼ˆåˆ—ç´¢å¼•=1ï¼‰
                            const cellB = firstSheet[XLSX.utils.encode_cell({ r: rowNum, c: 1 })];
                            // Cåˆ—ï¼ˆåˆ—ç´¢å¼•=2ï¼‰
                            const cellC = firstSheet[XLSX.utils.encode_cell({ r: rowNum, c: 2 })];

                            if (cellB) {
                                const codeValue = String(cellB.v).trim();
                                columnB.push(codeValue);
                            } else {
                                columnB.push('');
                            }

                            if (cellC) {
                                const funcValue = String(cellC.v).trim();
                                columnC.push(funcValue);
                            } else {
                                columnC.push('');
                            }
                        }


                        // Clear previous data
                        connectorFunctions = {};

                        // æ„å»ºæ˜ å°„è¡¨
                        let validCount = 0;
                        let skippedEmpty = 0;
                        let skippedDash = 0;

                        for (let i = 0; i < columnB.length; i++) {
                            const codeValue = columnB[i];
                            const funcValue = columnC[i];

                            // è·³è¿‡ç©ºå€¼
                            if (!codeValue || codeValue === '') {
                                skippedEmpty++;
                                continue;
                            }

                            // è·³è¿‡å ä½ç¬¦
                            if (codeValue === '-' || codeValue === 'N/A') {
                                skippedDash++;
                                continue;
                            }

                            // å­˜å‚¨æ˜ å°„ï¼ˆä»£ç è§„èŒƒåŒ–ï¼šå»é™¤ç©ºæ ¼ï¼Œè½¬å¤§å†™ï¼‰
                            const normalizedCode = codeValue.replace(/\s+/g, '').toUpperCase();
                            const normalizedFunc = funcValue || 'æœªçŸ¥åŠŸèƒ½';

                            connectorFunctions[normalizedCode] = normalizedFunc;
                            validCount++;

                        }


                        // æ˜¾ç¤ºå‰10ä¸ªæ˜ å°„
                        const sampleCodes = Object.keys(connectorFunctions).slice(0, 10);
                        sampleCodes.forEach(code => {
                        });

                        // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
                        if (Object.keys(connectorFunctions).length === 0) {
                            console.error('âŒ é”™è¯¯ï¼šæœªå»ºç«‹ä»»ä½•æ’ä»¶åŠŸèƒ½æ˜ å°„ï¼');
                            console.error('columnBé•¿åº¦:', columnB.length);
                            console.error('columnCé•¿åº¦:', columnC.length);
                            console.error('è·³è¿‡ç©ºè¡Œ:', skippedEmpty);
                            console.error('è·³è¿‡å ä½ç¬¦:', skippedDash);
                            console.error('å‰5ä¸ªBåˆ—å€¼:', columnB.slice(0, 5));
                            console.error('å‰5ä¸ªCåˆ—å€¼:', columnC.slice(0, 5));

                            alert('Connlistæ–‡ä»¶å¤„ç†å¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æ’ä»¶ä»£ç å’ŒåŠŸèƒ½æè¿°\n\nè¯·æ£€æŸ¥ï¼š\n1. Båˆ—æ˜¯å¦åŒ…å«æ’ä»¶ä»£ç \n2. Cåˆ—æ˜¯å¦åŒ…å«åŠŸèƒ½æè¿°\n3. æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºã€é"-"ï¼‰\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰');
                            reject(new Error('No valid mappings found'));
                            return;
                        }

                        console.log('âœ… Connlistå¤„ç†æˆåŠŸï¼å…±å»ºç«‹', Object.keys(connectorFunctions).length, 'ä¸ªæ˜ å°„');
                        console.log('æœ‰æ•ˆæ•°æ®:', validCount, 'è·³è¿‡ç©ºè¡Œ:', skippedEmpty, 'è·³è¿‡å ä½ç¬¦:', skippedDash);


                        resolve();
                    } catch (error) {
                        console.error('âŒ Connlistå¤„ç†å¼‚å¸¸:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function processInlineFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        if (jsonData.length === 0) {
                            alert('Inlineæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                            reject(new Error('Empty inline file'));
                            return;
                        }

                        // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
                        inlineMapping = {};
                        inlineCodes.clear();

                        // æ„å»ºinlineæ˜ å°„ï¼ˆåŒå‘ï¼‰
                        let validCount = 0;
                        jsonData.forEach(row => {
                            const left = String(row['INLINE-LEFT'] || '').trim();
                            const right = String(row['INLINE-RIGHT'] || '').trim();

                            if (left && right && left !== '-' && right !== '-') {
                                const normalizedLeft = left.toUpperCase();
                                const normalizedRight = right.toUpperCase();

                                // åŒå‘æ˜ å°„
                                inlineMapping[normalizedLeft] = normalizedRight;
                                inlineMapping[normalizedRight] = normalizedLeft;

                                // æ·»åŠ åˆ°ä»£ç é›†åˆ
                                inlineCodes.add(normalizedLeft);
                                inlineCodes.add(normalizedRight);

                                validCount++;
                            }
                        });

                        console.log(`âœ… Inlineæ–‡ä»¶å·²åŠ è½½ï¼šè¯†åˆ«åˆ° ${validCount} å¯¹è¿æ¥ï¼Œå…± ${inlineCodes.size} ä¸ªä»£ç `);

                        if (inlineCodes.size === 0) {
                            alert('Inlineæ–‡ä»¶æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®\n\nè¯·ç¡®ä¿æ–‡ä»¶åŒ…å«INLINE-LEFTå’ŒINLINE-RIGHTåˆ—');
                            reject(new Error('No valid inline data'));
                            return;
                        }

                        resolve();
                    } catch (error) {
                        console.error('âŒ Inlineå¤„ç†å¼‚å¸¸:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // æ„å»ºwirelistç´¢å¼• - åŠ é€ŸæŸ¥æ‰¾æ€§èƒ½
        function buildWirelistIndex(data) {
            const index = new Map(); // key: "code-pin" -> value: [wire1, wire2, ...]

            data.forEach(wire => {
                const from = String(wire.from || '').trim().toUpperCase();
                const to = String(wire.to || '').trim().toUpperCase();
                const fromPin = String(wire.fromPin || '').trim();
                const toPin = String(wire.toPin || '').trim();

                // ç´¢å¼•FROMç«¯
                const fromKey = fromPin ? `${from}-${fromPin}` : from;
                if (!index.has(fromKey)) {
                    index.set(fromKey, []);
                }
                index.get(fromKey).push(wire);

                // ç´¢å¼•TOç«¯
                const toKey = toPin ? `${to}-${toPin}` : to;
                if (!index.has(toKey)) {
                    index.set(toKey, []);
                }
                index.get(toKey).push(wire);
            });

            return index;
        }

        // æ ¹æ®code-pinå¿«é€ŸæŸ¥æ‰¾å¯¹åº”çš„wire
        function findWiresByCodePin(code, pin, wirelistIndex) {
            const key = pin ? `${code}-${pin}` : code;
            return wirelistIndex.get(key) || [];
        }

        // æ„å»ºè¿é€šå›¾ - V4.2ï¼šåŒ…å«inlineå’Œç„Šç‚¹ï¼Œç”¨äºæŸ¥æ‰¾æ‰€æœ‰è¿æ¥
        function buildConnectivityGraph(data) {
            const graph = new Map(); // èŠ‚ç‚¹ -> ç›¸é‚»èŠ‚ç‚¹åˆ—è¡¨

            // æ·»åŠ è¾¹åˆ°å›¾ä¸­
            function addEdge(node1, node2) {
                if (!node1 || !node2) return;
                if (!graph.has(node1)) {
                    graph.set(node1, new Set());
                }
                if (!graph.has(node2)) {
                    graph.set(node2, new Set());
                }
                graph.get(node1).add(node2);
                graph.get(node2).add(node1);
            }

            // ç¬¬ä¸€æ­¥ï¼šéå†æ‰€æœ‰wireï¼Œæ„å»ºç›´æ¥è¿æ¥
            data.forEach(wire => {
                const from = String(wire.from || '').trim().toUpperCase();
                const to = String(wire.to || '').trim().toUpperCase();
                const fromPin = String(wire.fromPin || '').trim();
                const toPin = String(wire.toPin || '').trim();

                if (!from || !to) return;

                // 1. ç›´æ¥è¿æ¥ï¼šFROM -> TO
                const fromNode = fromPin ? `${from}-${fromPin}` : from;
                const toNode = toPin ? `${to}-${toPin}` : to;
                addEdge(fromNode, toNode);
            });

            // ç¬¬äºŒæ­¥ï¼šå¤„ç†ç„Šç‚¹è¿æ¥ï¼ˆæ‰€æœ‰è¿æ¥åˆ°åŒä¸€ç„Šç‚¹çš„èŠ‚ç‚¹äº’ç›¸è¿æ¥ï¼‰
            const solderPoints = new Map(); // ç„Šç‚¹ä»£ç  -> è¿æ¥çš„èŠ‚ç‚¹åˆ—è¡¨

            data.forEach(wire => {
                const from = String(wire.from || '').trim().toUpperCase();
                const to = String(wire.to || '').trim().toUpperCase();
                const fromPin = String(wire.fromPin || '').trim();
                const toPin = String(wire.toPin || '').trim();

                // æ”¶é›†FROMç«¯ç„Šç‚¹
                if (fromPin === 'X') {
                    const fromNode = from; // ç„Šç‚¹èŠ‚ç‚¹ï¼ˆä¸å¸¦pinï¼‰
                    if (!solderPoints.has(fromNode)) {
                        solderPoints.set(fromNode, []);
                    }
                    // æ”¶é›†è¿æ¥åˆ°è¿™ä¸ªç„Šç‚¹çš„å¦ä¸€ç«¯èŠ‚ç‚¹
                    const toNode = toPin ? `${to}-${toPin}` : to;
                    solderPoints.get(fromNode).push(toNode);
                }

                // æ”¶é›†TOç«¯ç„Šç‚¹
                if (toPin === 'X') {
                    const toNode = to; // ç„Šç‚¹èŠ‚ç‚¹ï¼ˆä¸å¸¦pinï¼‰
                    if (!solderPoints.has(toNode)) {
                        solderPoints.set(toNode, []);
                    }
                    // æ”¶é›†è¿æ¥åˆ°è¿™ä¸ªç„Šç‚¹çš„å¦ä¸€ç«¯èŠ‚ç‚¹
                    const fromNode = fromPin ? `${from}-${fromPin}` : from;
                    solderPoints.get(toNode).push(fromNode);
                }
            });

            // å°†è¿æ¥åˆ°åŒä¸€ç„Šç‚¹çš„æ‰€æœ‰èŠ‚ç‚¹äº’ç›¸è¿æ¥
            solderPoints.forEach((nodes, solderPoint) => {
                // æ‰€æœ‰è¿æ¥åˆ°è¿™ä¸ªç„Šç‚¹çš„èŠ‚ç‚¹äº’ç›¸è¿æ¥
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        addEdge(nodes[i], nodes[j]);
                    }
                }
            });

            // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†Inlineè¿æ¥ï¼ˆç›¸åŒpinçš„inlineä¸¤ç«¯äº’ç›¸è¿æ¥ï¼‰
            data.forEach(wire => {
                const from = String(wire.from || '').trim().toUpperCase();
                const to = String(wire.to || '').trim().toUpperCase();
                const fromPin = String(wire.fromPin || '').trim();
                const toPin = String(wire.toPin || '').trim();

                if (!from || !to) return;

                const fromNode = fromPin ? `${from}-${fromPin}` : from;
                const toNode = toPin ? `${to}-${toPin}` : to;

                // æ£€æŸ¥FROMæ˜¯å¦åœ¨inlineä¸­
                if (inlineMapping[from]) {
                    const inlineTarget = inlineMapping[from];
                    // æŸ¥æ‰¾æ‰€æœ‰è¿æ¥åˆ°inlineç›®æ ‡ç«¯ä¸”pinç›¸åŒçš„èŠ‚ç‚¹
                    data.forEach(otherWire => {
                        if (otherWire === wire) return;
                        const otherFrom = String(otherWire.from || '').trim().toUpperCase();
                        const otherTo = String(otherWire.to || '').trim().toUpperCase();
                        const otherFromPin = String(otherWire.fromPin || '').trim();
                        const otherToPin = String(otherWire.toPin || '').trim();

                        // å¦‚æœotherWireçš„FROMè¿æ¥åˆ°inlineç›®æ ‡ç«¯ï¼Œä¸”pinç›¸åŒ
                        if (otherFrom === inlineTarget && otherFromPin === fromPin) {
                            const otherToNode = otherToPin ? `${otherTo}-${otherToPin}` : otherTo;
                            addEdge(fromNode, otherToNode);
                        }
                        // å¦‚æœotherWireçš„TOè¿æ¥åˆ°inlineç›®æ ‡ç«¯ï¼Œä¸”pinç›¸åŒ
                        if (otherTo === inlineTarget && otherToPin === fromPin) {
                            const otherFromNode = otherFromPin ? `${otherFrom}-${otherFromPin}` : otherFrom;
                            addEdge(fromNode, otherFromNode);
                        }
                    });
                }

                // æ£€æŸ¥TOæ˜¯å¦åœ¨inlineä¸­
                if (inlineMapping[to]) {
                    const inlineTarget = inlineMapping[to];
                    // æŸ¥æ‰¾æ‰€æœ‰è¿æ¥åˆ°inlineç›®æ ‡ç«¯ä¸”pinç›¸åŒçš„èŠ‚ç‚¹
                    data.forEach(otherWire => {
                        if (otherWire === wire) return;
                        const otherFrom = String(otherWire.from || '').trim().toUpperCase();
                        const otherTo = String(otherWire.to || '').trim().toUpperCase();
                        const otherFromPin = String(otherWire.fromPin || '').trim();
                        const otherToPin = String(otherWire.toPin || '').trim();

                        // å¦‚æœotherWireçš„FROMè¿æ¥åˆ°inlineç›®æ ‡ç«¯ï¼Œä¸”pinç›¸åŒ
                        if (otherFrom === inlineTarget && otherFromPin === toPin) {
                            const otherToNode = otherToPin ? `${otherTo}-${otherToPin}` : otherTo;
                            addEdge(toNode, otherToNode);
                        }
                        // å¦‚æœotherWireçš„TOè¿æ¥åˆ°inlineç›®æ ‡ç«¯ï¼Œä¸”pinç›¸åŒ
                        if (otherTo === inlineTarget && otherToPin === toPin) {
                            const otherFromNode = otherFromPin ? `${otherFrom}-${otherFromPin}` : otherFrom;
                            addEdge(toNode, otherFromNode);
                        }
                    });
                }
            });

            console.log('âœ… V4.2è¿é€šå›¾æ„å»ºå®Œæˆï¼ˆåŒ…å«inlineå’Œç„Šç‚¹ï¼‰ï¼ŒèŠ‚ç‚¹æ•°:', graph.size);
            return graph;
        }

        // åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸ºä¸­é—´èŠ‚ç‚¹ï¼ˆinlineæˆ–ç„Šç‚¹ï¼‰
        function isIntermediateNode(node) {
            const nodeUpper = String(node).trim().toUpperCase();

            // æå–codeéƒ¨åˆ†ï¼ˆä¸å«pinï¼‰
            let code = nodeUpper;
            if (code.includes('-')) {
                code = code.split('-')[0];
            }

            // 1. æ£€æŸ¥æ˜¯å¦ä¸ºinlineèŠ‚ç‚¹
            if (inlineMapping[code]) {
                return true;
            }

            // 2. æ£€æŸ¥æ˜¯å¦ä¸ºç„Šç‚¹èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹åæœ¬èº«ä¸å¸¦pinï¼Œè¯´æ˜æ˜¯ç„Šç‚¹ï¼‰
            // æˆ–è€…èŠ‚ç‚¹åŒ…å«-X
            if (!nodeUpper.includes('-') || nodeUpper.endsWith('-X')) {
                return true;
            }

            return false;
        }

        // æŸ¥æ‰¾æ‰€æœ‰ä¸èµ·ç‚¹è¿é€šçš„èŠ‚ç‚¹ï¼ˆBFSï¼‰
        function findConnectedNodes(startNode, graph) {
            if (!graph.has(startNode)) return [];

            const visited = new Set();
            const queue = [startNode];
            const connectedNodes = [];

            while (queue.length > 0) {
                const node = queue.shift();
                if (visited.has(node)) continue;
                visited.add(node);

                // ä¸åŒ…å«èµ·ç‚¹æœ¬èº«
                if (node !== startNode) {
                    connectedNodes.push(node);
                }

                // æ·»åŠ æ‰€æœ‰ç›¸é‚»èŠ‚ç‚¹
                const neighbors = graph.get(node);
                if (neighbors) {
                    neighbors.forEach(neighbor => {
                        if (!visited.has(neighbor)) {
                            queue.push(neighbor);
                        }
                    });
                }
            }

            return connectedNodes;
        }

        // è¯†åˆ«åŒä¸€å›è·¯ï¼ˆä¿ç•™åŸæœ‰æ¥å£ï¼‰
        function identifyCircuitGroups(data) {
            const groups = [];
            const processed = new Set();

            data.forEach((item, index) => {
                if (processed.has(index)) return;

                const group = {
                    groupId: groups.length + 1,
                    wires: [item],
                    allFunctions: item.fuseFunction ? [item.fuseFunction] : []
                };

                processed.add(index);
                groups.push(group);
            });

            return groups;
        }

        // æŸ¥æ‰¾ç›¸å…³çš„å›è·¯ï¼ˆé€šè¿‡inlineè¿æ¥ï¼‰
        function findRelatedWires(item, data, currentIndex) {
            const related = new Set();
            const from = String(item.from || '').trim().toUpperCase();
            const to = String(item.to || '').trim().toUpperCase();
            const fromPin = String(item.fromPin || '').trim();
            const toPin = String(item.toPin || '').trim();

            // 1. æ£€æŸ¥inlineè¿æ¥
            // å¦‚æœFROMåœ¨inlineä¸­ï¼ŒæŸ¥æ‰¾è¿æ¥åˆ°å¯¹åº”ç«¯çš„å›è·¯
            if (inlineMapping[from]) {
                const inlineTarget = inlineMapping[from];
                data.forEach((wire, idx) => {
                    if (idx === currentIndex) return;
                    const wireFrom = String(wire.from || '').trim().toUpperCase();
                    const wireTo = String(wire.to || '').trim().toUpperCase();

                    // æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°inlineå¯¹åº”ç«¯ä¸”pinç›¸åŒ
                    if ((wireFrom === inlineTarget && fromPin === wire.fromPin) ||
                        (wireTo === inlineTarget && toPin === wire.toPin)) {
                        related.add(idx);
                    }
                });
            }

            // å¦‚æœTOåœ¨inlineä¸­ï¼ŒæŸ¥æ‰¾è¿æ¥åˆ°å¯¹åº”ç«¯çš„å›è·¯
            if (inlineMapping[to]) {
                const inlineTarget = inlineMapping[to];
                data.forEach((wire, idx) => {
                    if (idx === currentIndex) return;
                    const wireFrom = String(wire.from || '').trim().toUpperCase();
                    const wireTo = String(wire.to || '').trim().toUpperCase();

                    // æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°inlineå¯¹åº”ç«¯ä¸”pinç›¸åŒ
                    if ((wireFrom === inlineTarget && fromPin === wire.fromPin) ||
                        (wireTo === inlineTarget && toPin === wire.toPin)) {
                        related.add(idx);
                    }
                });
            }

            // 2. æ£€æŸ¥ç„Šç‚¹è¿æ¥ï¼ˆå·²æœ‰é€»è¾‘ï¼‰
            if (fromPin === 'X' || toPin === 'X') {
                data.forEach((wire, idx) => {
                    if (idx === currentIndex) return;
                    const wireFrom = String(wire.from || '').trim().toUpperCase();
                    const wireTo = String(wire.to || '').trim().toUpperCase();
                    const wireFromPin = String(wire.fromPin || '').trim();
                    const wireToPin = String(wire.toPin || '').trim();

                    // æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°åŒä¸€ç„Šç‚¹
                    if ((fromPin === 'X' && wireFromPin === 'X' && wireTo === to) ||
                        (toPin === 'X' && wireToPin === 'X' && wireFrom === from)) {
                        related.add(idx);
                    }
                });
            }

            return Array.from(related);
        }

        // è·å–inlineå¦ä¸€ä¾§è¿æ¥çš„æ‰€æœ‰å›è·¯
        function getInlineConnectedWires(inlineTargetCode, targetPin, currentFrom) {
            const connectedWires = [];
            const currentFromUpper = String(currentFrom || '').trim().toUpperCase();

            // åœ¨wirelistä¸­æŸ¥æ‰¾æ‰€æœ‰è¿æ¥åˆ°inlineç›®æ ‡ç«¯çš„å›è·¯
            wirelistAllData.forEach(wire => {
                const wireFrom = String(wire.from || '').trim().toUpperCase();
                const wireTo = String(wire.to || '').trim().toUpperCase();
                const wireFromPin = String(wire.fromPin || '').trim();
                const wireToPin = String(wire.toPin || '').trim();

                // æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°inlineç›®æ ‡ç«¯ä¸”pinç›¸åŒ
                // æƒ…å†µ1: FROM = inlineç›®æ ‡ä»£ç  ä¸” FromPin = ç›®æ ‡Pin
                if (wireFrom === inlineTargetCode && wireFromPin === targetPin) {
                    // è·å–å¦ä¸€ç«¯çš„ä»£ç ï¼ˆTOç«¯ï¼‰
                    const otherEnd = wireTo;
                    if (otherEnd && otherEnd !== currentFromUpper && otherEnd !== inlineTargetCode) {
                        // æ ¼å¼ï¼šä»£ç -Pin
                        const displayFormat = wireToPin ? `${otherEnd}-${wireToPin}` : otherEnd;
                        connectedWires.push(displayFormat);
                    }
                }

                // æƒ…å†µ2: TO = inlineç›®æ ‡ä»£ç  ä¸” ToPin = ç›®æ ‡Pin
                if (wireTo === inlineTargetCode && wireToPin === targetPin) {
                    // è·å–å¦ä¸€ç«¯çš„ä»£ç ï¼ˆFROMç«¯ï¼‰
                    const otherEnd = wireFrom;
                    if (otherEnd && otherEnd !== currentFromUpper && otherEnd !== inlineTargetCode) {
                        // æ ¼å¼ï¼šä»£ç -Pin
                        const displayFormat = wireFromPin ? `${otherEnd}-${wireFromPin}` : otherEnd;
                        connectedWires.push(displayFormat);
                    }
                }
            });

            // å»é‡
            return [...new Set(connectedWires)];
        }

        // Data validation function
        async function validateData() {
            let warnings = [];
            let errors = [];

            // éªŒè¯çº¿å¾„
            if (configSettings.validateWireDiameter) {
                const abnormalWires = allData.filter(item => {
                    const wireDiameter = item.wireDiameter;
                    return wireDiameter < 0.3 || wireDiameter > 10.0;
                });

                if (abnormalWires.length > 0) {
                    warnings.push(`å‘ç° ${abnormalWires.length} æ¡çº¿å¾„å¼‚å¸¸æ•°æ®ï¼ˆ<0.3mmÂ² æˆ– >10mmÂ²ï¼‰`);
                    console.warn(`âš ï¸ çº¿å¾„å¼‚å¸¸: ${abnormalWires.length} æ¡`);
                }
            }

            // éªŒè¯ä¿é™©ä¸è§„æ ¼
            if (configSettings.validateFuseRating) {
                const noFuseRating = allData.filter(item => item.fuseRating === 'éœ€äººå·¥ç¡®è®¤');

                if (noFuseRating.length > 0) {
                    warnings.push(`å‘ç° ${noFuseRating.length} æ¡æ— æ³•åŒ¹é…ä¿é™©ä¸è§„æ ¼çš„æ•°æ®`);
                    console.warn(`âš ï¸ æ— æ³•åŒ¹é…ä¿é™©ä¸: ${noFuseRating.length} æ¡`);
                }
            }

            // éªŒè¯ä¿é™©ä¸åŠŸèƒ½
            const noFuseFunction = allData.filter(item => item.fuseFunction === 'æ— ');
            if (noFuseFunction.length > 0) {
                warnings.push(`å‘ç° ${noFuseFunction.length} æ¡æ— ä¿é™©ä¸åŠŸèƒ½æè¿°çš„æ•°æ®`);
                console.warn(`âš ï¸ æ— ä¿é™©ä¸åŠŸèƒ½: ${noFuseFunction.length} æ¡`);
            }

            // æ˜¾ç¤ºéªŒè¯ç»“æœ
            if (warnings.length > 0) {
                showAlert('warning', warnings.join('\n'));
            }

            return { errors, warnings };
        }

        // Analysis dashboard
        function displayAnalysisDashboard() {
            const dashboard = document.getElementById('analysisDashboard');

            if (filteredData.length === 0) {
                dashboard.classList.remove('active');
                return;
            }

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const wireDiameters = filteredData.map(d => d.wireDiameter).filter(d => d > 0);
            const avgWireDiameter = wireDiameters.length > 0
                ? (wireDiameters.reduce((a, b) => a + b, 0) / wireDiameters.length).toFixed(2)
                : 0;
            const minWireDiameter = wireDiameters.length > 0 ? Math.min(...wireDiameters).toFixed(2) : 0;
            const maxWireDiameter = wireDiameters.length > 0 ? Math.max(...wireDiameters).toFixed(2) : 0;

            const solderJointCount = filteredData.filter(d => d.connectionType === 'ç„Šç‚¹').length;
            const directConnectionCount = filteredData.filter(d => d.connectionType === 'ç›´æ¥è¿æ¥').length;
            const abnormalDataCount = filteredData.filter(d =>
                d.note === 'éœ€äººå·¥ç¡®è®¤' || d.fuseFunction === 'æ— '
            ).length;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('avgWireDiameter').textContent = avgWireDiameter;
            document.getElementById('minWireDiameter').textContent = minWireDiameter;
            document.getElementById('maxWireDiameter').textContent = maxWireDiameter;
            document.getElementById('solderJointCount').textContent = solderJointCount;
            document.getElementById('directConnectionCount').textContent = directConnectionCount;
            document.getElementById('abnormalDataCount').textContent = abnormalDataCount;

            // å¦‚æœæœ‰å¼‚å¸¸æ•°æ®ï¼Œæ”¹å˜é¢œè‰²
            const abnormalElement = document.getElementById('abnormalDataCount');
            if (abnormalDataCount > 0) {
                abnormalElement.style.color = 'var(--accent-orange)';
            } else {
                abnormalElement.style.color = 'var(--accent-lime)';
            }

            dashboard.classList.add('active');
        }

        function findColumns(row) {
            const columns = {};

            Object.keys(row).forEach(key => {
                const normalizedKey = key.toLowerCase().trim();

                // è¯†åˆ«Wire IDåˆ—ï¼ˆå›è·¯å·ï¼‰
                if (normalizedKey === 'wire id' || normalizedKey === 'wireid' ||
                    (normalizedKey.includes('wire') && normalizedKey.includes('id')) ||
                    normalizedKey === 'id' || normalizedKey === 'çº¿è·¯å·' || normalizedKey === 'å›è·¯å·') {
                    columns.wireId = key;
                }
                // è¯†åˆ«çº¿å¾„åˆ—
                else if (normalizedKey.includes('çº¿å¾„') || normalizedKey.includes('wire') ||
                    normalizedKey.includes('diameter') || normalizedKey.includes('æˆªé¢') ||
                    normalizedKey.includes('size') || normalizedKey.includes('gauge') ||
                    normalizedKey.includes('mm2') || normalizedKey.includes('mmÂ²')) {
                    columns.wireDiameter = key;
                }
                // è¯†åˆ«ç”µè·¯ç±»å‹åˆ—
                else if (normalizedKey.includes('ç”µè·¯') || normalizedKey.includes('circuit')) {
                    columns.circuitType = key;
                }
                // è¯†åˆ«çº¿æŸç±»å‹åˆ—ï¼ˆä¼˜å…ˆIdent Tagï¼‰
                else if (normalizedKey === 'ident tag' || normalizedKey === 'identtag' ||
                         normalizedKey === 'ident' || normalizedKey.includes('ident')) {
                    columns.harnessType = key;
                }
                else if (normalizedKey.includes('çº¿æŸ') || normalizedKey.includes('harness')) {
                    columns.harnessType = key;
                }
                // è¯†åˆ«Optionåˆ—
                else if (normalizedKey === 'option' || normalizedKey === 'options') {
                    columns.option = key;
                }
                // è¯†åˆ«FROMåˆ— - ä¼˜å…ˆåŒ¹é… "from code"ï¼Œé¿å…åŒ¹é… "from pin"
                else if (normalizedKey === 'from code' || normalizedKey === 'fromcode') {
                    columns.from = key;
                }
                else if (!columns.from && (normalizedKey === 'from' || normalizedKey === 'fromè®¾å¤‡' ||
                    normalizedKey.includes('æº') || normalizedKey.includes('source'))) {
                    columns.from = key;
                }
                // è¯†åˆ«From Pinåˆ—
                else if (normalizedKey === 'from pin' || normalizedKey === 'frompin' ||
                    (normalizedKey.includes('from') && normalizedKey.includes('pin'))) {
                    columns.fromPin = key;
                }
                // è¯†åˆ«TOåˆ— - ä¼˜å…ˆåŒ¹é… "to code"ï¼Œé¿å…åŒ¹é… "to pin"
                else if (normalizedKey === 'to code' || normalizedKey === 'tocode') {
                    columns.to = key;
                }
                else if (!columns.to && (normalizedKey === 'to' || normalizedKey === 'toè®¾å¤‡' ||
                    normalizedKey.includes('ç›®æ ‡') || normalizedKey.includes('destination'))) {
                    columns.to = key;
                }
                // è¯†åˆ«To Pinåˆ—
                else if (normalizedKey === 'to pin' || normalizedKey === 'topin' ||
                    (normalizedKey.includes('to') && normalizedKey.includes('pin'))) {
                    columns.toPin = key;
                }
            });

            return columns;
        }

        function determineConnectionType(fromCode, toCode, fromPin, toPin) {
            const fromPinUpper = String(fromPin).trim().toUpperCase();
            const toPinUpper = String(toPin).trim().toUpperCase();

            // åˆ¤æ–­æ˜¯å¦ä¸ºç„Šç‚¹ï¼šFrom Pinæˆ–To Pinæœ‰ä¸€ç«¯æ˜¯X
            const isSolderJoint = (fromPinUpper === 'X' || toPinUpper === 'X');

            return isSolderJoint ? 'ç„Šç‚¹' : 'ç›´æ¥è¿æ¥';
        }

        function getConnectorsForSolderJoint(fromCode, toCode, fromPin, toPin) {
            // å¯¹äºç„Šç‚¹ï¼ŒæŸ¥æ‰¾è¿æ¥çš„æ‰€æœ‰å…¶ä»–å›è·¯çš„æ’ä»¶ä»£ç å’ŒPinè„š
            const fromUpper = String(fromCode).trim().toUpperCase();
            const toUpper = String(toCode).trim().toUpperCase();
            const fromPinUpper = String(fromPin).trim().toUpperCase();
            const toPinUpper = String(toPin).trim().toUpperCase();

            // ç¡®å®šå“ªä¸€ç«¯æ˜¯ç„Šç‚¹ï¼ˆPin=Xçš„é‚£ç«¯ï¼‰
            // é‡è¦ï¼šå¦‚æœä¸¤ç«¯éƒ½æ˜¯Xï¼Œç„Šç‚¹åº”è¯¥æ˜¯éç”µå™¨ç›’ç«¯
            let solderPointCode = null;

            // æ£€æŸ¥å“ªä¸€ç«¯æ˜¯ç”µå™¨ç›’
            const fromIsBox = validCodes.some(code => fromUpper.includes(code));
            const toIsBox = validCodes.some(code => toUpper.includes(code));

            if (fromPinUpper === 'X' && toPinUpper === 'X') {
                // ä¸¤ç«¯éƒ½æ˜¯Xï¼Œé€‰æ‹©éç”µå™¨ç›’ç«¯ä½œä¸ºç„Šç‚¹
                if (fromIsBox && !toIsBox) {
                    solderPointCode = toUpper;  // TOç«¯æ˜¯éç”µå™¨ç›’ï¼Œæ˜¯ç„Šç‚¹
                } else if (!fromIsBox && toIsBox) {
                    solderPointCode = fromUpper;  // FROMç«¯æ˜¯éç”µå™¨ç›’ï¼Œæ˜¯ç„Šç‚¹
                } else if (fromIsBox && toIsBox) {
                    // ä¸¤ç«¯éƒ½æ˜¯ç”µå™¨ç›’ï¼Œæ— æ³•ç¡®å®š
                    return [];
                } else {
                    // ä¸¤ç«¯éƒ½ä¸æ˜¯ç”µå™¨ç›’ï¼Œä¼˜å…ˆé€‰TOç«¯
                    solderPointCode = toUpper;
                }
            } else if (fromPinUpper === 'X') {
                solderPointCode = fromUpper;  // FROMç«¯æ˜¯ç„Šç‚¹
            } else if (toPinUpper === 'X') {
                solderPointCode = toUpper;   // TOç«¯æ˜¯ç„Šç‚¹
            }

            if (!solderPointCode) {
                return [];  // æ²¡æœ‰ç„Šç‚¹
            }


            // æŸ¥æ‰¾æ‰€æœ‰è¿æ¥åˆ°è¿™ä¸ªç„Šç‚¹çš„å…¶ä»–å›è·¯
            // æ¡ä»¶ï¼šTO = ç„Šç‚¹ä»£ç  ä¸” TO Pin = X
            let relatedWires = wirelistAllData.filter(wire => {
                const wireToUpper = String(wire.to).trim().toUpperCase();
                const wireToPinUpper = String(wire.toPin || '').trim().toUpperCase();

                // TOå¿…é¡»å®Œå…¨ç­‰äºç„Šç‚¹ä»£ç ï¼Œä¸”TO Pinå¿…é¡»æ˜¯X
                return (wireToUpper === solderPointCode && wireToPinUpper === 'X');
            });

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä½¿ç”¨åŒ…å«åŒ¹é…ï¼ˆå¯èƒ½ç„Šç‚¹ä»£ç æ˜¯å…¶ä»–æ ¼å¼ï¼‰
            if (relatedWires.length === 0) {
                // å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼šTOåŒ…å«ç„Šç‚¹ä»£ç 
                const relatedWiresFuzzy = wirelistAllData.filter(wire => {
                    const wireToUpper = String(wire.to).trim().toUpperCase();
                    const wireToPinUpper = String(wire.toPin || '').trim().toUpperCase();

                    return (wireToUpper.includes(solderPointCode) || solderPointCode.includes(wireToUpper)) && wireToPinUpper === 'X';
                });
                relatedWires = relatedWiresFuzzy;
            }

            // æ”¶é›†æ‰€æœ‰å›è·¯çš„FROMç«¯æ’ä»¶ä»£ç å’ŒPinè„š
            const connectorArray = [];
            relatedWires.forEach(wire => {
                const wireFromUpper = String(wire.from).trim().toUpperCase();
                const wireFromPinUpper = String(wire.fromPin || '').trim().toUpperCase();

                // æ·»åŠ FROMä»£ç å’ŒPinï¼ˆæ ¼å¼ï¼šä»£ç -Pinï¼‰
                if (wireFromUpper && wireFromUpper !== '') {
                    const connectorWithPin = wireFromPinUpper && wireFromPinUpper !== ''
                        ? `${wireFromUpper}-${wireFromPinUpper}`
                        : wireFromUpper;
                    connectorArray.push(connectorWithPin);
                }
            });

            return connectorArray;
        }


        function processData(jsonData, columns, wirelistData, circuitGraph, wirelistIndex) {
            const processed = jsonData.map((row, index) => {
                // å®‰å…¨åœ°è·å–Wire IDï¼Œå¦‚æœåˆ—ä¸å­˜åœ¨åˆ™ä½¿ç”¨ç´¢å¼•
                let wireId = `Wire${index + 1}`;
                if (columns.wireId && row[columns.wireId]) {
                    wireId = String(row[columns.wireId]);
                } else if (columns.wireDiameter && row[columns.wireDiameter]) {
                    wireId = String(row[columns.wireDiameter]);
                }

                const wireDiameter = columns.wireDiameter ? parseFloat(row[columns.wireDiameter] || 0) : 0;
                const circuitType = (columns.circuitType && row[columns.circuitType]) ? String(row[columns.circuitType]) : 'æœªçŸ¥';
                const harnessType = (columns.harnessType && row[columns.harnessType]) ? String(row[columns.harnessType]) : 'é»˜è®¤çº¿æŸ';
                const option = (columns.option && row[columns.option]) ? String(row[columns.option]) : '';

                // è°ƒè¯•ï¼šè¾“å‡ºå‰3æ¡æ•°æ®çš„çº¿æŸç±»å‹å’ŒOptionä¿¡æ¯
                if (index < 3) {
                    console.log(`å›è·¯${index + 1}: åˆ—å="${columns.harnessType || 'æœªæ‰¾åˆ°'}", çº¿æŸç±»å‹å€¼="${harnessType}", Option="${option}"`);
                }

                const fromValue = columns.from ? String(row[columns.from] || '') : '';
                const toValue = columns.to ? String(row[columns.to] || '') : '';
                const fromPinValue = columns.fromPin ? String(row[columns.fromPin] || '') : '';
                const toPinValue = columns.toPin ? String(row[columns.toPin] || '') : '';

                // FROM/TOè°ƒæ¢é€»è¾‘ï¼šå¦‚æœç”µå™¨ç›’ä»£ç åœ¨TOä½ç½®ï¼Œè°ƒæ¢åˆ°FROMä½ç½®
                let finalFrom = fromValue;
                let finalTo = toValue;
                let finalFromPin = fromPinValue;
                let finalToPin = toPinValue;
                let swapped = false;

                // å…ˆç”¨åŸå§‹å€¼åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ¢
                const originalFromUpper = String(fromValue).trim().toUpperCase();
                const originalToUpper = String(toValue).trim().toUpperCase();

                // æ£€æŸ¥TOæ˜¯å¦åŒ…å«ç”µå™¨ç›’ä»£ç 
                const toHasBoxCode = validCodes.some(code => originalToUpper.includes(code));
                // æ£€æŸ¥FROMæ˜¯å¦ä¸åŒ…å«ç”µå™¨ç›’ä»£ç 
                const fromHasBoxCode = validCodes.some(code => originalFromUpper.includes(code));

                // å¦‚æœTOæœ‰ç”µå™¨ç›’ä»£ç ä½†FROMæ²¡æœ‰ï¼Œåˆ™è°ƒæ¢
                if (toHasBoxCode && !fromHasBoxCode) {
                    finalFrom = toValue;
                    finalTo = fromValue;
                    finalFromPin = toPinValue;
                    finalToPin = fromPinValue;
                    swapped = true;
                }

                // æå–ä¿é™©ä¸ä»£å·ï¼šå–å›è·¯å·å‰å››ä½
                let fuseCode = '';
                if (wireId && wireId.length >= 4) {
                    fuseCode = wireId.substring(0, 4).toUpperCase();
                } else {
                    fuseCode = wireId.substring(0, 4).toUpperCase();
                }

                // åˆ¤æ–­è¿æ¥ç±»å‹
                const connectionType = determineConnectionType(finalFrom, finalTo, finalFromPin, finalToPin);

                // Find closest match in fuse mapping
                let fuseInfo = { rating: 'N/A', type: 'æœªçŸ¥', primary: 0 };
                let minDiff = Infinity;

                Object.entries(fuseMapping).forEach(([diameter, info]) => {
                    const diff = Math.abs(wireDiameter - parseFloat(diameter));
                    if (diff < minDiff) {
                        minDiff = diff;
                        fuseInfo = info;
                    }
                });

                // If no close match found, use default
                if (minDiff > 2) {
                    fuseInfo = { rating: 'éœ€äººå·¥ç¡®è®¤', type: 'æœªçŸ¥', primary: 0 };
                }

                // V4.2ï¼šæ˜¾ç¤ºTOåˆ—ï¼Œè¿‡æ»¤æ‰inlineå’Œç„Šç‚¹ä¸­é—´èŠ‚ç‚¹
                let toDisplay = '';
                let toWireIds = '';
                let toWireOptions = '';
                let toWireDiameters = '';
                const fromCode = finalFrom.trim().toUpperCase();
                const fromPin = finalFromPin ? String(finalFromPin).trim() : '';
                const fromNode = fromPin ? `${fromCode}-${fromPin}` : fromCode;

                // æŸ¥æ‰¾æ‰€æœ‰ä¸FROMè¿é€šçš„èŠ‚ç‚¹
                const connectedNodes = findConnectedNodes(fromNode, circuitGraph);

                if (connectedNodes.length > 0) {
                    // è¿‡æ»¤æ‰FROMæœ¬èº«å’Œä¸­é—´èŠ‚ç‚¹ï¼ˆinlineã€ç„Šç‚¹ï¼‰
                    const filteredNodes = connectedNodes.filter(node => {
                        const nodeUpper = node.toUpperCase();
                        const fromUpper = fromNode.toUpperCase();

                        // å»æ‰FROMæœ¬èº«
                        if (nodeUpper === fromUpper) return false;

                        // å»æ‰ä¸­é—´èŠ‚ç‚¹ï¼ˆinlineå’Œç„Šç‚¹ï¼‰
                        if (isIntermediateNode(node)) return false;

                        return true;
                    });

                    if (filteredNodes.length > 0) {
                        // ä¸ºæ¯ä¸ªèŠ‚ç‚¹æŸ¥æ‰¾å¯¹åº”çš„å›è·¯å·ã€optionå’Œçº¿å¾„ï¼Œä¿æŒä¸€ä¸€å¯¹åº”
                        const toList = [];
                        const wireIdList = [];
                        const optionList = [];
                        const diameterList = [];

                        filteredNodes.forEach(node => {
                            const nodeTrimmed = node.trim();
                            if (!nodeTrimmed) return;

                            // è§£æcodeå’Œpin
                            let code, pin;
                            if (nodeTrimmed.includes('-')) {
                                const parts = nodeTrimmed.split('-');
                                code = parts[0];
                                pin = parts.slice(1).join('-');
                            } else {
                                code = nodeTrimmed;
                                pin = '';
                            }

                            // æ·»åŠ åˆ°TOåˆ—è¡¨
                            toList.push(nodeTrimmed);

                            // ä½¿ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾å¯¹åº”çš„wireï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
                            const matchedWires = findWiresByCodePin(code, pin, wirelistIndex);

                            // æ”¶é›†å›è·¯å·ï¼ˆå¯èƒ½æœ‰å¤šä¸ªwireè¿æ¥åˆ°åŒä¸€ä¸ªç‚¹ï¼‰
                            const wireIds = [];
                            const options = [];
                            const diameters = [];

                            matchedWires.forEach(wire => {
                                if (wire.wireId && !wireIds.includes(wire.wireId)) {
                                    wireIds.push(wire.wireId);
                                }
                                // æ”¶é›†option
                                if (wire.option && !options.includes(wire.option)) {
                                    options.push(wire.option);
                                }
                                // æ”¶é›†çº¿å¾„
                                if (wire.wireDiameter && !diameters.includes(wire.wireDiameter)) {
                                    diameters.push(wire.wireDiameter);
                                }
                            });

                            // æ·»åŠ å›è·¯å·
                            if (wireIds.length > 0) {
                                wireIdList.push(wireIds.join(', '));
                            } else {
                                wireIdList.push('');
                            }

                            // æ·»åŠ option
                            if (options.length > 0) {
                                optionList.push(options.join(', '));
                            } else {
                                optionList.push('');
                            }

                            // æ·»åŠ çº¿å¾„
                            if (diameters.length > 0) {
                                // æ ¼å¼åŒ–çº¿å¾„æ˜¾ç¤º
                                diameterList.push(diameters.map(d => d.toFixed(2)).join(', '));
                            } else {
                                diameterList.push('');
                            }
                        });

                        // åˆå¹¶ä¸ºæ˜¾ç¤ºå­—ç¬¦ä¸²ï¼ˆä¿æŒå¯¹åº”å…³ç³»ï¼‰
                        toDisplay = toList.join('\n');
                        toWireIds = wireIdList.join('\n');
                        toWireOptions = optionList.join('\n');
                        toWireDiameters = diameterList.join('\n');
                    }
                }

                // è·å–ä¿é™©ä¸åŠŸèƒ½ï¼ˆå°†TOåˆ—å»é™¤PINè„šååœ¨connlistä¸­æŸ¥æ‰¾ï¼‰
                let fuseFunction = 'æ— ';
                // åªæœ‰å½“toDisplayä¸ä¸ºç©ºæ—¶æ‰å¤„ç†
                if (toDisplay && toDisplay.trim() !== '') {
                    const toDisplayLines = toDisplay.split('\n');

                    if (toDisplayLines.length > 0) {
                        const descriptions = [];

                        toDisplayLines.forEach((line, idx) => {
                            let connectorCode = line.trim();
                            if (!connectorCode) return;

                            // è§„èŒƒåŒ–ä»£ç ï¼šå»é™¤ç©ºæ ¼ï¼Œè½¬å¤§å†™
                            const normalizedCode = connectorCode.replace(/\s+/g, '').toUpperCase();

                            // å»é™¤æœ€åä¸€ä¸ª"-"åŠå…¶åé¢çš„PINè„š
                            let baseCode = normalizedCode;
                            if (baseCode.includes('-')) {
                                // æ‰¾åˆ°æœ€åä¸€ä¸ª"-"çš„ä½ç½®ï¼Œå»é™¤å®ƒåŠä¹‹åçš„æ‰€æœ‰å†…å®¹
                                const lastDashIndex = baseCode.lastIndexOf('-');
                                baseCode = baseCode.substring(0, lastDashIndex);
                            }

                            // åœ¨connlistä¸­æŸ¥æ‰¾
                            let matchedFunction = null;
                            if (baseCode && connectorFunctions[baseCode]) {
                                matchedFunction = connectorFunctions[baseCode];
                            }

                            // å¦‚æœæ‰¾åˆ°åŒ¹é…ï¼Œæ·»åŠ åˆ°æè¿°åˆ—è¡¨
                            if (matchedFunction) {
                                descriptions.push(matchedFunction);
                            }
                        });

                        if (descriptions.length > 0) {
                            fuseFunction = descriptions.join('\n');  // ä½¿ç”¨æ¢è¡Œç¬¦è¿æ¥
                        }
                    }
                }

                return {
                    index: index + 1,
                    wireId: wireId,
                    fuseCode: fuseCode,
                    wireDiameter: wireDiameter || 0,
                    circuitType: String(circuitType),
                    harnessType: String(harnessType),
                    option: option,  // Optioné…ç½®
                    from: finalFrom,
                    fromPin: finalFromPin,
                    to: finalTo,
                    toPin: finalToPin,
                    toDisplay: toDisplay,  // ç”¨äºæ˜¾ç¤ºçš„TOå€¼
                    toWireIds: toWireIds,  // TOåˆ—å¯¹åº”çš„å›è·¯å·
                    toWireOptions: toWireOptions,  // TOå¯¹åº”å›è·¯å·çš„Option
                    toWireDiameters: toWireDiameters,  // TOå¯¹åº”å›è·¯å·çš„çº¿å¾„
                    connectionType: connectionType,
                    fuseFunction: fuseFunction,  // ä¿é™©ä¸åŠŸèƒ½
                    fuseRating: fuseInfo.rating,
                    fuseType: fuseInfo.type,
                    fusePrimary: fuseInfo.primary,
                    note: minDiff > 0.1 ? 'æ¥è¿‘æ ‡å‡†è§„æ ¼' : 'æ ‡å‡†åŒ¹é…',
                    swapped: swapped
                };
            });

            // Debug: è¾“å‡ºå‰5æ¡æ•°æ®çš„FROMå’ŒTOå€¼
            processed.slice(0, 5).forEach((item, i) => {
            });

            // Filter rows to only include those with valid codes in FROM or TO
            const filtered = processed.filter(item => {
                // å»é™¤ç©ºæ ¼å¹¶è½¬ä¸ºå¤§å†™ï¼Œç¡®ä¿åŒ¹é…å‡†ç¡®
                const fromUpper = String(item.from).trim().toUpperCase();
                const toUpper = String(item.to).trim().toUpperCase();

                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•æœ‰æ•ˆä»£ç ï¼ˆåªè¦åŒ…å«è¯¥å­—ç¬¦å³å¯ï¼‰
                const matches = validCodes.some(code =>
                    fromUpper.includes(code) || toUpper.includes(code)
                );

                return matches;
            });

            // Debug: è¾“å‡ºè¿‡æ»¤åŸå› 

            // æ˜¾ç¤ºä¸€äº›åŒ¹é…ç¤ºä¾‹
            if (filtered.length > 0) {
                filtered.slice(0, 3).forEach((item, i) => {
                    const matchedCodes = [];
                    const fromUpper = item.from.toUpperCase();
                    const toUpper = item.to.toUpperCase();
                    validCodes.forEach(code => {
                        if (fromUpper.includes(code) || toUpper.includes(code)) {
                            matchedCodes.push(code);
                        }
                    });
                });
            }

            return filtered;
        }

        function initializeFilters() {
            filterButtons.innerHTML = '';

            // Add "å…¨éƒ¨" button
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.innerHTML = `å…¨éƒ¨ <span class="count">${allData.length}</span>`;
            allBtn.onclick = () => applyFilter(null, allBtn);
            filterButtons.appendChild(allBtn);

            // Add box-specific buttons
            Object.entries(boxFilters).forEach(([boxName, boxInfo]) => {
                const count = countByBox(boxInfo.codes);
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerHTML = `${boxName} <span class="count">${count}</span>`;
                btn.onclick = () => applyFilter(boxName, btn);
                filterButtons.appendChild(btn);
            });

            filterSection.classList.add('active');
        }

        function countByBox(codes) {
            return allData.filter(item => {
                const fromUpper = String(item.from).trim().toUpperCase();
                const toUpper = String(item.to).trim().toUpperCase();

                return codes.some(code =>
                    fromUpper.includes(code) || toUpper.includes(code)
                );
            }).length;
        }

        function applyFilter(filterName, clickedBtn) {
            activeFilter = filterName;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            clickedBtn.classList.add('active');

            // Apply filter
            if (filterName === null) {
                filteredData = [...allData];
            } else {
                const codes = boxFilters[filterName].codes;
                filteredData = allData.filter(item => {
                    const fromUpper = String(item.from).trim().toUpperCase();
                    const toUpper = String(item.to).trim().toUpperCase();

                    return codes.some(code =>
                        fromUpper.includes(code) || toUpper.includes(code)
                    );
                });
            }


            displayResults();
            displayStats();
            displayAnalysisDashboard();
        }

        function displayResults() {
            resultsBody.innerHTML = '';

            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (filteredData.length === 0) {
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®
                        </td>
                    </tr>
                `;
                resultsSection.classList.add('active');
                return;
            }

            // Group by harness type
            const grouped = {};
            filteredData.forEach(row => {
                if (!grouped[row.harnessType]) {
                    grouped[row.harnessType] = [];
                }
                grouped[row.harnessType].push(row);
            });

            Object.entries(grouped).forEach(([harnessType, rows]) => {
                // Add group header
                const headerRow = document.createElement('tr');
                headerRow.className = 'harness-group';
                headerRow.innerHTML = `
                    <td colspan="15">${harnessType} (${rows.length} æ¡çº¿è·¯)</td>
                `;
                resultsBody.appendChild(headerRow);

                // Add rows
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    const fuseClass = `fuse-${row.fusePrimary || 'unknown'}`;

                    // toDisplayå·²ç»åœ¨processDataä¸­è¢«è¿‡æ»¤è¿‡äº†ï¼Œç›´æ¥ä½¿ç”¨
                    const toDisplayContent = row.toDisplay || '';

                    tr.innerHTML = `
                        <td style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent-lime);">${row.fuseCode}</td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--text-primary);">${row.wireId}</td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-orange); font-weight: 500;">${row.option || ''}</td>
                        <td><span class="from-to-badge">${row.from}${row.fromPin ? '-' + row.fromPin : ''}</span></td>
                        <td>${toDisplayContent}</td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary);">${row.toWireIds || ''}</td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-orange);">${row.toWireOptions || ''}</td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-cyan);">${row.toWireDiameters || ''}</td>
                        <td title="${row.fuseFunction}">${row.fuseFunction}</td>
                        <td class="wire-diameter">${row.wireDiameter.toFixed(2)}</td>
                        <td>${row.circuitType}</td>
                        <td>${row.harnessType}</td>
                        <td><span class="fuse-badge ${fuseClass}">${row.fuseRating}</span></td>
                        <td><span class="fuse-type">${row.fuseType}</span></td>
                        <td style="color: ${row.note.includes('æ ‡å‡†') ? 'var(--accent-lime)' : 'var(--accent-orange)'}">${row.note}</td>
                    `;
                    resultsBody.appendChild(tr);
                });
            });

            resultsSection.classList.add('active');
        }

        function displayStats() {
            const totalCircuits = filteredData.length;
            const harnessCount = new Set(filteredData.map(d => d.harnessType)).size;

            // Count fuse ratings
            const fuseCounts = {};
            filteredData.forEach(row => {
                const key = row.fusePrimary;
                fuseCounts[key] = (fuseCounts[key] || 0) + 1;
            });

            // Calculate max for distribution bars
            const maxCount = Math.max(...Object.values(fuseCounts), 1);

            // Create stats cards
            statsSection.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æ€»çº¿è·¯æ•°</div>
                    <div class="stat-value">${totalCircuits}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çº¿æŸç±»å‹æ•°</div>
                    <div class="stat-value">${harnessCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä¿é™©ä¸è§„æ ¼æ•°</div>
                    <div class="stat-value">${Object.keys(fuseCounts).length}</div>
                </div>
            `;

            // Create distribution bars
            const sortedFuses = Object.entries(fuseCounts).sort((a, b) => a[0] - b[0]);
            distributionBars.innerHTML = sortedFuses.map(([fuse, count]) => {
                const percentage = (count / maxCount) * 100;
                const fuseClass = `fuse-${fuse}`;
                return `
                    <div class="distribution-bar">
                        <div class="bar-label">${fuse}A</div>
                        <div class="bar-track">
                            <div class="bar-fill ${fuseClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="bar-value">${count}</div>
                    </div>
                `;
            }).join('');
        }

        function handleSort(column) {
            // Update sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header classes
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(`sort-${currentSort.direction}`);
                }
            });

            // Sort data
            const multiplier = currentSort.direction === 'asc' ? 1 : -1;
            filteredData.sort((a, b) => {
                if (column === 'wireDiameter') {
                    return (a.wireDiameter - b.wireDiameter) * multiplier;
                } else if (column === 'fuseRating') {
                    return (a.fusePrimary - b.fusePrimary) * multiplier;
                } else {
                    return String(a[column]).localeCompare(String(b[column])) * multiplier;
                }
            });

            // Re-display
            displayResults();
        }

        async function exportToExcel() {
            if (filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('ä¿é™©ä¸åŒ¹é…æ¸…å•');

                // å®šä¹‰åˆ—
                const columns = [
                    { header: 'ä¿é™©ä¸ä»£å·', key: 'fuseCode', width: 12 },
                    { header: 'å›è·¯å·', key: 'wireId', width: 10 },
                    { header: 'Option', key: 'option', width: 8 },
                    { header: 'FROM', key: 'from', width: 12 },
                    { header: 'TO', key: 'to', width: 15 },
                    { header: 'TOå¯¹åº”å›è·¯å·', key: 'toWireIds', width: 40 },
                    { header: 'å›è·¯å·Option', key: 'toWireOptions', width: 30 },
                    { header: 'å›è·¯çº¿å¾„', key: 'toWireDiameters', width: 12 },
                    { header: 'ä¿é™©ä¸åŠŸèƒ½', key: 'fuseFunction', width: 40 },
                    { header: 'çº¿å¾„(mmÂ²)', key: 'wireDiameter', width: 8 },
                    { header: 'ç”µè·¯ç±»å‹', key: 'circuitType', width: 10 },
                    { header: 'çº¿æŸç±»å‹', key: 'harnessType', width: 10 },
                    { header: 'æ¨èä¿é™©ä¸', key: 'fuseRating', width: 10 },
                    { header: 'ä¿é™©ä¸ç±»å‹', key: 'fuseType', width: 10 },
                    { header: 'å¤‡æ³¨', key: 'note', width: 10 }
                ];
                worksheet.columns = columns;

                // å®šä¹‰æ ·å¼
                const headerStyle = {
                    font: { name: 'å¾®è½¯é›…é»‘', size: 8, bold: true, color: { argb: 'FFFFFFFF' } },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF404040' } },
                    alignment: { horizontal: 'center', vertical: 'middle' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                };

                // åº”ç”¨è¡¨å¤´æ ·å¼
                worksheet.getRow(1).eachCell(cell => {
                    cell.style = headerStyle;
                });

                // æ·»åŠ æ•°æ®å¹¶åº”ç”¨æ ·å¼
                filteredData.forEach((row, index) => {
                    const rowIndex = index + 2;
                    const fromValue = row.fromPin ? `${row.from}-${row.fromPin}` : row.from;

                    worksheet.addRow({
                        fuseCode: row.fuseCode,
                        wireId: row.wireId,
                        option: row.option || '',
                        from: fromValue,
                        to: row.toDisplay || '',
                        toWireIds: row.toWireIds || '',
                        toWireOptions: row.toWireOptions || '',
                        toWireDiameters: row.toWireDiameters || '',
                        fuseFunction: row.fuseFunction,
                        wireDiameter: row.wireDiameter,
                        circuitType: row.circuitType,
                        harnessType: row.harnessType,
                        fuseRating: row.fuseRating,
                        fuseType: row.fuseType,
                        note: row.note
                    });

                    // è·å–è¡Œå¯¹è±¡
                    const dataRow = worksheet.getRow(rowIndex);

                    // è®¾ç½®æ•°æ®è¡Œæ ·å¼
                    dataRow.eachCell((cell, colNumber) => {
                        // åŸºç¡€æ ·å¼
                        cell.font = { name: 'å¾®è½¯é›…é»‘', size: 8, color: { argb: 'FF000000' } };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        cell.alignment = { vertical: 'top' };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };

                        // åˆ—ç‰¹å®šæ ·å¼
                        switch (colNumber) {
                            case 1: // ä¿é™©ä¸ä»£å· - äº®ç»¿è‰²ï¼Œç²—ä½“
                                cell.font.color = { argb: 'FF7FFF00' };
                                cell.font.bold = true;
                                break;
                            case 2: // å›è·¯å· - ç²—ä½“
                                cell.font.bold = true;
                                break;
                            case 3: // Option - æ©™è‰²ï¼Œç²—ä½“
                                cell.font.color = { argb: 'FFFF8C00' };
                                cell.font.bold = true;
                                break;
                            case 5: // TO - è‡ªåŠ¨æ¢è¡Œ
                            case 9: // ä¿é™©ä¸åŠŸèƒ½ - è‡ªåŠ¨æ¢è¡Œ
                                cell.alignment.wrapText = true;
                                break;
                            case 6: // TOå¯¹åº”å›è·¯å· - ç°è‰²ï¼Œè‡ªåŠ¨æ¢è¡Œ
                                cell.font.color = { argb: 'FF999999' };
                                cell.alignment.wrapText = true;
                                break;
                            case 7: // å›è·¯å·Option - æ©™è‰²ï¼Œè‡ªåŠ¨æ¢è¡Œ
                                cell.font.color = { argb: 'FFFF8C00' };
                                cell.alignment.wrapText = true;
                                break;
                            case 8: // å›è·¯çº¿å¾„ - é’è‰²ï¼Œè‡ªåŠ¨æ¢è¡Œ
                                cell.font.color = { argb: 'FF00FFFF' };
                                cell.alignment.wrapText = true;
                                break;
                            case 15: // å¤‡æ³¨ - æ ¹æ®å†…å®¹è®¾ç½®é¢œè‰²
                                if (cell.value && typeof cell.value === 'string') {
                                    if (cell.value.includes('æ ‡å‡†')) {
                                        cell.font.color = { argb: 'FF7FFF00' };
                                    } else if (cell.value.includes('æ¥è¿‘')) {
                                        cell.font.color = { argb: 'FFFF8C00' };
                                    }
                                }
                                break;
                        }
                    });
                });

                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filterSuffix = activeFilter ? `_${activeFilter}` : '';
                const filename = `ä¿é™©ä¸åŒ¹é…æ¸…å•${filterSuffix}_${timestamp}.xlsx`;

                // å¯¼å‡ºExcelæ–‡ä»¶
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                alert('å¯¼å‡ºExcelå¤±è´¥: ' + error.message);
            }
        }

        // å¤åˆ¶HTMLåˆ°å‰ªåˆ‡æ¿
        function copyHtmlToClipboard() {
            if (filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¤åˆ¶');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨æ ¼ï¼Œæ‰‹åŠ¨æ„å»ºHTMLä»¥ç¡®ä¿ä¸Excelå¯¼å‡ºå®Œå…¨ä¸€è‡´
            const columnWidths = [
                90,   // ä¿é™©ä¸ä»£å· (12 * 7.5)
                75,   // å›è·¯å· (10 * 7.5)
                60,   // Option (8 * 7.5)
                90,   // FROM (12 * 7.5)
                112,  // TO (15 * 7.5)
                300,  // TOå¯¹åº”å›è·¯å· (40 * 7.5)
                225,  // å›è·¯å·Option (30 * 7.5)
                90,   // å›è·¯çº¿å¾„ (12 * 7.5)
                300,  // ä¿é™©ä¸åŠŸèƒ½ (40 * 7.5)
                60,   // çº¿å¾„ (8 * 7.5)
                75,   // ç”µè·¯ç±»å‹ (10 * 7.5)
                75,   // çº¿æŸç±»å‹ (10 * 7.5)
                75,   // æ¨èä¿é™©ä¸ (10 * 7.5)
                75,   // ä¿é™©ä¸ç±»å‹ (10 * 7.5)
                75    // å¤‡æ³¨ (10 * 7.5)
            ];

            // æ„å»ºcolgroup
            let colgroupHtml = '<colgroup>';
            columnWidths.forEach(width => {
                colgroupHtml += `<col style="width:${width}px">`;
            });
            colgroupHtml += '</colgroup>';

            // æ„å»ºè¡¨å¤´
            let headerHtml = '<thead><tr>';
            const headers = [
                'ä¿é™©ä¸ä»£å·', 'å›è·¯å·', 'Option', 'FROM', 'TO',
                'TOå¯¹åº”å›è·¯å·', 'å›è·¯å·Option', 'å›è·¯çº¿å¾„', 'ä¿é™©ä¸åŠŸèƒ½',
                'çº¿å¾„(mmÂ²)', 'ç”µè·¯ç±»å‹', 'çº¿æŸç±»å‹', 'æ¨èä¿é™©ä¸', 'ä¿é™©ä¸ç±»å‹', 'å¤‡æ³¨'
            ];
            headers.forEach(header => {
                headerHtml += `<th style="background-color:#404040;color:#ffffff;font-family:å¾®è½¯é›…é»‘;font-size:8pt;font-weight:bold;text-align:center;vertical-align:middle;border:1px solid #000000;padding:4px;">${header}</th>`;
            });
            headerHtml += '</tr></thead>';

            // æ„å»ºæ•°æ®è¡Œ
            let bodyHtml = '<tbody>';

            filteredData.forEach(row => {
                bodyHtml += '<tr>';

                // è¾…åŠ©å‡½æ•°ï¼šå°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºbræ ‡ç­¾
                const nl2br = (text) => {
                    if (!text) return '';
                    return String(text).replace(/\n/g, '<br>');
                };

                // ä¿é™©ä¸ä»£å· - äº®ç»¿è‰²ï¼Œç²—ä½“
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#7FFF00;font-weight:bold;vertical-align:top;border:1px solid #000000;padding:4px;">${row.fuseCode}</td>`;

                // å›è·¯å· - ç²—ä½“
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;font-weight:bold;vertical-align:top;border:1px solid #000000;padding:4px;">${row.wireId}</td>`;

                // Option - æ©™è‰²ï¼Œç²—ä½“
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#FF8C00;font-weight:bold;vertical-align:top;border:1px solid #000000;padding:4px;">${row.option || ''}</td>`;

                // FROM
                const fromValue = row.fromPin ? `${row.from}-${row.fromPin}` : row.from;
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${fromValue}</td>`;

                // TO - éœ€è¦ä¿ç•™æ¢è¡Œç¬¦
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${nl2br(row.toDisplay || '')}</td>`;

                // TOå¯¹åº”å›è·¯å· - ç°è‰²ï¼Œéœ€è¦ä¿ç•™æ¢è¡Œç¬¦
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#999999;vertical-align:top;border:1px solid #000000;padding:4px;">${nl2br(row.toWireIds || '')}</td>`;

                // å›è·¯å·Option - æ©™è‰²ï¼Œéœ€è¦ä¿ç•™æ¢è¡Œç¬¦
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#FF8C00;vertical-align:top;border:1px solid #000000;padding:4px;">${nl2br(row.toWireOptions || '')}</td>`;

                // å›è·¯çº¿å¾„ - é’è‰²ï¼Œéœ€è¦ä¿ç•™æ¢è¡Œç¬¦
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#00FFFF;vertical-align:top;border:1px solid #000000;padding:4px;">${nl2br(row.toWireDiameters || '')}</td>`;

                // ä¿é™©ä¸åŠŸèƒ½ - éœ€è¦ä¿ç•™æ¢è¡Œç¬¦
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${nl2br(row.fuseFunction)}</td>`;

                // çº¿å¾„
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${row.wireDiameter.toFixed(2)}</td>`;

                // ç”µè·¯ç±»å‹
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${row.circuitType}</td>`;

                // çº¿æŸç±»å‹
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${row.harnessType}</td>`;

                // æ¨èä¿é™©ä¸
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${row.fuseRating}</td>`;

                // ä¿é™©ä¸ç±»å‹
                bodyHtml += `<td style="font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;">${row.fuseType}</td>`;

                // å¤‡æ³¨ - æ ¹æ®å†…å®¹è®¾ç½®é¢œè‰²
                let noteStyle = 'font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#000000;vertical-align:top;border:1px solid #000000;padding:4px;';
                if (row.note && row.note.includes('æ ‡å‡†')) {
                    noteStyle = 'font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#7FFF00;vertical-align:top;border:1px solid #000000;padding:4px;';
                } else if (row.note && row.note.includes('æ¥è¿‘')) {
                    noteStyle = 'font-family:å¾®è½¯é›…é»‘;font-size:8pt;color:#FF8C00;vertical-align:top;border:1px solid #000000;padding:4px;';
                }
                bodyHtml += `<td style="${noteStyle}">${row.note}</td>`;

                bodyHtml += '</tr>';
            });
            bodyHtml += '</tbody>';

            // æ„å»ºå®Œæ•´è¡¨æ ¼
            const tableHtml = `<table border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;font-family:å¾®è½¯é›…é»‘;font-size:8pt;">${colgroupHtml}${headerHtml}${bodyHtml}</table>`;

            const htmlContent = tableHtml;

            // æ„å»ºçº¯æ–‡æœ¬å†…å®¹ï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼‰
            let textContent = headers.join('\t') + '\n';
            filteredData.forEach(row => {
                const fromValue = row.fromPin ? `${row.from}-${row.fromPin}` : row.from;
                const rowData = [
                    row.fuseCode,
                    row.wireId,
                    row.option || '',
                    fromValue,
                    row.toDisplay || '',
                    row.toWireIds || '',
                    row.toWireOptions || '',
                    row.toWireDiameters || '',
                    row.fuseFunction,
                    row.wireDiameter.toFixed(2),
                    row.circuitType,
                    row.harnessType,
                    row.fuseRating,
                    row.fuseType,
                    row.note
                ];
                // ç§»é™¤æ¢è¡Œç¬¦ï¼Œæ›¿æ¢ä¸ºç©ºæ ¼
                const cleanRowData = rowData.map(cell =>
                    String(cell).replace(/\n/g, ' ').replace(/\r/g, '')
                );
                textContent += cleanRowData.join('\t') + '\n';
            });

            // ä½¿ç”¨Clipboard APIå¤åˆ¶HTML
            const clipboardItem = new ClipboardItem({
                'text/html': new Blob([htmlContent], { type: 'text/html' }),
                'text/plain': new Blob([textContent], { type: 'text/plain' })
            });

            navigator.clipboard.write([clipboardItem]).then(() => {
                alert('âœ… HTMLå·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼\n\nå¯ä»¥ç›´æ¥ç²˜è´´åˆ°Excelã€Wordæˆ–ç”µå­é‚®ä»¶ä¸­ã€‚');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = htmlContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('âœ… HTMLå·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼');
                } catch (e) {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©è¡¨æ ¼å†…å®¹å¤åˆ¶ã€‚');
                }
                document.body.removeChild(textarea);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>
</html>
