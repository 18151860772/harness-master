<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelå¤„ç†å·¥å…· v3.3 - å®Œæ•´æ ·å¼ç‰ˆ</title>
    <!-- ä½¿ç”¨ExcelJSï¼Œæ”¯æŒå®Œæ•´æ ·å¼åŒ…æ‹¬è¾¹æ¡† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9em;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            display: none;
            background: #f0f2ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            display: none;
        }

        .btn-success.show {
            display: block;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(56, 239, 125, 0.4);
        }

        .btn-copy {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: none;
        }

        .btn-copy.show {
            display: block;
        }

        .btn-copy:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.4);
        }

        .progress {
            display: none;
            margin-bottom: 20px;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .status {
            display: none;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .features {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .features h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .features ul {
            list-style: none;
            padding: 0;
        }

        .features li {
            padding: 8px 0;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
        }

        .features li:last-child {
            border-bottom: none;
        }

        .features li:before {
            content: "âœ“ ";
            color: #38ef7d;
            font-weight: bold;
            margin-right: 8px;
        }

        .steps {
            display: none;
            background: #fff9e6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            max-height: 300px;
            overflow-y: auto;
        }

        .steps.show {
            display: block;
        }

        .step-item {
            padding: 5px 0;
            color: #666;
            font-size: 0.9em;
        }

        .step-item.done {
            color: #28a745;
        }

        .step-item.done:before {
            content: "âœ“ ";
        }

        .step-item.current {
            color: #667eea;
            font-weight: bold;
        }

        .step-item.current:before {
            content: "â†’ ";
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelå¤„ç†å·¥å…· v3.3 - å®Œæ•´æ ·å¼ç‰ˆ</h1>
            <p>æ”¯æŒå®Œæ•´Excelæ ·å¼ï¼ˆè¾¹æ¡†ã€å­—ä½“ã€é¢œè‰²ç­‰ï¼‰</p>
        </div>

        <div class="content">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ .xlsx æ ¼å¼ï¼ˆå®Œæ•´æ ·å¼æ”¯æŒï¼‰</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx">

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <div class="steps" id="steps"></div>

            <button class="btn btn-primary" id="processBtn" disabled>
                ğŸš€ å¼€å§‹å¤„ç†
            </button>

            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            </div>

            <div class="status" id="status"></div>

            <button class="btn btn-success" id="downloadBtn" style="display: none;">
                â¬‡ï¸ ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶
            </button>

            <div class="features">
                <h3>âœ¨ å¤„ç†åŠŸèƒ½</h3>
                <ul>
                    <li>ç§»é™¤æ‰€æœ‰ç‰¹æ®Šç©ºç™½å­—ç¬¦ï¼ˆä¸é—´æ–­ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ç­‰ï¼‰</li>
                    <li>ç§»é™¤æ‰€æœ‰é—®å· (?)</li>
                    <li>å»é™¤é¦–å°¾ç©ºæ ¼ï¼Œæ¸…ç©ºçº¯ç©ºå­—ç¬¦ä¸²</li>
                    <li>åˆ é™¤å‰9è¡Œæ•°æ®</li>
                    <li>æ¸…é™¤Aåˆ—ï¼ˆå–æ¶ˆåˆå¹¶å•å…ƒæ ¼ï¼‰</li>
                    <li>åˆ é™¤æŒ‡å®šåˆ—ï¼ˆV, U, T, Q, P, M, K, J, G, Fï¼‰</li>
                    <li>åˆ é™¤sheet2å’Œsheet3å·¥ä½œè¡¨</li>
                    <li>å®Œæ•´ä¿ç•™æºæ–‡ä»¶æ ¼å¼ï¼Œè‡ªåŠ¨æ·»åŠ é»‘è‰²è¾¹æ¡†</li>
                    <li>æœ€ç»ˆæ¸…ç†ç¡®ä¿æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦è¢«ç§»é™¤</li>
                    <li>é‡å‘½åå·¥ä½œè¡¨ä¸º"new"</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let processedWorkbook = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const status = document.getElementById('status');
        const steps = document.getElementById('steps');

        // æ•°æ®æ¸…ç†å‡½æ•°
        function cleanWhitespace(text) {
            if (typeof text !== 'string') return text;
            if (!text) return text;

            text = text.replace(/\xa0/g, '');
            text = text.replace(/\n/g, '');
            text = text.replace(/\r/g, '');
            text = text.replace(/\t/g, '');
            text = text.replace(/\v/g, '');
            text = text.replace(/\f/g, '');
            text = text.replace(/\?/g, '');
            text = text.trim();

            return text === '' ? null : text;
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showStatus('è¯·ä¸Šä¼  .xlsx æ ¼å¼çš„Excelæ–‡ä»¶', 'error');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            processBtn.disabled = false;
            status.classList.remove('show');
            downloadBtn.classList.remove('show');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            progressText.textContent = text;
        }

        function showStatus(message, type) {
            status.innerHTML = message;
            status.className = `status ${type} show`;
        }

        function addStep(text, stepStatus) {
            const stepDiv = document.createElement('div');
            stepDiv.className = `step-item ${stepStatus}`;
            stepDiv.textContent = text;
            steps.appendChild(stepDiv);
            steps.scrollTop = steps.scrollHeight;
        }

        // å¤„ç†æŒ‰é’®
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            processBtn.disabled = true;
            progress.classList.add('show');
            steps.classList.add('show');
            steps.innerHTML = '';
            status.classList.remove('show');

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const buffer = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(buffer);

                    addStep('å¼€å§‹å¤„ç†å·¥ä½œè¡¨...', 'current');

                    const sheet = workbook.worksheets[0];
                    const sheetName = sheet.name;

                    // Step 0/1: æ•°æ®æ¸…ç†
                    addStep('Step 0/1: æ•°æ®æ¸…ç†...', 'current');
                    updateProgress(10, 'æ¸…ç†æ•°æ®...');

                    sheet.eachRow((row, rowNumber) => {
                        row.eachCell((cell) => {
                            if (cell.value) {
                                const cleaned = cleanWhitespace(cell.value);
                                if (cleaned === null || cleaned === '') {
                                    cell.value = null;
                                } else {
                                    cell.value = cleaned;
                                }
                            }
                        });
                    });
                    addStep('Step 0/1: æ•°æ®æ¸…ç† âœ“', 'done');

                    // Step 2: åˆ é™¤å‰9è¡Œ
                    addStep('Step 2: åˆ é™¤å‰9è¡Œ...', 'current');
                    updateProgress(20, 'åˆ é™¤å‰9è¡Œ...');
                    sheet.spliceRows(1, 9);
                    addStep('Step 2: åˆ é™¤å‰9è¡Œ âœ“', 'done');

                    // Step 3: æ¸…é™¤Aåˆ—
                    addStep('Step 3: æ¸…é™¤Aåˆ—...', 'current');
                    updateProgress(30, 'æ¸…é™¤Aåˆ—...');
                    sheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 3) {
                            const cell = row.getCell(1);
                            cell.value = null;
                        }
                    });
                    addStep('Step 3: æ¸…é™¤Aåˆ— âœ“', 'done');

                    // Step 4: åˆ é™¤æŒ‡å®šåˆ—
                    addStep('Step 4: åˆ é™¤æŒ‡å®šåˆ—...', 'current');
                    updateProgress(40, 'åˆ é™¤æŒ‡å®šåˆ—...');
                    const colsToDelete = [22, 21, 20, 17, 16, 13, 11, 10, 7, 6];
                    colsToDelete.sort((a, b) => b - a);
                    colsToDelete.forEach(col => {
                        sheet.spliceColumns(col, 1);
                    });
                    addStep('Step 4: åˆ é™¤æŒ‡å®šåˆ— âœ“', 'done');

                    // Step 5: åˆ é™¤å·¥ä½œè¡¨
                    addStep('Step 5: åˆ é™¤sheet2å’Œsheet3...', 'current');
                    updateProgress(50, 'åˆ é™¤å·¥ä½œè¡¨...');
                    const sheetsToDelete = [];
                    workbook.worksheets.forEach(ws => {
                        const nameLower = ws.name.toLowerCase();
                        if (nameLower === 'sheet2' || nameLower === 'sheet3') {
                            sheetsToDelete.push(ws.name);
                        }
                    });
                    sheetsToDelete.forEach(name => workbook.removeWorksheet(name));
                    addStep('Step 5: åˆ é™¤sheet2å’Œsheet3 âœ“', 'done');

                    // Step 6: æ·»åŠ è¾¹æ¡†
                    addStep('Step 6: æ·»åŠ è¡¨æ ¼è¾¹æ¡†...', 'current');
                    updateProgress(60, 'æ·»åŠ è¾¹æ¡†...');

                    const borderStyle = {
                        style: 'thin',
                        color: { argb: 'FF000000' }
                    };

                    sheet.eachRow((row) => {
                        row.eachCell((cell) => {
                            cell.border = {
                                top: borderStyle,
                                left: borderStyle,
                                bottom: borderStyle,
                                right: borderStyle
                            };
                        });
                    });
                    addStep('Step 6: æ·»åŠ è¡¨æ ¼è¾¹æ¡† âœ“', 'done');

                    // Step 7: æœ€ç»ˆæ¸…ç†
                    addStep('Step 7: æœ€ç»ˆæ•°æ®æ¸…ç†...', 'current');
                    updateProgress(70, 'æœ€ç»ˆæ¸…ç†...');
                    sheet.eachRow((row) => {
                        row.eachCell((cell) => {
                            if (cell.value) {
                                const cleaned = cleanWhitespace(cell.value);
                                if (cleaned === null || cleaned === '') {
                                    cell.value = null;
                                } else {
                                    cell.value = cleaned;
                                }
                            }
                        });
                    });
                    addStep('Step 7: æœ€ç»ˆæ•°æ®æ¸…ç† âœ“', 'done');

                    // Step 7.4: åˆå¹¶å•å…ƒæ ¼ (A1:L1 åŒºåŸŸæ¨ªå‘åˆå¹¶)
                    addStep('Step 7.4: åˆå¹¶æ ‡é¢˜è¡Œå•å…ƒæ ¼...', 'current');
                    updateProgress(75, 'åˆå¹¶A1:L1å•å…ƒæ ¼...');

                    // åˆå¹¶ A1:L1 (è¡Œ1, åˆ—1-12)
                    sheet.mergeCells(1, 1, 1, 12);

                    addStep('Step 7.4: åˆå¹¶æ ‡é¢˜è¡Œå•å…ƒæ ¼ âœ“', 'done');

                    // Step 7.5: åˆå¹¶å•å…ƒæ ¼ (A2:H3 åŒºåŸŸä¸Šä¸‹ä¸¤ä¸¤åˆå¹¶)
                    addStep('Step 7.5: åˆå¹¶è¡¨å¤´å•å…ƒæ ¼...', 'current');
                    updateProgress(80, 'åˆå¹¶å•å…ƒæ ¼...');

                    // åˆå¹¶ A2:A3, B2:B3, C2:C3, D2:D3, E2:E3, F2:F3, G2:G3, H2:H3
                    const mergeRanges = [
                        [2, 3, 1, 1], // A2:A3 (è¡Œ2-3, åˆ—1)
                        [2, 3, 2, 2], // B2:B3 (è¡Œ2-3, åˆ—2)
                        [2, 3, 3, 3], // C2:C3 (è¡Œ2-3, åˆ—3)
                        [2, 3, 4, 4], // D2:D3 (è¡Œ2-3, åˆ—4)
                        [2, 3, 5, 5], // E2:E3 (è¡Œ2-3, åˆ—5)
                        [2, 3, 6, 6], // F2:F3 (è¡Œ2-3, åˆ—6)
                        [2, 3, 7, 7], // G2:G3 (è¡Œ2-3, åˆ—7)
                        [2, 3, 8, 8]  // H2:H3 (è¡Œ2-3, åˆ—8)
                    ];

                    mergeRanges.forEach(range => {
                        const [startRow, endRow, startCol, endCol] = range;
                        sheet.mergeCells(startRow, startCol, endRow, endCol);
                    });

                    addStep('Step 7.5: åˆå¹¶è¡¨å¤´å•å…ƒæ ¼ âœ“', 'done');

                    // Step 8: é‡å‘½åå·¥ä½œè¡¨
                    addStep('Step 8: é‡å‘½åå·¥ä½œè¡¨...', 'current');
                    updateProgress(90, 'é‡å‘½åå·¥ä½œè¡¨...');
                    sheet.name = 'new';
                    addStep('Step 8: é‡å‘½åä¸º"new" âœ“', 'done');

                    updateProgress(100, 'å¤„ç†å®Œæˆï¼');

                    processedWorkbook = workbook;

                    // è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶
                    await downloadFile();

                };
                reader.readAsArrayBuffer(selectedFile);

            } catch (error) {
                console.error('å¤„ç†é”™è¯¯:', error);
                showStatus('âœ— å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
            }

            processBtn.disabled = false;
        });

        // ä¸‹è½½å‡½æ•°
        async function downloadFile() {
            if (!processedWorkbook) return;

            const originalName = selectedFile.name.replace(/\.[^/.]+$/, '');
            const newName = `${originalName}_processed.xlsx`;

            const buffer = await processedWorkbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, newName);

            showStatus(`âœ“ æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½ï¼š${newName}<br><strong>å·²è‡ªåŠ¨æ·»åŠ é»‘è‰²è¾¹æ¡†å¹¶å®Œæˆæ‰€æœ‰æ ¼å¼ä¼˜åŒ–ï¼</strong><br><br>A1:L1åˆå¹¶ âœ“<br>A2:H3å‚ç›´åˆå¹¶ âœ“`, 'success');
        }

        // ä¸‹è½½æŒ‰é’®ï¼ˆä¿ç•™ä½†ä¸å¯è§ï¼‰
        downloadBtn.addEventListener('click', downloadFile);
    </script>
</body>
</html>
