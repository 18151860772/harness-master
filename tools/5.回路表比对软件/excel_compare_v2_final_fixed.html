<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelè¡¨æ ¼æ¯”å¯¹å·¥å…· V2 - å«æ¨¡æ¿ä¸‹è½½</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="download_templates.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* æ¨¡æ¿ä¸‹è½½åŒºåŸŸ */
        .template-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .template-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        .template-description {
            color: #555;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.6;
        }

        .template-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .template-btn:active {
            transform: translateY(-1px);
        }

        .template-btn.old-template {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            box-shadow: 0 5px 15px rgba(238, 90, 111, 0.4);
        }

        .template-btn.old-template:hover {
            box-shadow: 0 8px 20px rgba(238, 90, 111, 0.6);
        }

        .template-btn.new-template {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            box-shadow: 0 5px 15px rgba(55, 178, 77, 0.4);
        }

        .template-btn.new-template:hover {
            box-shadow: 0 8px 20px rgba(55, 178, 77, 0.6);
        }

        .template-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .template-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .template-info ul {
            margin-left: 20px;
            color: #555;
        }

        .template-info li {
            margin: 5px 0;
        }

        .upload-section {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }

        .upload-box {
            flex: 1;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9ff;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .upload-box.dragover {
            border-color: #764ba2;
            background: #e8ecff;
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-box p {
            color: #666;
            margin-bottom: 10px;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            color: #333;
            font-size: 14px;
        }

        .file-info.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .compare-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .compare-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .compare-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-section.show {
            display: block;
        }

        .result-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-section {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 600;
            color: #667eea;
            margin-right: 10px;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .copy-btn {
            padding: 8px 20px;
            border: 2px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .result-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-info p {
            color: #333;
            margin: 5px 0;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            display: inline-block;
            text-decoration: none;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.6);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .table-container {
            margin-top: 20px;
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #resultTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        #resultTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            white-space: nowrap;
        }

        #resultTable td {
            padding: 8px;
            border: 1px solid #e0e0e0;
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #resultTable tbody tr:hover {
            background-color: #f5f5f5;
        }

        .diff-cell {
            background-color: #FF4444 !important;
            color: #000000 !important;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .added-row td {
            background-color: #90EE90 !important;
            color: #000000 !important;
        }

        .deleted-row td {
            background-color: #FF6B6B !important;
            color: #000000 !important;
        }

        .changed-row td:first-child {
            background-color: #FFD700 !important;
            color: #000000 !important;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .legend {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excelè¡¨æ ¼æ¯”å¯¹å·¥å…· V2</h1>
        <p class="subtitle">æ”¯æŒæ¨¡æ¿ä¸‹è½½ | æœ¬åœ°å¤„ç† | æ•°æ®å®‰å…¨</p>

        <!-- æ¨¡æ¿ä¸‹è½½åŒºåŸŸ -->
        <div class="template-section">
            <h2>ğŸ“¥ ä¸‹è½½ç¤ºä¾‹æ¨¡æ¿</h2>
            <p class="template-description">
                å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¯ä»¥å…ˆä¸‹è½½ç¤ºä¾‹æ¨¡æ¿æ–‡ä»¶äº†è§£æ ¼å¼è¦æ±‚ã€‚<br>
                ä¸‹è½½åï¼Œå¯ä»¥æŒ‰ç…§æ¨¡æ¿æ ¼å¼å‡†å¤‡æ‚¨çš„ Excel æ–‡ä»¶ã€‚
            </p>
            <div class="template-buttons">
                <button class="template-btn old-template" onclick="downloadOldTemplate()">
                    ğŸ“„ ä¸‹è½½æ—§ç‰ˆæœ¬æ¨¡æ¿ (OLD.xlsx)
                </button>
                <button class="template-btn new-template" onclick="downloadNewTemplate()">
                    ğŸ“„ ä¸‹è½½æ–°ç‰ˆæœ¬æ¨¡æ¿ (NEW.xlsx)
                </button>
            </div>
            <div class="template-info">
                <h4>ğŸ“‹ æ¨¡æ¿è¯´æ˜ï¼š</h4>
                <ul>
                    <li><strong>ç¬¬1-3è¡Œ</strong>ï¼šè¡¨å¤´ä¿¡æ¯ï¼ˆä¼šè¢«ä¿ç•™åˆ°æ¯”å¯¹ç»“æœä¸­ï¼‰</li>
                    <li><strong>ç¬¬4è¡Œå¼€å§‹</strong>ï¼šæ•°æ®è¡Œï¼ˆç¬¬1åˆ—ä½œä¸ºå”¯ä¸€æ ‡è¯†é”®ï¼Œç”¨äºæ¯”å¯¹ï¼‰</li>
                    <li><strong>æ¯”å¯¹é€»è¾‘</strong>ï¼šæ ¹æ®ç¬¬1åˆ—çš„å€¼è¿›è¡ŒåŒ¹é…ï¼Œè¯†åˆ«æ–°å¢ã€åˆ é™¤ã€å˜æ›´çš„è®°å½•</li>
                    <li><strong>è¾“å‡ºç»“æœ</strong>ï¼šåœ¨ç¬¬1åˆ—å‰æ’å…¥"å·®å¼‚è¯´æ˜"åˆ—ï¼Œæ ‡æ³¨æ¯è¡Œçš„å˜æ›´æƒ…å†µ</li>
                </ul>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-box" id="uploadBox1" onclick="document.getElementById('file1').click()">
                <h3>ğŸ“ ä¸Šä¼ ç¬¬ä¸€ä»½è¡¨æ ¼</h3>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <input type="file" id="file1" accept=".xlsx,.xls" onchange="handleFileSelect(this, 1)">
                <div class="file-info" id="fileInfo1">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>

            <div class="upload-box" id="uploadBox2" onclick="document.getElementById('file2').click()">
                <h3>ğŸ“ ä¸Šä¼ ç¬¬äºŒä»½è¡¨æ ¼</h3>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <input type="file" id="file2" accept=".xlsx,.xls" onchange="handleFileSelect(this, 2)">
                <div class="file-info" id="fileInfo2">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
        </div>

        <div class="button-container">
            <button class="compare-btn" id="compareBtn" onclick="compareExcel()" disabled>å¼€å§‹æ¯”å¯¹</button>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-section" id="resultSection">
            <div class="result-info">
                <h3>æ¯”å¯¹ç»“æœ</h3>
                <p id="resultText"></p>
            </div>

            <div class="filter-section" id="filterSection" style="display: none;">
                <span class="filter-label">ğŸ” ç­›é€‰ï¼š</span>
                <button class="filter-btn active" onclick="filterTable('all')">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterTable('added')">ğŸ“ æ–°å¢</button>
                <button class="filter-btn" onclick="filterTable('deleted')">âŒ åˆ é™¤</button>
                <button class="filter-btn" onclick="filterTable('changed')">ğŸ”„ å˜æ›´</button>
                <button class="filter-btn" onclick="filterTable('same')">âœ“ æ— å·®å¼‚</button>
                <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <a class="download-btn" id="downloadBtn" href="#" download="æ¯”å¯¹ç»“æœ.xlsx">ğŸ“¥ ä¸‹è½½æ¯”å¯¹ç»“æœ</a>
            </div>
        </div>
    </div>

    <script>
        let file1Data = null;
        let file2Data = null;
        let file1Name = '';
        let file2Name = '';

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragDrop(boxId, fileInputId, fileInfoId, fileNum) {
            const box = document.getElementById(boxId);

            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });

            box.addEventListener('dragleave', () => {
                box.classList.remove('dragover');
            });

            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById(fileInputId);
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    fileInput.files = dt.files;
                    handleFileSelect(fileInput, fileNum);
                }
            });
        }

        setupDragDrop('uploadBox1', 'file1', 'fileInfo1', 1);
        setupDragDrop('uploadBox2', 'file2', 'fileInfo2', 2);

        function handleFileSelect(input, fileNum) {
            const file = input.files[0];
            if (!file) return;

            const fileInfo = document.getElementById(`fileInfo${fileNum}`);
            fileInfo.textContent = `å·²é€‰æ‹©: ${file.name}`;
            fileInfo.classList.add('success');

            if (fileNum === 1) {
                file1Name = file.name;
            } else {
                file2Name = file.name;
            }

            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                if (fileNum === 1) {
                    file1Data = jsonData;
                } else {
                    file2Data = jsonData;
                }

                checkFilesReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkFilesReady() {
            const compareBtn = document.getElementById('compareBtn');
            if (file1Data && file2Data) {
                compareBtn.disabled = false;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function compareExcel() {
            if (!file1Data || !file2Data) {
                showError('è¯·å…ˆä¸Šä¼ ä¸¤ä»½Excelè¡¨æ ¼');
                return;
            }

            document.getElementById('loading').classList.add('show');
            document.getElementById('resultSection').classList.remove('show');

            setTimeout(() => {
                try {
                    // åˆ›å»ºç»“æœæ•°æ®å’Œå·®å¼‚æ ‡è®°
                    const resultData = [];
                    const diffCells = new Set(); // å­˜å‚¨æœ‰å·®å¼‚çš„å•å…ƒæ ¼ä½ç½® "è¡Œå·,åˆ—å·"

                    // è®¡ç®—æºæ–‡ä»¶çš„æœ€å¤§åˆ—æ•°ï¼ˆåŒ…æ‹¬è¡¨å¤´å’Œæ•°æ®è¡Œï¼‰
                    let maxCols = 0;
                    // åŒ…å«è¡¨å¤´
                    if (file1Data.length > 0) {
                        maxCols = Math.max(maxCols, file1Data[0].length);
                    }
                    if (file2Data.length > 0) {
                        maxCols = Math.max(maxCols, file2Data[0].length);
                    }
                    // åŒ…å«æ•°æ®è¡Œ
                    for (let j = 1; j < file1Data.length; j++) {
                        maxCols = Math.max(maxCols, file1Data[j].length);
                    }
                    for (let j = 1; j < file2Data.length; j++) {
                        maxCols = Math.max(maxCols, file2Data[j].length);
                    }

                    // æ·»åŠ è¡¨å¤´ï¼Œåœ¨Aåˆ—æ·»åŠ "å·®å¼‚è¯´æ˜"
                    // åˆå¹¶ä¸¤ä»½æ–‡ä»¶çš„è¡¨å¤´ï¼Œç¡®ä¿ä¸ä¸¢å¤±ä»»ä½•åˆ—
                    let header = [];
                    for (let col = 0; col < maxCols; col++) {
                        let headerText = '';
                        // ä¼˜å…ˆä½¿ç”¨ç¬¬äºŒä»½æ–‡ä»¶çš„è¡¨å¤´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¬¬ä¸€ä»½çš„
                        if (file2Data.length > 0 && col < file2Data[0].length && file2Data[0][col]) {
                            headerText = file2Data[0][col];
                        } else if (file1Data.length > 0 && col < file1Data[0].length && file1Data[0][col]) {
                            headerText = file1Data[0][col];
                        }
                        header.push(headerText);
                    }
                    header.unshift('å·®å¼‚è¯´æ˜');
                    resultData.push(header);

                    // æ ¹æ®Aåˆ—åˆ›å»ºç´¢å¼•ï¼ˆAåˆ—æ˜¯ç´¢å¼•0ï¼‰
                    const map1 = new Map();
                    const map2 = new Map();

                    // ç¬¬ä¸€ä»½æ–‡ä»¶çš„ç´¢å¼•
                    for (let i = 1; i < file1Data.length; i++) {
                        const row = file1Data[i];
                        if (row[0]) {
                            map1.set(String(row[0]).trim(), { index: i, data: row });
                        }
                    }

                    // ç¬¬äºŒä»½æ–‡ä»¶çš„ç´¢å¼•
                    for (let i = 1; i < file2Data.length; i++) {
                        const row = file2Data[i];
                        if (row[0]) {
                            map2.set(String(row[0]).trim(), { index: i, data: row });
                        }
                    }

                    // æ”¶é›†æ‰€æœ‰çš„Aåˆ—å€¼
                    const allKeys = new Set([...map1.keys(), ...map2.keys()]);
                    const sortedKeys = Array.from(allKeys).sort();

                    let diffCount = 0;
                    let sameCount = 0;
                    let currentRowIndex = 1; // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè¡¨å¤´æ˜¯ç¬¬1è¡Œï¼‰

                    // è·å–å½“å‰æ—¥æœŸ
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                    // å­˜å‚¨æ¯è¡Œçš„ç±»å‹ä¿¡æ¯
                    const rowTypes = []; // 0: same, 1: added, 2: deleted, 3: changed

                    // éå†æ‰€æœ‰Aåˆ—å€¼
                    for (const key of sortedKeys) {
                        const item1 = map1.get(key);
                        const item2 = map2.get(key);

                        let resultRow;
                        let diffDescription = '';
                        const diffIndices = []; // è®°å½•å·®å¼‚åˆ—ç´¢å¼•
                        let rowType = 0; // é»˜è®¤ä¸ºsame

                        if (item1 && item2) {
                            // ä¸¤ä»½æ–‡ä»¶éƒ½æœ‰ï¼Œæ¯”è¾ƒå·®å¼‚
                            const diffs = compareRows(item1.data, item2.data, diffIndices);
                            if (diffs.length > 0) {
                                diffDescription = diffs.join('; ');
                                diffCount++;
                                rowType = 3; // changed
                                // åˆå¹¶ä¸¤ä»½æ–‡ä»¶çš„æ•°æ®ï¼šå¿…é¡»æŒ‰ç´¢å¼•éå†ï¼Œç¡®ä¿ç©ºå€¼ä¿ç•™ä½ç½®
                                resultRow = [];
                                for (let col = 0; col < maxCols; col++) {
                                    if (col < item2.data.length && item2.data[col] !== undefined) {
                                        resultRow.push(item2.data[col]);
                                    } else if (col < item1.data.length && item1.data[col] !== undefined) {
                                        resultRow.push(item1.data[col]);
                                    } else {
                                        resultRow.push('');
                                    }
                                }
                                // æ ‡è®°æœ‰å·®å¼‚çš„å•å…ƒæ ¼
                                for (const colIdx of diffIndices) {
                                    diffCells.add(`${currentRowIndex},${colIdx + 1}`); // +1å› ä¸ºå‰é¢æ’å…¥äº†å·®å¼‚è¯´æ˜åˆ—
                                }
                            } else {
                                diffDescription = 'æ— å·®å¼‚';
                                sameCount++;
                                rowType = 0; // same
                                // åˆå¹¶ä¸¤ä»½æ–‡ä»¶çš„æ•°æ®ï¼šå¿…é¡»æŒ‰ç´¢å¼•éå†ï¼Œç¡®ä¿ç©ºå€¼ä¿ç•™ä½ç½®
                                resultRow = [];
                                for (let col = 0; col < maxCols; col++) {
                                    if (col < item2.data.length && item2.data[col] !== undefined) {
                                        resultRow.push(item2.data[col]);
                                    } else if (col < item1.data.length && item1.data[col] !== undefined) {
                                        resultRow.push(item1.data[col]);
                                    } else {
                                        resultRow.push('');
                                    }
                                }
                            }
                        } else if (item1 && !item2) {
                            // åªåœ¨ç¬¬ä¸€ä»½æ–‡ä»¶ä¸­ = åˆ é™¤
                            diffDescription = `${dateStr}åˆ é™¤`;
                            diffCount++;
                            rowType = 2; // deleted
                            // å¿…é¡»æŒ‰ç´¢å¼•éå†ï¼Œç¡®ä¿ç©ºå€¼ä¹Ÿèƒ½ä¿ç•™ä½ç½®
                            resultRow = [];
                            for (let col = 0; col < maxCols; col++) {
                                if (col < item1.data.length && item1.data[col] !== undefined) {
                                    resultRow.push(item1.data[col]);
                                } else {
                                    resultRow.push('');
                                }
                            }
                        } else {
                            // åªåœ¨ç¬¬äºŒä»½æ–‡ä»¶ä¸­ = æ–°å¢
                            diffDescription = `${dateStr}æ–°å¢`;
                            diffCount++;
                            rowType = 1; // added
                            // å¿…é¡»æŒ‰ç´¢å¼•éå†ï¼Œç¡®ä¿ç©ºå€¼ä¹Ÿèƒ½ä¿ç•™ä½ç½®
                            resultRow = [];
                            for (let col = 0; col < maxCols; col++) {
                                if (col < item2.data.length && item2.data[col] !== undefined) {
                                    resultRow.push(item2.data[col]);
                                } else {
                                    resultRow.push('');
                                }
                            }
                        }

                        resultRow.unshift(diffDescription);
                        resultData.push(resultRow);
                        rowTypes.push(rowType);
                        currentRowIndex++;
                    }

                    // åˆ›å»ºå·¥ä½œç°¿
                    const ws = XLSX.utils.aoa_to_sheet(resultData);

                    // è®¾ç½®Aåˆ—å®½åº¦
                    const colWidths = [{ wch: 50 }];
                    for (let i = 1; i < 20; i++) {
                        colWidths.push({ wch: 15 });
                    }
                    ws['!cols'] = colWidths;

                    // ä¸ºæ¯è¡Œæ·»åŠ èƒŒæ™¯è‰²
                    for (let i = 1; i < resultData.length; i++) {
                        const rowType = rowTypes[i - 1];
                        const row = resultData[i];

                        for (let col = 0; col < row.length; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: i, c: col });
                            if (!ws[cellAddress]) continue;

                            if (!ws[cellAddress].s) {
                                ws[cellAddress].s = {};
                            }

                            if (rowType === 1) {
                                // æ–°å¢ï¼šç»¿è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­—ä½“
                                ws[cellAddress].s.fill = { patternType: 'solid', fgColor: { rgb: 'FF90EE90' } };
                                ws[cellAddress].s.font = { color: { rgb: 'FF000000' } };
                            } else if (rowType === 2) {
                                // åˆ é™¤ï¼šçº¢è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­—ä½“
                                ws[cellAddress].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFFF6B6B' } };
                                ws[cellAddress].s.font = { color: { rgb: 'FF000000' } };
                            } else if (rowType === 3) {
                                // å˜æ›´ï¼šåªåœ¨å·®å¼‚è¯´æ˜åˆ—æ·»åŠ é»„è‰²èƒŒæ™¯
                                if (col === 0) {
                                    ws[cellAddress].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFFFD700' } };
                                    ws[cellAddress].s.font = { color: { rgb: 'FF000000' } };
                                }
                            }
                        }
                    }

                    // ä¸ºæœ‰å·®å¼‚çš„å•å…ƒæ ¼æ·»åŠ çº¢è‰²èƒŒæ™¯
                    for (const cellRef of diffCells) {
                        const [rowIdx, colIdx] = cellRef.split(',').map(Number);
                        const cellAddress = XLSX.utils.encode_cell({ r: rowIdx, c: colIdx });
                        if (ws[cellAddress]) {
                            if (!ws[cellAddress].s) {
                                ws[cellAddress].s = {};
                            }
                            // å˜æ›´è¡Œçš„å·®å¼‚å•å…ƒæ ¼ï¼šæ›´æ·±çš„çº¢è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­—ä½“
                            ws[cellAddress].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFFF4444' } };
                            ws[cellAddress].s.font = { color: { rgb: 'FF000000' } };
                        }
                    }

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'æ¯”å¯¹ç»“æœ');

                    // ç”Ÿæˆä¸‹è½½é“¾æ¥
                    XLSX.writeFile(wb, 'æ¯”å¯¹ç»“æœ.xlsx');

                    // æ˜¾ç¤ºç»“æœç»Ÿè®¡
                    document.getElementById('resultText').innerHTML = `
                        æ€»å…±æ¯”è¾ƒäº† ${sortedKeys.length} è¡Œ<br>
                        å‘ç°å·®å¼‚: ${diffCount} è¡Œ<br>
                        å®Œå…¨ç›¸åŒ: ${sameCount} è¡Œ
                    `;

                    // åœ¨ç½‘é¡µä¸­å±•ç¤ºè¡¨æ ¼ï¼ˆå¸¦è¡Œç±»å‹ä¿¡æ¯ï¼‰
                    displayTable(resultData, diffCells);

                    // æ˜¾ç¤ºç­›é€‰æŒ‰é’®
                    document.getElementById('filterSection').style.display = 'flex';

                    document.getElementById('resultSection').classList.add('show');

                } catch (error) {
                    console.error(error);
                    showError('æ¯”å¯¹è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message);
                }

                document.getElementById('loading').classList.remove('show');
            }, 500);
        }

        function compareRows(row1, row2, diffIndices) {
            const diffs = [];
            const maxLength = Math.max(row1.length, row2.length);

            // è·å–å½“å‰æ—¥æœŸ
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            for (let i = 0; i < maxLength; i++) {
                const val1 = row1[i] !== undefined ? String(row1[i]).trim() : '';
                const val2 = row2[i] !== undefined ? String(row2[i]).trim() : '';

                if (val1 !== val2) {
                    const colName = String.fromCharCode(65 + i);
                    diffs.push(`${dateStr}å˜æ›´, ${colName}åˆ—: "${val1}" æ›´æ”¹ä¸º "${val2}"`);
                    diffIndices.push(i); // è®°å½•å·®å¼‚åˆ—ç´¢å¼•
                }
            }

            return diffs;
        }

        let currentFilter = 'all';
        let tableRows = []; // å­˜å‚¨æ‰€æœ‰è¡Œæ•°æ®

        function displayTable(data, diffCells) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');

            // æ¸…ç©ºè¡¨æ ¼
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            tableRows = [];

            if (data.length === 0) return;

            // åˆ›å»ºè¡¨å¤´
            const headerRow = document.createElement('tr');
            const headers = data[0];
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header || `åˆ—${index + 1}`;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // åˆ›å»ºè¡¨æ ¼å†…å®¹å¹¶å­˜å‚¨
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const tr = document.createElement('tr');
                const diffDesc = row[0] || '';

                // åˆ¤æ–­è¡Œç±»å‹ï¼šåŸºäºæ–°çš„å·®å¼‚è¯´æ˜æ ¼å¼
                let rowType = 'same';
                if (diffDesc.endsWith('åˆ é™¤') && !diffDesc.includes('å˜æ›´')) {
                    // æ—¥æœŸ+åˆ é™¤ = åˆ é™¤
                    rowType = 'deleted';
                } else if (diffDesc.endsWith('æ–°å¢')) {
                    // æ—¥æœŸ+æ–°å¢ = æ–°å¢
                    rowType = 'added';
                } else if (diffDesc.includes('å˜æ›´')) {
                    // åŒ…å«"å˜æ›´" = å˜æ›´
                    rowType = 'changed';
                }

                tr.dataset.type = rowType;

                // æ·»åŠ è¡Œæ ·å¼ç±»
                if (rowType === 'added') {
                    tr.classList.add('added-row');
                } else if (rowType === 'deleted') {
                    tr.classList.add('deleted-row');
                } else if (rowType === 'changed') {
                    tr.classList.add('changed-row');
                }

                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    td.textContent = cell !== undefined ? cell : '';

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å·®å¼‚å•å…ƒæ ¼
                    if (diffCells.has(`${i},${colIndex}`)) {
                        td.classList.add('diff-cell');
                        td.title = 'è¯¥å•å…ƒæ ¼åœ¨ä¸¤ä»½æ–‡ä»¶ä¸­ä¸åŒ';
                    }

                    tr.appendChild(td);
                });

                tableRows.push(tr);
                tableBody.appendChild(tr);
            }
        }

        function filterTable(type) {
            currentFilter = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ç­›é€‰è¡Œ
            tableRows.forEach(row => {
                if (type === 'all') {
                    row.style.display = '';
                } else if (type === row.dataset.type) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function copyToClipboard() {
            // è·å–è¡¨å¤´
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');

            if (!tableHead || !tableBody) {
                showError('æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®');
                return;
            }

            // è·å–æ‰€æœ‰å¯è§çš„è¡Œ
            const visibleRows = tableBody.querySelectorAll('tr[style=""], tr:not([style])');

            if (visibleRows.length === 0) {
                showError('å½“å‰ç­›é€‰ç»“æœä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶');
                return;
            }

            // æ„å»ºHTMLè¡¨æ ¼ï¼ˆä¿ç•™æ ·å¼ï¼‰
            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            table.style.width = '100%';
            table.style.fontSize = '13px';

            // å¤åˆ¶è¡¨å¤´
            const htmlHead = document.createElement('thead');
            const headerRow = tableHead.querySelector('tr').cloneNode(true);
            htmlHead.appendChild(headerRow);
            table.appendChild(htmlHead);

            // å¤åˆ¶å¯è§è¡Œ
            const htmlBody = document.createElement('tbody');
            visibleRows.forEach(row => {
                htmlBody.appendChild(row.cloneNode(true));
            });
            table.appendChild(htmlBody);

            // æ„å»ºåˆ¶è¡¨ç¬¦åˆ†éš”çš„æ–‡æœ¬ï¼ˆé€‚åˆExcelç²˜è´´ï¼‰
            const headers = tableHead.querySelectorAll('th');
            const colCount = headers.length;
            let clipboardText = '';

            // æ·»åŠ è¡¨å¤´
            const headerValues = Array.from(headers).map(th => th.textContent);
            clipboardText += headerValues.join('\t') + '\n';

            // æ·»åŠ å¯è§è¡Œ
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowValues = [];

                for (let i = 0; i < colCount; i++) {
                    if (i < cells.length) {
                        rowValues.push(cells[i].textContent || '');
                    } else {
                        rowValues.push('');
                    }
                }

                clipboardText += rowValues.join('\t') + '\n';
            });

            // å°è¯•ä½¿ç”¨Clipboard APIåŒæ—¶å¤åˆ¶HTMLå’Œæ–‡æœ¬
            const clipboardItem = new ClipboardItem({
                'text/html': new Blob([table.outerHTML], { type: 'text/html' }),
                'text/plain': new Blob([clipboardText], { type: 'text/plain' })
            });

            navigator.clipboard.write([clipboardItem]).then(() => {
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ å·²å¤åˆ¶ï¼ˆå«é¢œè‰²ï¼‰';
                copyBtn.style.background = '#28a745';
                copyBtn.style.color = 'white';

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            }).catch(err => {
                console.log('HTMLå¤åˆ¶å¤±è´¥ï¼Œé™çº§åˆ°çº¯æ–‡æœ¬å¤åˆ¶', err);

                // é™çº§æ–¹æ¡ˆï¼šåªå¤åˆ¶çº¯æ–‡æœ¬
                const textArea = document.createElement('textarea');
                textArea.value = clipboardText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    const copyBtn = document.querySelector('.copy-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ“ å·²å¤åˆ¶ï¼ˆçº¯æ–‡æœ¬ï¼‰';
                    copyBtn.style.background = '#28a745';
                    copyBtn.style.color = 'white';

                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '';
                        copyBtn.style.color = '';
                    }, 2000);
                } catch (err) {
                    showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }

                document.body.removeChild(textArea);
            });
        }
    </script>
</body>
</html>
