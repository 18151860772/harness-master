<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥åœ°æ¸…å•ç”Ÿæˆå™¨ V6 - å¢å¼ºExcelå¯¼å‡ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="template_data.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header .version-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-box.has-file {
            border-color: #28a745;
            background: #f0fff4;
        }

        .upload-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .upload-box p {
            color: #666;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #5568d3;
        }

        .file-name {
            margin-top: 10px;
            font-size: 12px;
            color: #28a745;
            font-weight: 500;
        }

        .action-buttons {
            text-align: center;
            margin-bottom: 40px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .results-section {
            display: none;
            margin-top: 40px;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-header h2 {
            color: #333;
            font-size: 22px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #218838;
        }

        .data-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f0f2ff;
        }

        .data-table td.multi-line {
            white-space: pre-line;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-card h4 {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #333;
            font-size: 28px;
            font-weight: 700;
        }

        .filter-section {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .filter-section label {
            font-weight: 600;
            color: #495057;
        }

        /* æ¨¡æ¿ä¸‹è½½åŒºåŸŸæ ·å¼ */
        .template-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
        }

        .template-section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-info {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
        }

        .template-info strong {
            color: #1976D2;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .template-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.1);
            transform: translateY(-3px);
        }

        .template-card .template-icon {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }

        .template-card .template-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .template-card .template-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .template-card .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .template-card .download-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #667eea 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .download-all-btn {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .download-all-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        /* V6 æ–°å¢ç‰¹æ€§æ ·å¼ */
        .feature-highlight {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #ff6b6b;
        }

        .feature-highlight h3 {
            color: #d63031;
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-highlight p {
            color: #2d3436;
            font-size: 13px;
            line-height: 1.6;
        }

        .style-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .style-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .export-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-option-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .export-option-btn:hover {
            background: #138496;
        }

        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #5a6268;
        }

        .copy-btn.success {
            background: #28a745;
        }

        .copy-btn.copied {
            animation: copySuccess 0.5s ease;
        }

        @keyframes copySuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ¥åœ°æ¸…å•ç”Ÿæˆå™¨ V6 - å¢å¼ºExcelå¯¼å‡ºç‰ˆ</h1>
            <p>æ ¹æ®å›è·¯è¡¨ã€æ’ä»¶æ¸…å•å’Œinlineè¡¨è‡ªåŠ¨ç”Ÿæˆæ¥åœ°æ¸…å•ï¼ˆåŒä¸€æ¥åœ°åˆå¹¶æ˜¾ç¤ºï¼‰- æ”¯æŒå¸¦é¢œè‰²æ ¼å¼çš„Excelå¯¼å‡º</p>
            <div class="version-badge">âœ¨ V6 æ–°ç‰¹æ€§ï¼šExcelå¯¼å‡ºæ”¯æŒé¢œè‰²ã€è¾¹æ¡†ã€å­—ä½“æ ·å¼ï¼</div>
        </div>

        <div class="main-content">
            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="message"></div>

            <!-- V6 æ–°ç‰¹æ€§è¯´æ˜ -->
            <div class="feature-highlight">
                <h3>ğŸ¨ V6 ç‰ˆæœ¬æ–°ç‰¹æ€§</h3>
                <p>å¯¼å‡ºçš„Excelæ–‡ä»¶ç°åœ¨åŒ…å«å®Œæ•´çš„æ ¼å¼æ ·å¼ï¼šè¡¨å¤´æ¸å˜è‰²èƒŒæ™¯ã€äº¤æ›¿è¡Œé¢œè‰²ã€è‡ªåŠ¨åˆ—å®½ã€è¾¹æ¡†ã€å­—ä½“åŠ ç²—ç­‰ï¼Œè®©æ‚¨çš„æ•°æ®æ›´åŠ æ¸…æ™°æ˜“è¯»ï¼</p>
                <div class="style-preview">
                    <span class="style-badge" style="background: #667eea;">è¡¨å¤´æ¸å˜</span>
                    <span class="style-badge" style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6;">äº¤æ›¿è¡Œè‰²</span>
                    <span class="style-badge" style="background: #28a745;">ç»¿è‰²å¼ºè°ƒ</span>
                    <span class="style-badge" style="background: #ffc107; color: #333;">é»„è‰²æ ‡æ³¨</span>
                    <span class="style-badge" style="background: #dc3545;">çº¢è‰²æ ‡è®°</span>
                </div>
            </div>

            <!-- æ¨¡æ¿ä¸‹è½½åŒºåŸŸ -->
            <div class="template-section">
                <h2>ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿</h2>
                <div class="template-info">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>æœ¬ç‰ˆæœ¬å·²å†…ç½®æœ¬åœ°Excelæ¨¡æ¿æ–‡ä»¶çš„å®Œæ•´å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å³å¯ä¸‹è½½ã€‚è¿™äº›æ¨¡æ¿æ–‡ä»¶ä¸æ‚¨æœ¬åœ°çš„æ–‡ä»¶å®Œå…¨ä¸€è‡´ã€‚
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="download-all-btn" onclick="downloadAllTemplates()">
                        <span>ğŸ“¦</span>
                        ä¸‹è½½å…¨éƒ¨æ¨¡æ¿
                    </button>
                </div>
                <div class="template-grid">
                    <div class="template-card" onclick="downloadWirelistTemplate()">
                        <span class="template-icon">ğŸ“‹</span>
                        <div class="template-title">WIRELIST.xlsx</div>
                        <div class="template-desc">å›è·¯è¡¨æ¨¡æ¿<br>æœ¬åœ°æ–‡ä»¶çš„å®Œæ•´å†…å®¹</div>
                        <button class="download-btn">
                            <span>â¬‡ï¸</span>
                            ä¸‹è½½
                        </button>
                    </div>
                    <div class="template-card" onclick="downloadConnlistTemplate()">
                        <span class="template-icon">ğŸ”Œ</span>
                        <div class="template-title">T28-Connlist_20260113.xlsx</div>
                        <div class="template-desc">è¿æ¥å™¨åˆ—è¡¨æ¨¡æ¿<br>æœ¬åœ°æ–‡ä»¶çš„å®Œæ•´å†…å®¹</div>
                        <button class="download-btn">
                            <span>â¬‡ï¸</span>
                            ä¸‹è½½
                        </button>
                    </div>
                    <div class="template-card" onclick="downloadInlineTemplate()">
                        <span class="template-icon">ğŸ“</span>
                        <div class="template-title">inline.xlsx</div>
                        <div class="template-desc">Inlineè¡¨æ¨¡æ¿<br>æœ¬åœ°æ–‡ä»¶çš„å®Œæ•´å†…å®¹</div>
                        <button class="download-btn">
                            <span>â¬‡ï¸</span>
                            ä¸‹è½½
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="upload-box" id="wirelistBox">
                    <h3>ğŸ“‹ å›è·¯è¡¨</h3>
                    <p>ä¸Šä¼  WIRELIST.xlsx<br>åŒ…å«çº¿æŸè¿æ¥ä¿¡æ¯</p>
                    <input type="file" id="wirelistInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('wirelistInput').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div class="file-name" id="wirelistName"></div>
                </div>

                <div class="upload-box" id="connlistBox">
                    <h3>ğŸ”Œ è¿æ¥å™¨åˆ—è¡¨</h3>
                    <p>ä¸Šä¼  Connlist.xlsx<br>åŒ…å«æ‰€æœ‰è¿æ¥å™¨ä¿¡æ¯</p>
                    <input type="file" id="connlistInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('connlistInput').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div class="file-name" id="connlistName"></div>
                </div>

                <div class="upload-box" id="inlineBox">
                    <h3>ğŸ”— Inlineè¡¨</h3>
                    <p>ä¸Šä¼  inline.xlsx<br>åŒ…å«Inlineè¿æ¥å™¨å…³ç³»</p>
                    <input type="file" id="inlineInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('inlineInput').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div class="file-name" id="inlineName"></div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button id="generateBtn" class="generate-btn" disabled onclick="generateGroundingList()">
                    ğŸš€ ç”Ÿæˆæ¥åœ°æ¸…å•
                </button>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div id="resultsSection" class="results-section">
                <div class="results-header">
                    <h2>ğŸ“Š è§£æç»“æœ</h2>
                    <div class="export-options">
                        <button id="downloadBtn" class="download-btn" onclick="downloadStyledExcel()">
                            ğŸ“¥ ä¸‹è½½å¸¦æ ¼å¼Excel
                        </button>
                        <button id="downloadSimpleBtn" class="export-option-btn" onclick="downloadSimpleExcel()">
                            ğŸ“„ ä¸‹è½½ç®€å•Excel
                        </button>
                        <button id="copyHtmlBtn" class="copy-btn" onclick="copyHtmlToClipboard()">
                            ğŸ“‹ å¤åˆ¶HTMLè¡¨æ ¼
                        </button>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('overview')">æ¦‚è§ˆ</div>
                    <div class="tab" onclick="switchTab('generated')">æ¥åœ°æ¸…å•</div>
                </div>

                <div class="filter-section" id="filterSection" style="display: none; margin-bottom: 20px;">
                    <label style="margin-right: 10px; font-weight: 500;">ç­›é€‰æ¥åœ°çŸ­å·ï¼š</label>
                    <input type="text" id="filterInput" placeholder="è¾“å…¥å¼€å¤´å­—æ¯ï¼ˆå¦‚ï¼šE1ï¼‰"
                           style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px;"
                           oninput="filterGroundingList()">
                    <button onclick="clearFilter()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                        æ¸…é™¤ç­›é€‰
                    </button>
                </div>

                <div class="data-display">
                    <div id="overviewTab" class="tab-content active">
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>

                    <div id="generatedTab" class="tab-content">
                        <table class="data-table" id="generatedTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // æ¨¡æ¿ä¸‹è½½åŠŸèƒ½
        // ==========================================

        // ä»Base64æ•°æ®ä¸‹è½½æ–‡ä»¶
        function downloadFromBase64(base64Data, filename) {
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ä¸‹è½½WIRELISTæ¨¡æ¿
        function downloadWirelistTemplate() {
            if (typeof TEMPLATE_FILES === 'undefined' || !TEMPLATE_FILES.WIRELIST) {
                showMessage('æ¨¡æ¿æ•°æ®æœªåŠ è½½', 'error');
                return;
            }
            const template = TEMPLATE_FILES.WIRELIST;
            downloadFromBase64(template.data, template.filename);
            showMessage('å·²ä¸‹è½½: ' + template.filename, 'success');
        }

        // ä¸‹è½½Connlistæ¨¡æ¿
        function downloadConnlistTemplate() {
            if (typeof TEMPLATE_FILES === 'undefined' || !TEMPLATE_FILES.CONNLIST) {
                showMessage('æ¨¡æ¿æ•°æ®æœªåŠ è½½', 'error');
                return;
            }
            const template = TEMPLATE_FILES.CONNLIST;
            downloadFromBase64(template.data, template.filename);
            showMessage('å·²ä¸‹è½½: ' + template.filename, 'success');
        }

        // ä¸‹è½½inlineæ¨¡æ¿
        function downloadInlineTemplate() {
            if (typeof TEMPLATE_FILES === 'undefined' || !TEMPLATE_FILES.INLINE) {
                showMessage('æ¨¡æ¿æ•°æ®æœªåŠ è½½', 'error');
                return;
            }
            const template = TEMPLATE_FILES.INLINE;
            downloadFromBase64(template.data, template.filename);
            showMessage('å·²ä¸‹è½½: ' + template.filename, 'success');
        }

        // ä¸‹è½½å…¨éƒ¨æ¨¡æ¿
        function downloadAllTemplates() {
            downloadWirelistTemplate();
            setTimeout(() => downloadConnlistTemplate(), 300);
            setTimeout(() => downloadInlineTemplate(), 600);
            setTimeout(() => showMessage('âœ… å·²ä¸‹è½½å…¨éƒ¨æ¨¡æ¿æ–‡ä»¶ï¼', 'success'), 700);
        }

        // ==========================================
        // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®
        // ==========================================

        let wirelistData = null;
        let connlistData = null;
        let inlineData = null;
        let connlistArrayData = null;
        let groundingList = null;

        // ==========================================
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        // ==========================================

        document.getElementById('wirelistInput').addEventListener('change', function(e) {
            handleFileSelect(e, 'wirelist');
        });

        document.getElementById('connlistInput').addEventListener('change', function(e) {
            handleFileSelect(e, 'connlist');
        });

        document.getElementById('inlineInput').addEventListener('change', function(e) {
            handleFileSelect(e, 'inline');
        });

        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    if (type === 'wirelist') {
                        wirelistData = jsonData;
                    } else if (type === 'connlist') {
                        connlistData = jsonData;
                        connlistArrayData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    } else if (type === 'inline') {
                        inlineData = jsonData;
                    }

                    const box = document.getElementById(type + 'Box');
                    const name = document.getElementById(type + 'Name');
                    box.classList.add('has-file');
                    name.textContent = 'âœ“ ' + file.name;
                    checkAllFiles();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function checkAllFiles() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = !(wirelistData && connlistData && inlineData);
        }

        // ==========================================
        // ä¸»å¤„ç†å‡½æ•°
        // ==========================================

        async function generateGroundingList() {
            showLoading(true);
            showMessage('', '');

            try {
                await new Promise(resolve => setTimeout(resolve, 100));

                const groundShortCodes = identifyGroundCodes();
                const inlineList = getInlineList();
                const connlistCodes = getAllConnlistCodes();
                const weldPoints = identifyWeldPoints(connlistCodes);
                const connectors = identifyConnectors(groundShortCodes, inlineList, connlistCodes);
                const connectionGraph = buildConnectionGraph(weldPoints, inlineList);

                groundingList = generateGroundingListData(groundShortCodes, inlineList, connectors, connectionGraph);

                // åˆå¹¶åŒä¸€æ¥åœ°çŸ­å·çš„æ•°æ®
                const mergedList = mergeByGroundCode(groundingList);

                displayResults(groundShortCodes, mergedList);
                showMessage('âœ… æ¥åœ°æ¸…å•ç”ŸæˆæˆåŠŸï¼ç°åœ¨å¯ä»¥å¯¼å‡ºå¸¦æ ¼å¼çš„Excelæ–‡ä»¶äº†ï¼', 'success');

            } catch (error) {
                console.error(error);
                showMessage('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // åˆå¹¶åŒä¸€æ¥åœ°çŸ­å·çš„æ•°æ®
        function mergeByGroundCode(data) {
            const merged = {};

            for (const item of data) {
                const groundCode = item['æ¥åœ°çŸ­å·'];
                if (!merged[groundCode]) {
                    merged[groundCode] = {
                        'Family': item['Family'] || '',
                        'æ¥åœ°çŸ­å·': groundCode,
                        'æ’ä»¶çŸ­å·': [],
                        'ä¸­æ–‡æè¿°': [],
                        'æ’ä»¶PIN': [],
                        'Wire ID': [],
                        'çº¿å¾„': [],
                        'çº¿è‰²': [],
                        'Option': [],
                        'æ­é“ç±»å‹åˆ†æ': item['æ­é“ç±»å‹åˆ†æ'] || ''
                    };
                }

                merged[groundCode]['æ’ä»¶çŸ­å·'].push(item['æ’ä»¶çŸ­å·']);
                merged[groundCode]['ä¸­æ–‡æè¿°'].push(item['ä¸­æ–‡æè¿°']);
                merged[groundCode]['æ’ä»¶PIN'].push(item['æ’ä»¶PIN']);
                merged[groundCode]['Wire ID'].push(item['Wire ID']);
                merged[groundCode]['çº¿å¾„'].push(item['çº¿å¾„']);
                merged[groundCode]['çº¿è‰²'].push(item['çº¿è‰²']);
                merged[groundCode]['Option'].push(item['Option']);
            }

            // è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¹¶ç”¨æ¢è¡Œç¬¦è¿æ¥
            return Object.values(merged).map(item => ({
                'Family': item['Family'],
                'æ¥åœ°çŸ­å·': item['æ¥åœ°çŸ­å·'],
                'æ’ä»¶çŸ­å·': item['æ’ä»¶çŸ­å·'].join('\n'),
                'ä¸­æ–‡æè¿°': item['ä¸­æ–‡æè¿°'].join('\n'),
                'æ’ä»¶PIN': item['æ’ä»¶PIN'].join('\n'),
                'Wire ID': item['Wire ID'].join('\n'),
                'çº¿å¾„': item['çº¿å¾„'].join('\n'),
                'çº¿è‰²': item['çº¿è‰²'].join('\n'),
                'Option': item['Option'].join('\n'),
                'æ­é“ç±»å‹åˆ†æ': item['æ­é“ç±»å‹åˆ†æ']
            }));
        }

        function identifyGroundCodes() {
            const groundCodes = [];

            for (const row of connlistData) {
                let shortCode = null;
                let isGround = false;

                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    if (keyLower.includes('çŸ­å·') || keyLower.includes('short code') || keyLower.includes('code')) {
                        shortCode = String(row[key] || '').trim();
                        break;
                    }
                }

                if (!shortCode) continue;

                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    const desc = String(row[key] || '').toLowerCase();

                    if (keyLower.includes('ä¸­æ–‡') || keyLower.includes('æè¿°') || keyLower.includes('description') || keyLower.includes('desc')) {
                        if (desc.includes('æ¥åœ°') || desc.includes('ground') || desc.includes('gnd')) {
                            isGround = true;
                            break;
                        }
                    }
                }

                if (isGround) {
                    groundCodes.push(shortCode);
                }
            }

            return [...new Set(groundCodes)];
        }

        function getInlineList() {
            const inlineCodes = [];

            for (const row of inlineData) {
                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    if (keyLower.includes('inline') || keyLower.includes('çŸ­å·') || keyLower.includes('code')) {
                        const code = String(row[key] || '').trim();
                        if (code) {
                            inlineCodes.push(code);
                        }
                    }
                }
            }

            return [...new Set(inlineCodes)];
        }

        function getAllConnlistCodes() {
            const codes = new Set();

            for (const row of connlistData) {
                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    if (keyLower.includes('çŸ­å·') || keyLower.includes('code') || keyLower.includes('short code')) {
                        const code = String(row[key] || '').trim();
                        if (code) {
                            codes.add(code);
                        }
                    }
                }
            }

            return codes;
        }

        function identifyWeldPoints(connlistCodes) {
            const weldPoints = [];

            for (const row of wirelistData) {
                let fromPin = '', toPin = '', fromCode = '', toCode = '';

                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    const value = String(row[key] || '').trim();

                    if (keyLower.includes('from pin') || keyLower.includes('frompin')) {
                        fromPin = value;
                    } else if (keyLower.includes('to pin') || keyLower.includes('topin')) {
                        toPin = value;
                    } else if (keyLower.includes('from code') || keyLower.includes('fromcode')) {
                        fromCode = value;
                    } else if (keyLower.includes('to code') || keyLower.includes('tocode')) {
                        toCode = value;
                    }
                }

                if (fromPin === 'X' && fromCode && !connlistCodes.has(fromCode)) {
                    weldPoints.push(fromCode);
                }
                if (toPin === 'X' && toCode && !connlistCodes.has(toCode)) {
                    weldPoints.push(toCode);
                }
            }

            return [...new Set(weldPoints)];
        }

        function identifyConnectors(groundCodes, inlineList, connlistCodes) {
            const groundSet = new Set(groundCodes);
            const inlineSet = new Set(inlineList);

            return [...connlistCodes].filter(code =>
                code && !groundSet.has(code) && !inlineSet.has(code)
            );
        }

        function buildConnectionGraph(weldPoints, inlineList) {
            const graph = new Map();
            const weldSet = new Set(weldPoints);
            const inlineSet = new Set(inlineList);

            function addConnection(node1, node2) {
                if (!graph.has(node1)) {
                    graph.set(node1, new Set());
                }
                if (!graph.has(node2)) {
                    graph.set(node2, new Set());
                }
                graph.get(node1).add(node2);
                graph.get(node2).add(node1);
            }

            function addNode(node) {
                if (!graph.has(node)) {
                    graph.set(node, new Set());
                }
            }

            for (const row of wirelistData) {
                let fromCode = '', toCode = '', fromPin = '', toPin = '';

                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    const value = String(row[key] || '').trim();

                    if (keyLower.includes('from code') || keyLower.includes('fromcode')) {
                        fromCode = value;
                    } else if (keyLower.includes('to code') || keyLower.includes('tocode')) {
                        toCode = value;
                    } else if (keyLower.includes('from pin') || keyLower.includes('frompin')) {
                        fromPin = value;
                    } else if (keyLower.includes('to pin') || keyLower.includes('topin')) {
                        toPin = value;
                    }
                }

                if (!fromCode || !toCode) continue;

                const node1 = `${fromCode}:${fromPin}`;
                const node2 = `${toCode}:${toPin}`;

                addConnection(node1, node2);
                addNode(fromCode);
                addNode(toCode);

                if (weldSet.has(fromCode)) {
                    addConnection(fromCode, node1);
                }
                if (weldSet.has(toCode)) {
                    addConnection(toCode, node2);
                }

                if (inlineSet.has(fromCode) && inlineSet.has(toCode)) {
                    addConnection(fromCode, toCode);
                }
            }

            return graph;
        }

        function findConnectedComponents(graph, startNode) {
            if (!graph.has(startNode)) {
                return [];
            }

            const visited = new Set();
            const queue = [startNode];
            visited.add(startNode);

            while (queue.length > 0) {
                const node = queue.shift();
                const neighbors = graph.get(node) || new Set();

                for (const neighbor of neighbors) {
                    if (!visited.has(neighbor)) {
                        visited.add(neighbor);
                        queue.push(neighbor);
                    }
                }
            }

            return [...visited];
        }

        function getWireInfo(code, pin) {
            for (const row of wirelistData) {
                let fromCode = '', toCode = '', fromPin = '', toPin = '';
                let wireId = '', wireSize = '', wireColor = '', option = '';

                for (const key in row) {
                    const keyLower = key.toLowerCase();
                    const value = String(row[key] || '').trim();

                    if (keyLower.includes('from code') || keyLower.includes('fromcode')) {
                        fromCode = value;
                    } else if (keyLower.includes('to code') || keyLower.includes('tocode')) {
                        toCode = value;
                    } else if (keyLower.includes('from pin') || keyLower.includes('frompin')) {
                        fromPin = value;
                    } else if (keyLower.includes('to pin') || keyLower.includes('topin')) {
                        toPin = value;
                    } else if (keyLower.includes('wire') && keyLower.includes('id')) {
                        wireId = value;
                    } else if (keyLower.includes('size') || keyLower.includes('gauge') ||
                               (keyLower.includes('size') && keyLower.includes('/'))) {
                        wireSize = value;
                    } else if (keyLower.includes('color')) {
                        wireColor = value;
                    } else if (keyLower.includes('option')) {
                        option = value;
                    }
                }

                if ((fromCode === code && fromPin === pin) || (toCode === code && toPin === pin)) {
                    if (!wireId) {
                        for (const key in row) {
                            const keyLower = key.toLowerCase();
                            const value = String(row[key] || '').trim();
                            if (keyLower.includes('wire') || keyLower.includes('id')) {
                                if (!keyLower.includes('size')) {
                                    wireId = value;
                                    break;
                                }
                            }
                        }
                    }
                    if (!wireSize) {
                        for (const key in row) {
                            const keyLower = key.toLowerCase();
                            const value = String(row[key] || '').trim();
                            if (keyLower.includes('size') || keyLower.includes('gauge') ||
                                keyLower.includes('è§„æ ¼') || keyLower.includes('çº¿å¾„') ||
                                (keyLower.includes('size') && keyLower.includes('/'))) {
                                if (!keyLower.includes('wire') || keyLower.includes('gauge')) {
                                    wireSize = value;
                                    break;
                                }
                            }
                        }
                    }
                    if (!wireColor) {
                        for (const key in row) {
                            const keyLower = key.toLowerCase();
                            const value = String(row[key] || '').trim();
                            if (keyLower.includes('color') || keyLower.includes('é¢œè‰²')) {
                                wireColor = value;
                                break;
                            }
                        }
                    }
                    if (!option) {
                        for (const key in row) {
                            const keyLower = key.toLowerCase();
                            const value = String(row[key] || '').trim();
                            if (keyLower.includes('opt')) {
                                option = value;
                                break;
                            }
                        }
                    }
                    return { wireId, wireSize, wireColor, option };
                }
            }

            return { wireId: '', wireSize: '', wireColor: '', option: '' };
        }

        function getChineseDescription(code) {
            if (connlistArrayData && connlistArrayData.length > 0) {
                const headerRow = connlistArrayData[0];

                let codeColIndex = -1;
                for (let i = 0; i < headerRow.length; i++) {
                    const header = String(headerRow[i] || '').toLowerCase();
                    if (header.includes('çŸ­å·') || header.includes('code') || header.includes('short code')) {
                        codeColIndex = i;
                        break;
                    }
                }

                const descColIndex = 2;

                for (let i = 1; i < connlistArrayData.length; i++) {
                    const row = connlistArrayData[i];
                    if (codeColIndex >= 0 && row[codeColIndex]) {
                        const rowCode = String(row[codeColIndex] || '').trim();
                        if (rowCode === code && descColIndex < row.length) {
                            const desc = String(row[descColIndex] || '').trim();
                            if (desc && !desc.includes('æ¥åœ°')) {
                                return desc;
                            }
                        }
                    }
                }
            }

            return '';
        }

        function getFamily(code) {
            if (connlistArrayData && connlistArrayData.length > 0) {
                const headerRow = connlistArrayData[0];

                let codeColIndex = -1;
                let familyColIndex = -1;

                for (let i = 0; i < headerRow.length; i++) {
                    const header = String(headerRow[i] || '').toLowerCase();

                    if (codeColIndex === -1 && (header.includes('çŸ­å·') || header.includes('code') || header.includes('short code'))) {
                        codeColIndex = i;
                    }

                    if (familyColIndex === -1 && header.includes('family')) {
                        familyColIndex = i;
                    }
                }

                if (codeColIndex >= 0 && familyColIndex >= 0) {
                    for (let i = 1; i < connlistArrayData.length; i++) {
                        const row = connlistArrayData[i];
                        if (row[codeColIndex]) {
                            const rowCode = String(row[codeColIndex] || '').trim();
                            if (rowCode === code && familyColIndex < row.length) {
                                const family = String(row[familyColIndex] || '').trim();
                                if (family) {
                                    return family;
                                }
                            }
                        }
                    }
                }
            }

            return '';
        }

        function generateGroundingListData(groundCodes, inlineList, connectors, graph) {
            const groundingData = [];
            const inlineSet = new Set(inlineList);
            const connectorSet = new Set(connectors);

            const connlistCodes = getAllConnlistCodes();
            const weldPoints = identifyWeldPoints(connlistCodes);
            const weldSet = new Set(weldPoints);

            for (const groundCode of groundCodes) {
                let connectedNodes = [];
                for (const node of graph.keys()) {
                    if (node.startsWith(groundCode + ':')) {
                        connectedNodes = findConnectedComponents(graph, node);
                        break;
                    }
                }

                const connectorInfo = {};
                const allWireIds = [];
                const allOptions = [];

                for (const node of connectedNodes) {
                    if (node.startsWith(groundCode) ||
                        [...inlineSet].some(inline => node.includes(inline))) {
                        continue;
                    }

                    if (node.includes(':')) {
                        const [code, pin] = node.split(':');

                        if (code && pin && connectorSet.has(code)) {
                            if (!connectorInfo[code]) {
                                connectorInfo[code] = new Set();
                            }
                            connectorInfo[code].add(pin);

                            const wireInfo = getWireInfo(code, pin);
                            if (wireInfo.wireId) {
                                allWireIds.push(wireInfo.wireId);
                            }
                            if (wireInfo.option) {
                                allOptions.push(wireInfo.option);
                            }
                        }
                    }
                }

                const groundingType = analyzeGroundingType(groundCode, connectedNodes, allWireIds, allOptions, weldSet, inlineSet);

                for (const code in connectorInfo) {
                    const chineseDesc = getChineseDescription(code);
                    const pins = [...connectorInfo[code]];

                for (const pin of pins) {
                    const { wireId, wireSize, wireColor, option } = getWireInfo(code, pin);
                    const family = getFamily(groundCode);

                    groundingData.push({
                        'Family': family,
                        'æ¥åœ°çŸ­å·': groundCode,
                        'æ’ä»¶çŸ­å·': code,
                        'ä¸­æ–‡æè¿°': chineseDesc,
                        'æ’ä»¶PIN': pin,
                        'Wire ID': wireId,
                        'çº¿å¾„': wireSize,
                        'çº¿è‰²': wireColor,
                        'Option': option,
                        'æ­é“ç±»å‹åˆ†æ': groundingType
                    });
                }
                }
            }

            return groundingData;
        }

        // åˆ†ææ­é“ç±»å‹
        function analyzeGroundingType(groundCode, connectedNodes, wireIds, options, weldSet, inlineSet) {
            const hasDCWireId = wireIds.some(wireId => wireId && wireId.toUpperCase().startsWith('DC'));
            if (hasDCWireId) {
                return 'å¹¶å‹æ¥åœ°';
            }

            let connectedViaWeld = false;
            for (const node of connectedNodes) {
                if (!node.includes(':')) {
                    if (weldSet.has(node)) {
                        connectedViaWeld = true;
                        break;
                    }
                }
            }

            if (connectedViaWeld) {
                return 'ç„Šç‚¹æ¥åœ°';
            }

            let connectorCount = 0;
            const uniqueOptions = new Set();

            for (const node of connectedNodes) {
                if (node.includes(':')) {
                    const [code, pin] = node.split(':');
                    if (code !== groundCode && !inlineSet.has(code) && !weldSet.has(code)) {
                        connectorCount++;
                    }
                }
            }

            for (const option of options) {
                if (option) {
                    uniqueOptions.add(option);
                }
            }

            if (connectorCount === 1 ||
                (connectorCount >= 2 && connectorCount <= 3 && uniqueOptions.size > 1)) {
                return 'å•ç‹¬æ¥åœ°';
            }

            return '';
        }

        // ==========================================
        // æ˜¾ç¤ºç»“æœ
        // ==========================================

        function displayResults(groundCodes, data) {
            document.getElementById('resultsSection').classList.add('show');

            window.originalGroundingList = data;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>è¯†åˆ«çš„æ¥åœ°ç«¯å­</h4>
                    <div class="value">${groundCodes.length}</div>
                </div>
                <div class="stat-card">
                    <h4>åˆå¹¶åçš„æ¥åœ°è¡Œæ•°</h4>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-card">
                    <h4>è¿æ¥çš„æ’ä»¶æ€»æ•°</h4>
                    <div class="value">${data.reduce((sum, item) => sum + (item['æ’ä»¶çŸ­å·'] || '').split('\n').length, 0)}</div>
                </div>
                <div class="stat-card">
                    <h4>æ€»è¿æ¥å…³ç³»</h4>
                    <div class="value">${data.reduce((sum, item) => sum + (item['æ’ä»¶çŸ­å·'] || '').split('\n').length, 0)}</div>
                </div>
            `;

            displayGroundingList(data);
        }

        function displayGroundingList(data) {
            const table = document.getElementById('generatedTable');

            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td>æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            let html = '<thead><tr>';
            html += '<th>Family</th><th>æ¥åœ°çŸ­å·</th><th>æ’ä»¶çŸ­å·</th><th>ä¸­æ–‡æè¿°</th><th>æ’ä»¶PIN</th><th>Wire ID</th><th>çº¿å¾„</th><th>çº¿è‰²</th><th>Option</th><th>æ­é“ç±»å‹åˆ†æ</th>';
            html += '</tr></thead><tbody>';

            data.forEach(item => {
                html += `<tr>
                    <td><strong>${item['Family'] || ''}</strong></td>
                    <td><strong>${item['æ¥åœ°çŸ­å·'] || ''}</strong></td>
                    <td class="multi-line">${item['æ’ä»¶çŸ­å·'] || ''}</td>
                    <td class="multi-line">${item['ä¸­æ–‡æè¿°'] || ''}</td>
                    <td class="multi-line">${item['æ’ä»¶PIN'] || ''}</td>
                    <td class="multi-line">${item['Wire ID'] || ''}</td>
                    <td class="multi-line">${item['çº¿å¾„'] || ''}</td>
                    <td class="multi-line">${item['çº¿è‰²'] || ''}</td>
                    <td class="multi-line">${item['Option'] || ''}</td>
                    <td><strong>${item['æ­é“ç±»å‹åˆ†æ'] || ''}</strong></td>
                </tr>`;
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            const filterSection = document.getElementById('filterSection');
            if (tabName === 'generated') {
                filterSection.style.display = 'block';
            } else {
                filterSection.style.display = 'none';
            }
        }

        // ç­›é€‰æ¥åœ°æ¸…å•
        function filterGroundingList() {
            const filterText = document.getElementById('filterInput').value.trim().toUpperCase();
            if (!filterText) {
                displayGroundingList(groundingList);
                return;
            }

            const filtered = groundingList.filter(item => {
                const groundCode = (item['æ¥åœ°çŸ­å·'] || '').toUpperCase();
                return groundCode.startsWith(filterText);
            });

            displayGroundingList(filtered);
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            document.getElementById('filterInput').value = '';
            displayGroundingList(groundingList);
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type + ' show';
            if (text) {
                setTimeout(() => msg.classList.remove('show'), 5000);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('generateBtn').disabled = show;
        }

        // ==========================================
        // V6 æ–°å¢ï¼šå¸¦æ ·å¼çš„Excelå¯¼å‡ºåŠŸèƒ½
        // ==========================================

        // åˆ›å»ºå•å…ƒæ ¼æ ·å¼
        function createCellStyle(options) {
            const style = {};

            if (options.font) {
                style.font = options.font;
            }

            if (options.fill) {
                style.fill = options.fill;
            }

            if (options.alignment) {
                style.alignment = options.alignment;
            }

            if (options.border) {
                style.border = options.border;
            }

            return style;
        }

        // è®¡ç®—åˆ—å®½
        function calculateColumnWidth(data) {
            const colWidths = {};
            const keys = ['Family', 'æ¥åœ°çŸ­å·', 'æ’ä»¶çŸ­å·', 'ä¸­æ–‡æè¿°', 'æ’ä»¶PIN', 'Wire ID', 'çº¿å¾„', 'çº¿è‰²', 'Option', 'æ­é“ç±»å‹åˆ†æ'];

            keys.forEach(key => {
                colWidths[key] = {
                    wch: Math.max(
                        key.length,
                        ...data.map(row => String(row[key] || '').length)
                    ) + 2
                };

                // é™åˆ¶æœ€å¤§å’Œæœ€å°å®½åº¦
                if (colWidths[key].wch < 10) colWidths[key].wch = 10;
                if (colWidths[key].wch > 50) colWidths[key].wch = 50;
            });

            return colWidths;
        }

        // è·å–æ­é“ç±»å‹çš„èƒŒæ™¯è‰²
        function getTypeColor(type) {
            switch(type) {
                case 'å¹¶å‹æ¥åœ°':
                    return { fgColor: { rgb: "FFC6EFCE" } }; // ç»¿è‰²èƒŒæ™¯
                case 'ç„Šç‚¹æ¥åœ°':
                    return { fgColor: { rgb: "FFFFEB9C" } }; // é»„è‰²èƒŒæ™¯
                case 'å•ç‹¬æ¥åœ°':
                    return { fgColor: { rgb: "FFE2EFDA" } }; // æµ…ç»¿èƒŒæ™¯
                default:
                    return null;
            }
        }

        // å¯¼å‡ºå¸¦æ ·å¼çš„Excelï¼ˆV6ä¸»è¦åŠŸèƒ½ï¼‰
        function downloadStyledExcel() {
            let dataToDownload = window.originalGroundingList || groundingList;

            if (!dataToDownload || dataToDownload.length === 0) {
                showMessage('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦åœ¨ç­›é€‰çŠ¶æ€
            const filterText = document.getElementById('filterInput')?.value?.trim();
            if (filterText) {
                const filterUpper = filterText.toUpperCase();
                dataToDownload = dataToDownload.filter(item => {
                    const groundCode = (item['æ¥åœ°çŸ­å·'] || '').toUpperCase();
                    return groundCode.startsWith(filterUpper);
                });
            }

            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();

                // å‡†å¤‡æ•°æ®ï¼Œæ·»åŠ è¡¨å¤´
                const headers = ['Family', 'æ¥åœ°çŸ­å·', 'æ’ä»¶çŸ­å·', 'ä¸­æ–‡æè¿°', 'æ’ä»¶PIN', 'Wire ID', 'çº¿å¾„', 'çº¿è‰²', 'Option', 'æ­é“ç±»å‹åˆ†æ'];
                const rows = [headers, ...dataToDownload.map(item => [
                    item['Family'] || '',
                    item['æ¥åœ°çŸ­å·'] || '',
                    item['æ’ä»¶çŸ­å·'] || '',
                    item['ä¸­æ–‡æè¿°'] || '',
                    item['æ’ä»¶PIN'] || '',
                    item['Wire ID'] || '',
                    item['çº¿å¾„'] || '',
                    item['çº¿è‰²'] || '',
                    item['Option'] || '',
                    item['æ­é“ç±»å‹åˆ†æ'] || ''
                ])];

                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(rows);

                // å®šä¹‰æ ·å¼
                const headerStyle = {
                    font: { bold: true, sz: 12, color: { rgb: "FFFFFFFF" } },
                    fill: { fgColor: { rgb: "FF667EEA" } },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "FF000000" } },
                        bottom: { style: "thin", color: { rgb: "FF000000" } },
                        left: { style: "thin", color: { rgb: "FF000000" } },
                        right: { style: "thin", color: { rgb: "FF000000" } }
                    }
                };

                const dataStyle = {
                    font: { sz: 11 },
                    alignment: { horizontal: "left", vertical: "top", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        left: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        right: { style: "thin", color: { rgb: "FFD3D3D3" } }
                    }
                };

                const evenRowStyle = {
                    font: { sz: 11 },
                    fill: { fgColor: { rgb: "FFF8F9FA" } },
                    alignment: { horizontal: "left", vertical: "top", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        left: { style: "thin", color: { rgb: "FFD3D3D3" } },
                        right: { style: "thin", color: { rgb: "FFD3D3D3" } }
                    }
                };

                // åº”ç”¨æ ·å¼åˆ°è¡¨å¤´
                headers.forEach((_, colIndex) => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: colIndex });
                    if (!ws[cellAddress]) ws[cellAddress] = {};
                    ws[cellAddress].s = headerStyle;
                });

                // åº”ç”¨æ ·å¼åˆ°æ•°æ®è¡Œ
                for (let rowIndex = 1; rowIndex < rows.length; rowIndex++) {
                    const rowData = rows[rowIndex];
                    const groundingType = rowData[9]; // æ­é“ç±»å‹åˆ†æåˆ—

                    for (let colIndex = 0; colIndex < headers.length; colIndex++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
                        if (!ws[cellAddress]) ws[cellAddress] = {};

                        // ä½¿ç”¨äº¤æ›¿è¡Œæ ·å¼
                        if (rowIndex % 2 === 0) {
                            ws[cellAddress].s = evenRowStyle;
                        } else {
                            ws[cellAddress].s = dataStyle;
                        }

                        // ä¸ºç‰¹å®šåˆ—æ·»åŠ ç‰¹æ®Šæ ·å¼
                        if (colIndex === 9 && groundingType) {
                            // æ­é“ç±»å‹åˆ†æåˆ—ï¼šæ·»åŠ èƒŒæ™¯è‰²
                            const typeColor = getTypeColor(groundingType);
                            if (typeColor) {
                                ws[cellAddress].s = {
                                    font: { bold: true, sz: 11 },
                                    fill: typeColor,
                                    alignment: { horizontal: "center", vertical: "center" },
                                    border: {
                                        top: { style: "thin", color: { rgb: "FFD3D3D3" } },
                                        bottom: { style: "thin", color: { rgb: "FFD3D3D3" } },
                                        left: { style: "thin", color: { rgb: "FFD3D3D3" } },
                                        right: { style: "thin", color: { rgb: "FFD3D3D3" } }
                                    }
                                };
                            }
                        }

                        // Familyå’Œæ¥åœ°çŸ­å·åˆ—ï¼šåŠ ç²—
                        if (colIndex === 0 || colIndex === 1) {
                            if (ws[cellAddress].s) {
                                ws[cellAddress].s.font = { bold: true, sz: 11, color: { rgb: "FF333333" } };
                            }
                        }
                    }
                }

                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 12 },  // Family
                    { wch: 15 },  // æ¥åœ°çŸ­å·
                    { wch: 40 },  // æ’ä»¶çŸ­å·
                    { wch: 35 },  // ä¸­æ–‡æè¿°
                    { wch: 30 },  // æ’ä»¶PIN
                    { wch: 25 },  // Wire ID
                    { wch: 12 },  // çº¿å¾„
                    { wch: 12 },  // çº¿è‰²
                    { wch: 15 },  // Option
                    { wch: 15 }   // æ­é“ç±»å‹åˆ†æ
                ];

                // è®¾ç½®è¡Œé«˜
                ws['!rows'] = rows.map((_, rowIndex) => {
                    if (rowIndex === 0) {
                        return { hpx: 30 }; // è¡¨å¤´è¡Œé«˜
                    } else {
                        return { hpx: 60 }; // æ•°æ®è¡Œé«˜ï¼ˆæ”¯æŒå¤šè¡Œæ˜¾ç¤ºï¼‰
                    }
                });

                // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'æ¥åœ°æ¸…å•');

                // ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `æ¥åœ°æ¸…å•_${timestamp}.xlsx`;

                // ä¸‹è½½æ–‡ä»¶
                XLSX.writeFile(wb, filename);
                showMessage(`âœ… å·²æˆåŠŸå¯¼å‡ºå¸¦æ ¼å¼Excelæ–‡ä»¶ï¼š${filename}`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                showMessage('âŒ å¯¼å‡ºExcelå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºç®€å•Excelï¼ˆæ— æ ·å¼ï¼Œå‘åå…¼å®¹ï¼‰
        function downloadSimpleExcel() {
            let dataToDownload = window.originalGroundingList || groundingList;

            if (!dataToDownload || dataToDownload.length === 0) {
                showMessage('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®', 'error');
                return;
            }

            const filterText = document.getElementById('filterInput')?.value?.trim();
            if (filterText) {
                const filterUpper = filterText.toUpperCase();
                dataToDownload = dataToDownload.filter(item => {
                    const groundCode = (item['æ¥åœ°çŸ­å·'] || '').toUpperCase();
                    return groundCode.startsWith(filterUpper);
                });
            }

            const ws = XLSX.utils.json_to_sheet(dataToDownload);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ¥åœ°æ¸…å•');

            XLSX.writeFile(wb, 'æ¥åœ°æ¸…å•_ç®€å•ç‰ˆ.xlsx');
            showMessage('âœ… å·²å¯¼å‡ºç®€å•ç‰ˆExcelæ–‡ä»¶ï¼ˆæ— æ ¼å¼ï¼‰', 'success');
        }

        // ==========================================
        // å¤åˆ¶HTMLè¡¨æ ¼åˆ°å‰ªè´´æ¿
        // ==========================================

        function copyHtmlToClipboard() {
            const table = document.getElementById('generatedTable');

            if (!table || table.innerHTML.trim() === '' || table.innerHTML.includes('æš‚æ— æ•°æ®')) {
                showMessage('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®ï¼Œè¯·å…ˆç”Ÿæˆæ¥åœ°æ¸…å•', 'error');
                return;
            }

            try {
                // è·å–å½“å‰ç­›é€‰çŠ¶æ€çš„æ•°æ®
                let dataToCopy = window.originalGroundingList || groundingList;

                const filterText = document.getElementById('filterInput')?.value?.trim();
                if (filterText) {
                    const filterUpper = filterText.toUpperCase();
                    dataToCopy = dataToCopy.filter(item => {
                        const groundCode = (item['æ¥åœ°çŸ­å·'] || '').toUpperCase();
                        return groundCode.startsWith(filterUpper);
                    });
                }

                // åˆ›å»ºå¸¦æ ·å¼çš„HTMLè¡¨æ ¼
                let html = '<table border="1" style="border-collapse: collapse; table-layout: auto; font-size: 12px; font-family: Arial, sans-serif;">';

                // æ·»åŠ è¡¨å¤´
                html += '<thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: black; font-weight: bold; text-align: center; white-space: nowrap;">';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">Family</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">æ¥åœ°çŸ­å·</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">æ’ä»¶çŸ­å·</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">ä¸­æ–‡æè¿°</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">æ’ä»¶PIN</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">Wire ID</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">çº¿å¾„</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">çº¿è‰²</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">Option</th>';
                html += '<th style="padding: 10px; border: 1px solid #333; mso-number-format:\'@\'; white-space: nowrap;">æ­é“ç±»å‹åˆ†æ</th>';
                html += '</tr></thead><tbody>';

                // æ·»åŠ æ•°æ®è¡Œï¼ˆæ‹†åˆ†æ¢è¡Œç¬¦ä¸ºå¤šè¡Œï¼‰
                let totalRowCount = 0;
                dataToCopy.forEach((item, index) => {
                    // å°†åŒ…å«æ¢è¡Œç¬¦çš„å­—æ®µæ‹†åˆ†æˆæ•°ç»„
                    const splitField = (value) => {
                        if (!value) return [''];
                        return String(value).split('\n').map(v => v.trim()).filter(v => v);
                    };

                    const familyArr = [item['Family'] || ''];
                    const groundCodeArr = [item['æ¥åœ°çŸ­å·'] || ''];
                    const connectorArr = splitField(item['æ’ä»¶çŸ­å·']);
                    const descArr = splitField(item['ä¸­æ–‡æè¿°']);
                    const pinArr = splitField(item['æ’ä»¶PIN']);
                    const wireIdArr = splitField(item['Wire ID']);
                    const wireSizeArr = splitField(item['çº¿å¾„']);
                    const wireColorArr = splitField(item['çº¿è‰²']);
                    const optionArr = splitField(item['Option']);
                    const typeArr = [item['æ­é“ç±»å‹åˆ†æ'] || ''];

                    // æ‰¾å‡ºæœ€é•¿çš„æ•°ç»„é•¿åº¦ï¼ˆéœ€è¦æ‹†åˆ†çš„è¡Œæ•°ï¼‰
                    const maxRows = Math.max(
                        connectorArr.length,
                        descArr.length,
                        pinArr.length,
                        wireIdArr.length,
                        wireSizeArr.length,
                        wireColorArr.length,
                        optionArr.length,
                        1
                    );

                    // å¡«å……æ•°ç»„ï¼Œä½¿æ‰€æœ‰æ•°ç»„é•¿åº¦ä¸€è‡´
                    while (connectorArr.length < maxRows) connectorArr.push('');
                    while (descArr.length < maxRows) descArr.push('');
                    while (pinArr.length < maxRows) pinArr.push('');
                    while (wireIdArr.length < maxRows) wireIdArr.push('');
                    while (wireSizeArr.length < maxRows) wireSizeArr.push('');
                    while (wireColorArr.length < maxRows) wireColorArr.push('');
                    while (optionArr.length < maxRows) optionArr.push('');

                    // ç”Ÿæˆå¤šè¡ŒHTML
                    for (let i = 0; i < maxRows; i++) {
                        const isEvenRow = totalRowCount % 2 === 0;
                        const rowStyle = isEvenRow
                            ? 'background: #ffffff;'
                            : 'background: #f8f9fa;';

                        html += `<tr style="${rowStyle}">`;

                        // ç¬¬ä¸€è¡Œï¼šéœ€è¦åˆå¹¶çš„åˆ—ä½¿ç”¨ rowspan
                        if (i === 0) {
                            // Family åˆ— - åˆå¹¶
                            html += `<td rowspan="${maxRows}" style="padding: 8px; border: 1px solid #ddd; font-weight: bold; vertical-align: middle; mso-number-format:\'@\'; white-space: nowrap;">${familyArr[0]}</td>`;
                            // æ¥åœ°çŸ­å·åˆ— - åˆå¹¶
                            html += `<td rowspan="${maxRows}" style="padding: 8px; border: 1px solid #ddd; font-weight: bold; vertical-align: middle; mso-number-format:\'@\'; white-space: nowrap;">${groundCodeArr[0]}</td>`;
                        }

                        // ä¸éœ€è¦åˆå¹¶çš„åˆ—
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${connectorArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${descArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${pinArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${wireIdArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${wireSizeArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${wireColorArr[i] || ''}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; mso-number-format:\'@\'; white-space: nowrap;">${optionArr[i] || ''}</td>`;

                        // æ­é“ç±»å‹åˆ†æåˆ— - åˆå¹¶
                        if (i === 0) {
                            const type = typeArr[0];
                            let typeStyle = 'padding: 8px; border: 1px solid #ddd; font-weight: bold; text-align: center; vertical-align: middle; mso-number-format:\'@\'; white-space: nowrap;';
                            if (type === 'å¹¶å‹æ¥åœ°') {
                                typeStyle += 'background: #c6efce; color: #006100;';
                            } else if (type === 'ç„Šç‚¹æ¥åœ°') {
                                typeStyle += 'background: #ffeb9c; color: #9c6500;';
                            } else if (type === 'å•ç‹¬æ¥åœ°') {
                                typeStyle += 'background: #e2efda; color: #006100;';
                            }
                            html += `<td rowspan="${maxRows}" style="${typeStyle}">${type}</td>`;
                        }

                        html += '</tr>';
                        totalRowCount++;
                    }
                });

                html += '</tbody></table>';

                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([html], { type: 'text/html' });

                // ä½¿ç”¨Clipboard APIå†™å…¥
                const clipboardItem = new ClipboardItem({
                    'text/html': blob,
                    'text/plain': new Blob([table.innerText], { type: 'text/plain' })
                });

                navigator.clipboard.write([clipboardItem]).then(() => {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    const btn = document.getElementById('copyHtmlBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²å¤åˆ¶!';
                    btn.classList.add('success', 'copied');

                    showMessage(`âœ… å·²æˆåŠŸå¤åˆ¶ ${totalRowCount} è¡Œæ•°æ®åˆ°å‰ªè´´æ¿ï¼ï¼ˆå·²æ‹†åˆ†æ¢è¡Œç¬¦ï¼Œåˆå¹¶ç›¸åŒå•å…ƒæ ¼ï¼‰å¯ä»¥ç›´æ¥ç²˜è´´åˆ°Excel`, 'success');

                    // 2ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('success', 'copied');
                    }, 2000);

                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);

                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿçš„document.execCommand
                    try {
                        const container = document.createElement('div');
                        container.innerHTML = html;
                        container.style.position = 'fixed';
                        container.style.left = '-9999px';
                        document.body.appendChild(container);

                        const range = document.createRange();
                        range.selectNode(container);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);

                        const successful = document.execCommand('copy');
                        document.body.removeChild(container);

                        if (successful) {
                            const btn = document.getElementById('copyHtmlBtn');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = 'âœ… å·²å¤åˆ¶!';
                            btn.classList.add('success', 'copied');

                            showMessage(`âœ… å·²æˆåŠŸå¤åˆ¶ ${totalRowCount} è¡Œæ•°æ®åˆ°å‰ªè´´æ¿ï¼ï¼ˆå·²æ‹†åˆ†æ¢è¡Œç¬¦ï¼Œåˆå¹¶ç›¸åŒå•å…ƒæ ¼ï¼‰`, 'success');

                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('success', 'copied');
                            }, 2000);
                        } else {
                            throw new Error('execCommand failed');
                        }
                    } catch (fallbackErr) {
                        showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©è¡¨æ ¼å†…å®¹åå¤åˆ¶ (Ctrl+C)', 'error');
                    }
                });

            } catch (error) {
                console.error('å¤åˆ¶HTMLå¤±è´¥:', error);
                showMessage('âŒ å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
