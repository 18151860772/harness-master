<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ä»¶å›è·¯æŸ¥è¯¢å·¥å…· V4 - çŸ­æ ·æ¸…å•åˆ†æ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 3px;
        }

        .header p {
            opacity: 0.9;
            font-size: 12px;
        }

        .upload-section {
            padding: 12px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .upload-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-row {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }

        .upload-box {
            flex: 1;
            border: 2px dashed #667eea;
            border-radius: 6px;
            padding: 10px 12px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }

        .upload-box.has-file {
            border-color: #28a745;
            background: #d4edda;
        }

        .upload-box label:first-child {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-box .file-btn {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .upload-box .file-name {
            margin-top: 6px;
            font-size: 11px;
            color: #666;
            word-break: break-all;
        }

        .query-section {
            padding: 12px 30px;
            flex-shrink: 0;
        }

        .query-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 7px 30px 7px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box .search-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 13px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .query-controls select {
            flex: 1;
            min-width: 250px;
            padding: 7px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }

        .query-controls select:focus {
            outline: none;
            border-color: #667eea;
        }

        .query-controls button {
            padding: 7px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .query-controls button#clearBtn {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .query-controls button:hover {
            transform: translateY(-1px);
        }

        .query-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            padding: 0 25px 12px;
        }

        .results-section.show {
            display: flex;
        }

        .results-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .results-header h2 {
            color: #333;
            font-size: 16px;
            margin: 0;
        }

        .results-header p {
            margin: 3px 0 0;
            font-size: 12px;
        }

        .results-header .count {
            color: #667eea;
            font-weight: bold;
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            display: table;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #f0f0f0;
            font-size: 13px;
            white-space: nowrap;
            min-width: 80px;
        }

        th {
            font-weight: 600;
            position: sticky;
            top: 0;
            background: inherit;
            z-index: 10;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tbody tr:nth-child(even):hover {
            background: #f8f9fa;
        }

        .info-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            color: #0c5460;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .export-btn {
            padding: 5px 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }

        .export-btn:hover {
            background: #218838;
        }

        .status-bar {
            padding: 6px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .stats-info {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #666;
        }

        .stats-info span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ’ä»¶å›è·¯æŸ¥è¯¢å·¥å…· V4 - çŸ­æ ·æ¸…å•åˆ†æ</h1>
            <p>åˆ†æå›è·¯è¿æ¥å…³ç³»ï¼Œè¯†åˆ«åŒä¸€å›è·¯çš„æ’ä»¶</p>
        </div>

        <div class="upload-section">
            <div class="upload-title">ğŸ“ æ–‡ä»¶ä¸Šä¼ </div>
            <div class="upload-row">
                <div class="upload-box" id="upload1">
                    <label>1. è¿æ¥åˆ—è¡¨ (T28-Connlist)</label>
                    <input type="file" id="file1" accept=".xlsx,.xls" onchange="handleFile1(this)">
                    <label for="file1" class="file-btn">é€‰æ‹©æ–‡ä»¶</label>
                    <div class="file-name" id="fileName1">æœªé€‰æ‹©</div>
                </div>
                <div class="upload-box" id="upload2">
                    <label>2. çº¿ç¼†åˆ—è¡¨ (WIRELIST)</label>
                    <input type="file" id="file2" accept=".xlsx,.xls" onchange="handleFile2(this)">
                    <label for="file2" class="file-btn">é€‰æ‹©æ–‡ä»¶</label>
                    <div class="file-name" id="fileName2">æœªé€‰æ‹©</div>
                </div>
                <div class="upload-box" id="upload3">
                    <label>3. Inlineåˆ—è¡¨ (Inlinelist)</label>
                    <input type="file" id="file3" accept=".xlsx,.xls" onchange="handleFile3(this)">
                    <label for="file3" class="file-btn">é€‰æ‹©æ–‡ä»¶</label>
                    <div class="file-name" id="fileName3">æœªé€‰æ‹©(å¯é€‰)</div>
                </div>
            </div>
        </div>

        <div class="query-section">
            <div class="query-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢æ’ä»¶ï¼ˆæ”¯æŒä»£ç ã€ä¸­æ–‡ã€çŸ­å·ï¼‰" disabled oninput="handleSearch(this.value)">
                    <span class="search-icon">ğŸ”</span>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <select id="pluginSelect" disabled>
                    <option value="">-- è¯·é€‰æ‹©æ’ä»¶ --</option>
                </select>
                <button id="queryBtn" onclick="queryCircuits()" disabled>æŸ¥è¯¢å›è·¯</button>
                <button id="clearBtn" onclick="clearFilter()" disabled>æ¸…é™¤</button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2>æŸ¥è¯¢ç»“æœ - æ’ä»¶: <span id="selectedPlugin"></span></h2>
                        <p>æ‰¾åˆ° <span class="count" id="circuitCount">0</span> æ¡ç›¸å…³å›è·¯</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="export-btn" style="background: #17a2b8;" onclick="copyHtmlToClipboard()">å¤åˆ¶HTML</button>
                        <button class="export-btn" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="resultsTable">
                    <thead id="resultsTableHead"></thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="info-message" id="infoMessage">
            è¯·ä¸Šä¼  Connlist å’Œ WIRELIST æ–‡ä»¶ï¼ˆInlinelist å¯é€‰ï¼‰å¼€å§‹åˆ†æ
        </div>
    </div>

    <div class="status-bar">
        <div class="stats-info" id="statsInfo">
            <span>ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...</span>
        </div>
        <span>V4.0 | çŸ­æ ·æ¸…å•åˆ†æ</span>
    </div>

    <script>
        let file1Data = null;
        let file2Data = null;
        let file3Data = null;
        let file1Headers = [];
        let file2Headers = [];
        let file3Headers = [];
        let queryResults = [];
        let pluginInfoMap = new Map();
        let originalColumns = [];  // WIRELISTåŸå§‹åˆ—å
        let currentDisplayColumns = [];  // è°ƒæ¢åçš„æ˜¾ç¤ºåˆ—å

        // è¯†åˆ«é›†åˆ
        let inlinePlugins = new Set();
        let groundPlugins = new Set();

        // è¿æ¥å›¾
        let wireGraph = new Map();
        let connectionGraph = new Map();
        let spliceConnections = new Map();
        let inlineConnections = new Map();

        // å…³é”®åˆ—å
        let fromCodeColName = 'From Code';
        let fromPinColName = 'From Pin';
        let toCodeColName = 'To Code';
        let toPinColName = 'To Pin';

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            if (!searchBox || !searchBox.contains(e.target)) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });

        function updateStatus(message, stats = {}) {
            const statsInfo = document.getElementById('statsInfo');
            let html = `<span>${message}</span>`;
            if (stats.pluginCount) html += ` | <span>æ’ä»¶: ${stats.pluginCount}</span>`;
            if (stats.wireCount) html += ` | <span>å›è·¯: ${stats.wireCount}</span>`;
            if (stats.inlineCount) html += ` | <span>Inline: ${stats.inlineCount}</span>`;
            statsInfo.innerHTML = html;
        }

        function handleFile1(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('fileName1').textContent = file.name;
                document.getElementById('upload1').classList.add('has-file');
                updateStatus('æ­£åœ¨è¯»å–Connlist...');
                readExcel(file, 1);
            }
        }

        function handleFile2(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('fileName2').textContent = file.name;
                document.getElementById('upload2').classList.add('has-file');
                updateStatus('æ­£åœ¨è¯»å–WIRELIST...');
                readExcel(file, 2);
            }
        }

        function handleFile3(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('fileName3').textContent = file.name;
                document.getElementById('upload3').classList.add('has-file');
                updateStatus('æ­£åœ¨è¯»å–Inlinelist...');
                readExcel(file, 3);
            }
        }

        function readExcel(file, fileNum) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length > 0) {
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).filter(row => row.some(cell => cell !== undefined && cell !== ''));

                        if (fileNum === 1) {
                            file1Headers = headers;
                            file1Data = rows;
                            updateStatus('æ­£åœ¨è§£æConnlist...');
                            processConnlist();
                        } else if (fileNum === 2) {
                            file2Headers = headers;
                            file2Data = rows;
                            updateStatus('æ­£åœ¨è§£æWIRELIST...');
                            processWIRELIST();
                        } else {
                            file3Headers = headers;
                            file3Data = rows;
                            processInlinelist();
                        }
                        checkAllFilesLoaded();
                    }
                } catch (error) {
                    alert(`è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†Connlist
        function processConnlist() {
            pluginInfoMap.clear();

            // åŠ¨æ€æŸ¥æ‰¾å…³é”®åˆ—ç´¢å¼•
            let shortCodeCol = -1;
            let nameCol = -1;
            let pluginCol = -1;

            // è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰åˆ—å
            console.log('Connlist æ‰€æœ‰åˆ—å:', file1Headers.map((h, i) => `${i}:${h}`));

            file1Headers.forEach((header, index) => {
                const h = String(header || '').trim();
                const hLower = h.toLowerCase();
                if (h === 'çŸ­å·' || hLower === 'short code') shortCodeCol = index;
                // ä¸­æ–‡æè¿°å¯èƒ½æ˜¯"ä¸­æ–‡æè¿°"æˆ–ç›´æ¥æ˜¯ç¬¬3åˆ—(ç´¢å¼•2)
                if (h === 'ä¸­æ–‡æè¿°' || index === 2) nameCol = index;
                if (h.includes('æ’ä»¶') || hLower.includes('plug')) pluginCol = index;
            });

            // å¦‚æœæ²¡æ‰¾åˆ°æ’ä»¶åˆ—ï¼Œå°è¯•é…ç½®åˆ—
            if (pluginCol === -1) {
                pluginCol = file1Headers.findIndex(h => h === 'é…ç½®');
            }
            // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•ç¬¬7åˆ—
            if (pluginCol === -1 && file1Headers.length > 6) {
                pluginCol = 6;
            }

            console.log('Connlist åˆ—ç´¢å¼•:', { shortCodeCol, nameCol, pluginCol });

            // è°ƒè¯•ï¼šè¾“å‡ºå‰5è¡Œæ•°æ®çš„çŸ­å·å’Œæ’ä»¶ä»£ç 
            console.log('Connlist å‰5è¡Œæ•°æ®:');
            file1Data.slice(0, 5).forEach((row, idx) => {
                console.log(`  Row ${idx}: shortCode="${row[shortCodeCol]}", pluginCode="${row[pluginCol]}"`);
            });

            file1Data.forEach(row => {
                const shortCode = shortCodeCol >= 0 ? (row[shortCodeCol] ? String(row[shortCodeCol]).trim() : '') : '';
                const name = nameCol >= 0 ? (row[nameCol] ? String(row[nameCol]).trim() : '') : '';
                const pluginCode = pluginCol >= 0 ? (row[pluginCol] ? String(row[pluginCol]).trim() : '') : '';

                if (pluginCode) {
                    if (!pluginInfoMap.has(pluginCode)) {
                        pluginInfoMap.set(pluginCode, { name, shortCode });
                    }
                }
            });

            // è¯†åˆ«æ¥åœ°æ’ä»¶
            groundPlugins.clear();
            pluginInfoMap.forEach((info, code) => {
                const text = `${info.shortCode} ${info.name}`.toLowerCase();
                if (text.includes('ground') || text.includes('æ¥åœ°') || text.includes('gnd')) {
                    groundPlugins.add(code);
                }
            });

            console.log(`Connlistå¤„ç†å®Œæˆ: ${pluginInfoMap.size}ä¸ªæ’ä»¶`);
        }

        // å¤„ç†Inlinelist
        function processInlinelist() {
            inlinePlugins.clear();
            if (!file3Data || file3Data.length === 0) return;

            file3Data.forEach(row => {
                if (row[0]) {
                    inlinePlugins.add(String(row[0]).trim());
                }
            });

            file3Headers.forEach((header, index) => {
                const h = String(header || '').toLowerCase();
                if (h.includes('short') || h === 'çŸ­å·') {
                    file3Data.forEach(row => {
                        if (row[index]) {
                            inlinePlugins.add(String(row[index]).trim());
                        }
                    });
                }
            });
        }

        // å¤„ç†WIRELISTï¼Œæ„å»ºè¿æ¥å›¾
        function processWIRELIST() {
            wireGraph.clear();
            connectionGraph.clear();
            spliceConnections.clear();
            inlineConnections.clear();

            // æŸ¥æ‰¾å…³é”®åˆ—ç´¢å¼•
            let fromCodeIdx = -1, fromPinIdx = -1, toCodeIdx = -1, toPinIdx = -1;

            // è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰åˆ—å
            console.log('WIRELIST æ‰€æœ‰åˆ—å:', file2Headers.map((h, i) => `${i}:${h}`));

            file2Headers.forEach((header, index) => {
                const h = String(header || '').trim();
                const hLower = h.toLowerCase();
                if (hLower === 'from code') fromCodeIdx = index;
                if (hLower === 'from pin') fromPinIdx = index;
                if (hLower === 'to code') toCodeIdx = index;
                if (hLower === 'to pin') toPinIdx = index;
            });

            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤åˆ—ç´¢å¼•
            if (fromCodeIdx === -1) fromCodeIdx = 8;
            if (fromPinIdx === -1) fromPinIdx = 9;
            if (toCodeIdx === -1) toCodeIdx = 10;
            if (toPinIdx === -1) toPinIdx = 11;

            console.log('WIRELIST åˆ—ç´¢å¼•:', { fromCodeIdx, fromPinIdx, toCodeIdx, toPinIdx });

            // è·å–åˆ—å
            fromCodeColName = file2Headers[fromCodeIdx] || 'From Code';
            fromPinColName = file2Headers[fromPinIdx] || 'From Pin';
            toCodeColName = file2Headers[toCodeIdx] || 'To Code';
            toPinColName = file2Headers[toPinIdx] || 'To Pin';

            // ä¿å­˜åŸå§‹åˆ—åï¼ˆæ’é™¤éšè—åˆ—ï¼‰
            originalColumns = [];
            file2Headers.forEach((header, index) => {
                const h = String(header || '').trim();
                // è·³è¿‡ä¸€äº›æ˜æ˜¾çš„éšè—åˆ—
                if (h && !h.startsWith('_') && h.toLowerCase() !== 'hidden') {
                    originalColumns.push(h);
                }
            });

            file2Data.forEach((row, index) => {
                const fromCode = row[fromCodeIdx] ? String(row[fromCodeIdx]).trim() : '';
                const fromPin = row[fromPinIdx] || '';
                const toCode = row[toCodeIdx] ? String(row[toCodeIdx]).trim() : '';
                const toPin = row[toPinIdx] || '';

                if (!fromCode && !toCode) return;

                const wireData = {
                    _rowData: row,
                    _colIndexMap: {},  // åˆ—ååˆ°ç´¢å¼•çš„æ˜ å°„
                    fromCode: fromCode,
                    fromPin: String(fromPin),
                    toCode: toCode,
                    toPin: String(toPin)
                };

                // æ„å»ºåˆ—ååˆ°ç´¢å¼•çš„æ˜ å°„
                file2Headers.forEach((header, idx) => {
                    const h = String(header || '').trim();
                    if (h && !h.startsWith('_') && h.toLowerCase() !== 'hidden') {
                        wireData._colIndexMap[h] = idx;
                    }
                });

                const wireId = row[0] || `WIRE_${index}`;
                wireGraph.set(wireId, wireData);

                // è°ƒè¯•ï¼šè¾“å‡ºå‰10æ¡æ•°æ®çš„ From Code å’Œ To Code
                if (index < 10) {
                    console.log(`WIRE ${index}: From=${fromCode}(${fromCodeIdx}) Pin=${fromPin}, To=${toCode}(${toCodeIdx}) Pin=${toPin}`);
                }

                // æ’ä»¶åˆ°å›è·¯çš„è¿æ¥
                if (fromCode) {
                    const key = `${fromCode}|${fromPin}`;
                    if (!connectionGraph.has(key)) connectionGraph.set(key, []);
                    connectionGraph.get(key).push(wireId);
                }
                if (toCode) {
                    const key = `${toCode}|${toPin}`;
                    if (!connectionGraph.has(key)) connectionGraph.set(key, []);
                    connectionGraph.get(key).push(wireId);
                }

                // ç„Šç‚¹è¿æ¥ï¼ˆPinä¸ºXï¼‰
                if (String(fromPin).toUpperCase() === 'X' && fromCode) {
                    if (!spliceConnections.has(fromCode)) spliceConnections.set(fromCode, []);
                    spliceConnections.get(fromCode).push(wireId);
                }
                if (String(toPin).toUpperCase() === 'X' && toCode) {
                    if (!spliceConnections.has(toCode)) spliceConnections.set(toCode, []);
                    spliceConnections.get(toCode).push(wireId);
                }

                // Inlineè„šä½è¿æ¥
                if (inlinePlugins.has(fromCode)) {
                    const key = `${fromCode}|${fromPin}`;
                    if (!inlineConnections.has(key)) inlineConnections.set(key, []);
                    inlineConnections.get(key).push(wireId);
                }
                if (inlinePlugins.has(toCode)) {
                    const key = `${toCode}|${toPin}`;
                    if (!inlineConnections.has(key)) inlineConnections.set(key, []);
                    inlineConnections.get(key).push(wireId);
                }
            });
        }

        function checkAllFilesLoaded() {
            if (file1Data && file2Data) {
                document.getElementById('infoMessage').style.display = 'none';
                populatePluginSelect();
                document.getElementById('pluginSelect').disabled = false;
                document.getElementById('queryBtn').disabled = false;
                document.getElementById('clearBtn').disabled = false;
                document.getElementById('searchInput').disabled = false;

                const stats = {
                    pluginCount: pluginInfoMap.size,
                    wireCount: wireGraph.size,
                    inlineCount: inlinePlugins.size,
                    spliceCount: spliceConnections.size
                };
                updateStatus('æ–‡ä»¶åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©æ’ä»¶æŸ¥è¯¢', stats);
            }
        }

        // V4ç‰ˆæœ¬ï¼šåªæ˜¾ç¤ºConnlistä¸­æœ‰çš„çŸ­å·ï¼ˆä½ç½®å·ï¼‰ï¼ŒæŒ‰é¦–å­—æ¯æ’åº
        function populatePluginSelect() {
            const select = document.getElementById('pluginSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ’ä»¶ --</option>';

            // é‡ç½®æ˜ å°„
            shortCodeToPluginCodeMap.clear();

            // åŠ¨æ€æŸ¥æ‰¾Connliståˆ—ç´¢å¼•
            let shortCodeCol = -1, nameCol = -1, pluginCol = -1;
            file1Headers.forEach((header, index) => {
                const h = String(header || '').trim();
                const hLower = h.toLowerCase();
                if (h === 'çŸ­å·' || hLower === 'short code') shortCodeCol = index;
                // ä¸­æ–‡æè¿°å¯èƒ½æ˜¯"ä¸­æ–‡æè¿°"æˆ–ç›´æ¥æ˜¯ç¬¬3åˆ—(ç´¢å¼•2)
                if (h === 'ä¸­æ–‡æè¿°' || index === 2) nameCol = index;
                if (h.includes('æ’ä»¶') || hLower.includes('plug')) pluginCol = index;
            });
            if (pluginCol === -1) pluginCol = file1Headers.findIndex(h => h === 'é…ç½®');
            if (pluginCol === -1 && file1Headers.length > 6) pluginCol = 6;

            // æ”¶é›†çŸ­å·å’Œå¯¹åº”çš„æ’ä»¶ä»£ç 
            const pluginList = [];
            const seenShortCodes = new Set();

            file1Data.forEach(row => {
                const shortCode = shortCodeCol >= 0 ? (row[shortCodeCol] ? String(row[shortCodeCol]).trim() : '') : '';
                const pluginCode = pluginCol >= 0 ? (row[pluginCol] ? String(row[pluginCol]).trim() : '') : '';

                // æ’é™¤æ¥åœ°æ’ä»¶
                if (shortCode && pluginCode && !groundPlugins.has(pluginCode) && !inlinePlugins.has(pluginCode)) {
                    if (!seenShortCodes.has(shortCode)) {
                        seenShortCodes.add(shortCode);
                        pluginList.push({ shortCode, code: pluginCode });
                        shortCodeToPluginCodeMap.set(shortCode, pluginCode);
                    }
                }
            });

            // æŒ‰ç…§çŸ­å·é¦–å­—æ¯æ’åº
            pluginList.sort((a, b) => {
                return String(a.shortCode).localeCompare(String(b.shortCode));
            });

            // è°ƒè¯•ï¼šè¾“å‡ºæ˜ å°„è¡¨å‰10æ¡
            console.log('shortCodeToPluginCodeMap å‰10æ¡:');
            let count = 0;
            shortCodeToPluginCodeMap.forEach((v, k) => {
                if (count < 10) {
                    console.log(`  "${k}" -> "${v}"`);
                    count++;
                }
            });
            console.log('æ˜ å°„è¡¨æ€»æ•°:', shortCodeToPluginCodeMap.size);

            pluginList.forEach(item => {
                const option = document.createElement('option');
                option.value = item.shortCode;  // ç”¨çŸ­å·ä½œä¸ºæŸ¥è¯¢å€¼
                option.textContent = item.shortCode;
                select.appendChild(option);
            });
        }

        // æœç´¢åŠŸèƒ½ - ä¸ä¸‹æ‹‰é€‰é¡¹ä¸€è‡´ï¼Œåªæ˜¾ç¤ºConnlistä¸­çš„çŸ­å·
        function handleSearch(query) {
            const searchResults = document.getElementById('searchResults');
            const trimmedQuery = query.trim();

            if (!trimmedQuery) {
                searchResults.classList.remove('show');
                return;
            }

            const results = [];
            const queryLower = trimmedQuery.toLowerCase();

            // åŠ¨æ€æŸ¥æ‰¾Connliståˆ—ç´¢å¼•
            let shortCodeCol = -1, nameCol = -1, pluginCol = -1;
            file1Headers.forEach((header, index) => {
                const h = String(header || '').trim();
                const hLower = h.toLowerCase();
                if (h === 'çŸ­å·' || hLower === 'short code') shortCodeCol = index;
                // ä¸­æ–‡æè¿°å¯èƒ½æ˜¯"ä¸­æ–‡æè¿°"æˆ–ç›´æ¥æ˜¯ç¬¬3åˆ—(ç´¢å¼•2)
                if (h === 'ä¸­æ–‡æè¿°' || index === 2) nameCol = index;
                if (h.includes('æ’ä»¶') || hLower.includes('plug')) pluginCol = index;
            });
            if (pluginCol === -1) pluginCol = file1Headers.findIndex(h => h === 'é…ç½®');
            if (pluginCol === -1 && file1Headers.length > 6) pluginCol = 6;

            const seenShortCodes = new Set();

            // ç›´æ¥éå†Connlistæ•°æ®è¿›è¡Œæœç´¢ï¼ˆä¸ä¸‹æ‹‰é€‰é¡¹é€»è¾‘ä¸€è‡´ï¼‰
            file1Data.forEach(row => {
                const shortCode = shortCodeCol >= 0 ? (row[shortCodeCol] ? String(row[shortCodeCol]).trim() : '') : '';
                const name = nameCol >= 0 ? (row[nameCol] ? String(row[nameCol]).trim() : '') : '';
                const pluginCode = pluginCol >= 0 ? (row[pluginCol] ? String(row[pluginCol]).trim() : '') : '';

                // æ’é™¤æ¥åœ°å’ŒInlineæ’ä»¶
                if (!pluginCode || groundPlugins.has(pluginCode) || inlinePlugins.has(pluginCode)) {
                    return;
                }

                if (seenShortCodes.has(shortCode)) return;

                // åŒ¹é…é€»è¾‘ï¼šçŸ­å·ã€ä¸­æ–‡æè¿°
                const matchShort = shortCode && shortCode.toLowerCase().includes(queryLower);
                const matchName = name && name.toLowerCase().includes(queryLower);

                if (matchShort || matchName) {
                    seenShortCodes.add(shortCode);
                    results.push({ shortCode: shortCode, name: name, code: pluginCode });
                }
            });

            // æŒ‰ç…§çŸ­å·é¦–å­—æ¯æ’åº
            results.sort((a, b) => {
                return String(a.shortCode).localeCompare(String(b.shortCode));
            });

            if (results.length > 0) {
                searchResults.innerHTML = results.slice(0, 100).map(item => {
                    // æ˜¾ç¤ºæ ¼å¼ï¼šçŸ­å· - ä¸­æ–‡æè¿°
                    let displayHtml = '';
                    if (item.shortCode && item.name) {
                        displayHtml = `<span style="color:#667eea;font-weight:600;">${item.shortCode}</span> - <span style="color:#666;">${item.name}</span>`;
                    } else if (item.shortCode) {
                        displayHtml = `<span style="color:#667eea;font-weight:600;">${item.shortCode}</span>`;
                    } else {
                        displayHtml = `<span style="color:#667eea;font-weight:600;">${item.code}</span>`;
                    }
                    return `<div class="search-result-item" onclick="selectPlugin('${item.shortCode}')">${displayHtml}</div>`;
                }).join('');
                searchResults.classList.add('show');
            } else {
                searchResults.innerHTML = '<div class="search-result-item" style="cursor:default;color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„æ’ä»¶</div>';
                searchResults.classList.add('show');
            }
        }

        // å­˜å‚¨çŸ­å·åˆ°æ’ä»¶ä»£ç çš„æ˜ å°„
        let shortCodeToPluginCodeMap = new Map();

        function selectPlugin(shortCode) {
            // è·å–å¯¹åº”çš„æ’ä»¶ä»£ç 
            const actualPluginCode = shortCodeToPluginCodeMap.get(shortCode) || shortCode;
            // ä»pluginInfoMapä¸­è·å–ä¿¡æ¯ï¼ˆkeyæ˜¯æ’ä»¶ä»£ç ï¼‰
            const info = pluginInfoMap.get(actualPluginCode) || { shortCode: '', name: '' };
            let displayText = '';
            // ä¼˜å…ˆä½¿ç”¨çŸ­å·+åç§°æ˜¾ç¤º
            if (shortCode && info.name) {
                displayText = `${shortCode} - ${info.name}`;
            } else if (shortCode) {
                displayText = shortCode;
            } else {
                displayText = info.shortCode || actualPluginCode;
            }
            document.getElementById('pluginSelect').value = shortCode;
            document.getElementById('searchInput').value = displayText;
            document.getElementById('searchResults').classList.remove('show');
            queryCircuits();
        }

        function clearFilter() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('pluginSelect').value = '';
            queryResults = [];
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('resultsTableHead').innerHTML = '';
            document.getElementById('resultsTableBody').innerHTML = '';
            updateStatus('ç­›é€‰å·²æ¸…é™¤');
        }

        // æŸ¥æ‰¾ä¸ç»™å®šwireç›¸è¿çš„æ‰€æœ‰å›è·¯ï¼ˆåŒä¸€å›è·¯ï¼‰
        function findConnectedWires(wireId, visited = new Set()) {
            if (visited.has(wireId)) return [];
            visited.add(wireId);

            const wire = wireGraph.get(wireId);
            if (!wire) return [wireId];

            const connectedWires = [wireId];

            const checkPin = (code, pin) => {
                const key = `${code}|${pin}`;
                const wires = connectionGraph.get(key) || [];
                wires.forEach(w => {
                    if (w !== wireId && !visited.has(w)) {
                        connectedWires.push(...findConnectedWires(w, visited));
                    }
                });
            };
            checkPin(wire.fromCode, wire.fromPin);
            checkPin(wire.toCode, wire.toPin);

            // ç„Šç‚¹è¿æ¥
            const checkSplice = (code) => {
                const wires = spliceConnections.get(code) || [];
                wires.forEach(w => {
                    if (w !== wireId && !visited.has(w)) {
                        connectedWires.push(...findConnectedWires(w, visited));
                    }
                });
            };
            if (String(wire.fromPin).toUpperCase() === 'X') checkSplice(wire.fromCode);
            if (String(wire.toPin).toUpperCase() === 'X') checkSplice(wire.toCode);

            // Inlineè¿æ¥
            const checkInline = (code, pin) => {
                if (inlinePlugins.has(code)) {
                    const key = `${code}|${pin}`;
                    const wires = inlineConnections.get(key) || [];
                    wires.forEach(w => {
                        if (w !== wireId && !visited.has(w)) {
                            connectedWires.push(...findConnectedWires(w, visited));
                        }
                    });
                }
            };
            checkInline(wire.fromCode, wire.fromPin);
            checkInline(wire.toCode, wire.toPin);

            return [...new Set(connectedWires)];
        }

        // è·å–åŒä¸€å›è·¯çš„æ’ä»¶å’Œè„šä½ä¿¡æ¯
        function getConnectedCircuitsInfo(wireId, selectedPlugin) {
            const connectedWires = findConnectedWires(wireId);
            const result = [];  // æ”¹ä¸ºæ•°ç»„ï¼Œä¿å­˜æ’ä»¶ä¿¡æ¯å’ŒOption

            connectedWires.forEach(w => {
                const wire = wireGraph.get(w);
                if (!wire) return;

                // Fromç«¯ï¼ˆæ’é™¤é€‰ä¸­çš„æ’ä»¶ï¼Œæ’é™¤ç„Šç‚¹ï¼šè„šä½ä¸ºXï¼‰
                if (wire.fromCode && wire.fromCode !== selectedPlugin) {
                    if (String(wire.fromPin).toUpperCase() !== 'X') {
                        const isInline = inlinePlugins.has(wire.fromCode);
                        const info = pluginInfoMap.get(wire.fromCode);
                        let label = '';
                        if (isInline) {
                            label = `[Inline] ${wire.fromCode}-${wire.fromPin}`;
                        } else if (info && info.shortCode) {
                            label = `${info.shortCode} (${wire.fromCode})-${wire.fromPin}`;
                        } else {
                            label = `${wire.fromCode}-${wire.fromPin}`;
                        }
                        // è·å–Optionå€¼
                        const optionIdx = wire._colIndexMap['Option'];
                        const optionValue = optionIdx !== undefined ? wire._rowData[optionIdx] : '';
                        result.push({ label: label, option: optionValue || '' });
                    }
                }

                // Toç«¯ï¼ˆæ’é™¤é€‰ä¸­çš„æ’ä»¶ï¼Œæ’é™¤ç„Šç‚¹ï¼šè„šä½ä¸ºXï¼‰
                if (wire.toCode && wire.toCode !== selectedPlugin) {
                    if (String(wire.toPin).toUpperCase() !== 'X') {
                        const isInline = inlinePlugins.has(wire.toCode);
                        const info = pluginInfoMap.get(wire.toCode);
                        let label = '';
                        if (isInline) {
                            label = `[Inline] ${wire.toCode}-${wire.toPin}`;
                        } else if (info && info.shortCode) {
                            label = `${info.shortCode} (${wire.toCode})-${wire.toPin}`;
                        } else {
                            label = `${wire.toCode}-${wire.toPin}`;
                        }
                        // è·å–Optionå€¼
                        const optionIdx = wire._colIndexMap['Option'];
                        const optionValue = optionIdx !== undefined ? wire._rowData[optionIdx] : '';
                        result.push({ label: label, option: optionValue || '' });
                    }
                }
            });

            // å»é‡
            const uniqueResult = [];
            const seen = new Set();
            result.forEach(item => {
                if (!seen.has(item.label)) {
                    seen.add(item.label);
                    uniqueResult.push(item);
                }
            });

            return uniqueResult;
        }

        // æå–Pinå·ç”¨äºæ’åº
        function extractPinForSort(pinValue) {
            if (!pinValue) return 999999;
            const pin = String(pinValue).trim().toUpperCase();
            if (/^\d+$/.test(pin)) return parseInt(pin, 10);
            const numMatch = pin.match(/\d+/);
            if (numMatch) return parseInt(numMatch[0], 10);
            if (/^[A-Z]$/.test(pin)) return pin.charCodeAt(0) - 64;
            let value = 0;
            for (let i = 0; i < pin.length; i++) {
                value = value * 26 + (pin.charCodeAt(i) - 64);
            }
            return value;
        }

        // æ„å»ºæ˜¾ç¤ºåˆ—é¡ºåº - V1ç‰ˆæœ¬ï¼šä¿æŒåŸå§‹åˆ—é¡ºåº
        function buildDisplayColumns() {
            // ç›´æ¥ä½¿ç”¨åŸå§‹åˆ—é¡ºåºï¼Œä¸è¿›è¡Œè°ƒæ¢
            return originalColumns.slice();
        }

        // è·å–åˆ—æ ‡ç­¾ - V1ç‰ˆæœ¬ï¼šä¿æŒåŸå§‹åˆ—åï¼Œä¸è°ƒæ¢æ˜¾ç¤ºåç§°
        function getColumnLabel(colName, isFromPlugin) {
            // V1ç‰ˆæœ¬ï¼šè¡¨å¤´å§‹ç»ˆæ˜¾ç¤ºåŸå§‹åˆ—å
            return colName;
        }

        // è·å–åˆ—å€¼ï¼ˆæ ¹æ®æ˜¯å¦è°ƒæ¢ï¼‰
        function getColumnValue(rowData, colName, isFromPlugin) {
            const colLower = String(colName).toLowerCase();

            // Wire ID ç‰¹æ®Šå¤„ç†
            if (colLower === 'wire ID' || colLower === 'wire id' || colLower === 'wireid') {
                return rowData._rowData[0] || '';
            }

            if (isFromPlugin) {
                // æ’ä»¶åœ¨ Fromï¼šé€šè¿‡åˆ—åæŸ¥æ‰¾ç´¢å¼•è·å–å€¼
                const idx = rowData._colIndexMap[colName];
                return idx !== undefined && rowData._rowData[idx] !== undefined ? rowData._rowData[idx] : '';
            } else {
                // æ’ä»¶åœ¨ Toï¼šéœ€è¦è°ƒæ¢ From/To
                if (colLower === 'from code') {
                    return rowData.toCode;
                } else if (colLower === 'from pin') {
                    return rowData.toPin;
                } else if (colLower === 'to code') {
                    return rowData.fromCode;
                } else if (colLower === 'to pin') {
                    return rowData.fromPin;
                } else {
                    // å…¶ä»–åˆ—ï¼šé€šè¿‡åˆ—åæŸ¥æ‰¾ç´¢å¼•è·å–å€¼
                    const idx = rowData._colIndexMap[colName];
                    return idx !== undefined && rowData._rowData[idx] !== undefined ? rowData._rowData[idx] : '';
                }
            }
        }

        // åˆ¤æ–­æŸåˆ—æ˜¯å¦éœ€è¦é«˜äº® - V1ç‰ˆæœ¬ï¼šFrom Code å’Œ From Pin è¿™ä¸¤åˆ—å§‹ç»ˆæœ‰é¢œè‰²
        function shouldHighlight(colName, isFromPlugin) {
            const colLower = String(colName).toLowerCase();
            // V1è§„åˆ™ï¼šFrom Code å’Œ From Pin è¿™ä¸¤åˆ—å§‹ç»ˆæœ‰é¢œè‰²ï¼ˆåœ¨æ˜¾ç¤ºä½ç½®ä¸Šï¼‰
            return colLower === 'from code' || colLower === 'from pin';
        }

        function queryCircuits() {
            const selectedShortCode = document.getElementById('pluginSelect').value;
            if (!selectedShortCode) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ’ä»¶');
                return;
            }

            // çŸ­å·è½¬æ’ä»¶ä»£ç 
            const selectedPlugin = shortCodeToPluginCodeMap.get(selectedShortCode) || selectedShortCode;

            console.log('æŸ¥è¯¢æ’ä»¶ - çŸ­å·:', selectedShortCode, 'æ’ä»¶ä»£ç :', selectedPlugin);

            queryResults = [];
            const results = [];

            // æŸ¥æ‰¾è¯¥æ’ä»¶è¿æ¥çš„æ‰€æœ‰å›è·¯ï¼ˆåŒæ—¶åŒ¹é…çŸ­å·å’Œæ’ä»¶ä»£ç ï¼‰
            wireGraph.forEach((wire, wireId) => {
                const isFromPlugin = wire.fromCode === selectedPlugin || wire.fromCode === selectedShortCode;
                const isToPlugin = wire.toCode === selectedPlugin || wire.toCode === selectedShortCode;

                if (isFromPlugin || isToPlugin) {
                    const connectedInfo = getConnectedCircuitsInfo(wireId, selectedPlugin);

                    // è®¡ç®—æ’åºå€¼
                    const sortPin = isFromPlugin
                        ? extractPinForSort(wire.fromPin)
                        : extractPinForSort(wire.toPin);

                    // æ’åºç”¨çš„ From Code
                    const sortFromCode = isFromPlugin ? wire.fromCode : wire.toCode;

                    results.push({
                        _wireData: wire,
                        _isFromPlugin: isFromPlugin,
                        _sortPin: sortPin,
                        _sortFromCode: sortFromCode,
                        _connectedInfo: connectedInfo
                    });
                }
            });

            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            console.log('WIRELIST ä¸­çš„æ‰€æœ‰å”¯ä¸€æ’ä»¶ä»£ç :', [...new Set([...wireGraph.values()].map(w => w.fromCode).filter(x => x))].slice(0, 20));
            console.log('è¦åŒ¹é…çš„çŸ­å·:', selectedShortCode);
            console.log('è¦åŒ¹é…çš„æ’ä»¶ä»£ç :', selectedPlugin);

            // æ’åºï¼šFrom Code â†’ From Pin
            results.sort((a, b) => {
                const codeA = String(a._sortFromCode || '').trim();
                const codeB = String(b._sortFromCode || '').trim();
                if (codeA !== codeB) return codeA.localeCompare(codeB);
                return a._sortPin - b._sortPin;
            });

            // æ„å»ºæ˜¾ç¤ºåˆ—é¡ºåº
            currentDisplayColumns = buildDisplayColumns();

            queryResults = results;
            displayResults(selectedShortCode, results);
            updateStatus(`åˆ†æå®Œæˆ: å…±æœ‰ ${results.length} æ¡å›è·¯`);
        }

        function displayResults(shortCode, results) {
            // shortCode è½¬æ¢ä¸º pluginCode è·å–ä¿¡æ¯
            const pluginCode = shortCodeToPluginCodeMap.get(shortCode) || shortCode;
            const info = pluginInfoMap.get(pluginCode);
            let displayText = '';
            if (info && info.shortCode && info.name) {
                displayText = info.shortCode + ' - ' + info.name;
            } else if (info && info.shortCode) {
                displayText = info.shortCode;
            } else if (info && info.name) {
                displayText = info.name;
            } else {
                displayText = shortCode;
            }
            document.getElementById('selectedPlugin').textContent = displayText;
            document.getElementById('circuitCount').textContent = results.length;
            document.getElementById('resultsSection').classList.add('show');

            const thead = document.getElementById('resultsTableHead');
            const tbody = document.getElementById('resultsTableBody');

            // è¡¨å¤´ - éœ€è¦æ ¹æ®ç¬¬ä¸€æ¡æ•°æ®çš„isFromPluginæ¥ç¡®å®šåˆ—æ ‡ç­¾
            const firstRow = results[0];
            const isFromPlugin = firstRow ? firstRow._isFromPlugin : true;

            thead.innerHTML = '<tr>' +
                currentDisplayColumns.map(col => `<th>${getColumnLabel(col, isFromPlugin)}</th>`).join('') +
                '<th>åŒä¸€å›è·¯çš„å…¶ä»–æ’ä»¶å’Œè„šä½</th>' +
                '<th>Option</th>' +
                '</tr>';

            if (results.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${currentDisplayColumns.length + 2}" style="text-align:center;">æœªæ‰¾åˆ°ç›¸å…³å›è·¯</td></tr>`;
                return;
            }

            results.forEach(row => {
                const tr = document.createElement('tr');
                let html = '';

                currentDisplayColumns.forEach(col => {
                    const value = getColumnValue(row._wireData, col, row._isFromPlugin);
                    const highlight = shouldHighlight(col, row._isFromPlugin);

                    if (highlight) {
                        html += `<td style="background: #e7f3ff; color: #667eea; font-weight: bold;">${value}</td>`;
                    } else {
                        html += `<td>${value}</td>`;
                    }
                });

                // åŒä¸€å›è·¯çš„å…¶ä»–æ’ä»¶å’Œè„šä½
                const labelText = row._connectedInfo && row._connectedInfo.length > 0
                    ? row._connectedInfo.map(item => item.label).join('\n')
                    : '';
                html += `<td style="background: #fffde7; white-space: pre-wrap; min-width: 200px;">${labelText}</td>`;

                // Optionåˆ—
                const optionText = row._connectedInfo && row._connectedInfo.length > 0
                    ? row._connectedInfo.map(item => item.option).join('\n')
                    : '';
                html += `<td style="background: #fffde7; white-space: pre-wrap; min-width: 100px;">${optionText}</td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        function exportToExcel() {
            if (queryResults.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const headers = currentDisplayColumns.map(col => getColumnLabel(col, true));
            headers.push('åŒä¸€å›è·¯çš„å…¶ä»–æ’ä»¶å’Œè„šä½');
            headers.push('Option');

            const data = [headers];

            queryResults.forEach(row => {
                const rowData = [];
                currentDisplayColumns.forEach(col => {
                    rowData.push(getColumnValue(row._wireData, col, row._isFromPlugin));
                });
                const labelText = row._connectedInfo ? row._connectedInfo.map(item => item.label).join('\n') : '';
                const optionText = row._connectedInfo ? row._connectedInfo.map(item => item.option).join('\n') : '';
                rowData.push(labelText);
                rowData.push(optionText);
                data.push(rowData);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = headers.map((h, i) => {
                if (h === 'åŒä¸€å›è·¯çš„å…¶ä»–æ’ä»¶å’Œè„šä½') return { wch: 60 };
                if (h.includes('Code')) return { wch: 20 };
                if (h.includes('Pin')) return { wch: 10 };
                if (h.includes('Wire')) return { wch: 18 };
                return { wch: 15 };
            });

            const range = XLSX.utils.decode_range(ws['!ref']);

            // è¡¨å¤´æ ·å¼
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = {
                    fill: { fgColor: { rgb: "667eea" } },
                    font: { color: { rgb: "000000" }, bold: true },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }

            // æ•°æ®è¡Œæ ·å¼
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;

                    const colName = currentDisplayColumns[C];
                    const colLower = String(colName).toLowerCase();
                    const isFromCol = colLower === 'from code' || colLower === 'from pin';

                    if (isFromCol) {
                        ws[cellAddress].s = {
                            fill: { fgColor: { rgb: "E7F3FF" } },
                            font: { bold: true, color: { rgb: "667EEA" } }
                        };
                    } else if (C === range.e.c || C === range.e.c - 1) {
                        ws[cellAddress].s = {
                            fill: { fgColor: { rgb: "FFFDE7" } },
                            alignment: { vertical: "top", wrapText: true }
                        };
                    } else {
                        ws[cellAddress].s = { alignment: { vertical: "center" } };
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, 'å›è·¯åˆ†æç»“æœ');
            const shortCode = document.getElementById('pluginSelect').value;
            const pluginCode = shortCodeToPluginCodeMap.get(shortCode) || shortCode;
            const info = pluginInfoMap.get(pluginCode);
            const fileName = (info && info.shortCode ? info.shortCode : shortCode) + '_å›è·¯åˆ†æ.xlsx';
            XLSX.writeFile(wb, fileName);
            updateStatus('Excelå¯¼å‡ºå®Œæˆ');
        }

        async function copyHtmlToClipboard() {
            if (queryResults.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¤åˆ¶');
                return;
            }

            const headers = currentDisplayColumns.map(col => getColumnLabel(col, true));
            headers.push('åŒä¸€å›è·¯çš„å…¶ä»–æ’ä»¶å’Œè„šä½');
            headers.push('Option');

            let htmlTable = '<table style="border-collapse: collapse; width: 100%; font-size: 13px;">';
            htmlTable += '<thead><tr>';
            headers.forEach(h => {
                htmlTable += `<th style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #000; padding: 8px 12px; border: 1px solid #e0e0e0; font-weight: 600;">${h}</th>`;
            });
            htmlTable += '</tr></thead><tbody>';

            queryResults.forEach(row => {
                htmlTable += '<tr>';
                currentDisplayColumns.forEach(col => {
                    const value = getColumnValue(row._wireData, col, row._isFromPlugin);
                    const highlight = shouldHighlight(col, row._isFromPlugin);

                    if (highlight) {
                        htmlTable += `<td style="padding: 8px 12px; border: 1px solid #e0e0e0; background: #E7F3FF; font-weight: bold; color: #667EEA;">${value}</td>`;
                    } else {
                        htmlTable += `<td style="padding: 8px 12px; border: 1px solid #e0e0e0;">${value}</td>`;
                    }
                });

                const labelText = row._connectedInfo ? row._connectedInfo.map(item => item.label).join('\n') : '';
                htmlTable += `<td style="padding: 8px 12px; border: 1px solid #e0e0e0; background: #FFFDE7; white-space: pre-wrap;">${labelText}</td>`;

                const optionText = row._connectedInfo ? row._connectedInfo.map(item => item.option).join('\n') : '';
                htmlTable += `<td style="padding: 8px 12px; border: 1px solid #e0e0e0; background: #FFFDE7; white-space: pre-wrap;">${optionText}</td>`;
                htmlTable += '</tr>';
            });

            htmlTable += '</tbody></table>';

            try {
                const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>table{border-collapse:collapse}th{background:linear-gradient(135deg,#667eea,#764ba2);color:#000;padding:8px 12px;border:1px solid #e0e0e0;font-weight:600}td{padding:8px 12px;border:1px solid #e0e0e0}</style></head><body>${htmlTable}</body></html>`;

                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': new Blob([fullHtml], { type: 'text/html' }),
                        'text/plain': new Blob([htmlTable.replace(/<[^>]+>/g, '\t').replace(/<\/tr>/g, '\n')], { type: 'text/plain' })
                    })
                ]);
                alert('HTMLè¡¨æ ¼å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼');
                updateStatus('HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©è¡¨æ ¼åå¤åˆ¶ï¼ˆCtrl+Cï¼‰');
            }
        }
    </script>
</body>
</html>
