<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master List è‡ªåŠ¨åŒ–ç”Ÿæˆå·¥å…· - æ™ºèƒ½Sheetè¯†åˆ«ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }
        
        .upload-box.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }
        
        .upload-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .upload-box p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .upload-box .file-info {
            display: none;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .upload-box .file-info.show {
            display: inline-block;
        }
        
        .upload-box .sheet-info {
            display: none;
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .upload-box .sheet-info.show {
            display: inline-block;
        }
        
        .upload-box input[type="file"] {
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #00bcd4 0%, #00838f 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .progress-section {
            display: none;
            margin-bottom: 30px;
        }
        
        .progress-section.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .progress-status {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .results-section {
            display: none;
        }
        
        .results-section.show {
            display: block;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .results-header h2 {
            color: #333;
            font-size: 24px;
        }
        
        .results-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .results-table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 600px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            table-layout: fixed;
        }
        
        .results-table th,
        .results-table td {
            word-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            overflow: hidden;
        }
        
        .results-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: black;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .results-table th {
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            border: 1px solid rgba(255,255,255, 0.2);
            min-width: 50px;
        }
        
        .results-table th.version-col {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: black;
        }
        
        .results-table th.option-col {
            background: linear-gradient(135deg, #2196F3 0%, #0d47a1 100%);
            color: black;
        }
        
        .results-table th.family-relation-col {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: black;
        }
        
        .results-table tbody tr:nth-child(even) {
            background: #f8f9ff;
        }
        
        .results-table tbody tr:hover {
            background: #e8ebff;
        }
        
        .results-table td {
            padding: 6px 4px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .results-table td.marked {
            background: #4CAF50;
            color: black;
            font-weight: bold;
        }
        
        .results-table td.no-col {
            background: #e0e0e0;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .results-table td.family-col {
            background: #fff3e0;
            font-weight: bold;
            position: sticky;
            left: 50px;
            z-index: 5;
        }
        
        .results-table td.partno-col {
            background: #e3f2fd;
            font-weight: bold;
            position: sticky;
            left: 80px;
            z-index: 5;
        }
        
        .log-section {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid #667eea;
            background: white;
        }
        
        .log-entry.error {
            border-left-color: #f44336;
        }
        
        .log-entry.warning {
            border-left-color: #ff9800;
        }
        
        .log-entry.success {
            border-left-color: #4CAF50;
        }
        
        .log-entry.info {
            border-left-color: #2196F3;
        }
        
        .filter-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-controls label {
            color: #666;
            font-size: 14px;
        }
        
        .filter-controls select,
        .filter-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .results-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Master List è‡ªåŠ¨åŒ–ç”Ÿæˆå·¥å…· - æ™ºèƒ½Sheetè¯†åˆ«ç‰ˆ</h1>
            <p>æ ¹æ®Wire Listå’Œé…ç½®è¡¨è‡ªåŠ¨ç”ŸæˆMaster Listï¼ˆç‰¹å¾å€¼æŒ‰ABCå­—æ¯é¡ºåºæ’åˆ—ï¼‰<br>æ”¯æŒä¸åŒsheetåç§°çš„æ™ºèƒ½è¯†åˆ«</p>
        </div>
        
        <div class="content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="upload-box" id="wirelistBox" onclick="document.getElementById('wirelistFile').click()">
                    <h3>ğŸ“ ä¸Šä¼  Wire List</h3>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  .xlsx æ–‡ä»¶</p>
                    <div class="file-info" id="wirelistInfo"></div>
                    <div class="sheet-info" id="wirelistSheetInfo"></div>
                    <input type="file" id="wirelistFile" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'wirelist')">
                </div>
                
                <div class="upload-box" id="configBox" onclick="document.getElementById('configFile').click()">
                    <h3>ğŸ“Š ä¸Šä¼ é…ç½®è¡¨</h3>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  .xlsx æ–‡ä»¶</p>
                    <div class="file-info" id="configInfo"></div>
                    <div class="sheet-info" id="configSheetInfo"></div>
                    <input type="file" id="configFile" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'config')">
                </div>
            </div>
            
            <!-- æ¨¡æ¿ä¸‹è½½åŒºåŸŸ -->
            <div style="background: #f0f2ff; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center;">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œå¯ä»¥ä¸‹è½½ä»¥ä¸‹æ ‡å‡†æ¨¡æ¿ä½œä¸ºå‚è€ƒ</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="downloadWirelistTemplate()">
                        ğŸ“„ ä¸‹è½½Wire Listæ¨¡æ¿
                    </button>
                    <button class="btn btn-info" onclick="downloadConfigTemplate()">
                        ğŸ“Š ä¸‹è½½é…ç½®è¡¨æ¨¡æ¿
                    </button>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="processBtn" onclick="processFiles()" disabled>
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
                <button class="btn btn-info" id="showSheetsBtn" onclick="showAllSheets()" disabled>
                    ğŸ“‹ æŸ¥çœ‹Sheetåˆ—è¡¨
                </button>
                <button class="btn btn-success" id="exportBtn" onclick="exportResults()" disabled>
                    ğŸ“¥ å¯¼å‡ºç»“æœ
                </button>
                <button class="btn btn-success" id="copyBtn" onclick="copyToClipboard()" disabled>
                    ğŸ“‹ å¤åˆ¶åˆ°HTMLï¼ˆä¿ç•™é¢œè‰²ï¼‰
                </button>
                <button class="btn btn-success" id="exportFamilyOptionBtn" onclick="exportFamilyOptionRelation()" disabled>
                    ğŸ“‹ å¯¼å‡ºFamily-Optionå…³ç³»
                </button>
                <button class="btn btn-success" id="exportOptionFamilyBtn" onclick="exportOptionFamilyRelation()" disabled>
                    ğŸ“Š å¯¼å‡ºOption-Familyå…³ç³»
                </button>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-status" id="progressStatus">å‡†å¤‡å°±ç»ª</div>
            </div>
            
            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2>å¤„ç†ç»“æœ</h2>
                </div>
                
                <div class="results-stats">
                    <div class="stat-card">
                        <h3 id="statFamilies">0</h3>
                        <p>Familyæ€»æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statVersions">0</h3>
                        <p>ç‰ˆå‹æ€»æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statOptions">0</h3>
                        <p>Optionæ€»æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statMarks">0</h3>
                        <p>æ‰“ç‚¹æ€»æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statRows">0</h3>
                        <p>æ€»è¡Œæ•°</p>
                    </div>
                </div>
                
                <!-- ç­›é€‰åŒºåŸŸ -->
                <div class="filter-section">
                    <h3>ç­›é€‰æ¡ä»¶</h3>
                    <div class="filter-controls">
                        <label>Family:</label>
                        <input type="text" id="filterFamily" placeholder="è¾“å…¥Familyåç§°" oninput="filterResultsDebounced()">
                        
                        <label>ç‰ˆå‹:</label>
                        <select id="filterVersion" onchange="filterResultsDebounced()">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="results-table-container">
                    <table class="results-table" id="resultsTable">
                        <thead id="resultsTableHead"></thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
                
                <div class="log-section">
                    <h3>å¤„ç†æ—¥å¿—</h3>
                    <div id="logContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let wirelistData = null;
        let configData = null;
        let wirelistSheetName = '';
        let configSheetName = '';
        let processedResults = null;
        let filterTimeout = null;
        
        // Wire List sheetè¯†åˆ«å…³é”®è¯
        const WIRELIST_KEYWORDS = ['wire', 'list', 'wirelist', 'wire-list', 'å¯¼çº¿', 'çº¿æŸ', 'æ¥çº¿', 'è¿æ¥çº¿'];
        // é…ç½®è¡¨sheetè¯†åˆ«å…³é”®è¯
        const CONFIG_KEYWORDS = ['master', 'list', 'masterlist', 'master-list', 'config', 'configuration', 'é…ç½®', 'ç‰¹å¾å€¼'];
        
        // æ™ºèƒ½è¯†åˆ«Wire List sheetåç§°
        function detectWirelistSheet(workbook) {
            const sheetNames = workbook.SheetNames;
            addLog('info', `æ–‡ä»¶åŒ…å« ${sheetNames.length} ä¸ªsheet: ${sheetNames.join(', ')}`);
            
            // ä¼˜å…ˆçº§1: ç²¾ç¡®åŒ¹é…
            const exactMatch = sheetNames.find(name => name.toLowerCase() === 'wire list');
            if (exactMatch) {
                addLog('success', `æ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„Wire List sheet: "${exactMatch}"`);
                return exactMatch;
            }
            
            // ä¼˜å…ˆçº§2: å…³é”®è¯åŒ¹é…ï¼ˆåŒ…å«wireå’Œlistï¼‰
            const keywordMatch = sheetNames.find(name => {
                const lowerName = name.toLowerCase();
                return lowerName.includes('wire') && lowerName.includes('list');
            });
            if (keywordMatch) {
                addLog('success', `é€šè¿‡å…³é”®è¯åŒ¹é…æ‰¾åˆ°Wire List sheet: "${keywordMatch}"`);
                return keywordMatch;
            }
            
            // ä¼˜å…ˆçº§3: åŒ…å«ä»»ä¸€å…³é”®è¯
            const anyKeywordMatch = sheetNames.find(name => {
                const lowerName = name.toLowerCase();
                return WIRELIST_KEYWORDS.some(keyword => lowerName.includes(keyword));
            });
            if (anyKeywordMatch) {
                addLog('success', `é€šè¿‡ä»»ä¸€å…³é”®è¯åŒ¹é…æ‰¾åˆ°Wire List sheet: "${anyKeywordMatch}"`);
                return anyKeywordMatch;
            }
            
            // ä¼˜å…ˆçº§4: ä½¿ç”¨ç¬¬ä¸€ä¸ªsheet
            addLog('warning', `æœªæ‰¾åˆ°åŒ¹é…çš„Wire List sheetï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªsheet: "${sheetNames[0]}"`);
            return sheetNames[0];
        }
        
        // æ™ºèƒ½è¯†åˆ«é…ç½®è¡¨sheetåç§°
        function detectConfigSheet(workbook) {
            const sheetNames = workbook.SheetNames;
            addLog('info', `æ–‡ä»¶åŒ…å« ${sheetNames.length} ä¸ªsheet: ${sheetNames.join(', ')}`);
            
            // ä¼˜å…ˆçº§1: ç²¾ç¡®åŒ¹é…
            const exactMatch = sheetNames.find(name => name.toLowerCase() === 'master list');
            if (exactMatch) {
                addLog('success', `æ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„é…ç½®è¡¨sheet: "${exactMatch}"`);
                return exactMatch;
            }
            
            // ä¼˜å…ˆçº§2: å…³é”®è¯åŒ¹é…ï¼ˆåŒ…å«masterå’Œlistï¼‰
            const keywordMatch = sheetNames.find(name => {
                const lowerName = name.toLowerCase();
                return lowerName.includes('master') && lowerName.includes('list');
            });
            if (keywordMatch) {
                addLog('success', `é€šè¿‡å…³é”®è¯åŒ¹é…æ‰¾åˆ°é…ç½®è¡¨sheet: "${keywordMatch}"`);
                return keywordMatch;
            }
            
            // ä¼˜å…ˆçº§3: åŒ…å«ä»»ä¸€å…³é”®è¯
            const anyKeywordMatch = sheetNames.find(name => {
                const lowerName = name.toLowerCase();
                return CONFIG_KEYWORDS.some(keyword => lowerName.includes(keyword));
            });
            if (anyKeywordMatch) {
                addLog('success', `é€šè¿‡ä»»ä¸€å…³é”®è¯åŒ¹é…æ‰¾åˆ°é…ç½®è¡¨sheet: "${anyKeywordMatch}"`);
                return anyKeywordMatch;
            }
            
            // ä¼˜å…ˆçº§4: ä½¿ç”¨ç¬¬ä¸€ä¸ªsheet
            addLog('warning', `æœªæ‰¾åˆ°åŒ¹é…çš„é…ç½®è¡¨sheetï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªsheet: "${sheetNames[0]}"`);
            return sheetNames[0];
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰sheetä¿¡æ¯
        function showAllSheets() {
            if (!wirelistData && !configData) {
                addLog('error', 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            addLog('info', '========== Sheetä¿¡æ¯æ±‡æ€» ==========');
            
            if (wirelistData) {
                addLog('info', `Wire Listæ–‡ä»¶çš„sheetåˆ—è¡¨:`);
                wirelistData.SheetNames.forEach((name, index) => {
                    const isDetected = name === wirelistSheetName;
                    addLog(isDetected ? 'success' : 'info', `  ${index + 1}. ${name}${isDetected ? ' âœ“ (å·²è¯†åˆ«)' : ''}`);
                });
            }
            
            if (configData) {
                addLog('info', `é…ç½®è¡¨æ–‡ä»¶çš„sheetåˆ—è¡¨:`);
                configData.SheetNames.forEach((name, index) => {
                    const isDetected = name === configSheetName;
                    addLog(isDetected ? 'success' : 'info', `  ${index + 1}. ${name}${isDetected ? ' âœ“ (å·²è¯†åˆ«)' : ''}`);
                });
            }
            
            addLog('info', '====================================');
        }
        
        // æ‹–æ‹½ä¸Šä¼ å¤„ç†
        function setupDragDrop(boxId, fileType) {
            const box = document.getElementById(boxId);
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });
            box.addEventListener('dragleave', () => box.classList.remove('dragover'));
            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    handleFile(file, fileType);
                }
            });
        }
        
        setupDragDrop('wirelistBox', 'wirelist');
        setupDragDrop('configBox', 'config');
        
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(input, fileType) {
            const file = input.files[0];
            if (file) handleFile(file, fileType);
        }
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file, fileType) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                addLog('info', `å¼€å§‹åŠ è½½æ–‡ä»¶: ${file.name}`);
                
                if (fileType === 'wirelist') {
                    wirelistData = workbook;
                    wirelistSheetName = detectWirelistSheet(workbook);
                    
                    document.getElementById('wirelistInfo').textContent = `âœ“ ${file.name}`;
                    document.getElementById('wirelistInfo').classList.add('show');
                    document.getElementById('wirelistSheetInfo').textContent = `Sheet: ${wirelistSheetName}`;
                    document.getElementById('wirelistSheetInfo').classList.add('show');
                    
                    addLog('success', `Wire List æ–‡ä»¶åŠ è½½æˆåŠŸ: ${file.name}`);
                    addLog('success', `å·²è¯†åˆ«sheet: "${wirelistSheetName}"`);
                } else {
                    configData = workbook;
                    configSheetName = detectConfigSheet(workbook);
                    
                    document.getElementById('configInfo').textContent = `âœ“ ${file.name}`;
                    document.getElementById('configInfo').classList.add('show');
                    document.getElementById('configSheetInfo').textContent = `Sheet: ${configSheetName}`;
                    document.getElementById('configSheetInfo').classList.add('show');
                    
                    addLog('success', `é…ç½®è¡¨æ–‡ä»¶åŠ è½½æˆåŠŸ: ${file.name}`);
                    addLog('success', `å·²è¯†åˆ«sheet: "${configSheetName}"`);
                }
                
                checkFilesReady();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éƒ½å‡†å¤‡å¥½äº†
        function checkFilesReady() {
            const processBtn = document.getElementById('processBtn');
            const showSheetsBtn = document.getElementById('showSheetsBtn');
            
            if (wirelistData && configData) {
                processBtn.disabled = false;
                showSheetsBtn.disabled = false;
                addLog('success', 'æ‰€æœ‰æ–‡ä»¶å·²åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹å¤„ç†');
                addLog('info', 'æç¤ºï¼šç‚¹å‡»"æŸ¥çœ‹Sheetåˆ—è¡¨"æŒ‰é’®å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ä¸­çš„æ‰€æœ‰sheetåŠè¯†åˆ«ç»“æœ');
            }
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, status) {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent}%`;
            progressStatus.textContent = status;
        }
        
        // è§£æç»„åˆOption
        function parseOptions(optionStr) {
            if (!optionStr || optionStr === '-' || optionStr === '') return [];
            
            const options = [];
            
            // å¤„ç†æ‹¬å·
            while (optionStr.includes('(') && optionStr.includes(')')) {
                const startIndex = optionStr.indexOf('(');
                const endIndex = optionStr.indexOf(')');
                if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                    const content = optionStr.substring(startIndex + 1, endIndex);
                    const replacedContent = content.replace(/ï¼Œ/g, '&').replace(/,/g, '&');
                    optionStr = optionStr.substring(0, startIndex) + replacedContent + optionStr.substring(endIndex + 1);
                } else {
                    break;
                }
            }
            
            // å¤„ç†ä¸­æ–‡æ‹¬å·
            while (optionStr.includes('ï¼ˆ') && optionStr.includes('ï¼‰')) {
                const startIndex = optionStr.indexOf('ï¼ˆ');
                const endIndex = optionStr.indexOf('ï¼‰');
                if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                    const content = optionStr.substring(startIndex + 1, endIndex);
                    const replacedContent = content.replace(/ï¼Œ/g, '&').replace(/,/g, '&');
                    optionStr = optionStr.substring(0, startIndex) + replacedContent + optionStr.substring(endIndex + 1);
                } else {
                    break;
                }
            }
            
            // å¤„ç†/ï¼šå°†/æ›¿æ¢ä¸º&
            optionStr = optionStr.replace(/\//g, '&');
            
            // å¤„ç†&ï¼šæŒ‰&æ‹†åˆ†
            const parts = optionStr.split('&');
            
            parts.forEach(part => {
                part = part.trim();
                if (part) {
                    if (part.startsWith('-')) {
                        const optionWithoutMinus = part.substring(1);
                        if (optionWithoutMinus) options.push(optionWithoutMinus);
                    } else {
                        let cleanOption = part.replace(/[()ï¼ˆï¼‰]/g, '');
                        if (cleanOption) options.push(cleanOption);
                    }
                }
            });
            
            return [...new Set(options)];
        }
        
        // ç”ŸæˆOptionç»„åˆçš„å”¯ä¸€é”®
        function getOptionKey(optionSet, versionIndex) {
            const options = Array.from(optionSet).sort();
            const optionKeys = [];
            
            // ä¸ºæ¯ä¸ªOptionç”Ÿæˆåœ¨è¯¥ç‰ˆå‹ä¸­çš„æ‰“ç‚¹çŠ¶æ€
            options.forEach(opt => {
                const family = familyMap.get(opt);
                const isMarked = family && family.marks.has(versions[versionIndex].index) ? 1 : 0;
                optionKeys.push(`${opt}:${isMarked}`);
            });
            
            return optionKeys.join('|');
        }
        
        // å¤„ç†æ–‡ä»¶
        async function processFiles() {
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const processBtn = document.getElementById('processBtn');
            
            progressSection.classList.add('show');
            resultsSection.classList.remove('show');
            processBtn.disabled = true;
            document.getElementById('logContainer').innerHTML = '';
            
            try {
                updateProgress(10, 'æ­£åœ¨è§£æWire List...');
                addLog('success', 'å¼€å§‹å¤„ç†æ–‡ä»¶');
                
                // è¯»å–Wire Listï¼ˆä½¿ç”¨æ™ºèƒ½è¯†åˆ«çš„sheetåç§°ï¼‰
                addLog('info', `æ­£åœ¨è¯»å–Wire List sheet: "${wirelistSheetName}"`);
                const wirelistSheet = wirelistData.Sheets[wirelistSheetName];
                const wirelistJson = XLSX.utils.sheet_to_json(wirelistSheet, { header: 1 });
                const wirelistRows = wirelistJson.slice(1);
                addLog('success', `Wire Listå…± ${wirelistRows.length} æ¡æ•°æ®`);
                
                updateProgress(30, 'æ­£åœ¨è§£æé…ç½®è¡¨...');
                
                // è¯»å–é…ç½®è¡¨ï¼ˆä½¿ç”¨æ™ºèƒ½è¯†åˆ«çš„sheetåç§°ï¼‰
                addLog('info', `æ­£åœ¨è¯»å–é…ç½®è¡¨sheet: "${configSheetName}"`);
                const configSheet = configData.Sheets[configSheetName];
                const configJson = XLSX.utils.sheet_to_json(configSheet, { header: 1 });
                
                // è§£æç‰ˆå‹
                const versionNames = configJson[1].slice(3);
                versions = versionNames.map((name, index) => ({
                    index: index + 3,
                    name: String(index + 1),
                    name2: name || ''
                })).filter(v => v.name);
                
                addLog('success', `é…ç½®è¡¨å…± ${versions.length} ä¸ªç‰ˆå‹`);
                
                // è§£æç‰¹å¾å€¼æè¿°
                const optionDescriptions = new Map();
                for (let i = 2; i < configJson.length; i++) {
                    const row = configJson[i];
                    if (row[0] && row[0] !== '') {
                        optionDescriptions.set(row[0], row[1] || '');
                    }
                }
                
                addLog('success', `è¯»å–åˆ° ${optionDescriptions.size} ä¸ªOptionç‰¹å¾å€¼æè¿°`);
                
                // è§£æç‰¹å¾å€¼æ•°æ®
                familyMap = new Map();
                for (let i = 2; i < configJson.length; i++) {
                    const row = configJson[i];
                    if (row[0] && row[0] !== '') {
                        const marks = new Set();
                        versions.forEach(version => {
                            if (row[version.index] && (row[version.index] === 'â—' || row[version.index] === 'X')) {
                                marks.add(version.index);
                            }
                        });
                        familyMap.set(row[0], {
                            code: row[0],
                            name: row[1] || '',
                            remark: row[2] || '',
                            marks: marks
                        });
                    }
                }
                
                addLog('success', `é…ç½®è¡¨å…± ${familyMap.size} ä¸ªç‰¹å¾å€¼ä»£ç `);
                
                updateProgress(50, 'æ­£åœ¨åˆ†æWire Listæ•°æ®...');
                
                // æŒ‰Familyåˆ†ç»„Wire List
                const familyDataMap = new Map();
                const allWirelistOptions = new Set();
                
                wirelistRows.forEach(row => {
                    const family = row[6];
                    const option = row[4];
                    
                    if (family && family !== '') {
                        if (!familyDataMap.has(family)) {
                            familyDataMap.set(family, { family, options: new Set() });
                        }
                        
                        const familyInfo = familyDataMap.get(family);
                        const options = parseOptions(option);
                        options.forEach(opt => {
                            if (opt && opt !== '') {
                                familyInfo.options.add(opt);
                                allWirelistOptions.add(opt);
                            }
                        });
                    }
                });
                
                addLog('success', `Wire Listå…± ${familyDataMap.size} ä¸ªä¸åŒçš„Family`);
                addLog('success', `Wire Listå…±æ¶‰åŠ ${allWirelistOptions.size} ä¸ªä¸åŒçš„Option`);
                
                updateProgress(60, 'æ­£åœ¨åˆå¹¶ç›¸åŒFamilyé›¶ä»¶å·...');
                
                // å¡«å……ç‰ˆå‹ç­›é€‰ä¸‹æ‹‰æ¡†
                const versionSelect = document.getElementById('filterVersion');
                versionSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
                versions.forEach(version => {
                    versionSelect.innerHTML += `<option value="${version.name}">${version.name}</option>`;
                });
                
                // åˆå¹¶ç›¸åŒFamilyé›¶ä»¶å·
                const mergedParts = [];
                let partIndex = 1;
                
                familyDataMap.forEach((familyInfo, familyName) => {
                    const familyOptions = familyInfo.options;
                    
                    // ä¸ºæ¯ä¸ªç‰ˆå‹ç”ŸæˆOptionç»„åˆé”®
                    const versionKeys = versions.map((version, versionIndex) => ({
                        versionIndex: versionIndex,
                        key: getOptionKey(familyOptions, versionIndex),
                        versionColumnIndex: version.index
                    }));
                    
                    // æ ¹æ®Optionç»„åˆé”®åˆå¹¶ç›¸åŒçš„é›¶ä»¶å·
                    const mergedMap = new Map(); // key -> {versionIndices: [], versionColumnIndices: []}
                    
                    versionKeys.forEach((vk) => {
                        if (!mergedMap.has(vk.key)) {
                            mergedMap.set(vk.key, {
                                versionIndices: [vk.versionIndex],
                                versionColumnIndices: [vk.versionColumnIndex]
                            });
                        } else {
                            const merged = mergedMap.get(vk.key);
                            merged.versionIndices.push(vk.versionIndex);
                            merged.versionColumnIndices.push(vk.versionColumnIndex);
                        }
                    });
                    
                    // ä¸ºæ¯ä¸ªåˆå¹¶ç»„ç”Ÿæˆä¸€ä¸ªé›¶ä»¶å·
                    mergedMap.forEach((merged, key) => {
                        const partNo = `${familyName}${String(partIndex).padStart(3, '0')}`;
                        
                        mergedParts.push({
                            no: partIndex,
                            partNo: partNo,
                            family: familyName,
                            options: familyOptions,
                            versionIndices: merged.versionIndices,
                            versionColumnIndices: merged.versionColumnIndices,
                            optionKey: key
                        });
                        
                        partIndex++;
                    });
                });
                
                addLog('success', `åˆå¹¶åç”Ÿæˆ ${mergedParts.length} ä¸ªé›¶ä»¶å·`);
                
                updateProgress(70, 'æ­£åœ¨ä¿å­˜å¤„ç†ç»“æœ...');
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const totalMarks = mergedParts.reduce((sum, part) => sum + part.versionIndices.length, 0);
                document.getElementById('statFamilies').textContent = familyDataMap.size;
                document.getElementById('statVersions').textContent = versions.length;
                document.getElementById('statOptions').textContent = allWirelistOptions.size;
                document.getElementById('statMarks').textContent = totalMarks;
                document.getElementById('statRows').textContent = mergedParts.length;
                
                // ä¿å­˜å¤„ç†ç»“æœ
                processedResults = {
                    parts: mergedParts,
                    versions: versions,
                    allOptions: allWirelistOptions,
                    familyDataMap: familyDataMap,
                    familyMap: familyMap,
                    optionDescriptions: optionDescriptions
                };
                
                updateProgress(80, 'æ­£åœ¨ç”Ÿæˆç»“æœè¡¨æ ¼...');
                
                // ç”Ÿæˆç»“æœè¡¨æ ¼
                await renderTable();
                
                updateProgress(100, 'å¤„ç†å®Œæˆï¼');
                addLog('success', 'å¤„ç†å®Œæˆï¼');
                
                resultsSection.classList.add('show');
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('exportFamilyOptionBtn').disabled = false;
                document.getElementById('exportOptionFamilyBtn').disabled = false;
                
            } catch (error) {
                addLog('error', `å¤„ç†å‡ºé”™: ${error.message}`);
                console.error(error);
            } finally {
                processBtn.disabled = false;
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        async function renderTable() {
            const tableHead = document.getElementById('resultsTableHead');
            const tableBody = document.getElementById('resultsTableBody');
            // æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const sortedOptions = Array.from(processedResults.allOptions).sort((a, b) => {
                return a.toUpperCase().localeCompare(b.toUpperCase());
            });
            const versions = processedResults.versions;
            const mergedParts = processedResults.parts;
            const familyMap = processedResults.familyMap;
            const optionDescriptions = processedResults.optionDescriptions;
            const familyDataMap = processedResults.familyDataMap;
            
            // ç”Ÿæˆè¡¨å¤´HTML
            let headerHTML = '<tr><th style="width: 60px;">No</th><th style="width: 120px;">é›¶ä»¶å·</th><th style="width: 120px;">Family</th>';
            versions.forEach(version => {
                headerHTML += `<th class="version-col" style="width: 60px;">${version.name}</th>`;
            });
            sortedOptions.forEach(opt => {
                headerHTML += `<th class="option-col" style="width: 80px;">${opt}</th>`;
            });
            headerHTML += '</tr>';
            
            // ç”Ÿæˆç‰¹å¾å€¼æè¿°è¡ŒHTML
            let featureRowHTML = '<tr><th style="width: 60px;"></th><th style="width: 120px;"></th><th style="width: 120px;"></th>';
            versions.forEach(version => {
                featureRowHTML += `<th class="version-col" style="width: 60px;">${version.name2 || ''}</th>`;
            });
            sortedOptions.forEach(opt => {
                featureRowHTML += `<th class="option-col" style="width: 80px;">${optionDescriptions.get(opt) || ''}</th>`;
            });
            featureRowHTML += '</tr>';
            
            // ç”Ÿæˆç‰¹å¾å€¼å…³è”Familyè¡ŒHTML
            let familyRelationHTML = '<tr><th style="width: 60px;"></th><th style="width: 120px;"></th><th style="width: 120px;"></th>';
            versions.forEach(version => {
                familyRelationHTML += `<th class="version-col" style="width: 60px;"></th>`;
            });
            sortedOptions.forEach(opt => {
                const families = [];
                familyDataMap.forEach((familyInfo, familyName) => {
                    if (familyInfo.options.has(opt)) {
                        families.push(familyName);
                    }
                });
                families.sort();
                familyRelationHTML += `<th class="family-relation-col" style="width: 80px;">${families.join('ã€')}</th>`;
            });
            familyRelationHTML += '</tr>';
            
            // è®¾ç½®è¡¨å¤´
            tableHead.innerHTML = headerHTML + featureRowHTML + familyRelationHTML;
            
            // åˆ†æ‰¹ç”Ÿæˆæ•°æ®è¡Œ
            const batchSize = 200;
            let currentIndex = 0;
            
            return new Promise((resolve) => {
                function processBatch() {
                    const endIndex = Math.min(currentIndex + batchSize, mergedParts.length);
                    let rowsHTML = '';
                    
                    for (let i = currentIndex; i < endIndex; i++) {
                        const part = mergedParts[i];
                        
                        rowsHTML += `<tr>
                            <td class="no-col">${part.no}</td>
                            <td class="partno-col">${part.partNo}</td>
                            <td class="family-col">${part.family}</td>`;
                        
                        // å„ç‰ˆå‹çš„æ‰“ç‚¹æƒ…å†µï¼ˆåˆå¹¶åçš„å¤šä¸ªç‰ˆå‹éƒ½æ‰“ç‚¹ï¼‰
                        versions.forEach((version, index) => {
                            rowsHTML += part.versionIndices.includes(index) ? '<td class="marked">X</td>' : '<td></td>';
                        });
                        
                        // å„Optionçš„æ‰“ç‚¹æƒ…å†µ
                        sortedOptions.forEach(opt => {
                            if (part.options.has(opt)) {
                                const optionFamily = familyMap.get(opt);
                                // æ£€æŸ¥Optionæ˜¯å¦åœ¨è¯¥é›¶ä»¶å·çš„ä»»ä¸€ç‰ˆå‹ä¸­æ‰“ç‚¹
                                let isMarked = false;
                                part.versionColumnIndices.forEach(colIndex => {
                                    if (optionFamily && optionFamily.marks.has(colIndex)) {
                                        isMarked = true;
                                    }
                                });
                                rowsHTML += isMarked ? '<td class="marked">â—</td>' : '<td></td>';
                            } else {
                                rowsHTML += '<td></td>';
                            }
                        });
                        
                        rowsHTML += '</tr>';
                    }
                    
                    tableBody.insertAdjacentHTML('beforeend', rowsHTML);
                    currentIndex = endIndex;
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = 80 + Math.floor((currentIndex / mergedParts.length) * 20);
                    updateProgress(progress, `æ­£åœ¨ç”Ÿæˆç»“æœè¡¨æ ¼... (${currentIndex}/${mergedParts.length})`);
                    
                    // ç»§ç»­å¤„ç†
                    if (currentIndex < mergedParts.length) {
                        requestAnimationFrame(processBatch);
                    } else {
                        resolve();
                    }
                }
                
                processBatch();
            });
        }
        
        // é˜²æŠ–ç­›é€‰
        function filterResultsDebounced() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(filterResults, 300);
        }
        
        // ç­›é€‰ç»“æœ
        function filterResults() {
            if (!processedResults) return;
            
            const filterFamily = document.getElementById('filterFamily').value.toUpperCase();
            const filterVersion = document.getElementById('filterVersion').value;
            
            const tableBody = document.getElementById('resultsTableBody');
            // æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const sortedOptions = Array.from(processedResults.allOptions).sort((a, b) => {
                return a.toUpperCase().localeCompare(b.toUpperCase());
            });
            
            // ç­›é€‰é›¶ä»¶å·
            let filteredParts = processedResults.parts;
            if (filterFamily) {
                filteredParts = filteredParts.filter(part => part.family.toUpperCase().includes(filterFamily));
            }
            if (filterVersion) {
                const versionIndex = processedResults.versions.findIndex(v => v.name === filterVersion);
                if (versionIndex !== -1) {
                    filteredParts = filteredParts.filter(part => part.versionIndices.includes(versionIndex));
                }
            }
            
            // ç”Ÿæˆç­›é€‰åçš„è¡¨æ ¼
            let rowsHTML = '';
            filteredParts.forEach(part => {
                rowsHTML += `<tr>
                    <td class="no-col">${part.no}</td>
                    <td class="partno-col">${part.partNo}</td>
                    <td class="family-col">${part.family}</td>`;
                
                processedResults.versions.forEach((version, index) => {
                    rowsHTML += part.versionIndices.includes(index) ? '<td class="marked">X</td>' : '<td></td>';
                });
                
                sortedOptions.forEach(opt => {
                    if (part.options.has(opt)) {
                        const optionFamily = processedResults.familyMap.get(opt);
                        let isMarked = false;
                        part.versionColumnIndices.forEach(colIndex => {
                            if (optionFamily && optionFamily.marks.has(colIndex)) {
                                isMarked = true;
                            }
                        });
                        rowsHTML += isMarked ? '<td class="marked">â—</td>' : '<td></td>';
                    } else {
                        rowsHTML += '<td></td>';
                    }
                });
                
                rowsHTML += '</tr>';
            });
            
            tableBody.innerHTML = rowsHTML;
        }
        
        // å¤åˆ¶åˆ°HTMLï¼ˆä¿ç•™é¢œè‰²ï¼‰
        function copyToClipboard() {
            if (!processedResults) {
                addLog('error', 'æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ');
                return;
            }
            
            try {
                addLog('success', 'æ­£åœ¨å¤åˆ¶åˆ°å‰ªè´´æ¿...');
                
                const table = document.getElementById('resultsTable');
                
                // è·å–è¡¨æ ¼çš„å®Œæ•´HTML
                const tableHTML = table.outerHTML;
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶divæ¥å¤„ç†è¡¨æ ¼
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.innerHTML = `
                    <style>
                        table {
                            border-collapse: collapse;
                            width: 100%;
                            font-size: 11px;
                            table-layout: fixed;
                        }
                        th, td {
                            border: 1px solid #e0e0e0;
                            padding: 6px 8px;
                            text-align: center;
                            word-wrap: break-word;
                            word-break: break-all;
                            white-space: normal;
                        }
                        .version-col {
                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
                            color: black !important;
                            font-weight: bold !important;
                        }
                        .option-col {
                            background: linear-gradient(135deg, #2196F3 0%, #0d47a1 100%) !important;
                            color: black !important;
                            font-weight: bold !important;
                        }
                        .family-relation-col {
                            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%) !important;
                            color: black !important;
                            font-weight: bold !important;
                        }
                        .marked {
                            background: #4CAF50 !important;
                            color: black !important;
                            font-weight: bold !important;
                        }
                        .no-col {
                            background: #e0e0e0 !important;
                            font-weight: bold !important;
                        }
                        .family-col {
                            background: #fff3e0 !important;
                            font-weight: bold !important;
                        }
                        .partno-col {
                            background: #e3f2fd !important;
                            font-weight: bold !important;
                        }
                        tbody tr:nth-child(even) {
                            background: #f8f9ff !important;
                        }
                        tbody tr:hover {
                            background: #e8ebff !important;
                        }
                    </style>
                    ${tableHTML}
                `;
                
                document.body.appendChild(tempDiv);
                
                // é€‰æ‹©æ•´ä¸ªä¸´æ—¶div
                const range = document.createRange();
                range.selectNode(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // æ‰§è¡Œå¤åˆ¶
                const successful = document.execCommand('copy');
                selection.removeAllRanges();
                
                // ç§»é™¤ä¸´æ—¶å…ƒç´ 
                document.body.removeChild(tempDiv);
                
                if (successful) {
                    addLog('success', 'å¤åˆ¶æˆåŠŸï¼é¢œè‰²å·²ä¿ç•™ï¼Œå¯ä»¥ç²˜è´´åˆ°Wordæˆ–Excelä¸­');
                } else {
                    addLog('error', 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è¡¨æ ¼');
                }
            } catch (error) {
                addLog('error', `å¤åˆ¶å‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
        
        // å¯¼å‡ºç»“æœ
        function exportResults() {
            if (!processedResults) {
                addLog('error', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }
            
            try {
                addLog('success', 'æ­£åœ¨å¯¼å‡ºç»“æœ...');
                
                // æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const sortedOptions = Array.from(processedResults.allOptions).sort((a, b) => {
                    return a.toUpperCase().localeCompare(b.toUpperCase());
                });
                
                // åˆ›å»ºæ•°æ®æ•°ç»„
                const data = [];
                
                // è¡¨å¤´
                const header = ['No', 'é›¶ä»¶å·', 'Family'];
                processedResults.versions.forEach(version => header.push(version.name));
                sortedOptions.forEach(opt => header.push(opt));
                data.push(header);
                
                // ç‰¹å¾å€¼æè¿°è¡Œ
                const featureRow = ['', '', ''];
                processedResults.versions.forEach(version => featureRow.push(version.name2 || ''));
                sortedOptions.forEach(opt => {
                    let description = '';
                    processedResults.familyMap.forEach((family, code) => {
                        if (code === opt) description = family.name || '';
                    });
                    featureRow.push(description);
                });
                data.push(featureRow);
                
                // ç‰¹å¾å€¼å…³è”Familyè¡Œ
                const familyRelationRow = ['', '', ''];
                processedResults.versions.forEach(version => familyRelationRow.push(''));
                sortedOptions.forEach(opt => {
                    const families = [];
                    processedResults.familyDataMap.forEach((familyInfo, familyName) => {
                        if (familyInfo.options.has(opt)) {
                            families.push(familyName);
                        }
                    });
                    families.sort();
                    familyRelationRow.push(families.join('ã€'));
                });
                data.push(familyRelationRow);
                
                // æ•°æ®è¡Œ
                processedResults.parts.forEach(part => {
                    const row = [part.no, part.partNo, part.family];
                    
                    // å„ç‰ˆå‹çš„æ‰“ç‚¹æƒ…å†µ
                    processedResults.versions.forEach((version, index) => {
                        row.push(part.versionIndices.includes(index) ? 'X' : '');
                    });
                    
                    // å„Optionçš„æ‰“ç‚¹æƒ…å†µ
                    sortedOptions.forEach(opt => {
                        if (part.options.has(opt)) {
                            const optionFamily = processedResults.familyMap.get(opt);
                            let isMarked = false;
                            part.versionColumnIndices.forEach(colIndex => {
                                if (optionFamily && optionFamily.marks.has(colIndex)) {
                                    isMarked = true;
                                }
                            });
                            row.push(isMarked ? 'â—' : '');
                        } else {
                            row.push('');
                        }
                    });
                    
                    data.push(row);
                });
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 20 },
                    { wch: 20 }
                ];
                
                // æ·»åŠ å·¥ä½œè¡¨
                XLSX.utils.book_append_sheet(wb, ws, 'Master List');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const now = new Date();
                const timestamp = now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');
                const filename = `MasterList__${timestamp}.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, filename);
                
                addLog('success', `å¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                addLog('error', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
        
        // å¯¼å‡ºFamily-Optionå…³ç³»
        function exportFamilyOptionRelation() {
            if (!processedResults) {
                addLog('error', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }
            
            try {
                addLog('success', 'æ­£åœ¨å¯¼å‡ºFamily-Optionå…³ç³»...');
                
                const wb = XLSX.utils.book_new();
                const data = [['No', 'Family', 'Optionç»„åˆ', 'æ¶‰åŠçš„Option']];
                
                let no = 1;
                processedResults.familyDataMap.forEach((familyInfo, familyName) => {
                    // æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                    const options = Array.from(familyInfo.options).sort((a, b) => {
                        return a.toUpperCase().localeCompare(b.toUpperCase());
                    });
                    data.push([no, familyName, options.join('ã€'), options.join('|')]);
                    no++;
                });
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ wch: 8 }, { wch: 20 }, { wch: 80 }, { wch: 100 }];
                XLSX.utils.book_append_sheet(wb, ws, 'Family-Optionå…³ç³»');
                
                const now = new Date();
                const timestamp = now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');
                XLSX.writeFile(wb, `FamilyOptionRelation__${timestamp}.xlsx`);
                
                addLog('success', 'å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                addLog('error', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
        
        // å¯¼å‡ºOption-Familyå…³ç³»
        function exportOptionFamilyRelation() {
            if (!processedResults) {
                addLog('error', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
                return;
            }
            
            try {
                addLog('success', 'æ­£åœ¨å¯¼å‡ºOption-Familyå…³ç³»...');
                
                const wb = XLSX.utils.book_new();
                const data = [['No', 'Option', 'æ¶‰åŠçš„Family']];
                
                // æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const sortedOptions = Array.from(processedResults.allOptions).sort((a, b) => {
                    return a.toUpperCase().localeCompare(b.toUpperCase());
                });
                
                let no = 1;
                sortedOptions.forEach(option => {
                    const families = [];
                    processedResults.familyDataMap.forEach((familyInfo, familyName) => {
                        if (familyInfo.options.has(option)) families.push(familyName);
                    });
                    families.sort();
                    data.push([no, option, families.join('ã€')]);
                    no++;
                });
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ wch: 8 }, { wch: 20 }, { wch: 200 }];
                XLSX.utils.book_append_sheet(wb, ws, 'Option-Familyå…³ç³»');
                
                const now = new Date();
                const timestamp = now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');
                XLSX.writeFile(wb, `OptionFamilyRelation__${timestamp}.xlsx`);
                
                addLog('success', 'å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                addLog('error', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
        
        // ä¸‹è½½Wire Listæ¨¡æ¿
        function downloadWirelistTemplate() {
            try {
                addLog('info', 'æ­£åœ¨ç”ŸæˆWire Listæ¨¡æ¿...');
                
                const data = [
                    ['åºå·', 'è¿æ¥å™¨åç§°', 'ç«¯å­å·', 'çº¿å·', 'Option', 'çº¿å¾„', 'Family', 'çº¿è‰²', 'é•¿åº¦'],
                    ['1', 'Connector1', '1', 'W001', 'A01', '0.5', 'F001', 'RED', '100'],
                    ['2', 'Connector1', '2', 'W002', 'A01&B02', '0.5', 'F001', 'BLUE', '150'],
                    ['3', 'Connector2', '1', 'W003', 'B01', '0.75', 'F002', 'GREEN', '200'],
                    ['4', 'Connector2', '2', 'W004', 'A01/B01', '0.75', 'F002', 'YELLOW', '250'],
                    ['5', 'Connector3', '1', 'W005', 'C01', '1.0', 'F003', 'BLACK', '300'],
                    ['6', 'Connector3', '2', 'W006', 'A01&B02&C01', '1.0', 'F003', 'WHITE', '350'],
                    ['7', 'Connector4', '1', 'W007', 'D01', '1.5', 'F004', 'GRAY', '400'],
                    ['8', 'Connector4', '2', 'W008', 'D01/E01', '1.5', 'F004', 'PURPLE', '450'],
                    ['9', 'Connector5', '1', 'W009', 'E01', '2.0', 'F005', 'ORANGE', '500'],
                    ['10', 'Connector5', '2', 'W010', 'A01/D01/E01', '2.0', 'F005', 'PINK', '550']
                ];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 8 },   // åºå·
                    { wch: 20 },  // è¿æ¥å™¨åç§°
                    { wch: 10 },  // ç«¯å­å·
                    { wch: 10 },  // çº¿å·
                    { wch: 25 },  // Option
                    { wch: 10 },  // çº¿å¾„
                    { wch: 12 },  // Family
                    { wch: 10 },  // çº¿è‰²
                    { wch: 10 }   // é•¿åº¦
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Wire List');
                XLSX.writeFile(wb, 'WireList_æ¨¡æ¿.xlsx');
                
                addLog('success', 'Wire Listæ¨¡æ¿ä¸‹è½½æˆåŠŸ');
                alert('Wire Listæ¨¡æ¿ä¸‹è½½æˆåŠŸï¼\n\nSheetåç§°ï¼šWire List\n\nåˆ—è¯´æ˜ï¼š\n- ç¬¬5åˆ—ï¼šOptionï¼ˆæ”¯æŒç»„åˆï¼Œå¦‚A01&B02ï¼‰\n- ç¬¬7åˆ—ï¼šFamilyï¼ˆç”¨äºåˆ†ç»„ï¼‰\n- å…¶ä»–åˆ—ï¼šå¯æ ¹æ®å®é™…éœ€è¦å¡«å†™');
            } catch (error) {
                addLog('error', `ä¸‹è½½Wire Listæ¨¡æ¿å‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
        
        // ä¸‹è½½é…ç½®è¡¨æ¨¡æ¿
        function downloadConfigTemplate() {
            try {
                addLog('info', 'æ­£åœ¨ç”Ÿæˆé…ç½®è¡¨æ¨¡æ¿...');
                
                const data = [
                    ['ç‰¹å¾å€¼ä»£ç ', 'ç‰¹å¾å€¼æè¿°', 'å¤‡æ³¨', 'ç‰ˆå‹1', 'ç‰ˆå‹2', 'ç‰ˆå‹3', 'ç‰ˆå‹4', 'ç‰ˆå‹5'],
                    ['A01', 'é€‰é¡¹A-01', 'åŸºç¡€é…ç½®', 'â—', '', 'â—', 'â—', ''],
                    ['A02', 'é€‰é¡¹A-02', 'æ‰©å±•é…ç½®A', 'â—', 'â—', 'â—', '', ''],
                    ['A03', 'é€‰é¡¹A-03', 'æ‰©å±•é…ç½®B', '', 'â—', 'â—', 'â—', 'â—'],
                    ['B01', 'é€‰é¡¹B-01', 'åŠŸèƒ½æ¨¡å—1', 'â—', '', '', 'â—', 'â—'],
                    ['B02', 'é€‰é¡¹B-02', 'åŠŸèƒ½æ¨¡å—2', '', 'â—', 'â—', '', 'â—'],
                    ['C01', 'é€‰é¡¹C-01', 'é«˜çº§åŠŸèƒ½', 'â—', 'â—', '', '', ''],
                    ['D01', 'é€‰é¡¹D-01', 'ç‰¹æ®Šé…ç½®', '', '', 'â—', 'â—', ''],
                    ['E01', 'é€‰é¡¹E-01', 'å¯é€‰åŠŸèƒ½', '', '', '', '', 'â—'],
                    ['F01', 'é€‰é¡¹F-01', 'å¤‡ç”¨é€‰é¡¹', 'â—', '', '', '', ''],
                    ['F02', 'é€‰é¡¹F-02', 'å¤‡ç”¨é€‰é¡¹', '', 'â—', '', '', ''],
                    ['F03', 'é€‰é¡¹F-03', 'å¤‡ç”¨é€‰é¡¹', '', '', 'â—', '', ''],
                    ['F04', 'é€‰é¡¹F-04', 'å¤‡ç”¨é€‰é¡¹', '', '', '', 'â—', ''],
                    ['F05', 'é€‰é¡¹F-05', 'å¤‡ç”¨é€‰é¡¹', '', '', '', '', 'â—']
                ];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 15 },  // ç‰¹å¾å€¼ä»£ç 
                    { wch: 20 },  // ç‰¹å¾å€¼æè¿°
                    { wch: 20 },  // å¤‡æ³¨
                    { wch: 10 },  // ç‰ˆå‹1
                    { wch: 10 },  // ç‰ˆå‹2
                    { wch: 10 },  // ç‰ˆå‹3
                    { wch: 10 },  // ç‰ˆå‹4
                    { wch: 10 }   // ç‰ˆå‹5
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Master List');
                XLSX.writeFile(wb, 'é…ç½®è¡¨_æ¨¡æ¿.xlsx');
                
                addLog('success', 'é…ç½®è¡¨æ¨¡æ¿ä¸‹è½½æˆåŠŸ');
                alert('é…ç½®è¡¨æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼\n\nSheetåç§°ï¼šMaster List\n\nåˆ—è¯´æ˜ï¼š\n- ç¬¬1åˆ—ï¼šç‰¹å¾å€¼ä»£ç ï¼ˆOptionä»£ç ï¼‰\n- ç¬¬2åˆ—ï¼šç‰¹å¾å€¼æè¿°ï¼ˆOptionåç§°ï¼‰\n- ç¬¬3åˆ—ï¼šå¤‡æ³¨\n- ç¬¬4åˆ—åŠä»¥åï¼šå„ç‰ˆå‹çš„æ‰“ç‚¹ï¼ˆâ—æˆ–Xè¡¨ç¤ºè¯¥ç‰ˆå‹åŒ…å«æ­¤Optionï¼‰\n\næ³¨æ„äº‹é¡¹ï¼š\n1. ç‰¹å¾å€¼ä»£ç å¿…é¡»ä¸Wire Listä¸­çš„Optionä¸€è‡´\n2. æ‰“ç‚¹ä½¿ç”¨â—æˆ–Xå‡å¯\n3. ç‰ˆå‹æ•°é‡å¯ä»¥æ ¹æ®å®é™…éœ€è¦å¢å‡');
            } catch (error) {
                addLog('error', `ä¸‹è½½é…ç½®è¡¨æ¨¡æ¿å‡ºé”™: ${error.message}`);
                console.error(error);
            }
        }
    </script>
</body>
</html>
