<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¶ä»¶å·åŠŸèƒ½å·®å¼‚æ¯”å¯¹å·¥å…·</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 14px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9ff;
            cursor: pointer;
            position: relative;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-box.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-box.has-file {
            border-color: #4caf50;
            background: #f1f8e9;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-box.has-file .upload-icon {
            color: #4caf50;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .file-name {
            color: #333;
            font-weight: bold;
            font-size: 16px;
            word-break: break-all;
        }

        .file-info {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-compare {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-compare:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-compare:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-export {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-export:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .btn-export:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-html {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-html:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6);
        }

        .btn-html:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .results-stats {
            color: #666;
            font-size: 14px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            vertical-align: top;
        }

        .results-table tbody tr:hover {
            background: #f8f9ff;
        }

        .added-features {
            color: #2e7d32;
            background: #e8f5e9;
            padding: 8px;
            border-radius: 5px;
            font-weight: 500;
            line-height: 1.8;
            word-break: break-all;
        }

        .cancelled-features {
            color: #c62828;
            background: #ffebee;
            padding: 8px;
            border-radius: 5px;
            font-weight: 500;
            line-height: 1.8;
            word-break: break-all;
        }

        .no-features {
            color: #999;
            font-style: italic;
        }

        .status-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }

        .status-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é›¶ä»¶å·åŠŸèƒ½å·®å¼‚æ¯”å¯¹å·¥å…·</h1>
        <div class="subtitle">åŸºäºâ—æ ‡è®°æ¯”å¯¹é›¶ä»¶å·ä¹‹é—´çš„åŠŸèƒ½å·®å¼‚</div>

        <div class="upload-section">
            <div class="upload-box" id="masterUploadBox">
                <input type="file" id="masterFile" accept=".xlsx,.xls">
                <div class="upload-icon">ğŸ“‹</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Master List æ–‡ä»¶</div>
                <div class="file-name" id="masterFileName">æœªé€‰æ‹©æ–‡ä»¶</div>
                <div class="file-info" id="masterFileInfo"></div>
            </div>

            <div class="upload-box" id="diffUploadBox">
                <input type="file" id="diffFile" accept=".xlsx,.xls">
                <div class="upload-icon">ğŸ“Š</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  æŠ€æœ¯å·®å¼‚è¾“å…¥ æ–‡ä»¶</div>
                <div class="file-name" id="diffFileName">æœªé€‰æ‹©æ–‡ä»¶</div>
                <div class="file-info" id="diffFileInfo"></div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-compare" id="compareBtn" disabled>å¼€å§‹æ¯”å¯¹</button>
            <button class="btn-export" id="exportBtn" disabled>å¯¼å‡ºExcel</button>
            <button class="btn-html" id="exportHtmlBtn" disabled>å¯¼å‡ºHTMLåˆ°å‰ªè´´æ¿</button>
        </div>

        <div id="statusMessage"></div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-title">ğŸ“Š æ¯”å¯¹ç»“æœ</div>
                <div class="results-stats" id="resultsStats"></div>
            </div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th style="width: 15%">é›¶ä»¶å·</th>
                        <th style="width: 15%">é›¶ä»¶åç§°(ä¸­æ–‡ï¼‰</th>
                        <th style="width: 15%">å¯¹æ¯”é›¶ä»¶å·</th>
                        <th style="width: 27%">æ–°å¢åŠŸèƒ½</th>
                        <th style="width: 28%">å–æ¶ˆåŠŸèƒ½</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let masterListData = null;
        let diffInputData = null;
        let comparisonResults = null;

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('masterFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'master');
        });

        document.getElementById('diffFile').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'diff');
        });

        // æ‹–æ‹½ä¸Šä¼ 
        const masterUploadBox = document.getElementById('masterUploadBox');
        const diffUploadBox = document.getElementById('diffUploadBox');

        setupDragAndDrop(masterUploadBox, 'master');
        setupDragAndDrop(diffUploadBox, 'diff');

        function setupDragAndDrop(element, type) {
            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                element.classList.add('dragover');
            });

            element.addEventListener('dragleave', () => {
                element.classList.remove('dragover');
            });

            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload(file, type);
                }
            });
        }

        function handleFileUpload(file, type) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (type === 'master') {
                    masterListData = jsonData;
                    document.getElementById('masterFileName').textContent = file.name;
                    document.getElementById('masterFileInfo').textContent = `${jsonData.length} è¡Œ Ã— ${jsonData[0] ? jsonData[0].length : 0} åˆ—`;
                    masterUploadBox.classList.add('has-file');
                } else {
                    diffInputData = jsonData;
                    document.getElementById('diffFileName').textContent = file.name;
                    document.getElementById('diffFileInfo').textContent = `${jsonData.length} è¡Œ Ã— ${jsonData[0] ? jsonData[0].length : 0} åˆ—`;
                    diffUploadBox.classList.add('has-file');
                }

                updateCompareButton();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateCompareButton() {
            const compareBtn = document.getElementById('compareBtn');
            compareBtn.disabled = !(masterListData && diffInputData);
        }

        // å¼€å§‹æ¯”å¯¹
        document.getElementById('compareBtn').addEventListener('click', function() {
            if (!masterListData || !diffInputData) {
                showStatus('è¯·å…ˆä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶', 'error');
                return;
            }

            try {
                comparisonResults = comparePartNumbers(masterListData, diffInputData);
                displayResults(comparisonResults);
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportHtmlBtn').disabled = false;
                showStatus(`æ¯”å¯¹å®Œæˆï¼å…±æ¯”å¯¹ ${comparisonResults.length} ç»„é›¶ä»¶å·`, 'success');
            } catch (error) {
                showStatus('æ¯”å¯¹å¤±è´¥ï¼š' + error.message, 'error');
                console.error(error);
            }
        });

        function comparePartNumbers(masterList, diffInput) {
            // æŸ¥æ‰¾"æ ‡é…"å•å…ƒæ ¼çš„ä½ç½®
            let standardColumnIndex = -1;
            let standardRowIndex = -1;

            for (let i = 0; i < masterList.length; i++) {
                const row = masterList[i];
                for (let j = 0; j < row.length; j++) {
                    const cell = row[j];
                    if (cell !== undefined && cell !== null && String(cell).includes('æ ‡é…')) {
                        standardRowIndex = i;
                        standardColumnIndex = j;
                        break;
                    }
                }
                if (standardRowIndex !== -1) break;
            }

            if (standardRowIndex === -1) {
                throw new Error('æœªæ‰¾åˆ°"æ ‡é…"å•å…ƒæ ¼');
            }

            // è·å–åŠŸèƒ½åˆ—ï¼ˆä»"æ ‡é…"åˆ—ä¹‹åå¼€å§‹ï¼‰
            const featureColumns = [];
            for (let i = standardColumnIndex + 1; i < masterList[0].length; i++) {
                featureColumns.push(i);
            }

            // è·å–åŠŸèƒ½åˆ—çš„å€¼ï¼ˆä»"æ ‡é…"è¡Œè·å–ï¼‰
            const featureValues = {};
            const standardRow = masterList[standardRowIndex];
            for (let col of featureColumns) {
                const value = standardRow[col];
                if (value !== undefined && value !== null) {
                    // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼
                    featureValues[col] = String(value).trim().replace(/\n/g, ' ');
                }
            }

            // è§£æMaster Listæ•°æ®ï¼Œå»ºç«‹é›¶ä»¶å·åˆ°åŠŸèƒ½çš„æ˜ å°„
            const partMap = new Map();
            for (let i = 1; i < masterList.length; i++) {
                const row = masterList[i];
                const partNumber = String(row[0] || '').trim();
                if (partNumber && partNumber !== 'undefined' && partNumber !== 'null') {
                    const features = new Set();
                    for (let col of featureColumns) {
                        const value = row[col];
                        if (value !== undefined && value !== null && String(value).includes('â—')) {
                            // ä½¿ç”¨åŠŸèƒ½å€¼è€Œä¸æ˜¯åˆ—å
                            if (featureValues[col]) {
                                features.add(featureValues[col]);
                            }
                        }
                    }
                    partMap.set(partNumber, {
                        partNumber: partNumber,
                        partName: String(row[1] || '').trim(),
                        status: String(row[2] || '').trim(),
                        quantity: String(row[3] || '').trim(),
                        description: String(row[4] || '').trim(),
                        features: features
                    });
                }
            }

            // å¤„ç†æŠ€æœ¯å·®å¼‚è¾“å…¥æ–‡ä»¶
            const results = [];
            for (let i = 1; i < diffInput.length; i++) {
                const row = diffInput[i];
                const partNumber1 = String(row[0] || '').trim();
                const partName1 = String(row[1] || '').trim();
                const partNumber2 = String(row[2] || '').trim();

                if (!partNumber1 || partNumber1 === 'undefined' || partNumber1 === 'null') {
                    continue;
                }

                const part1 = partMap.get(partNumber1);
                const part2 = partMap.get(partNumber2);

                if (!part1) {
                    console.warn(`é›¶ä»¶å· ${partNumber1} åœ¨Master Listä¸­æœªæ‰¾åˆ°`);
                    continue;
                }

                const features1 = part1.features;
                const features2 = part2 ? part2.features : new Set();

                // è¯†åˆ«å·®å¼‚
                const addedFeatures = new Set([...features1].filter(x => !features2.has(x)));
                const cancelledFeatures = new Set([...features2].filter(x => !features1.has(x)));

                // å°†åŠŸèƒ½åˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆç”¨åˆ†å·åˆ†éš”ï¼‰
                const addedFeaturesStr = Array.from(addedFeatures).sort().join(';');
                const cancelledFeaturesStr = Array.from(cancelledFeatures).sort().join(';');

                results.push({
                    partNumber: partNumber1,
                    partName: part1.partName,
                    comparePartNumber: partNumber2,
                    addedFeatures: addedFeaturesStr,
                    cancelledFeatures: cancelledFeaturesStr
                });
            }

            return results;
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const resultsStats = document.getElementById('resultsStats');

            resultsBody.innerHTML = '';
            resultsStats.textContent = `å…± ${results.length} æ¡è®°å½•`;

            results.forEach(result => {
                const row = document.createElement('tr');

                const addedFeaturesHtml = result.addedFeatures
                    ? `<div class="added-features">${result.addedFeatures}</div>`
                    : '<span class="no-features">æ— </span>';

                const cancelledFeaturesHtml = result.cancelledFeatures
                    ? `<div class="cancelled-features">${result.cancelledFeatures}</div>`
                    : '<span class="no-features">æ— </span>';

                row.innerHTML = `
                    <td><strong>${result.partNumber}</strong></td>
                    <td>${result.partName}</td>
                    <td>${result.comparePartNumber}</td>
                    <td>${addedFeaturesHtml}</td>
                    <td>${cancelledFeaturesHtml}</td>
                `;

                resultsBody.appendChild(row);
            });

            resultsSection.style.display = 'block';
        }

        // å¯¼å‡ºExcel
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!comparisonResults || comparisonResults.length === 0) {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            try {
                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = [
                    ['é›¶ä»¶å·', 'é›¶ä»¶åç§°(ä¸­æ–‡ï¼‰', 'å¯¹æ¯”é›¶ä»¶å·', 'æ–°å¢åŠŸèƒ½', 'å–æ¶ˆåŠŸèƒ½']
                ];

                comparisonResults.forEach(result => {
                    exportData.push([
                        result.partNumber,
                        result.partName,
                        result.comparePartNumber,
                        result.addedFeatures,
                        result.cancelledFeatures
                    ]);
                });

                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);

                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 20 },
                    { wch: 25 },
                    { wch: 20 },
                    { wch: 80 },
                    { wch: 80 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'é›¶ä»¶å·åŠŸèƒ½å·®å¼‚');

                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, 'é›¶ä»¶å·åŠŸèƒ½å·®å¼‚è¾“å‡º.xlsx');

                showStatus('Excelæ–‡ä»¶å·²å¯¼å‡º', 'success');
            } catch (error) {
                showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                console.error(error);
            }
        });

        // å¯¼å‡ºHTMLåˆ°å‰ªè´´æ¿
        document.getElementById('exportHtmlBtn').addEventListener('click', function() {
            if (!comparisonResults || comparisonResults.length === 0) {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            try {
                // ç”ŸæˆHTMLè¡¨æ ¼
                let html = '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">\n';
                html += '<thead>\n<tr>\n';
                html += '<th style="background-color: #0055AA; color: white; font-weight: bold; font-size: 14px; padding: 10px;">é›¶ä»¶å·</th>\n';
                html += '<th style="background-color: #0055AA; color: white; font-weight: bold; font-size: 14px; padding: 10px;">é›¶ä»¶åç§°(ä¸­æ–‡ï¼‰</th>\n';
                html += '<th style="background-color: #0055AA; color: white; font-weight: bold; font-size: 14px; padding: 10px;">å¯¹æ¯”é›¶ä»¶å·</th>\n';
                html += '<th style="background-color: #0055AA; color: white; font-weight: bold; font-size: 14px; padding: 10px;">æ–°å¢åŠŸèƒ½</th>\n';
                html += '<th style="background-color: #0055AA; color: white; font-weight: bold; font-size: 14px; padding: 10px;">å–æ¶ˆåŠŸèƒ½</th>\n';
                html += '</tr>\n</thead>\n';
                html += '<tbody>\n';

                comparisonResults.forEach(result => {
                    html += '<tr>\n';
                    html += `<td style="padding: 8px; border: 1px solid #ccc;"><strong>${result.partNumber}</strong></td>\n`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc;">${result.partName}</td>\n`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc;">${result.comparePartNumber}</td>\n`;
                    
                    if (result.addedFeatures) {
                        html += `<td style="padding: 8px; border: 1px solid #ccc; background-color: #90EE90; color: #006400; font-weight: bold;">${result.addedFeatures}</td>\n`;
                    } else {
                        html += '<td style="padding: 8px; border: 1px solid #ccc; color: #999; font-style: italic;">æ— </td>\n';
                    }
                    
                    if (result.cancelledFeatures) {
                        html += `<td style="padding: 8px; border: 1px solid #ccc; background-color: #FFB6C1; color: #8B0000; font-weight: bold;">${result.cancelledFeatures}</td>\n`;
                    } else {
                        html += '<td style="padding: 8px; border: 1px solid #ccc; color: #999; font-style: italic;">æ— </td>\n';
                    }
                    
                    html += '</tr>\n';
                });

                html += '</tbody>\n</table>';

                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(html).then(() => {
                    showStatus('HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å¯ä»¥ç›´æ¥ç²˜è´´åˆ°Wordæˆ–é‚®ä»¶ä¸­', 'success');
                }).catch(err => {
                    showStatus('å¤åˆ¶å¤±è´¥ï¼š' + err.message, 'error');
                    console.error(err);
                });
            } catch (error) {
                showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                console.error(error);
            }
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-message status-' + type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
