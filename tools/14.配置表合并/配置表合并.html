<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®è¡¨åˆå¹¶å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-box.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-box label {
            display: block;
            color: #667eea;
            font-size: 16px;
            cursor: pointer;
        }

        .upload-box .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .file-info {
            display: none;
            background: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .file-info.active {
            display: block;
        }

        .file-info strong {
            color: #2e7d32;
        }

        .options {
            margin: 30px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .options h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .merge-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .merge-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .merge-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress {
            display: none;
            margin-top: 20px;
            text-align: center;
            color: #667eea;
        }

        .progress.active {
            display: block;
        }

        .result {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            text-align: center;
        }

        .result.active {
            display: block;
        }

        .result h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .result-info {
            margin: 10px 0;
            color: #333;
        }

        .download-btn {
            margin-top: 15px;
            padding: 12px 30px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #45a049;
        }

        .error {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #ffebee;
            border-radius: 8px;
            color: #c62828;
        }

        .error.active {
            display: block;
        }

        .preview {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .preview h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .preview-table {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        .preview-table::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .preview-table::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .preview-table::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        .preview-table::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }

        .preview-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #667eea;
            color: white;
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* å‰ä¸‰è¡Œæ•°æ®å›ºå®šæ˜¾ç¤º */
        .preview-table tbody tr.fixed-row-1 td,
        .preview-table tbody tr.fixed-row-2 td,
        .preview-table tbody tr.fixed-row-3 td {
            position: sticky;
            background: #fff3e0;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* ç¬¬ä¸€è¡Œæ•°æ®å›ºå®šåœ¨ top: 41px (è¡¨å¤´é«˜åº¦) */
        .preview-table tbody tr.fixed-row-1 td {
            top: 41px;
        }

        /* ç¬¬äºŒè¡Œæ•°æ®å›ºå®šåœ¨ top: 82px */
        .preview-table tbody tr.fixed-row-2 td {
            top: 82px;
        }

        /* ç¬¬ä¸‰è¡Œæ•°æ®å›ºå®šåœ¨ top: 123px */
        .preview-table tbody tr.fixed-row-3 td {
            top: 123px;
        }

        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }

        .preview-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        /* æ»šåŠ¨æç¤ºå›¾æ ‡ */
        .scroll-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .scroll-indicator:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š é…ç½®è¡¨åˆå¹¶å·¥å…·</h1>

        <div class="upload-section">
            <h3>æ–‡ä»¶1ï¼ˆä¸»æ–‡ä»¶ï¼‰</h3>
            <div class="upload-box" id="uploadBox1">
                <input type="file" id="file1" accept=".xlsx,.xls">
                <label for="file1">
                    <div class="icon">ğŸ“</div>
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç¬¬ä¸€ä¸ªé…ç½®è¡¨</div>
                </label>
            </div>
            <div class="file-info" id="fileInfo1">
                <strong>âœ“ å·²é€‰æ‹©ï¼š</strong> <span id="fileName1"></span>
            </div>
        </div>

        <div class="upload-section">
            <h3>æ–‡ä»¶2ï¼ˆåˆå¹¶æ–‡ä»¶ï¼‰</h3>
            <div class="upload-box" id="uploadBox2">
                <input type="file" id="file2" accept=".xlsx,.xls">
                <label for="file2">
                    <div class="icon">ğŸ“</div>
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç¬¬äºŒä¸ªé…ç½®è¡¨</div>
                </label>
            </div>
            <div class="file-info" id="fileInfo2">
                <strong>âœ“ å·²é€‰æ‹©ï¼š</strong> <span id="fileName2"></span>
            </div>
        </div>

        <button class="merge-btn" id="mergeBtn" disabled>å¼€å§‹åˆå¹¶</button>

        <div class="progress" id="progress">
            <p>â³ æ­£åœ¨å¤„ç†...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <h3>âœ… åˆå¹¶å®Œæˆï¼</h3>
            <p class="result-info" id="resultInfo"></p>
            <button class="download-btn" id="downloadBtn">ğŸ“¥ ä¸‹è½½åˆå¹¶æ–‡ä»¶</button>
        </div>

        <div class="preview" id="preview" style="display: none;">
            <h3>ğŸ“Š æ•°æ®é¢„è§ˆï¼ˆæ‰€æœ‰å†…å®¹ï¼‰</h3>
            <div class="preview-table" id="previewTable"></div>
        </div>
    </div>

    <!-- æ»šåŠ¨æç¤ºå›¾æ ‡ -->
    <div class="scroll-indicator" id="scrollIndicator" title="å¯å·¦å³æ»šåŠ¨æŸ¥çœ‹æ›´å¤šå†…å®¹">â†”ï¸</div>

    <script>
        let file1Data = null;
        let file2Data = null;
        let mergedWorkbook = null;

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload(uploadBoxId, fileInputId, fileInfoId, fileNameId, dataVar) {
            const uploadBox = document.getElementById(uploadBoxId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(fileInfoId);
            const fileName = document.getElementById(fileNameId);

            uploadBox.addEventListener('click', () => fileInput.click());

            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('dragover');
            });

            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('dragover');
            });

            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFile(files[0], fileInfo, fileName, dataVar);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0], fileInfo, fileName, dataVar);
                }
            });
        }

        function handleFile(file, fileInfo, fileName, dataVar) {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (dataVar === 'file1Data') {
                        file1Data = workbook;
                    } else {
                        file2Data = workbook;
                    }

                    fileInfo.classList.add('active');
                    fileName.textContent = file.name;

                    checkFilesReady();
                } catch (error) {
                    showError('è¯»å–æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function checkFilesReady() {
            const mergeBtn = document.getElementById('mergeBtn');
            mergeBtn.disabled = !(file1Data && file2Data);

            // å½“ä¸¤ä¸ªæ–‡ä»¶éƒ½å‡†å¤‡å¥½æ—¶ï¼Œè‡ªåŠ¨è§¦å‘åˆå¹¶
            if (file1Data && file2Data) {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIæ›´æ–°
                setTimeout(() => {
                    performMerge();
                }, 500);
            }
        }

        function performMerge() {
            const progress = document.getElementById('progress');
            const result = document.getElementById('result');
            const error = document.getElementById('error');
            const preview = document.getElementById('preview');

            progress.classList.add('active');
            result.classList.remove('active');
            error.classList.remove('active');
            preview.style.display = 'none';

            try {
                mergedWorkbook = mergeExcelFiles(file1Data, file2Data);

                const sheet1 = file1Data.Sheets[file1Data.SheetNames[0]];
                const sheet2 = file2Data.Sheets[file2Data.SheetNames[0]];
                const rows1 = XLSX.utils.sheet_to_json(sheet1, { header: 1 });
                const rows2 = XLSX.utils.sheet_to_json(sheet2, { header: 1 });

                document.getElementById('resultInfo').textContent =
                    `æ–‡ä»¶1ï¼š${rows1.length - 1} è¡Œæ•°æ® | æ–‡ä»¶2ï¼š${rows2.length - 1} è¡Œæ•°æ® | åˆå¹¶æ¨¡å¼ï¼šVBSé£æ ¼ï¼ˆç©ºå•å…ƒæ ¼å¡«å……ï¼Œä¸åŒå€¼ç”¨åˆ†å·è¿æ¥ï¼‰`;

                showPreview(mergedWorkbook);

                progress.classList.remove('active');
                result.classList.add('active');

                // è‡ªåŠ¨ä¸‹è½½åˆå¹¶æ–‡ä»¶
                setTimeout(() => {
                    XLSX.writeFile(mergedWorkbook, 'åˆå¹¶é…ç½®è¡¨.xlsx');
                }, 1000);
            } catch (error) {
                progress.classList.remove('active');
                showError('åˆå¹¶å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ‰‹åŠ¨åˆå¹¶æŒ‰é’®ï¼ˆä¿ç•™å¤‡ç”¨ï¼‰
        document.getElementById('mergeBtn').addEventListener('click', performMerge);

        function mergeExcelFiles(workbook1, workbook2) {
            const sheet1 = workbook1.Sheets[workbook1.SheetNames[0]];
            const sheet2 = workbook2.Sheets[workbook2.SheetNames[0]];

            const rows1 = XLSX.utils.sheet_to_json(sheet1, { header: 1 });
            const rows2 = XLSX.utils.sheet_to_json(sheet2, { header: 1 });

            if (rows1.length === 0 || rows2.length === 0) {
                throw new Error('æ–‡ä»¶ä¸ºç©º');
            }

            if (rows1.length < 5 || rows2.length < 5) {
                throw new Error('æ–‡ä»¶è‡³å°‘éœ€è¦5è¡Œï¼ˆ4è¡Œå›ºå®šè¡Œ+æ•°æ®ï¼‰');
            }

            // å‰å››è¡Œæ˜¯å›ºå®šè¡Œï¼ˆä¿æŒä¸å˜ï¼‰
            const fixedRows1 = rows1.slice(0, 4);
            const fixedRows2 = rows2.slice(0, 4);
            const headers1 = rows1[0] || [];
            const headers2 = rows2[0] || [];
            const dataRows1 = rows1.slice(4);
            const dataRows2 = rows2.slice(4);

            // æ£€æŸ¥ç¬¬ä¸€è¡Œè¡¨å¤´ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼‰æ˜¯å¦æœ‰æ•°å­—è¡¨å¤´
            const checkIsNumber = (value) => {
                if (value === null || value === undefined || value === '') return false;
                const num = Number(value);
                return !isNaN(num) && isFinite(num);
            };

            // æ£€æŸ¥æ–‡ä»¶1çš„ç¬¬ä¸€è¡Œè¡¨å¤´ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼‰æ˜¯å¦æœ‰æ•°å­—
            let hasNumberHeader1 = false;
            for (let i = 3; i < headers1.length; i++) {
                if (checkIsNumber(headers1[i])) {
                    hasNumberHeader1 = true;
                    break;
                }
            }

            // æ£€æŸ¥æ–‡ä»¶2çš„ç¬¬ä¸€è¡Œè¡¨å¤´ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼‰æ˜¯å¦æœ‰æ•°å­—
            let hasNumberHeader2 = false;
            for (let i = 3; i < headers2.length; i++) {
                if (checkIsNumber(headers2[i])) {
                    hasNumberHeader2 = true;
                    break;
                }
            }

            if (!hasNumberHeader1 && !hasNumberHeader2) {
                throw new Error('è¡¨å¤´ä¸­æœªæ‰¾åˆ°æ•°å­—ä»£ç åˆ—ï¼Œä¸è¿›è¡Œåˆå¹¶æ“ä½œ');
            }

            // å‰ä¸‰åˆ—ï¼šå›ºå®šåˆ—ï¼ˆç´¢å¼•0,1,2ï¼‰ï¼Œç›´æ¥å¤åˆ¶
            // ä»ç¬¬å››åˆ—å¼€å§‹ï¼ˆç´¢å¼•3å¼€å§‹ï¼‰ï¼šé€šè¿‡åˆ—åè¿›è¡ŒVLOOKUPåˆå¹¶

            // åˆ›å»ºæ–‡ä»¶2çš„åˆ—åæ˜ å°„ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼Œç´¢å¼•3ï¼‰
            const headerMap2 = new Map();
            for (let i = 3; i < headers2.length; i++) {
                const headerName = String(headers2[i] || '').trim();
                if (headerName !== '') {
                    headerMap2.set(headerName, i);
                }
            }

            // åˆ›å»ºæ–‡ä»¶1çš„åˆ—åæ˜ å°„ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼Œç´¢å¼•3ï¼‰
            const headerMap1 = new Map();
            for (let i = 3; i < headers1.length; i++) {
                const headerName = String(headers1[i] || '').trim();
                if (headerName !== '') {
                    headerMap1.set(headerName, i);
                }
            }

            // åˆå¹¶è¡¨å¤´
            const mergedHeaders = [];
            const mergedFixedRows = [[], [], [], []];

            // å‰ä¸‰åˆ—ä¿æŒæ–‡ä»¶1çš„è¡¨å¤´
            mergedHeaders.push(headers1[0] || '');
            mergedHeaders.push(headers1[1] || '');
            mergedHeaders.push(headers1[2] || '');

            // å‰å››è¡Œçš„å‰ä¸‰åˆ—æ•°æ®
            for (let r = 0; r < 4; r++) {
                mergedFixedRows[r].push(fixedRows1[r][0] || '');
                mergedFixedRows[r].push(fixedRows1[r][1] || '');
                mergedFixedRows[r].push(fixedRows1[r][2] || '');
            }

            // ä»ç¬¬å››åˆ—å¼€å§‹ï¼Œå…ˆæ·»åŠ æ–‡ä»¶1çš„åˆ—ï¼Œå†æ·»åŠ æ–‡ä»¶2çš„æ–°åˆ—
            const headerSet = new Set();

            // æ·»åŠ æ–‡ä»¶1çš„åˆ—ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼‰
            for (let i = 3; i < headers1.length; i++) {
                const headerName = String(headers1[i] || '').trim();
                if (headerName !== '' && !headerSet.has(headerName)) {
                    mergedHeaders.push(headerName);
                    headerSet.add(headerName);
                    // å‰å››è¡Œçš„å¯¹åº”åˆ—æ•°æ®
                    for (let r = 0; r < 4; r++) {
                        mergedFixedRows[r].push(fixedRows1[r][i] || '');
                    }
                }
            }

            // æ·»åŠ æ–‡ä»¶2çš„æ–°åˆ—
            for (let i = 3; i < headers2.length; i++) {
                const headerName = String(headers2[i] || '').trim();
                if (headerName !== '' && !headerSet.has(headerName)) {
                    mergedHeaders.push(headerName);
                    headerSet.add(headerName);
                    // å‰å››è¡Œçš„å¯¹åº”åˆ—æ•°æ®
                    for (let r = 0; r < 4; r++) {
                        mergedFixedRows[r].push(fixedRows2[r][i] || '');
                    }
                }
            }

            // ä½¿ç”¨å¯¹è±¡å­˜å‚¨åˆå¹¶çš„æ•°æ®ï¼ˆä»¥é¦–åˆ—å€¼ä¸ºkeyï¼‰
            const mergedData = new Map();

            // å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®è¡Œ
            for (let i = 0; i < dataRows1.length; i++) {
                const row = dataRows1[i];
                const key = String(row[0] || '').trim();

                if (key === '') continue;

                // åˆ›å»º rowData å¯¹è±¡
                const rowData = {};

                // å‰ä¸‰åˆ—æŒ‰ä½ç½®å­˜å‚¨
                rowData['__col0'] = row[0];
                rowData['__col1'] = row[1];
                rowData['__col2'] = row[2];

                // ä»ç¬¬å››åˆ—å¼€å§‹ï¼Œé€šè¿‡åˆ—åå­˜å‚¨
                headerMap1.forEach((colIndex, colName) => {
                    rowData[colName] = row[colIndex];
                });

                mergedData.set(key, rowData);
            }

            // å¤„ç†ç¬¬äºŒä¸ªæ–‡ä»¶çš„æ•°æ®è¡Œ - VLOOKUPåˆå¹¶
            for (let i = 0; i < dataRows2.length; i++) {
                const row = dataRows2[i];
                const key = String(row[0] || '').trim();

                if (key === '') continue;

                const existing = mergedData.get(key);

                if (existing) {
                    // å·²å­˜åœ¨ï¼šè¿›è¡ŒVLOOKUPåˆå¹¶ï¼ˆä»ç¬¬å››åˆ—å¼€å§‹ï¼‰
                    headerMap2.forEach((colIndex, colName) => {
                        const newValue = row[colIndex];
                        const oldValue = existing[colName];

                        if (oldValue === undefined || oldValue === '' || oldValue === null) {
                            // ç©ºå•å…ƒæ ¼ç›´æ¥å¡«å……
                            existing[colName] = newValue;
                        } else if (newValue !== undefined && newValue !== '' && newValue !== null && String(oldValue) !== String(newValue)) {
                            // æœ‰å€¼ä¸”ä¸åŒï¼Œç”¨åˆ†å·è¿æ¥ï¼ˆä¸VBSä¸€è‡´ï¼‰
                            existing[colName] = `${oldValue};${newValue}`;
                        }
                    });
                } else {
                    // ä¸å­˜åœ¨ï¼šæ–°å¢è¡Œ
                    const rowData = {};

                    // å‰ä¸‰åˆ—æŒ‰ä½ç½®å­˜å‚¨
                    rowData['__col0'] = row[0];
                    rowData['__col1'] = row[1];
                    rowData['__col2'] = row[2];

                    // ä»ç¬¬å››åˆ—å¼€å§‹ï¼Œé€šè¿‡åˆ—åå­˜å‚¨
                    headerMap2.forEach((colIndex, colName) => {
                        rowData[colName] = row[colIndex];
                    });

                    mergedData.set(key, rowData);
                }
            }

            // æ„å»ºåˆå¹¶åçš„å®Œæ•´æ•°æ®
            const mergedRows = [];

            // æ·»åŠ å‰å››è¡Œå›ºå®šè¡Œ
            mergedFixedRows.forEach(row => mergedRows.push(row));

            // æ·»åŠ åˆå¹¶åçš„æ•°æ®è¡Œ
            mergedData.forEach((rowData) => {
                const row = [];

                // å‰ä¸‰åˆ—æŒ‰ä½ç½®è¾“å‡º
                row.push(rowData['__col0'] !== undefined ? rowData['__col0'] : '');
                row.push(rowData['__col1'] !== undefined ? rowData['__col1'] : '');
                row.push(rowData['__col2'] !== undefined ? rowData['__col2'] : '');

                // ä»ç¬¬å››åˆ—å¼€å§‹ï¼Œé€šè¿‡åˆ—åè¾“å‡ºï¼ˆæŒ‰åˆå¹¶åçš„è¡¨å¤´é¡ºåºï¼‰
                for (let i = 3; i < mergedHeaders.length; i++) {
                    const headerName = String(mergedHeaders[i] || '').trim();
                    row.push(rowData[headerName] !== undefined ? rowData[headerName] : '');
                }

                mergedRows.push(row);
            });

            const newSheet = XLSX.utils.aoa_to_sheet(mergedRows);

            // è®¾ç½®è¡Œé«˜ï¼šç¬¬å››è¡Œæ˜¯å…¶ä»–è¡Œçš„å››å€
            if (!newSheet['!rows']) newSheet['!rows'] = [];
            const normalHeight = 15; // æ ‡å‡†è¡Œé«˜
            const fourthRowHeight = normalHeight * 4; // ç¬¬å››è¡Œè¡Œé«˜ = 60

            // è®¾ç½®æ‰€æœ‰è¡Œçš„è¡Œé«˜
            const range = XLSX.utils.decode_range(newSheet['!ref']);
            for (let r = range.s.r; r <= range.e.r; r++) {
                if (r === 3) {
                    // ç¬¬å››è¡Œï¼ˆç´¢å¼•3ï¼‰è®¾ç½®ä¸ºå››å€è¡Œé«˜
                    newSheet['!rows'][r] = { hpx: fourthRowHeight, hpt: fourthRowHeight };
                } else {
                    // å…¶ä»–è¡Œè®¾ç½®ä¸ºæ ‡å‡†è¡Œé«˜
                    newSheet['!rows'][r] = { hpx: normalHeight, hpt: normalHeight };
                }
            }

            // è®¾ç½®å‰å››è¡Œè‡ªåŠ¨æ¢è¡Œ
            // éå†å‰å››è¡Œçš„æ‰€æœ‰å•å…ƒæ ¼
            for (let r = 0; r < 4; r++) {
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!newSheet[cellAddress]) continue;

                    // è®¾ç½®å•å…ƒæ ¼æ ·å¼
                    if (!newSheet[cellAddress].s) {
                        newSheet[cellAddress].s = {};
                    }

                    // è®¾ç½®å¯¹é½æ–¹å¼ï¼šè‡ªåŠ¨æ¢è¡Œã€å‚ç›´å±…ä¸Šã€æ°´å¹³å±…å·¦
                    newSheet[cellAddress].s.alignment = {
                        wrapText: true,
                        vertical: 'top',
                        horizontal: 'left'
                    };
                }
            }

            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'åˆå¹¶ç»“æœ');

            return newWorkbook;
        }

        function showPreview(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const preview = document.getElementById('preview');
            const previewTable = document.getElementById('previewTable');

            let html = '<table><thead><tr>';
            // æ˜¾ç¤ºæ‰€æœ‰åˆ—
            if (rows[0]) {
                for (let i = 0; i < rows[0].length; i++) {
                    html += `<th>${rows[0][i] || ''}</th>`;
                }
            }
            html += '</tr></thead><tbody>';

            // æ˜¾ç¤ºæ‰€æœ‰è¡Œ
            for (let i = 1; i < rows.length; i++) {
                // å‰ä¸‰è¡Œæ•°æ®æ·»åŠ ç‰¹æ®Šç±»å
                const rowClass = i <= 3 ? ` class="fixed-row-${i}"` : '';
                html += `<tr${rowClass}>`;
                for (let j = 0; j < rows[i].length; j++) {
                    html += `<td>${rows[i][j] !== undefined ? rows[i][j] : ''}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            previewTable.innerHTML = html;
            preview.style.display = 'block';

            // æ˜¾ç¤ºæ»šåŠ¨æŒ‡ç¤ºå™¨
            document.getElementById('scrollIndicator').style.display = 'flex';
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('active');
        }

        // ä¸‹è½½åŠŸèƒ½
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (mergedWorkbook) {
                XLSX.writeFile(mergedWorkbook, 'åˆå¹¶é…ç½®è¡¨.xlsx');
            }
        });

        // æ»šåŠ¨æŒ‡ç¤ºå™¨ç‚¹å‡»äº‹ä»¶
        document.getElementById('scrollIndicator').addEventListener('click', () => {
            const previewTable = document.getElementById('previewTable');
            previewTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        setupFileUpload('uploadBox1', 'file1', 'fileInfo1', 'fileName1', 'file1Data');
        setupFileUpload('uploadBox2', 'file2', 'fileInfo2', 'fileName2', 'file2Data');
    </script>
</body>
</html>
