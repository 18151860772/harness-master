<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼çº¿é€‰å‹çŸ©é˜µè¡¨ V3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="web.data.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .upload-section {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .upload-info {
            margin-bottom: 0;
            color: #666;
            font-size: 12px;
            flex: 1;
        }

        .upload-btn {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #fileInput {
            display: none;
        }

        .tabs {
            display: flex;
            background: #f0f0f0;
            border-bottom: 2px solid #ddd;
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: #f0f0f0;
            border: none;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        #sheetsContainer {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-container {
            padding: 5px;
            overflow: auto;
            flex: 1;
            max-height: calc(100vh - 200px);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
            table-layout: fixed;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 100;
            display: table-header-group;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            white-space: normal;
            word-wrap: break-word;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4190 100%);
        }

        th.filter-active {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: inset 0 0 0 2px #fff;
        }

        th.filter-active::after {
            content: 'ğŸ”½';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        td {
            padding: 6px 4px;
            border: 1px solid #e0e0e0;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
            font-size: 12px;
            min-width: 40px;
            position: relative;
            z-index: 1;
        }

        /* ç¡®ä¿tbodyå•å…ƒæ ¼åœ¨stickyè¡¨å¤´ä¸‹æ–¹ */
        tbody tr {
            position: relative;
            z-index: 1;
        }

        td.x-cell {
            background: #28a745 !important;
            color: white !important;
            font-weight: bold;
            font-size: 16px;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e8f4f8;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 18px;
        }

        .sheet-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .sheet-content.active {
            display: flex;
        }

        .stats {
            padding: 8px 15px;
            background: #e8f4f8;
            border-bottom: 1px solid #d0e0f0;
            font-size: 12px;
            color: #333;
            flex-shrink: 0;
        }

        .stats strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¯¼çº¿é€‰å‹çŸ©é˜µè¡¨ V3.0</h1>
            <p>ç‚¹å‡»è¡¨å¤´ç­›é€‰è¯¥åˆ—æœ‰Xçš„è¡Œ | å†æ¬¡ç‚¹å‡»å–æ¶ˆç­›é€‰</p>
        </div>

        <div class="upload-section">
            <div class="upload-info">
                å½“å‰æ•°æ®æ¥æº: <span id="dataSource" style="font-weight: bold; color: #667eea;">æœ¬åœ°é»˜è®¤æ–‡ä»¶</span>
            </div>
            <label class="upload-btn">
                ä¸Šä¼ æ–°çš„Excelæ–‡ä»¶
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </label>
            <span id="fileName" style="margin-left: 15px; color: #666;"></span>
        </div>

        <div class="tabs" id="tabs" style="display: none;">
        </div>

        <div id="sheetsContainer"></div>
    </div>

    <script>
        let workbookData = {};
        // defaultData is loaded from web.data.js
        let headerFilter = { sheetIndex: -1, colIndex: -1, headerName: '' };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰é»˜è®¤æ•°æ®
        window.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœ defaultData ä¸­æœ‰æ•°æ®ï¼ˆé€šè¿‡ web.data.js åŠ è½½ï¼‰ï¼Œåˆ™ä½¿ç”¨å®ƒ
            if (Object.keys(defaultData).length > 0) {
                console.log('=== defaultData è°ƒè¯•ä¿¡æ¯ ===');
                const sheetNames = Object.keys(defaultData);
                console.log('Sheetæ•°é‡:', sheetNames.length);
                sheetNames.forEach((name, index) => {
                    console.log(`\nSheet ${index}: ${name}`);
                    const data = defaultData[name];
                    console.log('  è¡Œæ•°:', data.length);
                    if (data.length > 0) {
                        console.log('  åˆ—æ•°:', data[0].length);
                        console.log('  è¡¨å¤´:', data[0]);
                    }
                });
                workbookData = defaultData;
                renderUI();
                console.log('\nå·²åŠ è½½é¢„ç½®æ•°æ®');
            } else {
                console.log('æœªæ‰¾åˆ°é¢„ç½®æ•°æ®ï¼Œè¯·ä¸Šä¼  Excel æ–‡ä»¶');
            }
        });

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('dataSource').textContent = 'ä¸Šä¼ æ–‡ä»¶: ' + file.name;

            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                workbookData = {};
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    // ä½¿ç”¨ header: 1 è¯»å–ä¸ºæ•°ç»„æ ¼å¼ï¼Œdefval: '' ä¿ç•™ç©ºå•å…ƒæ ¼
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: '',  // ç©ºå•å…ƒæ ¼ç”¨ç©ºå­—ç¬¦ä¸²å¡«å……
                        blankrows: true  // ä¿ç•™ç©ºè¡Œ
                    });

                    // æ‰¾åˆ°æœ€å¤§åˆ—æ•°ï¼Œç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åŒæ•°é‡çš„åˆ—
                    let maxCols = 0;
                    jsonData.forEach(row => {
                        if (row.length > maxCols) {
                            maxCols = row.length;
                        }
                    });

                    // å¡«å……æ¯è¡Œåˆ°æœ€å¤§åˆ—æ•°
                    workbookData[sheetName] = jsonData.map(row => {
                        const newRow = [];
                        for (let i = 0; i < maxCols; i++) {
                            newRow.push(row[i] !== undefined && row[i] !== null ? row[i] : '');
                        }
                        return newRow;
                    });

                    console.log(`Sheet ${sheetName}: ${jsonData.length} è¡Œ, æœ€å¤§åˆ—æ•°: ${maxCols}`);
                });

                // é‡ç½®ç­›é€‰
                headerFilter = { sheetIndex: -1, colIndex: -1, headerName: '' };
                renderUI();
            };
            reader.readAsArrayBuffer(file);
        });

        function renderUI() {
            const sheetNames = Object.keys(workbookData);

            if (sheetNames.length === 0) {
                showError('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•°æ®');
                return;
            }

            const tabsContainer = document.getElementById('tabs');
            const sheetsContainer = document.getElementById('sheetsContainer');

            tabsContainer.innerHTML = '';
            sheetsContainer.innerHTML = '';

            sheetNames.forEach((sheetName, index) => {
                // åˆ›å»ºtab
                const tab = document.createElement('button');
                tab.className = 'tab' + (index === 0 ? ' active' : '');
                tab.textContent = sheetName;
                tab.onclick = () => switchTab(sheetName);
                tabsContainer.appendChild(tab);

                // åˆ›å»ºsheetå†…å®¹å®¹å™¨
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'sheet-content' + (index === 0 ? ' active' : '');
                sheetDiv.id = 'sheet-' + index;

                // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯æ 
                const statsDiv = document.createElement('div');
                statsDiv.className = 'stats';
                statsDiv.id = 'stats-' + index;
                sheetDiv.appendChild(statsDiv);

                // åˆ›å»ºè¡¨æ ¼å®¹å™¨
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.id = 'table-' + index;
                sheetDiv.appendChild(tableContainer);

                sheetsContainer.appendChild(sheetDiv);
            });

            tabsContainer.style.display = 'flex';

            // åˆå§‹åŒ–æ‰€æœ‰è¡¨æ ¼
            sheetNames.forEach((sheetName, index) => {
                renderTable(index, sheetName);
            });
        }

        function switchTab(sheetName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.sheet-content');

            tabs.forEach((tab, index) => {
                if (tab.textContent === sheetName) {
                    tab.classList.add('active');
                    contents[index].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[index].classList.remove('active');
                }
            });
        }

        // åˆ‡æ¢è¡¨å¤´ç­›é€‰
        function toggleHeaderFilter(sheetIndex, colIndex, headerName) {
            console.log(`ç‚¹å‡»è¡¨å¤´: Sheet=${sheetIndex}, åˆ—=${colIndex}, è¡¨å¤´="${headerName}"`);

            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰ç­›é€‰çš„åˆ—ï¼Œåˆ™å–æ¶ˆç­›é€‰
            if (headerFilter.sheetIndex === sheetIndex && headerFilter.colIndex === colIndex) {
                console.log('å–æ¶ˆç­›é€‰');
                headerFilter = { sheetIndex: -1, colIndex: -1, headerName: '' };
            } else {
                // è®¾ç½®æ–°çš„ç­›é€‰
                console.log(`è®¾ç½®ç­›é€‰: åˆ—${colIndex} (${headerName})`);
                headerFilter = { sheetIndex, colIndex, headerName };
            }

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderTable(sheetIndex, Object.keys(workbookData)[sheetIndex]);
        }

        function renderTable(sheetIndex, sheetName) {
            const data = workbookData[sheetName];
            const tableContainer = document.getElementById('table-' + sheetIndex);
            const statsContainer = document.getElementById('stats-' + sheetIndex);

            if (!data || data.length === 0) {
                tableContainer.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å½“å‰sheetæœ‰ç­›é€‰
            const hasFilter = headerFilter.sheetIndex === sheetIndex && headerFilter.colIndex >= 0;
            const filterColIndex = hasFilter ? headerFilter.colIndex : -1;

            // è®¡ç®—æ¯åˆ—çš„å†…å®¹å®½åº¦ï¼Œç”¨äºè®¾ç½®å›ºå®šåˆ—å®½
            const colWidths = [];
            if (data.length > 0) {
                for (let colIndex = 0; colIndex < data[0].length; colIndex++) {
                    let maxLen = 0;
                    // æ£€æŸ¥å‰20è¡Œæ¥ä¼°ç®—åˆ—å®½
                    for (let i = 0; i < Math.min(data.length, 20); i++) {
                        const cellValue = String(data[i][colIndex] || '');
                        // ä¸­æ–‡å­—ç¬¦ç®—2ä¸ªå­—ç¬¦å®½åº¦
                        const len = cellValue.length + (cellValue.match(/[\u4e00-\u9fa5]/g) || []).length;
                        if (len > maxLen) maxLen = len;
                    }
                    // è®¾ç½®æœ€å°å’Œæœ€å¤§å®½åº¦
                    const width = Math.max(60, Math.min(maxLen * 8, 300));
                    colWidths.push(width);
                }
            }

            let html = '<table>';
            html += '<colgroup>';
            colWidths.forEach(width => {
                html += `<col style="width: ${width}px;">`;
            });
            html += '</colgroup>';

            // è¡¨å¤´
            if (data.length > 0) {
                html += '<thead><tr>';
                const header = data[0];
                header.forEach((cell, colIndex) => {
                    const isActive = hasFilter && filterColIndex === colIndex;
                    html += `<th class="${isActive ? 'filter-active' : ''}" onclick="toggleHeaderFilter(${sheetIndex}, ${colIndex}, '${cell || ''}')">${cell || ''}</th>`;
                });
                html += '</tr></thead>';
            }

            // è¡¨ä½“
            html += '<tbody>';
            let matchedRowCount = 0;
            let totalRowCount = data.length - 1;

            for (let i = 1; i < data.length; i++) {
                // å¦‚æœæœ‰ç­›é€‰ï¼Œæ£€æŸ¥è¯¥è¡Œåœ¨ç­›é€‰åˆ—æ˜¯å¦æœ‰X
                let rowHasX = true;
                if (hasFilter) {
                    const cellValue = String(data[i][filterColIndex] || '').trim().toUpperCase();
                    rowHasX = cellValue === 'X' || cellValue === 'âœ“';
                    if (rowHasX) {
                        matchedRowCount++;
                    }
                }

                // å¦‚æœæœ‰ç­›é€‰ä¸”è¯¥è¡Œæ²¡æœ‰Xï¼Œè·³è¿‡
                if (hasFilter && !rowHasX) {
                    continue;
                }

                html += '<tr>';
                data[i].forEach((cell, colIndex) => {
                    const cellValue = cell !== undefined && cell !== null ? String(cell).trim() : '';
                    const isXCell = cellValue === 'X' || cellValue === 'âœ“';
                    const cellClass = isXCell ? 'x-cell' : '';
                    const cellStyle = (hasFilter && colIndex === filterColIndex) ? 'background: #fff3cd; font-weight: bold;' : '';

                    if (isXCell) {
                        html += `<td class="${cellClass}" style="${cellStyle}">âœ“</td>`;
                    } else {
                        html += `<td style="${cellStyle}">${cell}</td>`;
                    }
                });
                html += '</tr>';
            }

            html += '</tbody></table>';

            tableContainer.innerHTML = html;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (statsContainer) {
                if (hasFilter) {
                    statsContainer.innerHTML = `ç­›é€‰åˆ—: <strong>${headerFilter.headerName}</strong> | æ˜¾ç¤º: <strong>${matchedRowCount}</strong> è¡Œ (å…± ${totalRowCount} è¡Œ)`;
                } else {
                    statsContainer.innerHTML = `æ€»è¡Œæ•°: <strong>${totalRowCount}</strong> è¡Œ`;
                }
            }

            console.log(`Sheet ${sheetName}: ${hasFilter ? 'ç­›é€‰' : 'å…¨éƒ¨'} | æ˜¾ç¤º: ${matchedRowCount || totalRowCount}/${totalRowCount} è¡Œ`);
        }

        function showError(message) {
            const sheetsContainer = document.getElementById('sheetsContainer');
            sheetsContainer.innerHTML = `<div class="no-data" style="color: #dc3545;">${message}</div>`;
        }
    </script>
</body>
</html>
