<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECRåˆ—è¡¨ç”Ÿæˆå™¨</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script id="worker-code" type="javascript/worker">
        // Web Worker for ECRæ–‡ä»¶å¤„ç†
        self.importScripts('https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js');

        const ECR_PATTERN = /ECR-([A-Z0-9-]+)[-_](\d{8})/;
        const SKIP_SHEETS = ['Wire', 'T28_Masterlist', 'Masterlist', 'Connector', 'Splice'];

        self.onmessage = async function(e) {
            const { files, skipTemp } = e.data;
            const results = [];
            let processed = 0;

            for (const fileData of files) {
                try {
                    const info = await parseECRFile(fileData, skipTemp);
                    if (info) {
                        results.push(info);
                    }
                } catch (err) {
                    console.error('Error:', err.message);
                }

                processed++;
                self.postMessage({ type: 'progress', current: processed, total: files.length });
            }

            self.postMessage({ type: 'complete', results });
        };

        async function parseECRFile(fileData, skipTemp) {
            const { name, data } = fileData;
            if (skipTemp && name.includes('ä¸´æ—¶')) return null;

            // è§£ææ–‡ä»¶åè·å–ecrNumberå’Œdateï¼ˆè¿™æ˜¯æœ€å‡†ç¡®çš„ï¼‰
            const nameMatch = name.match(ECR_PATTERN);
            if (!nameMatch) return null;

            const ecrNumber = nameMatch[1];  // ä¾‹å¦‚ï¼šT28-0S
            const date = nameMatch[2];       // ä¾‹å¦‚ï¼š202403011

            const info = {
                originalFile: name,
                ecrNumber,
                date,
                project: '',
                description: '',
                status: '',
                department: '',
                applicant: '',
                checker: ''
            };

            // å¿«é€Ÿè§£æExcel
            const workbook = XLSX.read(data, { type: 'array', cellStyles: false, cellFormulae: false, cellDates: false });

            // åªå¤„ç†Coverå·¥ä½œè¡¨
            const coverSheetName = workbook.SheetNames.find(n => n === 'Cover') || workbook.SheetNames[0];
            const coverSheet = workbook.Sheets[coverSheetName];

            if (coverSheet && coverSheet['!ref']) {
                // ç›´æ¥ç”¨å•å…ƒæ ¼åœ°å€è¯»å–
                // C4 = ECR Number, G4 = Title
                // C5 = ECR Type
                // C6 = Project, G6 = Requestor, I6 = Checker
                const c4 = coverSheet['C4'];
                const g4 = coverSheet['G4'];
                const c5 = coverSheet['C5'];
                const c6 = coverSheet['C6'];
                const g6 = coverSheet['G6'];
                const i6 = coverSheet['I6'];

                // æ³¨æ„ï¼šecrNumberå’Œdateä½¿ç”¨æ–‡ä»¶åè§£æçš„å€¼ï¼Œä¸ä»å•å…ƒæ ¼è¦†ç›–
                // åªè¯»å–descriptionã€statusã€projectã€applicantã€checker
                info.description = g4 ? String(g4.v || '') : '';
                info.status = c5 ? String(c5.v || '') : '';
                info.project = c6 ? String(c6.v || '') : '';
                info.applicant = g6 ? String(g6.v || '') : '';
                info.checker = i6 ? String(i6.v || '') : '';
            }

            // å¤‡é€‰ï¼šä»Input Analyzeè·å–æè¿°
            if (!info.description) {
                const inputSheet = workbook.Sheets['Input Analyze'];
                if (inputSheet) {
                    const cell = inputSheet['B2'];
                    if (cell) info.description = String(cell.v || '').slice(0, 200);
                }
            }

            return info;
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 30px);
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        .upload-area:hover {
            background: #e8ebff;
            border-color: #764ba2;
        }
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }
        .upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .upload-text {
            color: #666;
            font-size: 1rem;
        }
        .btn {
            display: inline-block;
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .file-item:hover {
            background: #e8ebff;
        }
        .file-name {
            flex: 1;
            font-weight: 500;
            color: #333;
        }
        .file-date {
            color: #666;
            font-size: 0.9rem;
            margin-right: 15px;
        }
        .file-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .preview-table th,
        .preview-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 500;
        }
        .preview-table tbody tr:hover {
            background: #f8f9ff;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            flex-shrink: 0;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-entry.info { color: #00bfff; }
        .log-entry.success { color: #00ff00; }
        .log-entry.error { color: #ff4444; }
        .log-entry.warning { color: #ffaa00; }
        .hidden { display: none; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ECRåˆ—è¡¨ç”Ÿæˆå™¨</h1>

        <!-- ç»Ÿè®¡åŒºåŸŸ -->
        <div class="stats" id="statsArea">
            <div class="stat-box">
                <div class="stat-number" id="totalFiles">0</div>
                <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="validFiles">0</div>
                <div class="stat-label">æœ‰æ•ˆECRæ–‡ä»¶</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="processedFiles">0</div>
                <div class="stat-label">å·²å¤„ç†</div>
            </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="card">
            <h2>1. é€‰æ‹©ECRæ–‡ä»¶</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ECR Excelæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div style="color: #999; font-size: 0.9rem; margin-top: 10px;">æ”¯æŒ .xlsx æ ¼å¼</div>
            </div>
            <input type="file" id="fileInput" multiple accept=".xlsx" class="hidden">
            <div class="file-list" id="fileList"></div>
        </div>

        <!-- å¤„ç†æ§åˆ¶ -->
        <div class="card">
            <h2>2. å¤„ç†é€‰é¡¹</h2>
            <div style="margin-bottom: 15px;">
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="includeSubFolder" checked> åŒ…å«å­æ–‡ä»¶å¤¹ä¸­çš„ECRæ–‡ä»¶
                </label>
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="skipTempFiles" checked> è·³è¿‡ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚åŒ…å«"ä¸´æ—¶"çš„æ–‡ä»¶ï¼‰
                </label>
            </div>
            <div>
                <button class="btn" id="processBtn" disabled>å¤„ç†æ–‡ä»¶</button>
                <button class="btn btn-success" id="exportBtn" disabled>å¯¼å‡ºECRåˆ—è¡¨</button>
                <button class="btn btn-danger" id="clearBtn">æ¸…ç©º</button>
            </div>
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="card hidden" id="previewCard" style="flex: 1; display: flex; flex-direction: column; padding: 10px;">
            <h2 style="margin-bottom: 8px; flex-shrink: 0;">3. é¢„è§ˆç»“æœ</h2>
            <div style="overflow: auto; flex: 1; border: 1px solid #ddd; border-radius: 5px;">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>ECRç¼–å·</th>
                            <th>å˜æ›´å†…å®¹æ¦‚è¿°</th>
                            <th>é¡¹ç›®é˜¶æ®µ</th>
                            <th>ä¸‹å‘æ—¶é—´</th>
                            <th>åŸç†æ£€æŸ¥äººå‘˜</th>
                            <th>æ£€æŸ¥ç»“æœ</th>
                            <th>æ˜¯å¦å®æ–½å®Œæˆ</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="card" style="flex-shrink: 0; margin-top: auto;">
            <h2>å¤„ç†æ—¥å¿—</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ecrFiles = [];
        let ecrData = [];
        const ECR_PATTERN = /ECR-([A-Z0-9-]+)[-_](\d{8})/;

        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const logContainer = document.getElementById('logContainer');
        const previewCard = document.getElementById('previewCard');
        const previewBody = document.getElementById('previewBody');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // æ—¥å¿—ç¼“å­˜ï¼ˆå‡å°‘DOMæ“ä½œï¼‰
        let logQueue = [];
        let logTimer = null;

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            logQueue.push({ message: `[${time}] ${message}`, type });

            if (!logTimer) {
                logTimer = setTimeout(flushLog, 100);
            }
        }

        function flushLog() {
            if (logQueue.length === 0) {
                logTimer = null;
                return;
            }

            const fragment = document.createDocumentFragment();
            logQueue.forEach(item => {
                const entry = document.createElement('div');
                entry.className = `log-entry ${item.type}`;
                entry.textContent = item.message;
                fragment.appendChild(entry);
            });

            logContainer.appendChild(fragment);
            logContainer.scrollTop = logContainer.scrollHeight;

            logQueue = [];
            logTimer = null;
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalFiles').textContent = ecrFiles.length;
            const validCount = ecrFiles.filter(f => f.valid).length;
            document.getElementById('validFiles').textContent = validCount;
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            fileList.innerHTML = '';
            ecrFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';

                let statusClass = 'status-pending';
                let statusText = 'ç­‰å¾…å¤„ç†';

                if (file.processed) {
                    statusClass = 'status-success';
                    statusText = 'å·²å¤„ç†';
                } else if (!file.valid) {
                    statusClass = 'status-error';
                    statusText = 'æ— æ•ˆæ ¼å¼';
                }

                item.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-date">${file.date || '-'}</span>
                    <span class="file-status ${statusClass}">${statusText}</span>
                `;
                fileList.appendChild(item);
            });
            updateStats();
        }

        // åˆ›å»ºWeb Worker
        let worker = null;
        function createWorker() {
            if (worker) return worker;

            const workerCode = document.getElementById('worker-code').textContent;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                const { type, current, total, results } = e.data;

                if (type === 'progress') {
                    const progress = (current / total) * 100;
                    progressFill.style.width = `${progress}%`;
                    document.getElementById('processedFiles').textContent = current;
                } else if (type === 'complete') {
                    ecrData = results;

                    // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                    const processedNames = new Set(results.map(r => r.originalFile));
                    ecrFiles.forEach(f => {
                        if (processedNames.has(f.name)) f.processed = true;
                    });
                    renderFileList();

                    processBtn.disabled = false;
                    processBtn.textContent = 'å¤„ç†æ–‡ä»¶';
                    progressBar.classList.add('hidden');

                    log(`å¤„ç†å®Œæˆï¼Œå…± ${ecrData.length} ä¸ªæ–‡ä»¶`, 'success');

                    if (ecrData.length > 0) {
                        renderPreview();
                        exportBtn.disabled = false;
                    }
                }
            };

            return worker;
        }

        // è¯»å–æ–‡ä»¶ä¸ºArrayBufferï¼ˆå¹¶è¡Œï¼‰
        async function readFilesAsArrayBuffers(files) {
            const results = [];
            const batchSize = 20; // å¹¶è¡Œè¯»å–20ä¸ªæ–‡ä»¶

            for (let i = 0; i < files.length; i += batchSize) {
                const batch = files.slice(i, i + batchSize);
                const promises = batch.map(fileObj => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve({ name: fileObj.name, data: e.target.result });
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(fileObj.file);
                    });
                });

                const batchResults = await Promise.all(promises);
                results.push(...batchResults);
            }

            return results;
        }

        // å¤„ç†æ–‡ä»¶ï¼ˆä½¿ç”¨Web Workerï¼‰
        async function processFiles() {
            if (ecrFiles.length === 0) {
                log('æ²¡æœ‰æ–‡ä»¶éœ€è¦å¤„ç†', 'warning');
                return;
            }

            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading"></span> è¯»å–æ–‡ä»¶ä¸­...';
            progressBar.classList.remove('hidden');

            const skipTemp = document.getElementById('skipTempFiles').checked;
            const validFiles = ecrFiles.filter(f => f.valid && !(skipTemp && f.name.includes('ä¸´æ—¶')));
            const total = validFiles.length;

            if (total === 0) {
                log('æ²¡æœ‰æœ‰æ•ˆçš„ECRæ–‡ä»¶', 'warning');
                processBtn.disabled = false;
                processBtn.textContent = 'å¤„ç†æ–‡ä»¶';
                progressBar.classList.add('hidden');
                return;
            }

            log(`æ­£åœ¨è¯»å– ${total} ä¸ªæ–‡ä»¶...`, 'info');

            try {
                // å¹¶è¡Œè¯»å–æ‰€æœ‰æ–‡ä»¶
                const fileDataList = await readFilesAsArrayBuffers(validFiles);

                log(`å¼€å§‹å¤„ç†...`, 'info');
                processBtn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';

                // å‘é€æ•°æ®åˆ°Workerå¤„ç†
                const w = createWorker();
                w.postMessage({ files: fileDataList, skipTemp });

            } catch (err) {
                log(`è¯»å–æ–‡ä»¶å¤±è´¥: ${err.message}`, 'error');
                processBtn.disabled = false;
                processBtn.textContent = 'å¤„ç†æ–‡ä»¶';
            }
        }

        // æ¸²æŸ“é¢„è§ˆï¼ˆä½¿ç”¨DocumentFragmentä¼˜åŒ–ï¼‰
        function renderPreview() {
            previewCard.classList.remove('hidden');

            // æŒ‰æ—¥æœŸå‡åºæ’åºï¼ˆæ—¶é—´æ—©çš„åœ¨å‰ï¼‰
            const sorted = [...ecrData].sort((a, b) => a.date.localeCompare(b.date));

            // è®¡ç®—é¡¹ç›®é˜¶æ®µ
            const getProjectPhase = (item) => {
                const ecrFullNum = `ECR-${item.ecrNumber}`;
                const dateMatch = item.date;
                if (dateMatch) {
                    const beforeDate = ecrFullNum.split('_' + dateMatch)[0];
                    const lastDashIndex = beforeDate.lastIndexOf('-');
                    return lastDashIndex > 4 ? beforeDate.substring(lastDashIndex + 1) : '';
                }
                return '';
            };

            const fragment = document.createDocumentFragment();
            sorted.forEach((item, index) => {
                const ecrName = item.originalFile.replace(/\.xlsx$/i, '');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${ecrName}</td>
                    <td>${truncateText(item.description, 60)}</td>
                    <td>${getProjectPhase(item)}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.checker || '-'}</td>
                    <td>OK</td>
                    <td>å·²å®Œæˆ</td>
                `;
                fragment.appendChild(row);
            });

            previewBody.innerHTML = '';
            previewBody.appendChild(fragment);

            log(`é¢„è§ˆæ˜¾ç¤º ${ecrData.length} æ¡è®°å½•`, 'info');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return '-';
            return `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`;
        }

        // æˆªæ–­æ–‡æœ¬
        function truncateText(text, maxLength) {
            if (!text) return '-';
            text = String(text);
            return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            if (ecrData.length === 0) {
                log('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
                return;
            }

            log('æ­£åœ¨ç”ŸæˆECRåˆ—è¡¨...', 'info');

            // å‡†å¤‡æ•°æ®ï¼ˆæŒ‰æ—¥æœŸå‡åºæ’åºï¼Œæ—¶é—´æ—©çš„åœ¨å‰ï¼‰
            const sorted = [...ecrData].sort((a, b) => a.date.localeCompare(b.date));
            const exportData = sorted.map((item, index) => {
                // æå–é¡¹ç›®é˜¶æ®µï¼šä»ECRç¼–å·ä¸­å– "_æ—¥æœŸ" å‰é¢åˆ°æœ€åä¸€ä¸ª "-" çš„å†…å®¹
                // ä¾‹å¦‚ ECR-T28-0S_202403011 -> T28-0S
                const ecrFullNum = `ECR-${item.ecrNumber}`;
                const dateMatch = item.date;
                let projectPhase = '';
                if (dateMatch) {
                    const beforeDate = ecrFullNum.split('_' + dateMatch)[0];
                    const lastDashIndex = beforeDate.lastIndexOf('-');
                    projectPhase = lastDashIndex > 4 ? beforeDate.substring(lastDashIndex + 1) : '';
                }

                return {
                    'åºå·': index + 1,
                    'ECRç¼–å·': item.originalFile.replace(/\.xlsx$/i, ''),  // å»æ‰åç¼€
                    'å˜æ›´å†…å®¹æ¦‚è¿°': item.description || '',
                    'é¡¹ç›®é˜¶æ®µ': projectPhase,
                    'ä¸‹å‘æ—¶é—´': formatDate(item.date),
                    'åŸç†æ£€æŸ¥äººå‘˜': item.checker || '',
                    'æ£€æŸ¥ç»“æœ': 'OK',
                    'æ˜¯å¦å®æ–½å®Œæˆ': 'å·²å®Œæˆ'
                };
            });

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 5 },   // åºå·
                { wch: 30 },  // ECRç¼–å·
                { wch: 60 },  // å˜æ›´å†…å®¹æ¦‚è¿°
                { wch: 15 },  // é¡¹ç›®é˜¶æ®µ
                { wch: 12 },  // ä¸‹å‘æ—¶é—´
                { wch: 12 },  // åŸç†æ£€æŸ¥äººå‘˜
                { wch: 10 },  // æ£€æŸ¥ç»“æœ
                { wch: 12 }   // æ˜¯å¦å®æ–½å®Œæˆ
            ];

            // æ·»åŠ è¡¨å¤´æ ·å¼ï¼ˆç²—ä½“ï¼‰
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let c = range.s.c; c <= range.e.c; c++) {
                const cell = ws[XLSX.utils.encode_cell({ r: 0, c })];
                if (cell) cell.s = { font: { bold: true } };
            }

            XLSX.utils.book_append_sheet(wb, ws, 'ECRåˆ—è¡¨');

            // ç”Ÿæˆæ–‡ä»¶å
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `SYE_ECR_LIST_${dateStr}.xlsx`;

            // ä¸‹è½½
            XLSX.writeFile(wb, fileName);
            log(`âœ“ å·²å¯¼å‡º: ${fileName}`, 'success');
        }

        // æ¸…ç©º
        function clearAll() {
            ecrFiles = [];
            ecrData = [];
            fileInput.value = '';
            fileList.innerHTML = '';
            previewCard.classList.add('hidden');
            exportBtn.disabled = true;
            processBtn.disabled = true;
            updateStats();
            log('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'warning');
        }

        // äº‹ä»¶ç›‘å¬
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        processBtn.addEventListener('click', processFiles);
        exportBtn.addEventListener('click', exportToExcel);
        clearBtn.addEventListener('click', clearAll);

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFiles(files) {
            const skipTemp = document.getElementById('skipTempFiles').checked;

            for (const file of files) {
                if (!file.name.endsWith('.xlsx')) continue;
                if (skipTemp && file.name.includes('ä¸´æ—¶')) continue;

                const match = file.name.match(ECR_PATTERN);
                ecrFiles.push({
                    file: file,
                    name: file.name,
                    date: match ? formatDate(match[2]) : null,
                    valid: !!match,
                    processed: false
                });
            }

            renderFileList();
            processBtn.disabled = ecrFiles.filter(f => f.valid).length === 0;
            log(`æ·»åŠ äº† ${files.length} ä¸ªæ–‡ä»¶`, 'info');
        }

        // åˆå§‹åŒ–
        log('ECRåˆ—è¡¨ç”Ÿæˆå™¨å·²å°±ç»ª', 'info');
    </script>
</body>
</html>
